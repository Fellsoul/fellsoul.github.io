var Constants={ANIM_FADE:.18,PLAYER_SPEED:5,PLAYER_RUN_MULTIPLIER:2,PLAYER_JUMP_FORCE:10,CAMERA_OFFSET:[0,3,5],CAMERA_SMOOTH_FACTOR:5,WALK_THRESHOLD:.2,RUN_THRESHOLD:2.5,EVENTS:{PLAYER_JUMP:"player:jump",PLAYER_MOVE:"player:move",PLAYER_STATE_CHANGE:"player:stateChange"}};"undefined"!=typeof module&&module.exports&&(module.exports=Constants);var EventBus=pc.createScript("eventBus");EventBus.prototype.initialize=function(){window.EventBus||(window.EventBus=this.app),console.log("[EventBus] 初始化完成")},EventBus.prototype.emit=function(t,n){this.app.fire(t,n)},EventBus.prototype.on=function(t,n,o){this.app.on(t,n,o)},EventBus.prototype.off=function(t,n,o){this.app.off(t,n,o)},EventBus.prototype.once=function(t,n,o){this.app.once(t,n,o)};var Boot=pc.createScript("boot");Boot.prototype.initialize=function(){console.log("Booting game..."),this.initializeCore(),this.initializeManagers(),this.loadInitialScene()},Boot.prototype.initializeCore=function(){console.log("Initializing core systems..."),this.app.script.constants||console.log("Constants script not found"),this.app.script.eventBus||console.log("EventBus script not found")},Boot.prototype.initializeManagers=function(){console.log("Initializing managers...")},Boot.prototype.loadInitialScene=function(){console.log("Loading initial scene...")};var PlayerController=pc.createScript("playerController");PlayerController.attributes.add("walkSpeed",{type:"number",default:4,title:"走路速度"}),PlayerController.attributes.add("runSpeed",{type:"number",default:7,title:"跑步速度"}),PlayerController.attributes.add("accel",{type:"number",default:12,title:"加速(越大越快到目标)"}),PlayerController.attributes.add("decel",{type:"number",default:16,title:"减速(松键后收敛)"}),PlayerController.attributes.add("airControl",{type:"number",default:.3,title:"空中控制(0~1)"}),PlayerController.attributes.add("jumpSpeed",{type:"number",default:6,title:"跳起初速度"}),PlayerController.attributes.add("groundCheckDistance",{type:"number",default:.6,title:"落地检测距离"}),PlayerController.attributes.add("groundCheckHz",{type:"number",default:30,title:"落地检测频率(Hz, 降帧压测)"}),PlayerController.attributes.add("climbSpeed",{type:"number",default:2,title:"攀爬速度"}),PlayerController.attributes.add("climbKey",{type:"string",default:"KeyF",title:"攀爬按键"}),PlayerController.attributes.add("climbOffset",{type:"number",default:.35,title:"贴墙间距(米)"}),PlayerController.attributes.add("climbStickGain",{type:"number",default:12,title:"贴附强度(越大越贴墙)"}),PlayerController.attributes.add("climbMaxSlopeDeg",{type:"number",default:89,title:"可攀最大坡度(°)"}),PlayerController.attributes.add("cameraEntity",{type:"entity",title:"相机实体(可选)"}),PlayerController.attributes.add("visualPivot",{type:"entity",title:"可视旋转节点(建议)"}),PlayerController.attributes.add("mouseSensitivity",{type:"number",default:.3,title:"鼠标灵敏度"}),PlayerController.attributes.add("autoRotateWithMovement",{type:"boolean",default:!1,title:"移动时自动转向(不用鼠标时)"}),PlayerController.attributes.add("invertForward",{type:"boolean",default:!0,title:"反向前后(W/S反转)"}),PlayerController.attributes.add("invertRight",{type:"boolean",default:!0,title:"反向左右(A/D反转)"}),PlayerController.attributes.add("turnWithKeys",{type:"boolean",default:!0,title:"方向键控制朝向(基于相机)"}),PlayerController.attributes.add("turnTimeSeconds",{type:"number",default:.8,title:"键盘转向时长(秒)"}),PlayerController.attributes.add("eventHz",{type:"number",default:10,title:"状态/速度广播频率(Hz)"}),PlayerController.attributes.add("yawEpsilonDeg",{type:"number",default:.1,title:"旋转更新阈值(度)"}),PlayerController.prototype._normalizeAngle=function(t){return(t=(t%360+360)%360)>180&&(t-=360),t},PlayerController.prototype._lerpAngle=function(t,e,i){t=this._normalizeAngle(t),e=this._normalizeAngle(e);var a=this._normalizeAngle(e-t);return this._normalizeAngle(t+a*Math.max(0,Math.min(1,i)))},PlayerController.prototype.initialize=function(){if(this.rigidbody=this.entity.rigidbody,this.rigidbody){var t=this.entity.render;t&&t.meshInstances&&t.meshInstances.forEach((t=>{var e=t.material&&t.material.clone();e&&(e.metalness=0,"roughness"in e&&(e.roughness=1),e.specular&&e.specular.set(0,0,0),"envIntensity"in e&&(e.envIntensity=0),e.useLighting=!1,e.emissive.set(1,1,1),e.update(),t.material=e)})),this.rigidbody.linearDamping=.2,this.rigidbody.angularDamping=1,this.rigidbody.angularFactor=new pc.Vec3(0,0,0),this.rigidbody.angularVelocity=new pc.Vec3(0,0,0),this.rigidbody.friction=.8,this._tmpVel=new pc.Vec3,this._tmpHoriz=new pc.Vec3,this._tmpDir=new pc.Vec3,this._tmpPos=new pc.Vec3,this._tmpStart=new pc.Vec3,this._tmpEnd=new pc.Vec3,this._input=new pc.Vec3,this.keys={w:!1,s:!1,a:!1,d:!1,shift:!1},this.isRunning=!1,this.isGrounded=!1,this.speedMagnitude=0,this.playerYaw=this._normalizeAngle(this.entity.getEulerAngles().y),this._lastAppliedYaw=this.playerYaw,this.actionState="Idle",this.mobileInput=new pc.Vec2(0,0),this.mobileMagnitude=0,this.mobileState="idle",this.app.keyboard.on(pc.EVENT_KEYDOWN,this.onKeyDown,this),this.app.keyboard.on(pc.EVENT_KEYUP,this.onKeyUp,this),this._bindMobileEvents(),this._evtInterval=1/Math.max(1,this.eventHz||10),this._evtTimer=0,this._prevActionState=null,this._groundInterval=1/Math.max(1,this.groundCheckHz||30),this._groundTimer=0;var e=this.app.scene&&this.app.scene.name||"",i="start"===e.toLowerCase()||"main"===e.toLowerCase();if(this.isSitting=i,this.actionState=i?"Sitting":"Idle",this.isClimbing=!1,this.climbableData=null,i)try{this.rigidbody.linearVelocity=new pc.Vec3(0,0,0),this.rigidbody.angularVelocity=new pc.Vec3(0,0,0),this.rigidbody.type=pc.BODYTYPE_STATIC,this.lockAction()}catch(t){console.error("[PlayerController] Failed to set sitting state:",t)}else try{this.rigidbody.type=pc.BODYTYPE_DYNAMIC,this.rigidbody.linearFactor=new pc.Vec3(1,1,1),this.actionEnabled=!0,setTimeout((function(){try{if("undefined"!=typeof GlobalCameraManager){var t=GlobalCameraManager.getInstance();t&&t.setState(GlobalCameraManager.CONTROL_STATES.FREE_FOLLOW)}else a.app.fire("ui:control:set","FREE_FOLLOW")}catch(t){console.warn("[PlayerController] Failed to set camera state:",t)}}),100)}catch(t){console.error("[PlayerController] Failed to set standing state:",t)}var a=this;this._onSetSitting=function(t){var e=a.isSitting;if(a.isSitting=!!t,console.log("[PlayerController] _onSetSitting called, flag:",t,"wasSitting:",e,"newSitting:",a.isSitting),a.isSitting!==e){if(a.isSitting){a.lockAction();try{a.rigidbody.linearVelocity=new pc.Vec3(0,0,0),a.rigidbody.angularVelocity=new pc.Vec3(0,0,0),a.rigidbody.type=pc.BODYTYPE_STATIC}catch(t){}a.actionState="Sitting",console.log("[PlayerController] Set to sitting, actionState:",a.actionState)}else{a.unlockAction();try{a.rigidbody.type=pc.BODYTYPE_DYNAMIC,a.rigidbody.linearFactor=new pc.Vec3(1,1,1),a.rigidbody.wakeUp()}catch(t){}a.actionState="Idle",console.log("[PlayerController] Set to standing, actionState:",a.actionState)}a.app.fire("player:is_sitting",a.isSitting),a.app.fire("player:actionState",a.actionState),a._queueEventNow()}},this.app.on("player:set_sitting",this._onSetSitting,this);a=this;this._onClimbableEnter=function(t){a.climbableData=t},this._onClimbableExit=function(){a.climbableData=null,a.isClimbing=!1,a._updateActionState()},this.app.on("climbable:enter",this._onClimbableEnter,this),this.app.on("climbable:exit",this._onClimbableExit,this),this._onLockAction=this.lockAction.bind(this),this._onUnlockAction=this.unlockAction.bind(this),this.app.on("player:lock_action",this._onLockAction,this),this.app.on("player:unlock_action",this._onUnlockAction,this),this.app.fire("player:is_sitting",this.isSitting),this.app.fire("player:actionState",this.actionState),this._queueEventNow()}else this.enabled=!1},PlayerController.prototype._bindMobileEvents=function(){var t=this;this._onJoystickMove=function(e){if(e){if("undefined"!=typeof UIManager){var i=UIManager.getInstance();if(i&&("typewriter"===i.currentState||"first_time_intro"===i.currentState))return void(t.enableDebugLog&&console.log("[PlayerController] Mobile joystick input ignored during UIManager animation state:",i.currentState))}t.mobileInput.set(e.x||0,e.y||0),t.mobileMagnitude=e.magnitude||0,t.mobileState=e.moveState||"idle"}},this.app.on("mobile:joystick:move",this._onJoystickMove,this),this._onMobileJump=function(){if("undefined"!=typeof UIManager){var e=UIManager.getInstance();if(e&&("typewriter"===e.currentState||"first_time_intro"===e.currentState))return void(t.enableDebugLog&&console.log("[PlayerController] Mobile jump ignored during UIManager animation state:",e.currentState))}t.jump()},this.app.on("mobile:jump",this._onMobileJump,this)},PlayerController.prototype.onKeyDown=function(t){if("undefined"!=typeof UIManager){var e=UIManager.getInstance();if(e&&("typewriter"===e.currentState||"first_time_intro"===e.currentState))return void(this.enableDebugLog&&console.log("[PlayerController] Key input ignored during UIManager animation state:",e.currentState,"key:",t.key))}switch(t.key){case pc.KEY_W:this.keys.w=!0;break;case pc.KEY_S:this.keys.s=!0;break;case pc.KEY_A:this.keys.a=!0;break;case pc.KEY_D:this.keys.d=!0;break;case pc.KEY_SPACE:this.jump();break;case pc.KEY_SHIFT:this.keys.shift=!0;break;case pc.KEY_ALT:if(document.exitPointerLock)try{document.exitPointerLock()}catch(t){}}},PlayerController.prototype.onKeyUp=function(t){if("undefined"!=typeof UIManager){var e=UIManager.getInstance();if(e&&("typewriter"===e.currentState||"first_time_intro"===e.currentState))return void(this.enableDebugLog&&console.log("[PlayerController] Key release ignored during UIManager animation state:",e.currentState,"key:",t.key))}switch(t.key){case pc.KEY_W:this.keys.w=!1;break;case pc.KEY_S:this.keys.s=!1;break;case pc.KEY_A:this.keys.a=!1;break;case pc.KEY_D:this.keys.d=!1;break;case pc.KEY_SHIFT:this.keys.shift=!1}},PlayerController.prototype.update=function(t){if(this.rigidbody){if(this.actionEnabled&&this.rigidbody.type!==pc.BODYTYPE_DYNAMIC)try{this.rigidbody.type=pc.BODYTYPE_DYNAMIC,this.rigidbody.linearFactor=new pc.Vec3(1,1,1),this.rigidbody.wakeUp()}catch(t){}if(this._groundTimer+=t,this._groundTimer>=this._groundInterval&&(this._groundTimer-=this._groundInterval,this._checkGrounded()),!this.isActionEnabled||!this.isActionEnabled()){var e=this.rigidbody.linearVelocity;return this.speedMagnitude=Math.sqrt(e.x*e.x+e.z*e.z),this.isRunning=!1,this.actionState=this.isSitting?"Sitting":"Idle",void this._broadcastThrottled(t)}var i=0,a=0,r=this.mobileMagnitude>.05;r?(i=this.mobileInput.x,a=this.mobileInput.y,this.isRunning="running"===this.mobileState||this.mobileMagnitude>.9):(a=(this.keys.w?1:0)+(this.keys.s?-1:0),i=(this.keys.d?1:0)+(this.keys.a?-1:0),this.invertForward&&(a=-a),this.invertRight&&(i=-i),a=Math.max(-1,Math.min(1,a)),i=Math.max(-1,Math.min(1,i)),this.isRunning=!!this.keys.shift),this._input.set(i,0,a);var n=this.app.keyboard.isPressed(pc[this.climbKey]||pc.KEY_F);this.climbableData&&n&&this.actionEnabled?this.isClimbing=!0:this.isClimbing=!1;var o=0!==i||0!==a,s=this.isRunning?this.runSpeed:this.walkSpeed;r&&this.mobileMagnitude>0&&(s*=this.mobileMagnitude);var l=this.rigidbody.linearVelocity.clone();if(this.isClimbing&&this.climbableData){var h=new pc.Vec3;if(Math.abs(i)>.05){var p=this._getCameraRight();h.add(p.mulScalar(i))}if(Math.abs(a)>.05){var c=this.climbableData.normal.clone().mulScalar(-1);h.add(c.mulScalar(a))}h.length()>.05?(h.normalize(),h.mulScalar(this.climbSpeed),l.set(h.x,h.y,h.z)):l.set(0,0,0),this.rigidbody.linearVelocity=l,this.speedMagnitude=h.length(),this.actionState="Climbing"}else{var d=this._getMoveDirFromYaw(0,-1,this._tmpDir);o||d.set(0,0,0);var y=d.x*(o?s:0),u=d.z*(o?s:0);this._tmpHoriz.set(l.x,0,l.z);var b=o?this.isGrounded?this.accel:this.accel*this.airControl:this.isGrounded?this.decel:this.decel*this.airControl,g=1-Math.exp(-b*t);this._tmpHoriz.x=this._tmpHoriz.x+(y-this._tmpHoriz.x)*g,this._tmpHoriz.z=this._tmpHoriz.z+(u-this._tmpHoriz.z)*g,l.set(this._tmpHoriz.x,l.y,this._tmpHoriz.z),this.rigidbody.linearVelocity=l,this.speedMagnitude=Math.sqrt(this._tmpHoriz.x*this._tmpHoriz.x+this._tmpHoriz.z*this._tmpHoriz.z)}if(this.turnWithKeys&&o){var m=this._getCameraYaw(),_=180*Math.atan2(-this._input.x,this._input.z)/Math.PI,f=this._normalizeAngle(m+_),C=Math.max(.001,this.turnTimeSeconds||.8),S=1-Math.exp(-t/C);this.playerYaw=this._lerpAngle(this.playerYaw,f,S)}this._applyYawOptimized();var v="Idle";this.isClimbing?v=o?Math.abs(i)>Math.abs(a)?i>0?"ClimbRight":"ClimbLeft":a>0?"ClimbUp":"ClimbDown":"ClimbIdle":o&&this.speedMagnitude>=.05&&(v=this.isRunning?"Runing":"Walk"),this.actionState=v,this._broadcastThrottled(t)}},PlayerController.prototype._checkGrounded=function(){var t=this.entity.getPosition();this._tmpStart.set(t.x,t.y+.5,t.z),this._tmpEnd.set(t.x,t.y-this.groundCheckDistance,t.z);var e=this.app.systems.rigidbody.raycastFirst(this._tmpStart,this._tmpEnd),i=!!e&&e.entity!==this.entity;!i&&e&&e.entity===this.entity&&(this._tmpStart.set(t.x,t.y+1,t.z),i=!!(e=this.app.systems.rigidbody.raycastFirst(this._tmpStart,this._tmpEnd))&&e.entity!==this.entity),this.isGrounded=i},PlayerController.prototype._getMoveDirFromYaw=function(t,e,i){var a=t,r=-e,n=this.playerYaw*Math.PI/180,o=Math.sin(n),s=Math.cos(n),l=s*a+o*r,h=-o*a+s*r;return i.set(l,0,h),i.lengthSq()>0&&i.normalize(),i},PlayerController.prototype.jump=function(){if("undefined"!=typeof GlobalCameraManager){var t=GlobalCameraManager.getInstance();if(t&&t.getState()===GlobalCameraManager.CONTROL_STATES.LOCKED_MULTI)return void t.setState(GlobalCameraManager.CONTROL_STATES.FREE_FOLLOW)}if(this.isActionEnabled&&this.isActionEnabled()&&this.isGrounded){var e=this.rigidbody.linearVelocity.clone();e.y=this.jumpSpeed,this.rigidbody.linearVelocity=e}},PlayerController.prototype.actionEnabled=!0,PlayerController.prototype.isActionEnabled=function(){return!!this.actionEnabled},PlayerController.prototype.lockAction=function(){this.actionEnabled=!1,this.app&&this.app.fire("player:action_locked")},PlayerController.prototype.unlockAction=function(){if(this.actionEnabled=!0,this.isSitting)this.app&&this.app.fire("player:action_unlocked");else{try{this.rigidbody&&this.rigidbody.wakeUp()}catch(t){}this.app&&this.app.fire("player:action_unlocked")}},PlayerController.prototype._getCameraYaw=function(){var t=this.playerYaw,e=this.cameraEntity;if(e){var i=e.script&&e.script.followCamera;i&&void 0!==i._yaw?t=i._yaw:e.getEulerAngles&&(t=e.getEulerAngles().y)}return this._normalizeAngle(t)},PlayerController.prototype._getCameraRight=function(){var t=this.cameraEntity;if(t)return t.right.clone();var e=this.playerYaw*pc.math.DEG_TO_RAD;return new pc.Vec3(Math.cos(e),0,-Math.sin(e))},PlayerController.prototype._applyYawOptimized=function(){var t=this.yawEpsilonDeg||.1;if(!(Math.abs(this._normalizeAngle(this.playerYaw-this._lastAppliedYaw))<t)){if(this.visualPivot)this.visualPivot.setEulerAngles(0,this.playerYaw,0);else{var e=new pc.Quat;e.setFromEulerAngles(0,this.playerYaw,0),this.rigidbody.teleport(this.entity.getPosition(),e)}this._lastAppliedYaw=this.playerYaw}},PlayerController.prototype._queueEventNow=function(){this._evtTimer=9999,this._broadcastThrottled(0)},PlayerController.prototype._broadcastThrottled=function(t){this._evtTimer+=t,this._evtTimer>=this._evtInterval&&(this._evtTimer=0,this._prevActionState!==this.actionState&&(this.app.fire("player:actionState",this.actionState),this._prevActionState=this.actionState),this.app.fire("player:speed",this.speedMagnitude),this.app.fire("player:is_grounded",this.isGrounded))},PlayerController.prototype.destroy=function(){this.app&&this.app.keyboard&&(this.app.keyboard.off(pc.EVENT_KEYDOWN,this.onKeyDown,this),this.app.keyboard.off(pc.EVENT_KEYUP,this.onKeyUp,this)),this.app&&this._onJoystickMove&&this.app.off("mobile:joystick:move",this._onJoystickMove,this),this.app&&this._onMobileJump&&this.app.off("mobile:jump",this._onMobileJump,this),this._onSetSitting&&this.app.off("player:set_sitting",this._onSetSitting,this),this._onLockAction&&this.app.off("player:lock_action",this._onLockAction,this),this._onUnlockAction&&this.app.off("player:unlock_action",this._onUnlockAction,this),this._onClimbableEnter&&this.app.off("climbable:enter",this._onClimbableEnter,this),this._onClimbableExit&&this.app.off("climbable:exit",this._onClimbableExit,this)};var FollowCamera=pc.createScript("followCamera");FollowCamera.attributes.add("targetEntity",{type:"entity",title:"目标实体"}),FollowCamera.attributes.add("offset",{type:"vec3",default:[0,2,0],title:"围绕锚点偏移(世界空间)"}),FollowCamera.attributes.add("smoothFactor",{type:"number",default:3,title:"平滑系数"}),FollowCamera.attributes.add("mouseSensitivity",{type:"number",default:.25,title:"鼠标灵敏度(°/像素)"}),FollowCamera.attributes.add("minPitch",{type:"number",default:-20,title:"最小俯仰(°)"}),FollowCamera.attributes.add("maxPitch",{type:"number",default:60,title:"最大俯仰(°)"}),FollowCamera.attributes.add("distance",{type:"number",default:4,title:"初始距离"}),FollowCamera.attributes.add("minDistance",{type:"number",default:.5,title:"最小距离"}),FollowCamera.attributes.add("maxDistance",{type:"number",default:8,title:"最大距离"}),FollowCamera.attributes.add("zoomSensitivity",{type:"number",default:.5,title:"滚轮缩放灵敏度"}),FollowCamera.attributes.add("initialYaw",{type:"number",default:0,title:"初始水平角(°)"}),FollowCamera.attributes.add("initialPitch",{type:"number",default:15,title:"初始俯仰(°)"}),FollowCamera.attributes.add("enableCollision",{type:"boolean",default:!0,title:"启用碰撞检测"}),FollowCamera.attributes.add("collisionMask",{type:"number",default:4294967295,title:"碰撞组过滤(按 collision.group 的位与)"}),FollowCamera.attributes.add("safetyDistance",{type:"number",default:.15,title:"安全间隙"}),FollowCamera.attributes.add("ignoreSelf",{type:"boolean",default:!0,title:"忽略目标自身碰撞"}),FollowCamera.attributes.add("fov",{type:"number",default:60,title:"FOV(°)"}),FollowCamera.attributes.add("enableDebugLog",{type:"boolean",default:!1,title:"启用调试日志"}),FollowCamera.attributes.add("enableTouchRotate",{type:"boolean",default:!0,title:"启用触摸旋转"}),FollowCamera.attributes.add("touchZone",{type:"string",default:"right",title:"触摸区域: right | full"}),FollowCamera.attributes.add("touchDeadZone",{type:"number",default:2,title:"触摸死区(像素，防误触)"}),FollowCamera.attributes.add("touchSensitivityScale",{type:"number",default:1,title:"触摸灵敏度缩放(相对鼠标)"}),FollowCamera.prototype.initialize=function(){this._yaw=this.initialYaw,this._pitch=this.initialPitch,this._distance=this.distance,this._smoothedDx=0,this._smoothedDy=0,this._touchSmoothFactor=.3,this.canvas=this.app.graphicsDevice.canvas,this._pointerLocked=!1,this._onPointerLockChange=()=>{this._pointerLocked=document.pointerLockElement===this.canvas},document.addEventListener("pointerlockchange",this._onPointerLockChange),this._sensitivityMultiplier=1,this._invertY=!1,this._loadMouseSettings(),this._onMouseSensitivityChanged=t=>{t&&"number"==typeof t.sensitivity&&(this._sensitivityMultiplier=t.sensitivity,this.enableDebugLog&&console.log("[FollowCamera] Mouse sensitivity changed to:",this._sensitivityMultiplier))},this.app.on("input:mouse_sensitivity:changed",this._onMouseSensitivityChanged,this),this._onInvertYChanged=t=>{t&&"boolean"==typeof t.inverted&&(this._invertY=t.inverted,this.enableDebugLog&&console.log("[FollowCamera] Invert Y changed to:",this._invertY))},this.app.on("input:invert_y:changed",this._onInvertYChanged,this),this._isEnabled=!1,this._dialogueMode=!1,this._dialogueCenterYaw=0,this._dialogueCenterPitch=0,this._dialogueYawRange=40,this._dialoguePitchRange=30,this.app.mouse&&(this.app.mouse.on(pc.EVENT_MOUSEDOWN,this.onMouseDown,this),this.app.mouse.on(pc.EVENT_MOUSEMOVE,this.onMouseMove,this),this.app.mouse.on(pc.EVENT_MOUSEWHEEL,this.onMouseWheel,this)),this._onUiControlChanged=t=>{var i=t&&t.to;if(this._currentControl=i,"free_follow"===i)this._dialogueMode=!1,this.enable();else if("dialogue"===i){this._dialogueMode=!0,this._syncDialogueRanges(),this._captureDialogueCenter(),this._isEnabled=!0;try{document.exitPointerLock&&document.exitPointerLock()}catch(t){}this._pointerLocked=!1}else this._dialogueMode=!1,this.disable()},this.app.on("ui:control_state_changed",this._onUiControlChanged,this),this._onDialogueBegin=t=>{this._dialogueMode=!0,this._syncDialogueRanges(),this._captureDialogueCenter(),this._isEnabled=!0},this._onDialogueEnd=()=>{this._dialogueMode=!1},this.app.on("ui:dialogue:begin",this._onDialogueBegin,this),this.app.on("ui:dialogue:end",this._onDialogueEnd,this),this._onMobileCameraRotate=t=>{this._isEnabled?t&&(t.dx||t.dy)&&(this._smoothedDx=this._smoothedDx*(1-this._touchSmoothFactor)+(t.dx||0)*this._touchSmoothFactor,this._smoothedDy=this._smoothedDy*(1-this._touchSmoothFactor)+(t.dy||0)*this._touchSmoothFactor,this.enableDebugLog&&console.log("[FollowCamera] Mobile rotate:",t.dx,t.dy,"smoothed:",this._smoothedDx.toFixed(2),this._smoothedDy.toFixed(2)),this._applyRotation(this._smoothedDx,-this._smoothedDy)):this.enableDebugLog&&console.log("[FollowCamera] Mobile rotate ignored: not enabled")},this.app.on("mobile:camera:rotate",this._onMobileCameraRotate,this),this._vOffset=new pc.Vec3,this._anchor=new pc.Vec3,this._ideal=new pc.Vec3,this._final=new pc.Vec3,this._dir=new pc.Vec3,this._safe=new pc.Vec3,this._touchRotId=null,this._touchLastX=0,this._touchLastY=0,this.app.touch&&this.enableTouchRotate&&(this._onTouchStart=this._handleTouchStart.bind(this),this._onTouchMove=this._handleTouchMove.bind(this),this._onTouchEnd=this._handleTouchEnd.bind(this),this.app.touch.on(pc.EVENT_TOUCHSTART,this._onTouchStart,this),this.app.touch.on(pc.EVENT_TOUCHMOVE,this._onTouchMove,this),this.app.touch.on(pc.EVENT_TOUCHEND,this._onTouchEnd,this),this.app.touch.on(pc.EVENT_TOUCHCANCEL,this._onTouchEnd,this)),this._currentDistance=this._distance,this.enableDebugLog&&console.log("[FollowCamera] 基于射线的碰撞检测已启用"),this.entity.camera&&(this.entity.camera.fov=this.fov)},FollowCamera.prototype.update=function(t){if(this._isEnabled&&this.targetEntity){var i=this._yaw*Math.PI/180,e=this._pitch*Math.PI/180,o=Math.cos(e),a=Math.sin(e),s=Math.sin(i),n=Math.cos(i),h=this._currentDistance;if(this._vOffset.set(h*s*o,h*a,h*n*o),this._anchor.copy(this.targetEntity.getPosition()).add(this.offset),this._ideal.copy(this._anchor).add(this._vOffset),this.enableCollision){var l=this._raycastSafeDistance(this._anchor,this._ideal,this._distance);if(l<this._distance-.01){var r=5*this.smoothFactor;this._currentDistance=pc.math.lerp(this._currentDistance,l,Math.min(1,r*t))}else{var c=2*this.smoothFactor;this._currentDistance=pc.math.lerp(this._currentDistance,this._distance,Math.min(1,c*t))}this._vOffset.set(this._currentDistance*s*o,this._currentDistance*a,this._currentDistance*n*o),this._final.copy(this._anchor).add(this._vOffset)}else this._currentDistance=this._distance,this._final.copy(this._ideal);var u=this.entity.getPosition(),d=1-Math.exp(-this.smoothFactor*t);d=Math.min(1,d),u.lerp(u,this._final,d),this.entity.setPosition(u),this.entity.lookAt(this._anchor),this.entity.camera&&this.entity.camera.fov!==this.fov&&(this.entity.camera.fov=this.fov)}},FollowCamera.prototype.enable=function(){this._isEnabled=!0},FollowCamera.prototype.disable=function(){this._isEnabled=!1;try{document.exitPointerLock&&document.exitPointerLock()}catch(t){}this._pointerLocked=!1},FollowCamera.prototype._raycastSafeDistance=function(t,i,e){if(!this.app.systems||!this.app.systems.rigidbody)return e;var o=this._dir.copy(i).sub(t),a=o.length();if(a<=1e-4)return e;o.scale(1/a);var s=this.app.systems.rigidbody.raycastFirst(t,i);if(s){var n=s.entity;if(this.ignoreSelf&&this._isInSubtree(n,this.targetEntity))return e;var h=s.point.distance(t),l=Math.max(this.minDistance,h-this.safetyDistance);return this.enableDebugLog&&console.log("[FollowCamera] 射线检测:",n.name,"碰撞距离:",h.toFixed(2),"安全距离:",l.toFixed(2)),l}return e},FollowCamera.prototype._computeCollisionSafePosition=function(t,i,e){if(e.copy(i),this.app.systems&&this.app.systems.rigidbody){var o=[],a=this._dir.copy(i).sub(t),s=a.length();if(!(s<=1e-4)){a.scale(1/s);var n=this._tmpFrom||(this._tmpFrom=new pc.Vec3),h=this._tmpTo||(this._tmpTo=new pc.Vec3);n.copy(t).add(a.clone().scale(.06)),h.copy(i).sub(a.clone().scale(Math.min(.06,.5*s)));var l=null,r=1/0,pickNearest=(t,i,e)=>{for(var o=0;o<t.length;o++){var a=t[o],s=a.entity;if((!this.ignoreSelf||!this._isInSubtree(s,this.targetEntity))&&(s.collision&&s.collision.enabled)){if(null!=this.collisionMask&&4294967295!==this.collisionMask)if(0==((s.collision.group||0)&this.collisionMask))continue;var n=a.point||a.hitPoint;if(n){var h=n.distance(i);h<r&&(r=h,l=n)}}}};if(o.length=0,this.app.systems.rigidbody.raycastAll(n,h,o),pickNearest(o,n),o.length=0,this.app.systems.rigidbody.raycastAll(h,n,o),pickNearest(o,h),l){var c=this._safe.copy(l).sub(a.clone().scale(this.safetyDistance));if(c.distance(t)<this.minDistance){var u=c.clone().sub(t).normalize();c.copy(t).add(u.scale(this.minDistance))}e.copy(c)}}}},FollowCamera.prototype._isInSubtree=function(t,i){for(var e=t;e;){if(e===i)return!0;e=e.parent}return!1},FollowCamera.prototype.onMouseDown=function(t){if(this._isEnabled&&!this._dialogueMode&&"free_follow"===this._currentControl&&t.button===pc.MOUSEBUTTON_LEFT&&this.canvas&&this.canvas.requestPointerLock)try{this.canvas.requestPointerLock()}catch(t){"SecurityError"!==t.name&&console.warn("[FollowCamera] requestPointerLock failed:",t)}},FollowCamera.prototype._loadMouseSettings=function(){try{if("undefined"!=typeof GameManager&&GameManager.getInstance){var t=GameManager.getInstance();if(t&&t.getSettings){var i=t.getSettings();i&&(this._sensitivityMultiplier=i.mouseSensitivity||1,this._invertY=i.invertY||!1,this.enableDebugLog&&console.log("[FollowCamera] Loaded settings - sensitivity:",this._sensitivityMultiplier,"invertY:",this._invertY))}}}catch(t){console.warn("[FollowCamera] Failed to load mouse settings:",t)}},FollowCamera.prototype._applyRotation=function(t,i){var e=this.mouseSensitivity*(this._sensitivityMultiplier||1),o=this._invertY?-i:i;if(this._dialogueMode){this._yaw-=t*e,this._pitch-=o*e;var a=this._normalizeAngle(this._yaw),s=this._normalizeAngle(this._dialogueCenterYaw),n=this._shortestAngleDelta(s,a);n=pc.math.clamp(n,-this._dialogueYawRange,this._dialogueYawRange),this._yaw=this._normalizeAngle(s+n);var h=this._dialogueCenterPitch,l=this._pitch-h;return l=pc.math.clamp(l,-this._dialoguePitchRange,this._dialoguePitchRange),void(this._pitch=pc.math.clamp(h+l,this.minPitch,this.maxPitch))}this._yaw-=t*e,this._pitch-=o*e,this._yaw=(this._yaw%360+360)%360,this._yaw>180&&(this._yaw-=360),this._pitch=Math.max(this.minPitch,Math.min(this.maxPitch,this._pitch))},FollowCamera.prototype.onMouseMove=function(t){this._isEnabled&&(this._dialogueMode||this._pointerLocked)&&this._applyRotation(t.dx,t.dy)},FollowCamera.prototype.onMouseWheel=function(t){if(this._isEnabled){var i=.01*(t.wheelDelta?-t.wheelDelta:t.deltaY)*this.zoomSensitivity;this._distance=pc.math.clamp(this._distance+i,this.minDistance,this.maxDistance)}},FollowCamera.prototype.destroy=function(){this.app&&this.app.mouse&&(this.app.mouse.off(pc.EVENT_MOUSEDOWN,this.onMouseDown,this),this.app.mouse.off(pc.EVENT_MOUSEMOVE,this.onMouseMove,this),this.app.mouse.off(pc.EVENT_MOUSEWHEEL,this.onMouseWheel,this)),this.app&&this._onMobileCameraRotate&&this.app.off("mobile:camera:rotate",this._onMobileCameraRotate,this),this.app&&this.app.touch&&(this._onTouchStart&&this.app.touch.off(pc.EVENT_TOUCHSTART,this._onTouchStart,this),this._onTouchMove&&this.app.touch.off(pc.EVENT_TOUCHMOVE,this._onTouchMove,this),this._onTouchEnd&&this.app.touch.off(pc.EVENT_TOUCHEND,this._onTouchEnd,this),this._onTouchEnd&&this.app.touch.off(pc.EVENT_TOUCHCANCEL,this._onTouchEnd,this)),this.app&&this._onUiControlChanged&&(this.app.off("ui:control_state_changed",this._onUiControlChanged,this),this._onUiControlChanged=null),this.app&&this._onDialogueBegin&&(this.app.off("ui:dialogue:begin",this._onDialogueBegin,this),this._onDialogueBegin=null),this.app&&this._onMouseSensitivityChanged&&(this.app.off("input:mouse_sensitivity:changed",this._onMouseSensitivityChanged,this),this._onMouseSensitivityChanged=null),this.app&&this._onInvertYChanged&&(this.app.off("input:invert_y:changed",this._onInvertYChanged,this),this._onInvertYChanged=null),this.app&&this._onDialogueEnd&&(this.app.off("ui:dialogue:end",this._onDialogueEnd,this),this._onDialogueEnd=null),this._onPointerLockChange&&(document.removeEventListener("pointerlockchange",this._onPointerLockChange),this._onPointerLockChange=null)},FollowCamera.prototype._isTouchInRotateZone=function(t){if("full"===this.touchZone)return!0;var i=this.app.graphicsDevice.canvas,e=i.clientWidth?i.clientWidth/2:i.width/2;return t.x>=e},FollowCamera.prototype._handleTouchStart=function(t){if(this._isEnabled)for(var i=t.touches,e=0;e<i.length;e++){var o=i[e];if(null==this._touchRotId&&this._isTouchInRotateZone(o)){this._touchRotId=o.id,this._touchLastX=o.x,this._touchLastY=o.y,t.event&&t.event.preventDefault&&t.event.preventDefault();break}}},FollowCamera.prototype._handleTouchMove=function(t){if(this._isEnabled&&null!=this._touchRotId)for(var i=t.touches,e=0;e<i.length;e++){var o=i[e];if(o.id===this._touchRotId){var a=o.x-this._touchLastX,s=o.y-this._touchLastY,n=this.touchDeadZone||0;if(Math.abs(a)<n&&(a=0),Math.abs(s)<n&&(s=0),0!==a||0!==s){var h=this.touchSensitivityScale||1;this._applyRotation(a*h,-s*h)}this._touchLastX=o.x,this._touchLastY=o.y,t.event&&t.event.preventDefault&&t.event.preventDefault();break}}},FollowCamera.prototype._handleTouchEnd=function(t){if(null!=this._touchRotId)for(var i=t.changedTouches||t.touches||[],e=0;e<i.length;e++)if(i[e].id===this._touchRotId){this._touchRotId=null,t.event&&t.event.preventDefault&&t.event.preventDefault();break}},FollowCamera.prototype._normalizeAngle=function(t){return(t=(t%360+360)%360)>180&&(t-=360),t},FollowCamera.prototype._shortestAngleDelta=function(t,i){var e=this._normalizeAngle(i)-this._normalizeAngle(t);return e=(e+540)%360-180},FollowCamera.prototype._captureDialogueCenter=function(){this._dialogueCenterYaw=this._normalizeAngle(this._yaw),this._dialogueCenterPitch=this._pitch},FollowCamera.prototype._syncDialogueRanges=function(){try{var t="undefined"!=typeof UIManager?UIManager.getInstance&&UIManager.getInstance():null;t&&("number"==typeof t.dialogueYawRange&&(this._dialogueYawRange=Math.max(0,0|t.dialogueYawRange)),"number"==typeof t.dialoguePitchRange&&(this._dialoguePitchRange=Math.max(0,0|t.dialoguePitchRange)))}catch(t){}};var PlayerAnimator=pc.createScript("playerAnimator");PlayerAnimator.attributes.add("hips",{type:"entity",title:"Hips (has anim)"}),PlayerAnimator.attributes.add("layerName",{type:"string",default:"Base Layer",title:"Anim Layer"}),PlayerAnimator.attributes.add("useParameters",{type:"boolean",default:!0,title:"Use Parameters"}),PlayerAnimator.attributes.add("paramSpeed",{type:"string",default:"Speed"}),PlayerAnimator.attributes.add("paramIsMoving",{type:"string",default:"IsMoving"}),PlayerAnimator.attributes.add("paramIsRunning",{type:"string",default:"IsRunning"}),PlayerAnimator.attributes.add("paramIsSitting",{type:"string",default:"IsSitting",title:"Param IsSitting"}),PlayerAnimator.prototype.initialize=function(){if(this.animEntity=this.hips||this.entity,this.anim=this.animEntity.anim,this._smoothSpeed=0,this._lastSpeed=0,this._smoothing=8,!this.anim)return console.error("[PlayerAnimator] Missing anim on Hips / entity"),void(this.enabled=!1);this.app.on("player:actionState",this.onActionState,this),this.app.on("player:speed",this.onSpeed,this),this.app.on("player:is_sitting",this.onSitting,this),this.useParameters&&(this.paramSpeed&&this.anim.setFloat(this.paramSpeed,0),this.paramIsMoving&&this.anim.setBoolean(this.paramIsMoving,!1),this.paramIsRunning&&this.anim.setBoolean(this.paramIsRunning,!1),this.paramIsSitting&&this.anim.setBoolean(this.paramIsSitting,!1))},PlayerAnimator.prototype.update=function(t){if(this.anim){var i=Math.min(1,Math.max(0,t*this._smoothing));this._smoothSpeed+=(this._lastSpeed-this._smoothSpeed)*i,this.useParameters&&this.paramSpeed&&this.anim.setFloat(this.paramSpeed,this._smoothSpeed)}},PlayerAnimator.prototype.destroy=function(){this.app.off("player:actionState",this.onActionState,this),this.app.off("player:speed",this.onSpeed,this),this.app.off("player:is_sitting",this.onSitting,this)},PlayerAnimator.prototype.onSpeed=function(t){this._lastSpeed=Math.max(0,t||0)},PlayerAnimator.prototype.onActionState=function(t){if(this.anim&&this.useParameters){var i="Walk"===t||"Runing"===t;return this.paramIsMoving&&this.anim.setBoolean(this.paramIsMoving,i),this.paramIsRunning&&this.anim.setBoolean(this.paramIsRunning,"Runing"===t),void(this.paramIsSitting&&this.anim.setBoolean(this.paramIsSitting,"Sitting"===t))}},PlayerAnimator.prototype.onSitting=function(t){this.anim&&this.useParameters&&this.paramIsSitting&&this.anim.setBoolean(this.paramIsSitting,!!t)};!function(e){"use strict";function nowMs(){return"undefined"!=typeof performance&&performance.now?performance.now():Date.now()}var t={STATES:{LOADING:"loading",MAIN_MENU:"main_menu",LEVEL_SELECT:"level_select",LEVEL:"level",FREE_WORLD:"free_world",PAUSED:"paused",GAME_OVER:"game_over",SETTINGS:"settings",START:"start",LEVEL1:"level1",LEVEL2:"level2",LEVEL3:"level3",LEVEL4:"level4",IN_ROOM_QUIET:"inRoomQuiet",IN_ROOM_ECHOING:"InRoomEchoing",VILLAGE:"village",NYMPH_QUEEN:"nymphQueen"},app:null,device:function detectDevice(){var e=("undefined"!=typeof navigator?navigator.userAgent:"")||"",t="undefined"!=typeof window&&("ontouchstart"in window||navigator.maxTouchPoints>0),o=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(e)||t&&screen&&Math.min(screen.width,screen.height)<=820;return{isMobile:!!o,isDesktop:!o,userAgent:e}}(),debug:!1,defaultState:"main_menu",_currentLocale:null,_current:null,_previous:null,_stateStart:0,_transitioning:!1,_currentScene:null,_cb:{enter:{},exit:{},update:{}},_unsub:[],_prologueVisited:{},_playerSettings:{},_checkpointPosition:null,_prologuePlayHistory:{},_sceneCheckpoints:{},currentScene:null,init(e,t){if(!this.app){this.app=e,t=t||{},this.debug=!!(t.debug??1),this.defaultState=t.defaultState||this.defaultState,this.debug&&console.log("[GlobalGame] init; device:",this.device.isMobile?"mobile":"desktop",this.device.userAgent);try{this.app.fire("player:set_sitting",!0),this.app.fire("ui:control:set","LOCKED_MULTI"),this.debug&&console.log("[GlobalGame] Set player sitting and camera locked on boot")}catch(e){}this._registerDefaultHandlers(),this._loadPlayerSettings();var o="undefined"!=typeof navigator?navigator.language||navigator.languages&&navigator.languages[0]:null,a=this._detectLocale();if(this._currentLocale=a,this.debug&&(console.log("[GlobalGame] ===== Language Detection (Session Only) ====="),console.log("[GlobalGame] Browser language:",o),console.log("[GlobalGame] Detected locale:",a),console.log("[GlobalGame] Note: Language is not persisted, resets on page refresh"),console.log("[GlobalGame] ===================================================")),this._loadPrologueVisited(),this._loadProloguePlayHistory(),"undefined"!=typeof I18n&&I18n.init){I18n.init(this.app);var l="zh-CN"===a?"en-US":"zh-CN";this.changeState(this.STATES.LOADING),this._loadPrologueForLocale(a,l)}else this.changeState(this.defaultState);this._setupGlobalEvents(),this._setupSceneEvents(),this._setupMobileFullscreen(),this._initializeAudioSystem()}},_initializeAudioSystem(){if("undefined"==typeof GlobalAudioSceneConfig)return console.error("[GlobalGame] GlobalAudioSceneConfig未定义"),console.error("[GlobalGame] 请确保以下脚本已加载："),console.error("[GlobalGame]   - audio-settings-global.js"),console.error("[GlobalGame]   - audio-bgm-global.js"),console.error("[GlobalGame]   - audio-sfx-global.js"),void console.error("[GlobalGame]   - audio-scene-config-global.js");var e=this.app.assets.find("audio-config.json","json");e||console.warn("[GlobalGame] 未找到audio-config.json，音频系统将使用空配置");try{GlobalAudioSceneConfig.initialize(this.app,{configAsset:e,poolSize2D:8,poolSize3D:16,storageKey:"game.audio.v1",enableDebugLog:this.debug}),this.debug&&(console.log("[GlobalGame] ========================================"),console.log("[GlobalGame] ✓ 全局音频系统初始化完成"),console.log("[GlobalGame] ========================================"))}catch(e){console.error("[GlobalGame] 音频系统初始化失败:",e)}},_setupMobileFullscreen(){if(this.device.isMobile){var e=this,t=this.app.graphicsDevice.canvas,lockLandscape=function(){try{screen.orientation&&screen.orientation.lock?screen.orientation.lock("landscape").then((function(){e.debug&&console.log("[GlobalGame] 屏幕已锁定为横屏模式")})).catch((function(t){e.debug&&console.warn("[GlobalGame] 横屏锁定失败:",t.message)})):screen.lockOrientation?(screen.lockOrientation("landscape")||screen.lockOrientation("landscape-primary"))&&e.debug&&console.log("[GlobalGame] 屏幕已锁定为横屏模式（旧版API）"):screen.webkitLockOrientation?(screen.webkitLockOrientation("landscape"),e.debug&&console.log("[GlobalGame] 屏幕已锁定为横屏模式（webkit）")):screen.mozLockOrientation?(screen.mozLockOrientation("landscape"),e.debug&&console.log("[GlobalGame] 屏幕已锁定为横屏模式（moz）")):e.debug&&console.log("[GlobalGame] 浏览器不支持屏幕方向锁定，使用 CSS 提示")}catch(t){e.debug&&console.warn("[GlobalGame] 横屏锁定异常:",t)}};if(!document.querySelector('meta[name="viewport"]')){var o=document.createElement("meta");o.name="viewport",o.content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover",document.head.appendChild(o)}document.body.style.margin="0",document.body.style.padding="0",document.body.style.overflow="hidden",document.body.style.position="fixed",document.body.style.width="100%",document.body.style.height="100%";if(document.addEventListener("touchend",(function(o){setTimeout((function(){!function(){try{t.requestFullscreen?t.requestFullscreen():t.webkitRequestFullscreen?t.webkitRequestFullscreen():t.mozRequestFullScreen?t.mozRequestFullScreen():t.msRequestFullscreen&&t.msRequestFullscreen(),e.debug&&console.log("[GlobalGame] Fullscreen requested"),setTimeout(lockLandscape,200)}catch(t){e.debug&&console.warn("[GlobalGame] Fullscreen failed:",t)}}()}),100)}),{once:!0,passive:!0}),setTimeout((function(){lockLandscape()}),500),window.matchMedia){var a=window.matchMedia("(orientation: portrait)"),handleOrientationChange=function(t){t.matches?(e.debug&&console.log("[GlobalGame] 检测到竖屏，建议旋转到横屏"),e.app.fire("mobile:orientation:portrait")):(e.debug&&console.log("[GlobalGame] 检测到横屏"),e.app.fire("mobile:orientation:landscape"))};a.addListener(handleOrientationChange),handleOrientationChange(a)}this.debug&&console.log("[GlobalGame] Mobile fullscreen setup complete")}},_setupSceneEvents(){var e=this;this.app.on("start",(function(){console.log("[GlobalGame] ========== App started =========="),console.log("[GlobalGame] 开始检测当前场景...");var t=e._detectCurrentScene();console.log("[GlobalGame] 场景检测结果:",t),t||(console.log("[GlobalGame] 未检测到场景，使用默认场景: start"),t="start"),console.log("[GlobalGame] 最终场景名:",t),console.log("[GlobalGame] 准备调用 setCurrentScene..."),setTimeout((function(){console.log("[GlobalGame] 延迟触发场景音频播放"),e.setCurrentScene(t,!0)}),100),console.log("[GlobalGame] ==========================================")})),this.debug&&console.log("[GlobalGame] Scene events setup complete")},_detectCurrentScene(){try{if("undefined"!=typeof window&&window.location){var e=window.location.href.match(/scene[=\/]([^&\/\?]+)/i);if(e)return e[1]}if(this.app&&this.app.scene&&this.app.scene.name)return this.app.scene.name;if(this.app&&this.app.root)for(var t=["Level1","Level2","Level3","Level4","Start","Main","Village"],o=0;o<t.length;o++)if(this.app.root.findByName(t[o]))return t[o].toLowerCase();return null}catch(e){return this.debug&&console.warn("[GlobalGame] Failed to detect current scene:",e),null}},destroy(){if(this.app){for(var e=0;e<this._unsub.length;e++){var t=this._unsub[e];try{t.target.off(t.event,t.fn,t.scope)}catch(e){}}this._unsub.length=0,this.app=null,this.debug&&console.log("[GlobalGame] destroyed")}},changeState(e,t){this.app&&(this._transitioning?this.debug&&console.warn("[GlobalGame] transition in progress"):this._isValidState(e)?this._current!==e?(this._transitioning=!0,this._previous=this._current,this.app.fire("gamestate:before_change",{from:this._previous,to:e,data:t}),this._current&&this._exit(this._current),this._current=e,this._stateStart=nowMs(),this._enter(e,t),this._transitioning=!1,this.app.fire("gamestate:changed",{from:this._previous,to:this._current,data:t}),this.debug&&console.log("[GlobalGame] state:",this._previous,"->",this._current)):this.debug&&console.log("[GlobalGame] already in",e):console.error("[GlobalGame] invalid state",e))},getCurrentState(){return this._current},getPreviousState(){return this._previous},isInState(e){return this._current===e},getCurrentScene(){return this._currentScene},setCurrentScene(e,t){console.log("[GlobalGame] ========== setCurrentScene 被调用 =========="),console.log("[GlobalGame] 场景名称:",e),console.log("[GlobalGame] 跳过初始化:",t);var o=this,a=this._currentScene;if(a&&a!==e){if(console.log("[GlobalGame] 检测到场景切换:",a,"→",e),console.log("[GlobalGame] 开始清理旧场景音频..."),this.app.fire("sfx:stopAll"),console.log("[GlobalGame] 所有SFX已停止"),!t)return console.log("[GlobalGame] 开始淡出BGM..."),this.app.fire("bgm:stop",{fadeOut:.3}),this.app.fire("audio:scene:stop"),void setTimeout((function(){console.log("[GlobalGame] 音频淡出完成，继续场景切换"),o._continueSceneChange(e,t)}),350);console.log("[GlobalGame] skipInitialization=true，SFX已清理，立即继续")}this._continueSceneChange(e,t)},_continueSceneChange(e,t){if(console.log("[GlobalGame] ========== 继续场景切换 =========="),console.log("[GlobalGame] 场景名称:",e),this._currentScene=e,console.log("[GlobalGame] _currentScene 已设置为:",this._currentScene),console.log("[GlobalGame] 准备播放场景音频..."),this._playSceneAudio(e),t)return console.log("[GlobalGame] skipInitialization=true，只设置存档点"),this._autoSetLatestCheckpoint(e),(!e||"start"===e.toLowerCase()||"main"===e.toLowerCase())&&console.log("[GlobalGame] Start场景 - 玩家和相机状态由UIManager控制，不在此改变"),void console.log("[GlobalGame] ================================================");console.log("[GlobalGame] 执行完整场景初始化..."),this._cleanupInteractableEvents(),this._resetPlayerOnSceneChange(),this._autoSetLatestCheckpoint(e),this._checkGardenTeleport()||this._loadAndApplySpawnPoint(e)},_playSceneAudio(e){if(console.log("[GlobalGame] ========== _playSceneAudio 被调用 =========="),console.log("[GlobalGame] 场景名称:",e),!e)return console.warn("[GlobalGame] 场景名称为空，取消音频播放"),void console.log("[GlobalGame] =============================================");var t={sceneName:e,forceReplay:!1};console.log("[GlobalGame] 准备触发 audio:scene:play 事件"),console.log("[GlobalGame] 事件数据:",t),this.app.fire("audio:scene:play",t),console.log("[GlobalGame] audio:scene:play 事件已触发"),console.log("[GlobalGame] 场景:",e),console.log("[GlobalGame] =============================================")},_autoSetLatestCheckpoint(e){if(e){var t=this;setTimeout((function(){try{var o="echoSoul_currentCheckpoint_"+e,a=null;try{var l=localStorage.getItem(o);l&&(a=JSON.parse(l))}catch(e){t.debug&&console.warn("[GlobalGame] Failed to load checkpoint from localStorage:",e)}a&&a.position?(t.setCheckpoint(a.position,a.id,a.additionalData),t.debug&&(console.log("[GlobalGame] Auto-set checkpoint for scene",e+":",a.id),console.log("[GlobalGame] Checkpoint position:",a.position))):t.debug&&console.log("[GlobalGame] No saved checkpoint found for scene:",e)}catch(e){t.debug&&console.error("[GlobalGame] Failed to auto-set checkpoint:",e)}}),500)}},saveCurrentSceneCheckpoint(e,t,o){var a=this._currentScene;if(a&&e)try{var l={id:t||"checkpoint_"+Date.now(),position:{x:e.x,y:e.y,z:e.z},additionalData:o||{},timestamp:Date.now(),sceneName:a},n="echoSoul_currentCheckpoint_"+a;localStorage.setItem(n,JSON.stringify(l)),this.setCheckpoint(e,t,o),this.debug&&(console.log("[GlobalGame] Saved checkpoint for scene",a+":",t),console.log("[GlobalGame] Position:",e)),this.app.fire("checkpoint:saved",{sceneName:a,checkpointId:t,position:e})}catch(e){this.debug&&console.error("[GlobalGame] Failed to save checkpoint:",e)}},_spawnPointsData:null,_loadAndApplySpawnPoint(e){if(e){var t=this;this._spawnPointsData?this._applySpawnPoint(e):this._loadSpawnPointsData((function(o){o&&t._applySpawnPoint(e)}))}},_loadSpawnPointsData(e){this.debug&&console.log("[GlobalGame] 使用默认出生点配置，跳过外部文件加载"),this._spawnPointsData=this._getDefaultSpawnPoints(),e&&e(!0)},_getDefaultSpawnPoints:()=>({start:{x:0,y:0,z:0},main:{x:0,y:0,z:0},level1:{x:-2,y:0,z:5},level2:{x:3,y:0,z:-2},level3:{x:0,y:0,z:8},level4:{x:-5,y:0,z:0},inRoomQuiet:{x:0,y:0,z:3},InRoomEchoing:{x:2,y:0,z:0},village:{x:-3,y:0,z:4},nymphQueen:{x:0,y:0,z:-3}}),_applySpawnPoint(e){if(this._spawnPointsData&&e){var t=this._spawnPointsData[e.toLowerCase()];if(t){console.log("[GlobalGame] Applying spawn point for scene",e,":",t);var o=this;setTimeout((function(){o._teleportPlayer(t)}),200)}else console.warn("[GlobalGame] No spawn point found for scene:",e)}},_teleportPlayer(e){if(e&&this.app)try{var t=this._findPlayerEntity();if(!t)return void console.warn("[GlobalGame] Player entity not found for teleport");this._resetPlayerState(t);var o=new pc.Vec3(e.x,e.y,e.z);t.rigidbody?t.rigidbody.teleport(o,t.getRotation()):t.setPosition(o),console.log("[GlobalGame] Player teleported to:",o),this.app.fire("player:teleported",{position:o,scene:this._currentScene})}catch(e){console.error("[GlobalGame] Failed to teleport player:",e)}},_findPlayerEntity(){var e=this.app.root.findByName("Player");if(!e)for(var t=["player","PlayerController","Character","MainCharacter"],o=0;o<t.length&&!(e=this.app.root.findByName(t[o]));o++);return e},_resetPlayerState(e){if(e)try{e.enabled=!0,e.getLocalScale().length()<.1&&e.setLocalScale(1,1,1),e.render&&(e.render.enabled=!0),this._resetChildrenState(e),e.rigidbody&&(e.rigidbody.enabled=!0,e.rigidbody.linearVelocity=pc.Vec3.ZERO,e.rigidbody.angularVelocity=pc.Vec3.ZERO),e.collision&&(e.collision.enabled=!0),this.debug&&console.log("[GlobalGame] Player state reset completed")}catch(e){console.error("[GlobalGame] Failed to reset player state:",e)}},_resetChildrenState(e){if(e&&e.children)for(var t=0;t<e.children.length;t++){var o=e.children[t];o&&(o.enabled=!0,o.getLocalScale().length()<.1&&o.setLocalScale(1,1,1),o.render&&(o.render.enabled=!0),this._resetChildrenState(o))}},_resetPlayerOnSceneChange(){try{var e=this._findPlayerEntity();if(e){this.debug&&console.log("[GlobalGame] Resetting player state on scene change");var t=this;setTimeout((function(){t._resetPlayerState(e),t._performSceneChangeReset(e)}),100)}else this.debug&&console.warn("[GlobalGame] Player not found during scene change reset")}catch(e){console.error("[GlobalGame] Error during scene change player reset:",e)}},_performSceneChangeReset(e){if(e)try{var t=e.script;if(t){if(t.playerController){var o=t.playerController;void 0!==o.enabled&&(o.enabled=!0),void 0!==o.isHidden&&(o.isHidden=!1),void 0!==o.isVisible&&(o.isVisible=!0)}for(var a=["player","character","movement","controller"],l=0;l<a.length;l++){var n=a[l];t[n]&&void 0!==t[n].enabled&&(t[n].enabled=!0)}}this._forcePlayerVisibility(e),this.app&&this.app.fire("player:scene:reset",{player:e,scene:this._currentScene}),this.debug&&console.log("[GlobalGame] Scene change reset completed for player")}catch(e){console.error("[GlobalGame] Error in scene change reset:",e)}},_forcePlayerVisibility(e){if(e)try{if(e.enabled=!0,e.render&&e.render.material){var t=e.render.material;void 0!==t.opacity&&(t.opacity=1),void 0!==t.blendType&&(t.blendType=pc.BLEND_NONE)}for(var o=e.findComponents("render"),a=0;a<o.length;a++)o[a].enabled=!0;e.model&&(e.model.enabled=!0),this._forceChildrenVisibility(e)}catch(e){console.error("[GlobalGame] Error forcing player visibility:",e)}},_forceChildrenVisibility(e){if(e&&e.children)for(var t=0;t<e.children.length;t++){var o=e.children[t];o&&(o.enabled=!0,o.render&&(o.render.enabled=!0),o.model&&(o.model.enabled=!0),this._forceChildrenVisibility(o))}},switchToScene(e){e&&(console.log("[GlobalGame] Manual scene switch to:",e),this.setCurrentScene(e))},_isPlayerInGarden(){var e=this._detectCurrentScene();if(!e)return!1;for(var t=["Queen","flower","bloom","nature","park"],o=e.toLowerCase(),a=0;a<t.length;a++)if(-1!==o.indexOf(t[a]))return!0;try{if(this.app&&this.app.root)for(var l=["Garden","FlowerGarden","Flowers","BloomArea"],n=0;n<l.length;n++)if(this.app.root.findByName(l[n]))return!0}catch(e){this.debug&&console.warn("[GlobalGame] Error checking garden entities:",e)}return!1},_checkGardenTeleport(){if(this._isPlayerInGarden()){this.debug&&console.log("[GlobalGame] Player detected in garden, teleporting to special location");var e={x:14,y:14,z:26},t=this;return setTimeout((function(){t._teleportPlayer(e),t.app&&t.app.fire("player:garden:teleported",{position:e,scene:t._currentScene})}),300),!0}return!1},_cleanupInteractableEvents(){if(this.app)try{for(var e=["interactable:action","interactable:one_time_completed","interactable:hint:show","interactable:hint:hide","ui:hint:show","ui:hint:hide","mobile:interact"],t=0;t<e.length;t++)this.app.off(e[t]);for(var o=["E","F","Space","Enter","69","70","32","13"],a=0;a<o.length;a++){var l="interactableHint:"+o[a];this.app.off(l)}this.debug&&console.log("[GlobalGame] Cleaned up interactable events on scene change")}catch(e){console.error("[GlobalGame] Error cleaning up interactable events:",e)}},checkGardenTeleport(){return this._checkGardenTeleport()},isPlayerInGarden(){return this._isPlayerInGarden()},resetPlayerState(){var e=this._findPlayerEntity();return e?(this._resetPlayerState(e),this._performSceneChangeReset(e),this.debug&&console.log("[GlobalGame] Manual player state reset completed"),!0):(console.warn("[GlobalGame] Player not found for manual reset"),!1)},_partStates:null,_loadPartStates(){try{var e=localStorage.getItem("echoSoul_partStates");this._partStates=e?JSON.parse(e):{},this.debug&&console.log("[GlobalGame] Loaded part states:",this._partStates)}catch(e){console.warn("[GlobalGame] Failed to load part states:",e),this._partStates={}}},_savePartStates(){try{localStorage.setItem("echoSoul_partStates",JSON.stringify(this._partStates)),this.debug&&console.log("[GlobalGame] Saved part states:",this._partStates)}catch(e){console.warn("[GlobalGame] Failed to save part states:",e)}},setScenePartState(e,t){!e||t<0||(this._partStates||this._loadPartStates(),this._partStates[e]||(this._partStates[e]={}),this._partStates[e].activatedPartIndex=t,this._partStates[e].timestamp=Date.now(),this._savePartStates(),this.debug&&console.log("[GlobalGame] Set part state for scene",e,"part index:",t))},getScenePartState(e){if(!e)return null;this._partStates||this._loadPartStates();var t=this._partStates[e];return t?t.activatedPartIndex:0},clearScenePartState(e){e&&this._partStates&&(delete this._partStates[e],this._savePartStates(),this.debug&&console.log("[GlobalGame] Cleared part state for scene:",e))},getAllPartStates(){return this._partStates||this._loadPartStates(),this._partStates},setCheckpoint(e,t,o){e&&e.clone&&(this._checkpointPosition=e.clone(),this.debug&&console.log("[GlobalGame] Checkpoint set at:",e))},getCheckpoint(){return this._checkpointPosition?this._checkpointPosition.clone():null},setSceneCheckpoint(e,t){if(e&&t){this._sceneCheckpoints||(this._sceneCheckpoints={}),this._sceneCheckpoints[e]=t.clone();try{var o="echoSoul_sceneCheckpoint_"+e,a={position:{x:t.x,y:t.y,z:t.z},timestamp:Date.now()};localStorage.setItem(o,JSON.stringify(a)),this.debug&&console.log("[GlobalGame] 场景存档点已保存到localStorage，场景:",e,"位置:",t)}catch(e){console.error("[GlobalGame] 保存场景存档点到localStorage失败:",e)}}else console.warn("[GlobalGame] setSceneCheckpoint: 场景名或位置无效")},getSceneCheckpoint(e){if(!e)return console.warn("[GlobalGame] getSceneCheckpoint: 场景名无效"),null;if(this._sceneCheckpoints&&this._sceneCheckpoints[e])return this.debug&&console.log("[GlobalGame] 从内存获取场景存档点，场景:",e),this._sceneCheckpoints[e].clone();try{var t="echoSoul_sceneCheckpoint_"+e,o=localStorage.getItem(t);if(o){var a=JSON.parse(o);if(a&&a.position){var l=new pc.Vec3(a.position.x,a.position.y,a.position.z);return this._sceneCheckpoints||(this._sceneCheckpoints={}),this._sceneCheckpoints[e]=l,this.debug&&console.log("[GlobalGame] 从localStorage加载场景存档点，场景:",e,"位置:",l),l.clone()}}}catch(e){console.error("[GlobalGame] 从localStorage加载场景存档点失败:",e)}return this.debug&&console.log("[GlobalGame] 场景存档点不存在，场景:",e),null},clearCheckpoint(){this._checkpointPosition=null;try{localStorage.removeItem("echoSoul_checkpoint")}catch(e){}this.debug&&console.log("[GlobalGame] Checkpoint cleared")},teleportToCheckpoint(){var e=this.getCheckpoint();if(!e)return this.debug&&console.warn("[GlobalGame] No current checkpoint found for teleport"),!1;try{var t=this.app.root.findByName("Player");if(t||(t=this.app.root.findByName("player")||this.app.root.findByName("PlayerController")||this.app.root.findByTag("player")[0]),!t)return this.debug&&console.error("[GlobalGame] Player entity not found for teleport"),!1;var o,a,l,n=e;if(this.debug&&(console.log("[GlobalGame] Teleport debug info:"),console.log("  - Current checkpoint position:",n),console.log("  - Position type:",typeof n),console.log("  - Player entity:",t.name),console.log("  - Player has rigidbody:",!!t.rigidbody)),!n||"object"!=typeof n)return this.debug&&console.error("[GlobalGame] Position is not an object:",n),!1;if(void 0!==n.x&&void 0!==n.y&&void 0!==n.z)o=n.x,a=n.y,l=n.z;else{if(!n.clone||"function"!=typeof n.clone)return this.debug&&console.error("[GlobalGame] Invalid position format:",n),!1;var i=n.clone();o=i.x,a=i.y,l=i.z}return this.debug&&console.log("[GlobalGame] Parsed position:",o,a,l),t.rigidbody?(t.rigidbody.teleport(o,a,l),this.debug&&console.log("[GlobalGame] Used rigidbody.teleport()")):(t.setPosition(o,a,l),this.debug&&console.log("[GlobalGame] Used setPosition()")),this.debug&&console.log("[GlobalGame] Player teleported to checkpoint at:",o,a,l),this.app.fire("player:teleported",{position:{x:o,y:a,z:l},timestamp:nowMs()}),!0}catch(e){return this.debug&&console.error("[GlobalGame] Teleport failed:",e),!1}},debugTeleport(){console.log("[GlobalGame] === Debug Teleport ==="),console.log("Current scene:",this._currentScene),console.log("Current state:",this._current);var e=this.getCheckpoint();if(console.log("Current checkpoint:",e),this._currentScene){var t="echoSoul_currentCheckpoint_"+this._currentScene;try{var o=localStorage.getItem(t);console.log("Saved checkpoint data:",o?JSON.parse(o):null)}catch(e){console.log("Failed to load saved checkpoint:",e)}}console.log("Attempting teleport...");var a=this.teleportToCheckpoint();console.log("Teleport result:",a)},loadScene(e,t){var o=this;if(this.debug&&console.log("[GlobalGame] Loading scene:",e),this._currentScene&&this._currentScene.toLowerCase()===e.toLowerCase())return console.warn("[GlobalGame] Already in scene:",e),void(t&&t(null));this._stopSceneAudio();try{this.app.fire("loading:show",{text:"Loading..."}),this.debug&&console.log("[GlobalGame] Loading screen shown")}catch(e){console.warn("[GlobalGame] Failed to show loading screen:",e)}try{if("undefined"!=typeof UIManager&&(o.debug&&console.log("[GlobalGame] Clearing UIManager singleton before scene change"),UIManager._instance=null),"undefined"!=typeof GlobalCameraManager&&(o.debug&&console.log("[GlobalGame] Clearing CameraManager singleton before scene change"),GlobalCameraManager._instance=null),"undefined"!=typeof UIMobile&&(o.debug&&console.log("[GlobalGame] Clearing UIMobile singleton before scene change"),UIMobile._instance=null),"undefined"!=typeof PortalConfirmUI){if(console.log("[GlobalGame] Clearing PortalConfirmUI singleton before scene change"),PortalConfirmUI._instance&&"function"==typeof PortalConfirmUI._instance.destroy)try{PortalConfirmUI._instance.destroy()}catch(e){console.warn("[GlobalGame] Failed to destroy PortalConfirmUI:",e)}PortalConfirmUI._instance=null}"undefined"!=typeof CameraUIController&&(o.debug&&console.log("[GlobalGame] Clearing CameraUIController instances before scene change"),CameraUIController._instances={}),o.debug&&console.log("[GlobalGame] Triggering scene:beforeunload for cleanup"),o.app.fire("scene:beforeunload",{sceneName:e})}catch(e){console.warn("[GlobalGame] Failed to clear singletons:",e)}try{this.app.scenes.changeScene(e,(function(a,l){if(a){console.error("[GlobalGame] Failed to load scene:",a);try{o.app.fire("loading:hide")}catch(e){}t&&t(a)}else o.setCurrentScene(e,!0),o.debug&&console.log("[GlobalGame] Scene loaded successfully:",e),o._playSceneAudio(e),setTimeout((function(){try{o.debug&&console.log("[GlobalGame] Cleaning up old scene remnants..."),o._cleanupOldSceneRemnants(),o.app.fire("scene:loaded",{sceneName:e});try{var a=o.getLocale();o._applyLocaleFonts(a),o.debug&&console.log("[GlobalGame] Applied fonts for locale:",a,"to new scene:",e)}catch(e){console.warn("[GlobalGame] Failed to apply fonts to new scene:",e)}if(0===e.toLowerCase().indexOf("level")&&o._initializeLevelManager(l),!e||"start"===e.toLowerCase()||"main"===e.toLowerCase())o.debug&&console.log("[GlobalGame] Start scene (or empty name), keeping player state unchanged - controlled by UIManager");else if(o.debug&&console.log("[GlobalGame] Non-start scene, forcing player to standing state"),o.debug&&o._logEventListenerCounts(),o.app.fire("player:set_sitting",!1),"undefined"!=typeof GlobalCameraManager){var n=GlobalCameraManager.getInstance();n&&(n.setState(GlobalCameraManager.CONTROL_STATES.FREE_FOLLOW),o.debug&&console.log("[GlobalGame] Camera set to FREE_FOLLOW"))}o.app.fire("loading:hide"),o.debug&&console.log("[GlobalGame] Loading screen hidden"),setTimeout((function(){o._showSceneTitle(e)}),300)}catch(e){console.warn("[GlobalGame] Failed to hide loading screen:",e)}t&&t(null,l)}),800)}))}catch(e){console.error("[GlobalGame] Exception loading scene:",e);try{this.app.fire("loading:hide")}catch(e){}t&&t(e)}},_showSceneTitle(e){if(e){var t={Start:"level.mind_shore.entrance",level1:"level.ethans_wind.outer",ethans_wind_outer:"level.ethans_wind.outer",mind_shore:"level.mind_shore.entrance",Queen:"Queen.entrance",village:"village.entrance",Chapter1:"story.chapter1.title"}[e];if(t)try{this.app.fire("title:show",t)}catch(e){}}},_playSceneAudio(e){if(e)if("undefined"!=typeof GlobalAudioSceneConfig&&GlobalAudioSceneConfig._initialized)try{GlobalAudioSceneConfig.playScene(e),this.debug&&console.log("[GlobalGame] ✓ 场景音频播放:",e)}catch(e){console.error("[GlobalGame] 场景音频播放失败:",e)}else this.debug&&console.warn("[GlobalGame] GlobalAudioSceneConfig未初始化，跳过场景音频播放")},_stopSceneAudio(){if("undefined"!=typeof GlobalAudioSceneConfig&&GlobalAudioSceneConfig._initialized)try{GlobalAudioSceneConfig.stopScene(),this.debug&&console.log("[GlobalGame] ✓ 场景音频已停止")}catch(e){console.error("[GlobalGame] 停止场景音频失败:",e)}},_cleanupOldSceneRemnants(){var e=0;try{var t=this.app.root.find((function(e){return e.script&&e.script.cameraTransition}));if(t.length>1){console.warn("[GlobalGame] Found",t.length,"CameraTransition instances, keeping only the first one");for(var o=1;o<t.length;o++)try{this.debug&&console.log("[GlobalGame] Destroying duplicate CameraTransition:",t[o].name,t[o].getGuid()),t[o].destroy(),e++}catch(e){console.warn("[GlobalGame] Failed to destroy CameraTransition:",e)}}var a=this.app.root.findByTag("player");if(a.length>1){console.warn("[GlobalGame] Found",a.length,"Player instances, keeping only the first one");for(var l=1;l<a.length;l++)try{this.debug&&console.log("[GlobalGame] Destroying duplicate Player:",a[l].name,a[l].getGuid()),a[l].destroy(),e++}catch(e){console.warn("[GlobalGame] Failed to destroy Player:",e)}}e>0?console.log("[GlobalGame] Cleaned up",e,"duplicate instances"):this.debug&&console.log("[GlobalGame] No duplicate instances found")}catch(e){console.error("[GlobalGame] Error cleaning up old scene remnants:",e)}},_logEventListenerCounts(){try{var e=["ui:control_state_changed","player:set_sitting","player:respawn","ui:dialogue:begin","ui:dialogue:end"];console.log("[GlobalGame] Event listener counts:");for(var t=0;t<e.length;t++){var o=e[t];if(this.app._callbacks&&this.app._callbacks.has(o)){var a=this.app._callbacks.get(o),l=a?a.length:0;console.log("[GlobalGame]  -",o+":",l),l>1&&console.warn("[GlobalGame]  ⚠️ Multiple listeners detected for:",o)}}}catch(e){console.warn("[GlobalGame] Failed to log event listener counts:",e)}},_initializeLevelManager(e){if(e){var t=null;if(e.script&&e.script.levelManager&&(t=e.script.levelManager),!t){var o=e.findByName("LevelManager");o&&o.script&&o.script.levelManager&&(t=o.script.levelManager)}!t&&"undefined"!=typeof LevelManager&&LevelManager.getInstance&&(t=LevelManager.getInstance()),t?(this.debug&&console.log("[GlobalGame] Found LevelManager, initializing parts"),"function"==typeof t._initializeParts&&t._initializeParts()):this.debug&&console.warn("[GlobalGame] LevelManager not found in scene root")}else this.debug&&console.warn("[GlobalGame] sceneRoot is null, cannot initialize LevelManager")},getLocale(){return this._currentLocale||this._detectLocale()},setLocale(e){var t="zh-CN"===e||"en-US"===e?e:this._detectLocale();if(t!==this._currentLocale){var o=this._currentLocale;if(this._currentLocale=t,this.debug&&console.log("[GlobalGame] setLocale: switching to",t,"(session only)"),"undefined"!=typeof I18n&&I18n.setLocale){try{I18n.setLocale(t),this.debug&&console.log("[GlobalGame] I18n.setLocale called with:",t)}catch(e){console.error("[GlobalGame] I18n.setLocale failed:",e)}var a=this,l="zh-CN"===t?"en-US":"zh-CN";this._reloadAllI18nBundles(t,l,(function(){try{I18n.getLocale()!==t&&(I18n.setLocale(t),a.debug&&console.log("[GlobalGame] 强制同步 I18n locale 到:",t))}catch(e){console.warn("[GlobalGame] Failed to sync I18n locale:",e)}try{a._applyLocaleFonts(t)}catch(e){console.warn("[GlobalGame] Failed to apply locale fonts:",e)}a.app.fire("i18n:ready"),a.app.fire("locale:changed",{locale:t,oldLocale:o,timestamp:Date.now()}),a.app.fire("i18n:changed",{locale:t,oldLocale:o}),a.debug&&(console.log("[GlobalGame] 语言切换完成，所有 i18n 资源已重新加载"),console.log("[GlobalGame] locale changed ->",t),console.log("[GlobalGame] I18n.getLocale() returns:",I18n.getLocale()))}))}else this.app.fire("locale:changed",{locale:t,oldLocale:o,timestamp:Date.now()}),this.app.fire("i18n:changed",{locale:t,oldLocale:o}),this.debug&&console.log("[GlobalGame] I18n not available, fired locale:changed and i18n:changed events")}else this.debug&&console.log("[GlobalGame] setLocale: already",t,", skipping")},_reloadAllI18nBundles(e,t,o){if("undefined"!=typeof I18n&&I18n.loadBundles){var a=this;this.debug&&(console.log("[GlobalGame] 开始重新加载所有 i18n 资源，目标语言:",e),console.log("[GlobalGame] 当前已加载的资源包:",I18n.getLoadedBundles?I18n.getLoadedBundles():"unknown"));try{I18n.clearBundles&&(I18n.clearBundles(),this.debug&&console.log("[GlobalGame] 已清除所有 i18n 缓存"))}catch(e){console.warn("[GlobalGame] Failed to clear i18n bundles:",e)}var l=[{assetName:"prologue_"+e+".json",namespace:"prologue"},{assetName:"ui_"+e+".json",namespace:"ui"},{assetName:"title_"+e+".json",namespace:"title"}];this.debug&&console.log("[GlobalGame] 准备加载资源包:",l.map((function(e){return e.assetName}))),I18n.loadBundles(l,(function(){var l=!(!I18n.get||!I18n.get("prologue")),n=!(!I18n.get||!I18n.get("ui")),i=!(!I18n.get||!I18n.get("title"));if(a.debug&&(console.log("[GlobalGame] 重新加载结果 - Prologue:",l,"UI:",n,"Title:",i),console.log("[GlobalGame] 新加载的资源包:",I18n.getLoadedBundles?I18n.getLoadedBundles():"unknown")),l&&n&&i||!t||t===e)a.debug&&console.log("[GlobalGame] 所有 i18n 资源重新加载完成"),o&&o();else{a.debug&&console.log("[GlobalGame] 主要语言资源加载不完整，尝试 fallback:",t);var s=[{assetName:"prologue_"+t+".json",namespace:"prologue"},{assetName:"ui_"+t+".json",namespace:"ui"},{assetName:"title_"+t+".json",namespace:"title"}];I18n.loadBundles(s,(function(){a.debug&&console.log("[GlobalGame] Fallback 资源加载完成"),o&&o()}))}}))}else o&&o()},canTransitionTo(e){var t=this.STATES,o={};return o[t.LOADING]=[t.MAIN_MENU],o[t.MAIN_MENU]=[t.LEVEL_SELECT,t.FREE_WORLD,t.SETTINGS],o[t.LEVEL_SELECT]=[t.MAIN_MENU,t.LEVEL],o[t.LEVEL]=[t.PAUSED,t.GAME_OVER,t.MAIN_MENU],o[t.FREE_WORLD]=[t.PAUSED,t.MAIN_MENU],o[t.PAUSED]=[t.LEVEL,t.FREE_WORLD,t.MAIN_MENU],o[t.GAME_OVER]=[t.MAIN_MENU,t.LEVEL],o[t.SETTINGS]=[t.MAIN_MENU],-1!==(o[this._current]||[]).indexOf(e)},on(e,t,o){this._cb[e][t]=o},startGame(){this.changeState(this.STATES.LEVEL_SELECT)},enterFreeWorld(){this.changeState(this.STATES.FREE_WORLD)},pause(){(this.isInState(this.STATES.LEVEL)||this.isInState(this.STATES.FREE_WORLD))&&this.changeState(this.STATES.PAUSED)},resume(){this.isInState(this.STATES.PAUSED)&&this.changeState(this._previous)},toMainMenu(){this.changeState(this.STATES.MAIN_MENU)},playPrologue(e,t){e?(this.debug&&console.log("[GlobalGame] playPrologue called with key:",e),this.app.fire("ui:play:prologue",{prologueKey:e,options:t||{}})):this.debug&&console.warn("[GlobalGame] playPrologue: prologueKey is required")},_dialogueData:null,_initDialogueStorage(){if(!this._dialogueData)try{var e=localStorage.getItem("echoSoul_dialogue_progress");this._dialogueData=e?JSON.parse(e):{}}catch(e){console.warn("[GlobalGame] Failed to load dialogue progress:",e),this._dialogueData={}}},_saveDialogueStorage(){if(this._dialogueData)try{localStorage.setItem("echoSoul_dialogue_progress",JSON.stringify(this._dialogueData))}catch(e){console.warn("[GlobalGame] Failed to save dialogue progress:",e)}},setDialogueNode(e,t){return this._initDialogueStorage(),!!e&&(this._dialogueData[e]=String(t||""),this._saveDialogueStorage(),this.debug&&console.log("[GlobalGame] Saved dialogue node:",e,"->",t),!0)},getDialogueNode(e,t){this._initDialogueStorage();var o=this._dialogueData[e];return void 0===o?t||"":String(o)},clearDialogueProgress(){this._dialogueData={},this._saveDialogueStorage(),this.debug&&console.log("[GlobalGame] Cleared all dialogue progress")},clearDialogueProgressFor(e){return this._initDialogueStorage(),!!this._dialogueData[e]&&(delete this._dialogueData[e],this._saveDialogueStorage(),this.debug&&console.log("[GlobalGame] Cleared dialogue progress for:",e),!0)},showDialogueProgress(){return this._initDialogueStorage(),console.log("[GlobalGame] Current dialogue progress:",this._dialogueData),this._dialogueData},_settingsData:null,_initSettingsStorage(){if(!this._settingsData)try{var e=localStorage.getItem("echoSoul_settings");this._settingsData=e?JSON.parse(e):{};var t={masterVolume:80,musicVolume:70,sfxVolume:80,voiceVolume:80,language:"zh-CN",fullscreen:!1,vSync:!0,brightness:50,mouseSensitivity:1,invertY:!1};for(var o in t)o in this._settingsData||(this._settingsData[o]=t[o])}catch(e){console.warn("[GlobalGame] Failed to load settings:",e),this._settingsData={}}},_saveSettingsStorage(){if(this._settingsData)try{localStorage.setItem("echoSoul_settings",JSON.stringify(this._settingsData))}catch(e){console.warn("[GlobalGame] Failed to save settings:",e)}},setSetting(e,t){return this._initSettingsStorage(),!!e&&(this._settingsData[e]=t,this._saveSettingsStorage(),this.debug&&console.log("[GlobalGame] Setting saved:",e,"=",t),!0)},getSetting(e,t){this._initSettingsStorage();var o=this._settingsData[e];return void 0===o?t:o},saveSettings(){this._saveSettingsStorage(),this.debug&&console.log("[GlobalGame] All settings saved to localStorage")},resetSettings(){this._settingsData=null,this._initSettingsStorage(),this._saveSettingsStorage(),this.debug&&console.log("[GlobalGame] Settings reset to defaults")},clearGameProgress(){try{this.clearDialogueProgress(),this.clearPrologueVisited(),this.clearProloguePlayHistory(),this.clearCheckpoint();for(var e=[],t=0;t<localStorage.length;t++){var o=localStorage.key(t);o&&o.startsWith("echoSoul_")&&"echoSoul_settings"!==o&&"echoSoul_locale"!==o&&!o.includes("_language")&&!o.includes("_i18n")&&e.push(o)}for(var a=0;a<e.length;a++)localStorage.removeItem(e[a]),this.debug&&console.log("[GlobalGame] Removed:",e[a]);return this._dialogueData=null,this._checkpointActivations={},this._prologuePlayHistory={},this._checkpointPosition=null,this.debug&&console.log("[GlobalGame] All game progress cleared"),!0}catch(e){return console.error("[GlobalGame] Error clearing game progress:",e),!1}},_enter(e,t){var o=this._cb.enter[e];o&&o.call(this,t),this.app.fire("gamestate:enter",{state:e,data:t});var a=this;this._bind(this.app,"update",(function(e){var t=a._cb.update[a._current];t&&t.call(a,e),a.app.fire("gamestate:update",{state:a._current,deltaTime:e,stateTime:(nowMs()-a._stateStart)/1e3})}),this)},_exit(e){var o=this._cb.exit[e];o&&o.call(this),this.app.fire("gamestate:exit",{state:e}),this._unsub=this._unsub.filter((function(e){if(e.target===t.app&&"update"===e.event){try{e.target.off(e.event,e.fn,e.scope)}catch(e){}return!1}return!0}))},_isValidState(e){return-1!==Object.values(this.STATES).indexOf(e)},_registerDefaultHandlers(){var e=this.STATES,t=this;this.on("enter",e.MAIN_MENU,(function(){t.app.fire("ui:show_main_menu"),t.app.fire("ui:hide_hud"),t.app.fire("player:set_sitting",!0);try{t.app.fire("ui:control:set","LOCKED_MULTI")}catch(e){}t._initMainMenuCamera()})),this.on("enter",e.LEVEL,(function(e){t.app.fire("ui:show_hud"),t.app.fire("ui:hide_main_menu"),t.app.fire("player:set_sitting",!1),e&&e.levelId&&t.app.fire("level:load",e.levelId)})),this.on("enter",e.FREE_WORLD,(function(){t.app.fire("ui:show_hud"),t.app.fire("ui:hide_main_menu"),t.app.fire("world:enter_free_mode"),t.app.fire("player:set_sitting",!1)})),this.on("enter",e.PAUSED,(function(){t.app.fire("game:pause"),t.app.fire("ui:show_pause_menu")})),this.on("exit",e.PAUSED,(function(){t.app.fire("game:resume"),t.app.fire("ui:hide_pause_menu")}))},_setupGlobalEvents(){var e=this;this._bind(this.app.keyboard,pc.EVENT_KEYDOWN,(function(t){t.key===pc.KEY_ESCAPE?e.isInState(e.STATES.LEVEL)||e.isInState(e.STATES.FREE_WORLD)?e.pause():e.isInState(e.STATES.PAUSED)&&e.resume():t.key===pc.KEY_G&&(e.isInState(e.STATES.LEVEL)||e.isInState(e.STATES.FREE_WORLD))&&e.teleportToCheckpoint()}),this),this._bind(this.app,"game:start_level",(function(t){e.changeState(e.STATES.LEVEL,{levelId:t})}),this),this._bind(this.app,"game:enter_free_world",(function(){e.enterFreeWorld()}),this),this._bind(this.app,"game:main_menu",(function(){e.toMainMenu()}),this),this._bind(this.app,"checkpoint:activated",(function(t){t&&t.position&&e.saveCurrentSceneCheckpoint(t.position,t.checkpointId,t.additionalData)}),this)},_bind(e,t,o,a){e&&e.on&&(e.on(t,o,a),this._unsub.push({target:e,event:t,fn:o,scope:a}))},_initMainMenuCamera(){var e=this.app.root.findByName("Camera");if(e&&e.script&&e.script.cameraTransition){var t=e.script.cameraTransition,o=0,a=this;!function tryGo(){var e=!1;try{e=t.transitionToPosition("mainMenu",null,(function(){a.debug&&console.log("[GlobalGame] camera at main menu")}))}catch(e){}!e&&o++<5?setTimeout(tryGo,100*o):!e&&a.debug&&console.warn("[GlobalGame] camera transition failed after retries")}()}else this.debug&&console.warn("[GlobalGame] camera or cameraTransition not found")},switchMainMenuCamera(e){if(!this.isInState(this.STATES.MAIN_MENU))return!1;var t=this.app.root.findByName("Camera"),o=t&&t.script&&t.script.cameraTransition;if(!o)return!1;try{return!!o.transitionToPosition("mainMenu",e)}catch(e){return!1}},_detectLocale(){var e="undefined"!=typeof navigator?navigator:null,t=e&&(e.language||e.languages&&e.languages[0])||"en-US";return/^zh(?:-Hans)?(?:-CN)?/i.test(t)?"zh-CN":(/^en/i.test(t),"en-US")},_loadPrologueForLocale(e,t){var o=this;try{I18n.setLocale(e)}catch(e){}this._currentLocale=e;var a="prologue_"+e+".json";I18n.loadBundles([{assetName:a,namespace:"prologue"}],(function(){if(!!(!I18n.get||!I18n.get("prologue"))&&t&&t!==e){try{I18n.setLocale(t)}catch(e){}o._currentLocale=t;var a="prologue_"+t+".json";I18n.loadBundles([{assetName:a,namespace:"prologue"}],(function(){o._loadUiForLocale(o._currentLocale,e===t?null:e,(function(){o._afterI18nLoaded()}))}))}else o._loadUiForLocale(o._currentLocale,t,(function(){o._afterI18nLoaded()}))}))},_loadUiForLocale(e,t,o){if("undefined"!=typeof I18n&&I18n.loadBundles){var a=this,l="ui_"+(e||"en-US")+".json",n="title_"+(e||"en-US")+".json";I18n.loadBundles([{assetName:l,namespace:"ui"},{assetName:n,namespace:"title"}],(function(){var l=!(!I18n.get||!I18n.get("ui")),n=!(!I18n.get||!I18n.get("title"));if(a.debug&&console.log("[GlobalGame] Loaded UI:",l,"Title:",n),l&&n||!t||t===e)o&&o();else{var i="ui_"+t+".json",s="title_"+t+".json";I18n.loadBundles([{assetName:i,namespace:"ui"},{assetName:s,namespace:"title"}],(function(){o&&o()}))}}))}else o&&o()},_afterI18nLoaded(){if(this.changeState(this.defaultState),!(!I18n.get||!I18n.get("prologue"))){try{this._applyLocaleFonts(this._currentLocale||"en-US")}catch(e){}this.app.fire("i18n:ready"),this.debug&&console.log("[GlobalGame] i18n ready"),this._checkLevelPrologue();var e=this;setTimeout((function(){e._currentScene&&e._showSceneTitle(e._currentScene)}),1e3)}else console.warn("[GlobalGame] prologue bundle missing")},_checkLevelPrologue(){this.debug&&console.log("[GlobalGame] Level prologue disabled - skipping")},_applyLocaleFonts(e){var t="zh-CN"===e?"ZCOOLKuaiLe-Regular.ttf":"plotFont.ttf",o=this._findFontAssetByName(t);if(o){for(var a=[this.app.root];a.length;){var l=a.pop();if(l.element&&l.element.type===pc.ELEMENTTYPE_TEXT)try{l.element.fontAsset=o.id||o}catch(e){}for(var n=l.children||[],i=0;i<n.length;i++)a.push(n[i])}this.debug&&console.log("[GlobalGame] applied font for",e,"->",t)}else console.warn("[GlobalGame] font not found:",t)},_findFontAssetByName(e){return this.app&&this.app.assets&&(this.app.assets.find(e,"font")||this.app.assets.find(e))||null},_loadPrologueVisited(){try{if("undefined"==typeof localStorage)return void(this._prologueVisited={});var e=localStorage.getItem("echoSoul_prologueVisited");e?(this._prologueVisited=JSON.parse(e),this.debug&&console.log("[GlobalGame] Loaded prologue visited:",this._prologueVisited)):this._prologueVisited={}}catch(e){this.debug&&console.warn("[GlobalGame] Failed to load prologue visited:",e),this._prologueVisited={}}},_savePrologueVisited(){try{if("undefined"==typeof localStorage)return;localStorage.setItem("echoSoul_prologueVisited",JSON.stringify(this._prologueVisited)),this.debug&&console.log("[GlobalGame] Saved prologue visited:",this._prologueVisited)}catch(e){this.debug&&console.warn("[GlobalGame] Failed to save prologue visited:",e)}},markPrologueVisited(e){e&&(this._prologueVisited[e]=!0,this._savePrologueVisited(),this.debug&&console.log("[GlobalGame] Marked prologue visited:",e))},hasPrologueVisited(e){return!!this._prologueVisited[e]},clearPrologueVisited(e){e?(delete this._prologueVisited[e],this.debug&&console.log("[GlobalGame] Cleared prologue visited:",e)):(this._prologueVisited={},this.debug&&console.log("[GlobalGame] Cleared all prologue visited")),this._savePrologueVisited()},_loadPlayerSettings(){try{if("undefined"==typeof localStorage)return;var e=localStorage.getItem("echoSoul_playerSettings");e&&(this._playerSettings=JSON.parse(e),this.debug&&console.log("[GlobalGame] Loaded player settings:",this._playerSettings))}catch(e){this.debug&&console.warn("[GlobalGame] Failed to load player settings:",e),this._playerSettings={}}},_savePlayerSettings(){try{if("undefined"==typeof localStorage)return;localStorage.setItem("echoSoul_playerSettings",JSON.stringify(this._playerSettings)),this.debug&&console.log("[GlobalGame] Saved player settings:",this._playerSettings)}catch(e){this.debug&&console.warn("[GlobalGame] Failed to save player settings:",e)}},setSetting(e,t){if(e){if("language"===e&&t&&("zh-CN"===t||"en-US"===t))return this.debug&&(console.log("[GlobalGame] ===== Language Change (Session Only) ====="),console.log("[GlobalGame] New language:",t),console.log("[GlobalGame] Current locale:",this._currentLocale),console.log("[GlobalGame] Note: Change is temporary, will reset on page refresh")),this.setLocale(t),this.debug&&console.log("[GlobalGame] ============================================="),void(this.app&&this.app.fire("setting:changed",e,t));this._playerSettings[e]=t,this._savePlayerSettings(),this.debug&&console.log("[GlobalGame] Set setting:",e,"=",t),this.app&&this.app.fire("setting:changed",e,t)}},getSetting(e,t){if(!e)return t;if("language"===e)return this._currentLocale||this._detectLocale();var o=this._playerSettings[e];return null!=o?o:t},getAllSettings(){return Object.assign({},this._playerSettings)},clearAllSettings(){this._playerSettings={},this._savePlayerSettings(),this.debug&&console.log("[GlobalGame] Cleared all settings")},_loadProloguePlayHistory(){try{if("undefined"==typeof localStorage)return void(this._prologuePlayHistory={});var e=localStorage.getItem("echoSoul_prologuePlayHistory");e?(this._prologuePlayHistory=JSON.parse(e),this.debug&&console.log("[GlobalGame] Loaded prologue play history:",Object.keys(this._prologuePlayHistory))):this._prologuePlayHistory={}}catch(e){this.debug&&console.warn("[GlobalGame] Failed to load prologue play history:",e),this._prologuePlayHistory={}}},_saveProloguePlayHistory(){try{if("undefined"==typeof localStorage)return;localStorage.setItem("echoSoul_prologuePlayHistory",JSON.stringify(this._prologuePlayHistory)),this.debug&&console.log("[GlobalGame] Saved prologue play history:",Object.keys(this._prologuePlayHistory))}catch(e){this.debug&&console.warn("[GlobalGame] Failed to save prologue play history:",e)}},recordProloguePlay(e,t,o){if(e){var a={timestamp:Date.now(),scene:this._currentScene||"unknown"};t&&(a.checkpointId=t),o&&Object.assign(a,o),this._prologuePlayHistory[e]=a,this.debug&&console.log("[GlobalGame] Recorded prologue play:",e,"data:",a),this._saveProloguePlayHistory()}},getProloguePlayRecord(e){return e?this._prologuePlayHistory[e]||null:Object.assign({},this._prologuePlayHistory)},hasProloguePlayed(e){return!!this._prologuePlayHistory[e]},getScenePrologues(e){var t=e||this._currentScene,o=[];for(var a in this._prologuePlayHistory){var l=this._prologuePlayHistory[a];l.scene===t&&o.push({key:a,data:l})}return o.sort((function(e,t){return e.data.timestamp-t.data.timestamp})),o},clearProloguePlayHistory(e){e?(delete this._prologuePlayHistory[e],this.debug&&console.log("[GlobalGame] Cleared prologue play record:",e)):(this._prologuePlayHistory={},this.debug&&console.log("[GlobalGame] Cleared all prologue play history")),this._saveProloguePlayHistory()}};e.GlobalGame=t}("undefined"!=typeof window?window:this);var UIManager=pc.createScript("uiManager");UIManager.UI_STATES={HIDDEN:"hidden",FIRST_TIME_INTRO:"first_time_intro",TYPEWRITER:"typewriter",FADE_TRANSITION:"fade_transition",NORMAL:"normal",ESC_CONFIRM:"esc_confirm"},UIManager.CONTROL_STATES={LOCKED_MULTI:"locked_multi",FREE_FIXED:"free_fixed",FREE_FOLLOW:"free_follow",LOCKED_FIXED:"locked_fixed",DIALOGUE:"dialogue"},UIManager.attributes.add("camera",{type:"entity",title:"摄像机实体（用于 Screen.camera；真实控制由 GlobalCameraManager）"}),UIManager.attributes.add("textElement",{type:"entity",title:"文字元素实体"}),UIManager.attributes.add("overlayElement",{type:"entity",title:"白色背景实体(白幕)"}),UIManager.attributes.add("blackOverlayElement",{type:"entity",title:"黑色背景实体(淡入淡出，可选)"}),UIManager.attributes.add("welcomeText",{type:"string",default:"欢迎来到回音之魂...\n\n这是一个充满神秘的世界\n\n准备好开始你的冒险了吗？"}),UIManager.attributes.add("typewriterSpeed",{type:"number",default:50}),UIManager.attributes.add("fadeSpeed",{type:"number",default:2}),UIManager.attributes.add("enableDebugLog",{type:"boolean",default:!0}),UIManager.attributes.add("bgHexColor",{type:"string",default:"#FCFBDB",title:"首屏纯色（十六进制）"}),UIManager.attributes.add("bgFadeOutMs",{type:"number",default:1500,title:"首屏纯色淡出时长(ms)"}),UIManager.attributes.add("imageCarouselContainer",{type:"entity",title:"图片轮播容器节点（挂载 prologue 图片）"}),UIManager.attributes.add("rightHintPanel",{type:"entity",title:"右侧提示面板(Image Element)"}),UIManager.attributes.add("rightHintText",{type:"entity",title:"右侧提示文本(Text Element)"}),UIManager.attributes.add("rightHintKeyText",{type:"entity",title:"右侧提示键位(Text Element)"}),UIManager.attributes.add("rightHintShowMs",{type:"number",default:160,title:"提示-显示时长(ms)"}),UIManager.attributes.add("rightHintHideMs",{type:"number",default:140,title:"提示-隐藏时长(ms)"}),UIManager.attributes.add("dialogueRootEntity",{type:"entity",title:"对话UI根(容器)"}),UIManager.attributes.add("dialogueTextEntity",{type:"entity",title:"对话文本(Element Text)"}),UIManager.attributes.add("dialogueBackgroundEntity",{type:"entity",title:"对话背景(可选)"}),UIManager.attributes.add("dialogueButtonsContainer",{type:"entity",title:"选项按钮容器(可选)"}),UIManager.attributes.add("dialogueButtonGroup",{type:"entity",title:"按钮组容器(新)"}),UIManager.attributes.add("dialogueButtonTemplate",{type:"entity",title:"按钮模板(含button插件)"}),UIManager.attributes.add("dialogueButtonSpacing",{type:"number",default:150,title:"按钮间距(px)"}),UIManager.attributes.add("dialogueButtonsMargin",{type:"number",default:24,title:"按钮与文本间距(px)"}),UIManager.attributes.add("dialogueButtonMaxTextWidth",{type:"number",default:300,title:"按钮文字最大宽度(px)"}),UIManager.attributes.add("dialogueAutoPlaceButtons",{type:"boolean",default:!1,title:"自动将按钮放在文本右侧(通常关闭)"}),UIManager.attributes.add("dialogueNpcNameEntity",{type:"entity",title:"NPC名字显示文本(Element Text)"}),UIManager.attributes.add("dialogueUnknownNpcName",{type:"string",default:"???",title:"未知NPC显示名字"}),UIManager.attributes.add("menuScrollView",{type:"entity",title:"菜单设置ScrollView主实体"}),UIManager.attributes.add("menuScrollViewContent",{type:"entity",title:"菜单设置ScrollView Content"}),UIManager.attributes.add("prologuePlayButtonTemplate",{type:"entity",title:"Prologue播放按钮模板"}),UIManager.attributes.add("mainMenuGroupName",{type:"string",default:"mainMenu",title:"主菜单机位组名(转交给相机管理器)"}),UIManager.attributes.add("mainMenuMainPos",{type:"string",default:"main",title:"主菜单默认子机位名"}),UIManager.attributes.add("fixedGroupName",{type:"string",default:"fixed",title:"固定机位组名"}),UIManager.attributes.add("fixedSubPos",{type:"string",default:"main",title:"固定机位子名"}),UIManager.attributes.add("dialogueYawRange",{type:"number",default:50,title:"对话-左右夹角(°)"}),UIManager.attributes.add("dialoguePitchRange",{type:"number",default:50,title:"对话-上下夹角(°)"}),UIManager.attributes.add("escConfirmFont",{type:"asset",assetType:"font",title:"ESC确认界面字体"}),UIManager._instance=null,UIManager.getInstance=function(){return UIManager._instance},UIManager.prototype.initialize=function(){if(UIManager._instance&&UIManager._instance!==this)console.warn("[UIManager] Multiple instances detected.");else if(UIManager._instance=this,this.currentState=UIManager.UI_STATES.HIDDEN,this.isTransitioning=!1,this.animationState={typewriterIndex:0,typewriterTimer:0,isAnimating:!1,fadeAlpha:0,fadeDirection:1},this._validateAndInitUI()){this._bindInputs();try{this.dialogueRootEntity&&(this.dialogueRootEntity.enabled=!1)}catch(e){}this._initEscConfirmUI(),this._bindDialogueAdaptor=function(){try{if("undefined"!=typeof DialogueUI&&DialogueUI.init&&(DialogueUI.init(this.app,{screen:this.entity,debug:!!this.enableDebugLog}),"function"==typeof DialogueUI.configure&&DialogueUI.configure({root:this.dialogueRootEntity||null,text:this.dialogueTextEntity||null,bg:this.dialogueBackgroundEntity||null,container:this.dialogueButtonsContainer||this.dialogueRootEntity||null,template:this.dialogueButtonTemplate||null,spacing:0|this.dialogueButtonSpacing||8})),"undefined"!=typeof DialogueManager&&DialogueManager.setUI){var e=this;DialogueManager.setUI({setManager:function(e){},showNode:function(t,n){try{if("undefined"!=typeof DialogueUI&&DialogueUI.show){var o=null;if(e.dialogueTextEntity&&e.dialogueTextEntity.element){var a=e.dialogueTextEntity.element,i=e.dialogueTextEntity.getPosition();o={x:i.x,y:i.y,width:a.calculatedWidth||a.width||0,height:a.calculatedHeight||a.height||0}}DialogueUI.show(t,n,o)}}catch(t){e.enableDebugLog&&console.warn("[UIManager] DialogueUI.show failed:",t)}},hide:function(){try{"undefined"!=typeof DialogueUI&&DialogueUI.hide&&DialogueUI.hide()}catch(e){}}})}try{this.app.fire("ui:dialogue:ready")}catch(e){}}catch(e){this.enableDebugLog&&console.warn("[UIManager] bindDialogueAdaptor failed:",e)}},this._bindDialogueAdaptor(),this._bindMenuSettingsUI=function(){try{"undefined"!=typeof MenuSettingsUI&&MenuSettingsUI.init&&(MenuSettingsUI.init(this.app,{debug:!!this.enableDebugLog}),this.enableDebugLog&&console.log("[UIManager] MenuSettingsUI initialized"))}catch(e){console.warn("[UIManager] MenuSettingsUI init failed:",e)}},this._bindMenuSettingsUI();var e=this;this._onDialogueBegin=function(t){try{e.dialogueNpcName=t&&t.npc?String(t.npc):""}catch(e){}try{e._bindDialogueAdaptor()}catch(e){}try{t&&t.buttonsPos&&DialogueUI&&DialogueUI.setButtonsPosition&&DialogueUI.setButtonsPosition(t.buttonsPos)}catch(e){}try{var n=GlobalCameraManager.getInstance();n&&n.setState(GlobalCameraManager.CONTROL_STATES.DIALOGUE)}catch(e){}},this.app.on("ui:dialogue:begin",this._onDialogueBegin,this),this._onDialogueEnd=function(){try{var e=GlobalCameraManager.getInstance();e&&e.setState(GlobalCameraManager.CONTROL_STATES.FREE_FOLLOW)}catch(e){}try{DialogueUI&&DialogueUI.hide&&DialogueUI.hide()}catch(e){}},this.app.on("ui:dialogue:end",this._onDialogueEnd,this);e=this;this._setInitialPlayerAndCameraState=function(){try{e.app.fire("player:set_sitting",!0),console.log("[UIManager] Initialize: Set player sitting state");var t="undefined"!=typeof GlobalCameraManager?GlobalCameraManager.getInstance():null;t&&(t.setState(GlobalCameraManager.CONTROL_STATES.LOCKED_MULTI),t.snapToMainMenu(),console.log("[UIManager] Initialize: Set camera to LOCKED_MULTI"))}catch(e){console.warn("[UIManager] Failed to set initial player/camera state:",e)}},this._setInitialPlayerAndCameraState(),setTimeout((function(){e._setInitialPlayerAndCameraState(),console.log("[UIManager] Re-confirmed player/camera state after 100ms")}),100),setTimeout((function(){e._setInitialPlayerAndCameraState(),console.log("[UIManager] Re-confirmed player/camera state after 300ms")}),300),this._introStarted=!1,"undefined"!=typeof I18n&&I18n.get&&I18n.get("prologue")?this._startFirstTimeIntro():this.app.once("i18n:ready",(function(){this._introStarted||this._startFirstTimeIntro()}),this),this._onLevelProloguePlay=this._handleLevelProloguePlay.bind(this),this.app.on("level:prologue:play",this._onLevelProloguePlay,this),this._onUIPlayPrologue=this._handleUIPlayPrologue.bind(this),this.app.on("ui:play:prologue",this._onUIPlayPrologue,this);try{"undefined"!=typeof RightHint&&RightHint.init&&RightHint.init(this.app,{panel:this.rightHintPanel,text:this.rightHintText,key:this.rightHintKeyText,debug:this.enableDebugLog})}catch(e){}this._onUiHintShow=function(e){e&&"right"===e.side&&this.showRightHint(e.text||"",e)},this._onUiHintHide=function(e){e&&e.side&&"right"!==e.side||this.hideRightHint(e)},this.app.on("ui:hint:show",this._onUiHintShow,this),this.app.on("ui:hint:hide",this._onUiHintHide,this);e=this;this._onUiControlSet=function(e){console.log("[UIManager] ui:control:set event received:",e);var t=GlobalCameraManager.getInstance();if(t){var n=GlobalCameraManager.CONTROL_STATES,o=e;"string"==typeof o&&(o=n[o]||o),o||(o=n.LOCKED_MULTI),console.log("[UIManager] Setting camera state to:",o),t.setState(o)}else console.warn("[UIManager] GlobalCameraManager not available")},this.app.on("ui:control:set",this._onUiControlSet,this);e=this;var t=this.app.scene&&this.app.scene.name||"";"start"===t.toLowerCase()||"main"===t.toLowerCase()?setTimeout((function(){try{e.app.fire("player:set_sitting",!0),e.enableDebugLog&&console.log("[UIManager] Set initial player sitting state (delayed) - Start scene"),e.app.fire("ui:control:set","LOCKED_MULTI"),e.enableDebugLog&&console.log("[UIManager] Set initial camera state to LOCKED_MULTI (delayed) - Start scene"),setTimeout((function(){try{e.app.fire("player:set_sitting",!0),e.app.fire("ui:control:set","LOCKED_MULTI"),e.enableDebugLog&&console.log("[UIManager] Re-enforced LOCKED_MULTI state after PlayerController init - Start scene")}catch(t){e.enableDebugLog&&console.warn("[UIManager] Failed to re-enforce states:",t)}}),150)}catch(t){e.enableDebugLog&&console.warn("[UIManager] Failed to set initial states (delayed):",t)}}),50):e.enableDebugLog&&console.log("[UIManager] Non-start scene detected, skipping LOCKED_MULTI initialization")}else try{"function"==typeof this._bindDialogueAdaptor&&this._bindDialogueAdaptor()}catch(e){}},UIManager.prototype.update=function(e){if(!this.isTransitioning)switch(this.currentState){case UIManager.UI_STATES.TYPEWRITER:this._updateTypewriter(e);break;case UIManager.UI_STATES.FADE_TRANSITION:this._updateFadeTransition(e)}},UIManager.prototype._validateAndInitUI=function(){var e=!0;if(this.entity.screen||(console.error("[UIManager] Screen component missing on this entity."),e=!1),this.textElement&&this.textElement.element&&this.textElement.element.type===pc.ELEMENTTYPE_TEXT||(console.error("[UIManager] textElement must be a Text Element."),e=!1),this.overlayElement&&this.overlayElement.element&&this.overlayElement.element.type===pc.ELEMENTTYPE_IMAGE||(console.error("[UIManager] overlayElement must be an Image Element (white screen)."),e=!1),!this.blackOverlayElement||this.blackOverlayElement.element&&this.blackOverlayElement.element.type===pc.ELEMENTTYPE_IMAGE||(console.warn("[UIManager] blackOverlayElement invalid, fade transition will be skipped."),this.blackOverlayElement=null),!e)return!1;this.camera&&(this.entity.screen.camera=this.camera);var t=this.textElement.element;t.text="",t.opacity=1,this.textElement.setLocalPosition(0,0,0);try{t.anchor=new pc.Vec4(.5,.5,.5,.5),t.pivot=new pc.Vec2(.5,.5),t.margin=new pc.Vec4(0,0,0,0),t.wrapLines=!1,t.autoWidth=!1,t.width=1200,t.alignment=new pc.Vec2(.5,.5)}catch(e){}if(t.drawOrder=1e3,this.blackOverlayElement){var n=this.blackOverlayElement.element;n.color=new pc.Color(0,0,0,1),n.opacity=0,this.blackOverlayElement.enabled=!1}if(!t.fontAsset&&this.app.assets&&this.app.assets.list)for(var o=this.app.assets.list(),a=0;a<o.length;a++)if("font"===o[a].type){t.fontAsset=o[a].id;break}return!0},UIManager.prototype._bindInputs=function(){var e=this;this._isSpeedingUp=!1,this.onKeyDown=function(t){if(t.key!==pc.KEY_SPACE||e.currentState!==UIManager.UI_STATES.TYPEWRITER&&e.currentState!==UIManager.UI_STATES.FIRST_TIME_INTRO||e._speedUpTypewriter(!0),t.key===pc.KEY_ESCAPE){if(e.currentState===UIManager.UI_STATES.TYPEWRITER||e.currentState===UIManager.UI_STATES.FIRST_TIME_INTRO)return void console.log("[UIManager] ESC key ignored during animation state:",e.currentState);e._handleEscKey()}},this.onKeyUp=function(t){t.key!==pc.KEY_SPACE||e.currentState!==UIManager.UI_STATES.TYPEWRITER&&e.currentState!==UIManager.UI_STATES.FIRST_TIME_INTRO||e._speedUpTypewriter(!1)},this.onMouseDown=function(){e.currentState!==UIManager.UI_STATES.TYPEWRITER&&e.currentState!==UIManager.UI_STATES.FIRST_TIME_INTRO||e._speedUpTypewriter(!0)},this.onMouseUp=function(){e.currentState!==UIManager.UI_STATES.TYPEWRITER&&e.currentState!==UIManager.UI_STATES.FIRST_TIME_INTRO||e._speedUpTypewriter(!1)},this.onTouchStart=function(){e.currentState!==UIManager.UI_STATES.TYPEWRITER&&e.currentState!==UIManager.UI_STATES.FIRST_TIME_INTRO||e._speedUpTypewriter(!0)},this.onTouchEnd=function(){e.currentState!==UIManager.UI_STATES.TYPEWRITER&&e.currentState!==UIManager.UI_STATES.FIRST_TIME_INTRO||e._speedUpTypewriter(!1)},this.app.keyboard.on(pc.EVENT_KEYDOWN,this.onKeyDown,this),this.app.keyboard.on(pc.EVENT_KEYUP,this.onKeyUp,this),this.app.mouse.on(pc.EVENT_MOUSEDOWN,this.onMouseDown,this),this.app.mouse.on(pc.EVENT_MOUSEUP,this.onMouseUp,this),this.app.touch&&(this.app.touch.on(pc.EVENT_TOUCHSTART,this.onTouchStart,this),this.app.touch.on(pc.EVENT_TOUCHEND,this.onTouchEnd,this))},UIManager.prototype._startFirstTimeIntro=function(){console.log("[UIManager] _startFirstTimeIntro called"),this._introStarted=!0;var e="";try{"undefined"!=typeof GlobalGame&&GlobalGame.getCurrentScene?e=GlobalGame.getCurrentScene()||"":this.app.scene&&this.app.scene.name&&(e=this.app.scene.name||"")}catch(e){console.warn("[UIManager] Failed to get current scene:",e)}if(console.log("[UIManager] Current scene:",e),e&&"start"!==e.toLowerCase()&&"main"!==e.toLowerCase())return console.log("[UIManager] Not in Start scene ("+e+"), skipping welcome prologue"),void this._finishFirstTimeIntro();e||console.log("[UIManager] Scene name is empty, assuming Start scene (first load)");var t,n,o=!1;try{if("undefined"!=typeof GlobalGame&&GlobalGame.hasPrologueVisited){if(o=GlobalGame.hasPrologueVisited("welcome"),console.log("[UIManager] Welcome prologue visited before:",o),"undefined"!=typeof localStorage){var a=localStorage.getItem("echoSoul_prologueVisited");console.log("[UIManager] localStorage echoSoul_prologueVisited:",a)}}else console.warn("[UIManager] GlobalGame.hasPrologueVisited not available")}catch(e){console.warn("[UIManager] Failed to check prologue visited:",e)}if(o)return console.log("[UIManager] Skipping welcome prologue (already visited)"),void this._finishFirstTimeIntro();console.log("[UIManager] ✓ All checks passed, starting welcome prologue"),this._changeState(UIManager.UI_STATES.FIRST_TIME_INTRO),this.enableDebugLog&&console.log("[UIManager] _startFirstTimeIntro - imageCarouselContainer:",this.imageCarouselContainer);var i="undefined"!=typeof I18n?I18n.getTypingData("prologue","welcome"):null,s="undefined"!=typeof I18n?I18n.getTypingOptions("prologue","welcomeOptions"):null;if("undefined"!=typeof TypingTypes){var r=[];if(i&&i.typeLines&&i.typeLines.length)for(var l=0;l<i.typeLines.length;l++){var g=i.typeLines[l]||{};this.enableDebugLog&&0===l&&(console.log("[UIManager] First line from i18nData:",g),console.log("[UIManager] imageName:",g.imageName,"clearImage:",g.clearImage)),r.push(TypingTypes.createLine(g.text||"",{durations:g.durations,bold:g.bold,color:g.color,size:g.size,clear:g.clear,imageName:g.imageName,clearImage:g.clearImage}))}else r.push(TypingTypes.createLine(this.welcomeText||"",{color:"#000000"}));t=TypingTypes.createData(r);var c={defaultCharMs:Math.max(0,0|this.typewriterSpeed)||void 0,lineGapMs:300,enableDebugLog:!!this.enableDebugLog,overlayEntity:this.overlayElement,bgHexColor:this.bgHexColor,bgFadeOutMs:this.bgFadeOutMs,autoFadeOut:!0,imageCarouselContainer:this.imageCarouselContainer};this.enableDebugLog&&console.log("[UIManager] baseOpts.imageCarouselContainer:",c.imageCarouselContainer),s&&("number"==typeof s.defaultCharMs&&(c.defaultCharMs=s.defaultCharMs),"number"==typeof s.lineGapMs&&(c.lineGapMs=s.lineGapMs),"string"==typeof s.bgHexColor&&(c.bgHexColor=s.bgHexColor),"number"==typeof s.bgFadeOutMs&&(c.bgFadeOutMs=s.bgFadeOutMs),"boolean"==typeof s.enableDebugLog&&(c.enableDebugLog=s.enableDebugLog),"boolean"==typeof s.autoFadeOut&&(c.autoFadeOut=s.autoFadeOut)),n=TypingTypes.createOptions(c),this.enableDebugLog&&console.log("[UIManager] After TypingTypes.createOptions, opts:",n)}else t=i&&i.typeLines&&i.typeLines.length?i:{typeLines:[{text:this.welcomeText||"",color:"#000000"}]},n={defaultCharMs:s&&"number"==typeof s.defaultCharMs?s.defaultCharMs:Math.max(0,0|this.typewriterSpeed)||50,lineGapMs:s&&"number"==typeof s.lineGapMs?s.lineGapMs:300,enableDebugLog:s&&"boolean"==typeof s.enableDebugLog?s.enableDebugLog:!!this.enableDebugLog,overlayEntity:this.overlayElement,bgHexColor:s&&"string"==typeof s.bgHexColor?s.bgHexColor:this.bgHexColor,bgFadeOutMs:s&&"number"==typeof s.bgFadeOutMs?s.bgFadeOutMs:this.bgFadeOutMs,autoFadeOut:!s||"boolean"!=typeof s.autoFadeOut||s.autoFadeOut,imageCarouselContainer:this.imageCarouselContainer};var u=this;this.playTypingData(t,n,(function(){console.log("[UIManager] Welcome prologue completed, calling _finishFirstTimeIntro"),u._finishFirstTimeIntro()}))},UIManager.prototype._handleUIPlayPrologue=function(e){if(e&&e.prologueKey){var t=e.prologueKey,n=e.options||{};this.enableDebugLog&&console.log("[UIManager] Playing prologue from menu:",t),this.playPrologue(t,n,function(){this.enableDebugLog&&console.log("[UIManager] Prologue playback completed:",t)}.bind(this))}else this.enableDebugLog&&console.warn("[UIManager] UI play prologue event missing prologueKey")},UIManager.prototype._handleLevelProloguePlay=function(e){if(e&&e.data){var t=e.levelKey||"level1",n=e.data;this.enableDebugLog&&(console.log("[UIManager] Playing level prologue for:",t),console.log("[UIManager] Level data:",n));var o=n,a=n.options||{};a.overlayEntity=this.overlayElement,a.imageCarouselContainer=this.imageCarouselContainer,a.enableDebugLog=!!this.enableDebugLog,this._changeState(UIManager.UI_STATES.TYPEWRITER),this.playTypingData(o,a,function(){this.app.fire("level:prologue:complete",{levelKey:t})}.bind(this))}else this.enableDebugLog&&console.warn("[UIManager] Level prologue event missing data")},UIManager.prototype.playTypingData=function(e,t,n){t=t||{},console.log("[UIManager] playTypingData called, onComplete:",!!n);try{if("undefined"!=typeof UiTypingAnimation&&UiTypingAnimation.createPlayer){this._typingPlayer&&"done"!==this._typingPlayer.state&&this._typingPlayer.skip(),this._typingPlayer=UiTypingAnimation.createPlayer(this.app,this.textElement,e,t);this._typingPlayer.play((function(){if(console.log("[UIManager] Typewriter animation completed, calling onComplete"),n)try{n()}catch(e){console.error("[UIManager] onComplete callback failed:",e)}else console.warn("[UIManager] No onComplete callback provided")})),this.textElement&&this.textElement.element&&(this.textElement.element.opacity=1),this.overlayElement&&this.overlayElement.element&&(this.overlayElement.element.opacity=1),this.currentState!==UIManager.UI_STATES.TYPEWRITER&&this.currentState!==UIManager.UI_STATES.FIRST_TIME_INTRO&&this._changeState(UIManager.UI_STATES.TYPEWRITER)}else console.warn("[UIManager] UiTypingAnimation not available"),n&&n()}catch(e){console.warn("[UIManager] playTypingData failed:",e),n&&n()}},UIManager.prototype._updateTypewriter=function(){},UIManager.prototype._speedUpTypewriter=function(e){this.currentState!==UIManager.UI_STATES.TYPEWRITER&&this.currentState!==UIManager.UI_STATES.FIRST_TIME_INTRO||this._typingPlayer&&"done"!==this._typingPlayer.state&&(this._typingPlayer.setSpeedMultiplier(e?5:1),this._isSpeedingUp=e,this.enableDebugLog&&console.log("[UIManager] Typewriter speed:",e?"5x":"1x","state:",this.currentState))},UIManager.prototype._skipTypewriter=function(){this.currentState!==UIManager.UI_STATES.TYPEWRITER&&this.currentState!==UIManager.UI_STATES.FIRST_TIME_INTRO||this._typingPlayer&&"done"!==this._typingPlayer.state&&(this._typingPlayer.skip(),this.enableDebugLog&&console.log("[UIManager] Typewriter skipped, state:",this.currentState))},UIManager.prototype._startFadeTransition=function(){this._finishFirstTimeIntro()},UIManager.prototype._finishFirstTimeIntro=function(){try{"undefined"!=typeof GlobalGame&&GlobalGame.markPrologueVisited&&(GlobalGame.markPrologueVisited("welcome"),this.enableDebugLog&&console.log("[UIManager] Marked welcome prologue as visited"))}catch(e){this.enableDebugLog&&console.warn("[UIManager] Failed to mark prologue visited:",e)}this._changeState(UIManager.UI_STATES.NORMAL);var e=this;setTimeout((function(){try{e.app.fire("player:set_sitting",!0),console.log("[UIManager] Maintained player sitting state after prologue (100ms)");var t="undefined"!=typeof GlobalCameraManager?GlobalCameraManager.getInstance():null;t&&(t.setState(GlobalCameraManager.CONTROL_STATES.LOCKED_MULTI),t.snapToMainMenu(),console.log("[UIManager] Camera state applied: LOCKED_MULTI (100ms)"))}catch(e){console.warn("[UIManager] Failed to apply state (100ms):",e)}}),100),setTimeout((function(){try{e.app.fire("player:set_sitting",!0),console.log("[UIManager] Re-confirmed player sitting state (200ms)");var t="undefined"!=typeof GlobalCameraManager?GlobalCameraManager.getInstance():null;t&&(t.setState(GlobalCameraManager.CONTROL_STATES.LOCKED_MULTI),t.snapToMainMenu(),console.log("[UIManager] Re-confirmed camera LOCKED_MULTI (200ms)"))}catch(e){console.warn("[UIManager] Failed to apply state (200ms):",e)}}),200),setTimeout((function(){try{e.app.fire("player:set_sitting",!0),console.log("[UIManager] Final confirmation - player sitting state (600ms)");var t="undefined"!=typeof GlobalCameraManager?GlobalCameraManager.getInstance():null;t&&(t.setState(GlobalCameraManager.CONTROL_STATES.LOCKED_MULTI),t.snapToMainMenu(),console.log("[UIManager] Final confirmation - camera LOCKED_MULTI (600ms)"))}catch(e){console.warn("[UIManager] Failed to apply state (600ms):",e)}}),600),this._hideAllUI(),this.app.fire("ui:first_time_intro_complete")},UIManager.prototype._hideAllUI=function(){this.overlayElement&&this.overlayElement.element&&(this.overlayElement.element.opacity=0),this.blackOverlayElement&&this.blackOverlayElement.element&&(this.blackOverlayElement.element.opacity=0),this.textElement&&this.textElement.element&&(this.textElement.element.text="")},UIManager.prototype.showRightHint=function(e,t){try{if("undefined"!=typeof RightHint&&RightHint.show){RightHint.configure&&RightHint.configure({panel:this.rightHintPanel,text:this.rightHintText,key:this.rightHintKeyText,debug:this.enableDebugLog});var n=t||{};return void 0===n.slideMs&&(n.slideMs=0|this.rightHintShowMs||160),void RightHint.show(e,n)}}catch(e){this.enableDebugLog&&console.warn("[UIManager.showRightHint] RightHint error:",e)}this.enableDebugLog&&console.warn("[UIManager.showRightHint] RightHint not available")},UIManager.prototype.hideRightHint=function(e){try{if("undefined"!=typeof RightHint&&RightHint.hide){RightHint.configure&&RightHint.configure({panel:this.rightHintPanel,text:this.rightHintText,key:this.rightHintKeyText,debug:this.enableDebugLog});var t=e||{};return void 0===t.slideMs&&(t.slideMs=0|this.rightHintHideMs||140),void RightHint.hide(t)}}catch(e){this.enableDebugLog&&console.warn("[UIManager.hideRightHint] RightHint error:",e)}},UIManager.prototype._changeState=function(e){if(this.currentState!==e){var t=this.currentState;this.currentState=e,console.log("[UIManager] State changed:",t,"->",e),console.log("[UIManager] Firing ui:state_changed event with data:",{from:t,to:e}),this.app.fire("ui:state_changed",{from:t,to:e})}},UIManager.prototype.playPrologue=function(e,t,n){if(!e)return this.enableDebugLog&&console.warn("[UIManager] playPrologue: prologueKey is required"),void(n&&n());t=t||{};var o=this;this.enableDebugLog&&console.log("[UIManager] Playing prologue:",e);var a=null,i=null;try{"undefined"!=typeof I18n&&(a=I18n.getTypingData("prologue",e),i=I18n.getTypingOptions("prologue",e+"Options"))}catch(t){this.enableDebugLog&&console.warn("[UIManager] Failed to get i18n data for:",e,t)}if(!a||!a.typeLines||!a.typeLines.length)return this.enableDebugLog&&console.warn("[UIManager] No prologue data found for:",e),void(n&&n());var s=a,r=i||{};r.overlayEntity=this.overlayElement,r.imageCarouselContainer=this.imageCarouselContainer,r.enableDebugLog=!!this.enableDebugLog,this._changeState(UIManager.UI_STATES.TYPEWRITER),this.playTypingData(s,r,(function(){try{"undefined"!=typeof GlobalGame&&GlobalGame.markPrologueVisited&&(GlobalGame.markPrologueVisited(e),o.enableDebugLog&&console.log("[UIManager] Marked prologue as visited:",e))}catch(e){o.enableDebugLog&&console.warn("[UIManager] Failed to mark prologue visited:",e)}console.log("[UIManager] Prologue completed, switching to NORMAL state"),o._changeState(UIManager.UI_STATES.NORMAL),o.app.fire("prologue:complete",{prologueKey:e}),n&&n()}))},UIManager.prototype.playLevelPrologue=function(e,t){if(!e||""===e.trim())return this.enableDebugLog&&console.warn("[UIManager] playLevelPrologue: prologueKey is empty"),void(t&&t());this.enableDebugLog&&console.log("[UIManager] playLevelPrologue called with key:",e),this.playPrologue(e,{},t)},UIManager.prototype.setControlState=function(e){var t=GlobalCameraManager.getInstance();if(t){var n=GlobalCameraManager.CONTROL_STATES,o=e;"string"==typeof o&&(o=n[o]||o),o||(o=n.LOCKED_MULTI),t.setState(o)}else this.enableDebugLog&&console.warn("[UIManager] setControlState ignored: no GlobalCameraManager")},UIManager.prototype._initEscConfirmUI=function(){var e=this;if(this.enableDebugLog&&console.log("[UIManager] _initEscConfirmUI starting..."),this.escConfirmPanel&&this.escConfirmText&&this.escConfirmYesButton&&this.escConfirmNoButton)this.enableDebugLog&&console.log("[UIManager] ESC confirm UI already initialized, skipping...");else try{this.escConfirmPanel=new pc.Entity("EscConfirmPanel"),this.escConfirmPanel.addComponent("element",{type:pc.ELEMENTTYPE_IMAGE,anchor:new pc.Vec4(0,0,1,1),pivot:new pc.Vec2(.5,.5),margin:new pc.Vec4(0,0,0,0),color:this._hexToColor("#FCFBDB"),opacity:.9,drawOrder:9e3,useInput:!0}),this.entity.addChild(this.escConfirmPanel),this.escConfirmDialog=new pc.Entity("EscConfirmDialog"),this.escConfirmDialog.addComponent("element",{type:pc.ELEMENTTYPE_IMAGE,anchor:new pc.Vec4(.5,.5,.5,.5),pivot:new pc.Vec2(.5,.5),width:400,height:200,color:new pc.Color(.3,.3,.3,.95),opacity:1,drawOrder:9001}),this.escConfirmPanel.addChild(this.escConfirmDialog),this.escConfirmText=new pc.Entity("EscConfirmText"),this.escConfirmText.addComponent("element",{type:pc.ELEMENTTYPE_TEXT,anchor:new pc.Vec4(.5,.7,.5,.7),pivot:new pc.Vec2(.5,.5),width:350,height:60,fontSize:20,color:new pc.Color(1,1,1,1),text:"是否回到心灵彼岸？",alignment:new pc.Vec2(.5,.5),wrapLines:!0,drawOrder:9002,autoWidth:!1,autoHeight:!1,fontAsset:null,useInput:!1});try{if(this.escConfirmFont)this.escConfirmText.element.fontAsset=this.escConfirmFont,this.enableDebugLog&&console.log("[UIManager] Using custom font for confirm text");else(t=this.app.assets.filter((function(e){return"font"===e.type}))).length>0?(this.escConfirmText.element.fontAsset=t[0].id,this.enableDebugLog&&console.log("[UIManager] Using first available font:",t[0].name)):(this.escConfirmText.element.fontAsset=null,this.enableDebugLog&&console.log("[UIManager] No fonts available, using default"));setTimeout((function(){e.escConfirmText&&e.escConfirmText.element&&(e.escConfirmText.element.text="是否回到心灵彼岸？",e.enableDebugLog&&console.log("[UIManager] Text refreshed:",e.escConfirmText.element.text))}),100)}catch(e){this.enableDebugLog&&console.warn("[UIManager] Failed to set font for ESC confirm text:",e)}this.escConfirmDialog.addChild(this.escConfirmText),this.escConfirmYesButton=new pc.Entity("EscConfirmYesButton"),this.escConfirmYesButton.addComponent("element",{type:pc.ELEMENTTYPE_IMAGE,anchor:new pc.Vec4(.3,.3,.3,.3),pivot:new pc.Vec2(.5,.5),width:120,height:40,color:new pc.Color(.2,.6,.2,1),opacity:1,drawOrder:9003,useInput:!0}),this.escConfirmYesButton.addComponent("button",{imageEntity:this.escConfirmYesButton,hitPadding:new pc.Vec4(10,10,10,10),transitionMode:pc.BUTTON_TRANSITION_MODE_TINT,hoverTint:new pc.Color(.3,.7,.3,1),pressedTint:new pc.Color(.1,.5,.1,1),inactiveTint:new pc.Color(.2,.6,.2,1),active:!0}),this.escConfirmDialog.addChild(this.escConfirmYesButton),this.escConfirmYesText=new pc.Entity("EscConfirmYesText"),this.escConfirmYesText.addComponent("element",{type:pc.ELEMENTTYPE_TEXT,anchor:new pc.Vec4(.5,.5,.5,.5),pivot:new pc.Vec2(.5,.5),width:100,height:30,fontSize:16,color:new pc.Color(1,1,1,1),text:"是",alignment:new pc.Vec2(.5,.5),drawOrder:9004,fontAsset:null});try{if(this.escConfirmFont)this.escConfirmYesText.element.fontAsset=this.escConfirmFont;else(t=this.app.assets.filter((function(e){return"font"===e.type}))).length>0&&(this.escConfirmYesText.element.fontAsset=t[0].id);setTimeout((function(){e.escConfirmYesText&&e.escConfirmYesText.element&&(e.escConfirmYesText.element.text="是")}),100)}catch(e){}this.escConfirmYesButton.addChild(this.escConfirmYesText),this.escConfirmNoButton=new pc.Entity("EscConfirmNoButton"),this.escConfirmNoButton.addComponent("element",{type:pc.ELEMENTTYPE_IMAGE,anchor:new pc.Vec4(.7,.3,.7,.3),pivot:new pc.Vec2(.5,.5),width:120,height:40,color:new pc.Color(.6,.2,.2,1),opacity:1,drawOrder:9003,useInput:!0}),this.escConfirmNoButton.addComponent("button",{imageEntity:this.escConfirmNoButton,hitPadding:new pc.Vec4(10,10,10,10),transitionMode:pc.BUTTON_TRANSITION_MODE_TINT,hoverTint:new pc.Color(.7,.3,.3,1),pressedTint:new pc.Color(.5,.1,.1,1),inactiveTint:new pc.Color(.6,.2,.2,1),active:!0}),this.escConfirmDialog.addChild(this.escConfirmNoButton),this.escConfirmNoText=new pc.Entity("EscConfirmNoText"),this.escConfirmNoText.addComponent("element",{type:pc.ELEMENTTYPE_TEXT,anchor:new pc.Vec4(.5,.5,.5,.5),pivot:new pc.Vec2(.5,.5),width:100,height:30,fontSize:16,color:new pc.Color(1,1,1,1),text:"否",alignment:new pc.Vec2(.5,.5),drawOrder:9004,fontAsset:null});try{var t;if(this.escConfirmFont)this.escConfirmNoText.element.fontAsset=this.escConfirmFont;else(t=this.app.assets.filter((function(e){return"font"===e.type}))).length>0&&(this.escConfirmNoText.element.fontAsset=t[0].id);setTimeout((function(){e.escConfirmNoText&&e.escConfirmNoText.element&&(e.escConfirmNoText.element.text="否")}),100)}catch(e){}this.escConfirmNoButton.addChild(this.escConfirmNoText),this.escConfirmYesButton.element.on("click",(function(){e.enableDebugLog&&console.log("[UIManager] Yes button clicked (element event)"),e._onEscConfirmYes()})),this.escConfirmYesButton.element.on("mouseenter",(function(){e.enableDebugLog&&console.log("[UIManager] Yes button mouse enter (element event)")})),this.escConfirmYesButton.element.on("mousedown",(function(){e.enableDebugLog&&console.log("[UIManager] Yes button mouse down (element event)")})),this.escConfirmYesButton.element.on("mouseup",(function(){e.enableDebugLog&&console.log("[UIManager] Yes button mouse up (element event)")})),this.escConfirmNoButton.element.on("click",(function(){e.enableDebugLog&&console.log("[UIManager] No button clicked (element event)"),e._onEscConfirmNo()})),this.escConfirmNoButton.element.on("mouseenter",(function(){e.enableDebugLog&&console.log("[UIManager] No button mouse enter (element event)")})),this.escConfirmPanel.enabled=!1,this.enableDebugLog&&(console.log("[UIManager] ESC confirm UI created dynamically"),console.log("[UIManager] Panel entity:",this.escConfirmPanel),console.log("[UIManager] Dialog entity:",this.escConfirmDialog),console.log("[UIManager] Text entity:",this.escConfirmText),console.log("[UIManager] Yes button entity:",this.escConfirmYesButton),console.log("[UIManager] No button entity:",this.escConfirmNoButton),console.log("[UIManager] Text element text:",this.escConfirmText.element.text),console.log("[UIManager] Yes button has button component:",!!this.escConfirmYesButton.button),console.log("[UIManager] No button has button component:",!!this.escConfirmNoButton.button),console.log("[UIManager] Root entity has screen component:",!!this.entity.screen),console.log("[UIManager] Panel parent entity:",this.escConfirmPanel.parent),console.log("[UIManager] Panel enabled:",this.escConfirmPanel.enabled),window.testEscUI=function(){console.log("[TEST] Showing ESC confirm dialog"),e._showEscConfirm()},window.forceShowText=function(){console.log("[TEST] Force showing text"),e.escConfirmText.element.text="TEST TEXT",e.escConfirmText.element.fontSize=30,e.escConfirmText.element.color=new pc.Color(1,0,0,1),e.escConfirmPanel.enabled=!0},window.testButtonClick=function(){console.log("[TEST] Manual button click"),e._onEscConfirmYes()},window.testSimpleEscUI=function(){console.log("[TEST] Creating simple ESC UI");try{var t=new pc.Entity("SimpleEscPanel");t.addComponent("element",{type:pc.ELEMENTTYPE_IMAGE,anchor:[0,0,1,1],pivot:[.5,.5],color:new pc.Color(0,0,0,.8),useInput:!0});var n=new pc.Entity("SimpleEscText");n.addComponent("element",{type:pc.ELEMENTTYPE_TEXT,anchor:[.5,.5,.5,.5],pivot:[.5,.5],text:"ESC TEST - Press any key to close",fontSize:24,color:new pc.Color(1,1,1,1)}),t.addChild(n),e.entity.addChild(t),t.element.on("click",(function(){t.destroy()})),console.log("[TEST] Simple ESC UI created successfully")}catch(e){console.error("[TEST] Failed to create simple ESC UI:",e)}},console.log("[UIManager] Added test methods: testEscUI(), forceShowText(), testButtonClick(), testSimpleEscUI()"))}catch(e){if(console.error("[UIManager] Error in _initEscConfirmUI:",e),console.error("[UIManager] Stack trace:",e.stack),this.escConfirmPanel)try{this.escConfirmPanel.destroy()}catch(e){}this.escConfirmPanel=null,this.escConfirmDialog=null,this.escConfirmText=null,this.escConfirmYesButton=null,this.escConfirmYesText=null,this.escConfirmNoButton=null,this.escConfirmNoText=null}},UIManager.prototype._getEscConfirmText=function(){var e="是否回到心灵彼岸？";try{if("undefined"!=typeof I18n&&I18n.get){var t=I18n.get("ui","esc_confirm_text");t&&(e=t)}}catch(e){}return e},UIManager.prototype._getYesText=function(){var e="是";try{if("undefined"!=typeof I18n&&I18n.get){var t=I18n.get("ui","yes");t&&(e=t)}}catch(e){}return e},UIManager.prototype._getNoText=function(){var e="否";try{if("undefined"!=typeof I18n&&I18n.get){var t=I18n.get("ui","no");t&&(e=t)}}catch(e){}return e},UIManager.prototype._hexToColor=function(e){e=e.replace("#","");var t=parseInt(e.substring(0,2),16)/255,n=parseInt(e.substring(2,4),16)/255,o=parseInt(e.substring(4,6),16)/255;return new pc.Color(t,n,o,1)},UIManager.prototype._handleEscKey=function(){if(this.currentState!==UIManager.UI_STATES.ESC_CONFIRM){var e="";try{"undefined"!=typeof GlobalGame&&GlobalGame.getCurrentScene?e=GlobalGame.getCurrentScene()||"":this.app.scene&&this.app.scene.name&&(e=this.app.scene.name)}catch(e){}"start"!==e.toLowerCase()&&"main"!==e.toLowerCase()&&this.currentState!==UIManager.UI_STATES.FIRST_TIME_INTRO&&this.currentState!==UIManager.UI_STATES.FADE_TRANSITION&&this._showEscConfirm()}else this._hideEscConfirm()},UIManager.prototype._showEscConfirm=function(){if(this.enableDebugLog&&(console.log("[UIManager] _showEscConfirm called"),console.log("[UIManager] escConfirmPanel exists:",!!this.escConfirmPanel)),!(this.escConfirmPanel&&this.escConfirmText&&this.escConfirmYesButton&&this.escConfirmNoButton)){this.enableDebugLog&&(console.log("[UIManager] ESC confirm UI elements missing, reinitializing..."),console.log("[UIManager] Missing elements:",{panel:!!this.escConfirmPanel,text:!!this.escConfirmText,yesButton:!!this.escConfirmYesButton,noButton:!!this.escConfirmNoButton}));try{this._initEscConfirmUI()}catch(e){return void(this.enableDebugLog&&console.error("[UIManager] Failed to reinitialize ESC confirm UI:",e))}}if(this.escConfirmPanel&&this.escConfirmText&&this.escConfirmYesButton&&this.escConfirmNoButton){this._previousState=this.currentState,this._changeState(UIManager.UI_STATES.ESC_CONFIRM),this.escConfirmPanel.enabled=!0,this.escConfirmYesButton&&this.escConfirmYesButton.button&&(this.escConfirmYesButton.button.active=!0,this.enableDebugLog&&console.log("[UIManager] Yes button reactivated")),this.escConfirmNoButton&&this.escConfirmNoButton.button&&(this.escConfirmNoButton.button.active=!0,this.enableDebugLog&&console.log("[UIManager] No button reactivated"));try{this.app.fire("player:set_sitting",!0),this.enableDebugLog&&console.log("[UIManager] Player locked for ESC confirm")}catch(e){}try{var e=GlobalCameraManager.getInstance();e?e.setState(GlobalCameraManager.CONTROL_STATES.LOCKED_MULTI):this.app.fire("ui:control:set","LOCKED_MULTI"),this.enableDebugLog&&console.log("[UIManager] Camera locked for ESC confirm")}catch(e){}if(this.enableDebugLog){console.log("[UIManager] ESC confirm dialog shown");try{console.log("[UIManager] Panel enabled:",this.escConfirmPanel?this.escConfirmPanel.enabled:"undefined"),console.log("[UIManager] Dialog enabled:",this.escConfirmDialog?this.escConfirmDialog.enabled:"undefined"),console.log("[UIManager] Text enabled:",this.escConfirmText?this.escConfirmText.enabled:"undefined"),this.escConfirmText&&this.escConfirmText.element?(console.log("[UIManager] Text content:",this.escConfirmText.element.text),console.log("[UIManager] Text color:",this.escConfirmText.element.color),console.log("[UIManager] Text fontSize:",this.escConfirmText.element.fontSize),console.log("[UIManager] Text fontAsset:",this.escConfirmText.element.fontAsset),console.log("[UIManager] Text drawOrder:",this.escConfirmText.element.drawOrder),console.log("[UIManager] Text world position:",this.escConfirmText.getPosition())):console.log("[UIManager] Text element is undefined"),this.escConfirmYesButton&&(console.log("[UIManager] Yes button enabled:",this.escConfirmYesButton.enabled),this.escConfirmYesButton.button&&console.log("[UIManager] Yes button active:",this.escConfirmYesButton.button.active),this.escConfirmYesButton.element&&(console.log("[UIManager] Yes button element anchor:",this.escConfirmYesButton.element.anchor),console.log("[UIManager] Yes button element width/height:",this.escConfirmYesButton.element.width,this.escConfirmYesButton.element.height)),console.log("[UIManager] Yes button world position:",this.escConfirmYesButton.getPosition())),this.escConfirmNoButton&&(console.log("[UIManager] No button enabled:",this.escConfirmNoButton.enabled),this.escConfirmNoButton.button&&console.log("[UIManager] No button active:",this.escConfirmNoButton.button.active),console.log("[UIManager] No button world position:",this.escConfirmNoButton.getPosition())),this.escConfirmPanel&&this.escConfirmPanel.element&&(console.log("[UIManager] Panel drawOrder:",this.escConfirmPanel.element.drawOrder),console.log("[UIManager] Panel world position:",this.escConfirmPanel.getPosition())),this.escConfirmDialog&&this.escConfirmDialog.element&&(console.log("[UIManager] Dialog drawOrder:",this.escConfirmDialog.element.drawOrder),console.log("[UIManager] Dialog world position:",this.escConfirmDialog.getPosition())),this.entity&&this.entity.screen&&(console.log("[UIManager] Screen camera:",this.entity.screen.camera),console.log("[UIManager] Screen resolution:",this.entity.screen.resolution),console.log("[UIManager] Screen scale mode:",this.entity.screen.scaleMode))}catch(e){console.error("[UIManager] Error in debug logging:",e)}}}else this.enableDebugLog&&console.error("[UIManager] ESC confirm UI initialization failed! Elements still missing:",{panel:!!this.escConfirmPanel,text:!!this.escConfirmText,yesButton:!!this.escConfirmYesButton,noButton:!!this.escConfirmNoButton})},UIManager.prototype._hideEscConfirm=function(){if(this.escConfirmPanel){this.escConfirmPanel.enabled=!1,this._previousState?(this._changeState(this._previousState),this._previousState=null):this._changeState(UIManager.UI_STATES.NORMAL);try{this.app.fire("player:set_sitting",!1),this.enableDebugLog&&console.log("[UIManager] Player unlocked after ESC confirm")}catch(e){}try{var e=GlobalCameraManager.getInstance();e?e.setState(GlobalCameraManager.CONTROL_STATES.FREE_FOLLOW):this.app.fire("ui:control:set","FREE_FOLLOW"),this.enableDebugLog&&console.log("[UIManager] Camera unlocked after ESC confirm")}catch(e){}this.enableDebugLog&&console.log("[UIManager] ESC confirm dialog hidden")}},UIManager.prototype._onEscConfirmYes=function(){this.enableDebugLog&&console.log("[UIManager] ESC confirm YES clicked - returning to Start scene"),this._hideEscConfirm();try{"undefined"!=typeof GlobalGame&&GlobalGame.loadScene?GlobalGame.loadScene("Start",(function(e){e?console.error("[UIManager] Failed to load Start scene:",e):console.log("[UIManager] Successfully returned to Start scene")})):this.app.scenes.changeScene("Start")}catch(e){console.error("[UIManager] Error loading Start scene:",e)}},UIManager.prototype._onEscConfirmNo=function(){this.enableDebugLog&&console.log("[UIManager] ESC confirm NO clicked - staying in current scene"),this._hideEscConfirm()},UIManager.prototype.destroy=function(){console.log("[UIManager] Destroying instance..."),UIManager._instance===this&&(UIManager._instance=null),this.app.off("gamestate:changed"),this._onDialogueBegin&&this.app.off("ui:dialogue:begin",this._onDialogueBegin,this),this._onDialogueEnd&&this.app.off("ui:dialogue:end",this._onDialogueEnd,this),this._onLevelProloguePlay&&this.app.off("level:prologue:play",this._onLevelProloguePlay,this),this._onUIPlayPrologue&&this.app.off("ui:play:prologue",this._onUIPlayPrologue,this),this._onUiControlSet&&this.app.off("ui:control:set",this._onUiControlSet,this),this._onUiHintShow&&this.app.off("ui:hint:show",this._onUiHintShow,this),this._onUiHintHide&&this.app.off("ui:hint:hide",this._onUiHintHide,this),this.onKeyDown&&this.app.keyboard.off(pc.EVENT_KEYDOWN,this.onKeyDown,this),this.onKeyUp&&this.app.keyboard.off(pc.EVENT_KEYUP,this.onKeyUp,this),this.onMouseDown&&this.app.mouse.off(pc.EVENT_MOUSEDOWN,this.onMouseDown,this),this.onMouseUp&&this.app.mouse.off(pc.EVENT_MOUSEUP,this.onMouseUp,this),this.app.touch&&(this.onTouchStart&&this.app.touch.off(pc.EVENT_TOUCHSTART,this.onTouchStart,this),this.onTouchEnd&&this.app.touch.off(pc.EVENT_TOUCHEND,this.onTouchEnd,this)),console.log("[UIManager] All event listeners unbound"),this.escConfirmYesButton&&this.escConfirmYesButton.element&&(this.escConfirmYesButton.element.off("click"),this.escConfirmYesButton.element.off("mouseenter"),this.escConfirmYesButton.element.off("mousedown"),this.escConfirmYesButton.element.off("mouseup")),this.escConfirmNoButton&&this.escConfirmNoButton.element&&(this.escConfirmNoButton.element.off("click"),this.escConfirmNoButton.element.off("mouseenter")),this.escConfirmPanel&&(this.escConfirmPanel.destroy(),this.escConfirmPanel=null),this.escConfirmDialog=null,this.escConfirmText=null,this.escConfirmYesButton=null,this.escConfirmYesText=null,this.escConfirmNoButton=null,this.escConfirmNoText=null};var UiTypingAnimation=pc.createScript("uiTypingAnimation");function _hexColor(t){if(!t||"string"!=typeof t)return new pc.Color(0,0,0,1);var e=t.trim();if("#"===e[0]&&(e=e.substring(1)),6!==e.length)return new pc.Color(0,0,0,1);var i=parseInt(e.substring(0,2),16)/255,n=parseInt(e.substring(2,4),16)/255,a=parseInt(e.substring(4,6),16)/255;return new pc.Color(i,n,a,1)}function TypingPlayer(t,e,i,n){this.app=t,this.textEntity=e,this.data=i||{typeLines:[]},this.opts=n||{},this.defaultCharMs=this.opts.defaultCharMs||50,this.lineGapMs=this.opts.lineGapMs||300,this.fontAssetNormal=this.opts.fontAssetNormal||null,this.fontAssetBold=this.opts.fontAssetBold||null,this.debug=!!this.opts.enableDebugLog,this.overlayEntity=this.opts.overlayEntity||null,this.bgHexColor=this.opts.bgHexColor||"#FCFBDB",this.bgFadeOutMs=(0|this.opts.bgFadeOutMs)>0?0|this.opts.bgFadeOutMs:1500,this.imageCarouselContainer=this.opts.imageCarouselContainer||null,this.maxImageWidth="number"==typeof this.opts.maxImageWidth?this.opts.maxImageWidth:1200,this.maxImageHeight="number"==typeof this.opts.maxImageHeight?this.opts.maxImageHeight:400,this.debug&&(console.log("[TypingPlayer] Constructor - imageCarouselContainer from opts:",this.imageCarouselContainer),console.log("[TypingPlayer] Constructor - maxImageWidth:",this.maxImageWidth,"maxImageHeight:",this.maxImageHeight),console.log("[TypingPlayer] Constructor - debug enabled:",this.debug),this.imageCarouselContainer||(console.warn("[TypingPlayer] ⚠️ imageCarouselContainer is NULL! Image carousel will not work."),console.warn("[TypingPlayer] 📋 To fix: In PlayCanvas Editor, set UIManager.imageCarouselContainer to an Entity with Image Element component"))),this.lineIndex=0,this.charIndex=0,this.timerMs=0,this.state="idle",this._onComplete=null,this._updateCb=this._onUpdate.bind(this),this._tweenCb=null,this.outputPrefix="",this.speedMultiplier=1,this.pendingClear=!1,this.nextOutputPrefix="",this.baseLocalPos=e?e.getLocalPosition().clone():new pc.Vec3,this.currentFullWidth=0,this.swayAmpX="number"==typeof this.opts.swayAmpX?this.opts.swayAmpX:10,this.swayAmpY="number"==typeof this.opts.swayAmpY?this.opts.swayAmpY:5,this.swaySpeed="number"==typeof this.opts.swaySpeed?this.opts.swaySpeed:.3,this._elapsed=0,this.widthFactorAscii="number"==typeof this.opts.widthFactorAscii?this.opts.widthFactorAscii:.6,this.widthFactorCJK="number"==typeof this.opts.widthFactorCJK?this.opts.widthFactorCJK:1}UiTypingAnimation.attributes.add("fontAssetNormal",{type:"asset",assetType:"font",title:"普通字体"}),UiTypingAnimation.attributes.add("fontAssetBold",{type:"asset",assetType:"font",title:"粗体字体(可选)"}),UiTypingAnimation.attributes.add("defaultCharMs",{type:"number",default:50,title:"默认每字耗时(ms)"}),UiTypingAnimation.attributes.add("lineGapMs",{type:"number",default:300,title:"行间停顿(ms)"}),UiTypingAnimation.attributes.add("enableDebugLog",{type:"boolean",default:!1,title:"调试日志"}),UiTypingAnimation._instance=null,UiTypingAnimation.getInstance=function(){return UiTypingAnimation._instance},UiTypingAnimation.prototype.initialize=function(){UiTypingAnimation._instance=this},TypingPlayer.prototype._applyLineStyle=function(t){if(this.textEntity&&this.textEntity.element){var e=this.textEntity.element;if(t){"number"==typeof t.size&&t.size>0&&(e.fontSize=t.size);var i=_hexColor(t.color||"#000000");e.color&&e.color.set?e.color.set(i.r,i.g,i.b,i.a):e.color=i,t.bold&&this.fontAssetBold?e.fontAsset=this.fontAssetBold.id||this.fontAssetBold:this.fontAssetNormal&&(e.fontAsset=this.fontAssetNormal.id||this.fontAssetNormal)}}},TypingPlayer.prototype._showImage=function(t,e){if(this.debug&&console.log("[TypingPlayer] _showImage called, imageName=",t,"useFadeIn=",e,"container=",this.imageCarouselContainer),this.imageCarouselContainer)if(t){var i=this,n=t;this.debug&&console.log("[TypingPlayer] Searching for asset:",n);var a=this.app.assets.find(n,"texture");if(a)this.debug&&console.log("[TypingPlayer] Asset found:",a.name,"loaded=",!!a.resource),a.resource?this._createImageEntity(a,e):(this.debug&&console.log("[TypingPlayer] Loading asset:",a.name),a.ready((function(){i.debug&&console.log("[TypingPlayer] Asset loaded, creating entity"),i._createImageEntity(a,e)})),this.app.assets.load(a));else if(this.debug&&console.warn("[TypingPlayer] Image asset not found:",n),this.debug){var s=this.app.assets.filter((function(t){return"texture"===t.type}));console.log("[TypingPlayer] Available texture assets:",s.map((function(t){return t.name})))}}else this.debug&&console.log("[TypingPlayer] imageName is empty, skipping image display");else this.debug&&console.warn("[TypingPlayer] imageCarouselContainer is null, cannot show image")},TypingPlayer.prototype._createImageEntity=function(t,e){if(this.debug&&console.log("[TypingPlayer] _createImageEntity called, asset=",t.name,"useFadeIn=",e),this.imageCarouselContainer)if(this.imageCarouselContainer.element){var i=this.imageCarouselContainer.element;i.type===pc.ELEMENTTYPE_IMAGE?(this.debug&&console.log("[TypingPlayer] Setting texture asset to container element"),i.textureAsset=t,i.texture=t.resource,this._resizeImageToFit(i,t.resource),this.imageCarouselContainer.enabled||(this.imageCarouselContainer.enabled=!0),e?(i.opacity=0,this._fadeInImage(this.imageCarouselContainer),this.debug&&console.log("[TypingPlayer] Image shown with fade in:",t.name)):(i.opacity=1,this.debug&&console.log("[TypingPlayer] Image shown directly (no fade):",t.name))):this.debug&&console.warn("[TypingPlayer] imageCarouselContainer element is not an IMAGE type, type=",i.type)}else this.debug&&console.warn("[TypingPlayer] imageCarouselContainer does not have an element component");else this.debug&&console.warn("[TypingPlayer] imageCarouselContainer is null in _createImageEntity")},TypingPlayer.prototype._resizeImageToFit=function(t,e){if(t&&e){var i=e.width||1,n=e.height||1;this.debug&&console.log("[TypingPlayer] Original texture size:",i,"x",n);var a=this.maxImageHeight,s=i/n,o=Math.floor(a*s);t.width=o,t.height=a,this.debug&&console.log("[TypingPlayer] Resized to:",o,"x",a,"aspectRatio:",s.toFixed(3))}},TypingPlayer.prototype._fadeInImage=function(t){if(t&&t.element){var e=t.element,i=0,n=this,fadeIn=function(t){i+=1e3*t;var a=Math.min(1,i/500);e.opacity=a,a>=1&&n.app.off("update",fadeIn)};this.app.on("update",fadeIn)}},TypingPlayer.prototype._clearImage=function(t){if(this.imageCarouselContainer&&this.imageCarouselContainer.element){var e=this.imageCarouselContainer.element,i=this;if(t)return e.opacity=0,e.textureAsset=null,e.texture=null,void(this.debug&&console.log("[TypingPlayer] Image cleared immediately"));var n=0,a=e.opacity||1,fadeOut=function(t){n+=1e3*t;var s=Math.min(1,n/500);e.opacity=a*(1-s),s>=1&&(i.app.off("update",fadeOut),e.textureAsset=null,e.texture=null,i.debug&&console.log("[TypingPlayer] Image cleared with fade"))};this.app.on("update",fadeOut)}},TypingPlayer.prototype._prepareOverlay=function(){var t=this.overlayEntity;if(t&&t.element&&t.element.type===pc.ELEMENTTYPE_IMAGE){var e=t.element,i=_hexColor(this.bgHexColor);e.color&&e.color.set?e.color.set(i.r,i.g,i.b,i.a):e.color=i,e.opacity=1;try{e.anchor=new pc.Vec4(0,0,1,1),e.pivot=new pc.Vec2(.5,.5),e.margin=new pc.Vec4(0,0,0,0)}catch(t){}var n=this._ensureWhiteTextureAsset();if(n&&(e.textureAsset=n,e.texture=n.resource),this.textEntity&&this.textEntity.element&&this.textEntity.element.layers)try{e.layers=this.textEntity.element.layers.slice(0)}catch(t){}e.drawOrder=Math.max(0,this.textEntity&&this.textEntity.element?this.textEntity.element.drawOrder-100:900),t.enabled||(t.enabled=!0),t.element&&!1===t.element.enabled&&(t.element.enabled=!0)}},TypingPlayer.prototype._overlayFadeOut=function(t,e){var i=this.overlayEntity;if(i&&i.element){var n=i.element;this._tweenOpacity(n,null!=n.opacity?n.opacity:1,0,Math.max(0,0|t),e)}else e&&e()},TypingPlayer.prototype._tweenOpacity=function(t,e,i,n,a){var s=this,o=0,r=Math.max(0,0|n);if(t.opacity=e,0===r)return t.opacity=i,void(a&&a());var cb=function(n){o+=1e3*n;var l=Math.min(1,o/r);t.opacity=e+(i-e)*l,l>=1&&(s.app.off("update",cb),a&&a())};this.app.on("update",cb),this._tweenCb=cb},TypingPlayer.prototype._ensureWhiteTexture=function(){if(UiTypingAnimation._whiteTexture)return UiTypingAnimation._whiteTexture;try{var t=this.app&&this.app.graphicsDevice;if(!t)return null;var e=document&&document.createElement?document.createElement("canvas"):null;if(!e)return null;e.width=1,e.height=1;var i=e.getContext("2d");i&&(i.clearRect(0,0,1,1),i.fillStyle="#ffffff",i.fillRect(0,0,1,1));var n=new pc.Texture(t,{width:1,height:1,format:pc.PIXELFORMAT_R8_G8_B8_A8});return n.setSource(e),UiTypingAnimation._whiteTexture=n,n}catch(t){return null}},TypingPlayer.prototype._ensureWhiteTextureAsset=function(){if(UiTypingAnimation._whiteTextureAsset)return UiTypingAnimation._whiteTextureAsset;var t=this._ensureWhiteTexture();if(!t)return null;try{var e=new pc.Asset("ui_white_1x1_global","texture",{url:""},{});return e.resource=t,e.loaded=!0,this.app.assets.add(e),UiTypingAnimation._whiteTextureAsset=e,e}catch(t){return null}},TypingPlayer.prototype.play=function(t){if(this.textEntity&&this.textEntity.element){this._onComplete=t||null,this.textEntity.element.text="",this.lineIndex=0,this.charIndex=0,this.timerMs=0,this.state="fade_in",this._applyLineStyle(this.data.typeLines[0]),this._prepareOverlay(),this.outputPrefix="",this.pendingClear=!1,this.nextOutputPrefix="",this._elapsed=0;try{this.textEntity.element.alignment=new pc.Vec2(.5,.5),this.textEntity.setLocalPosition(this.baseLocalPos.x,this.baseLocalPos.y,this.baseLocalPos.z),this.textEntity.element.opacity=0}catch(t){}this.overlayEntity&&this.overlayEntity.element&&(this.overlayEntity.element.opacity=0),this._updateLineFullWidth(this._currentLine());var e=this,i=800;this.debug&&console.log("[TypingPlayer] Starting fade in animation"),this.overlayEntity&&this.overlayEntity.element&&this._tweenOpacity(this.overlayEntity.element,0,1,i),setTimeout((function(){e.textEntity&&e.textEntity.element&&e._tweenOpacity(e.textEntity.element,0,1,480,(function(){e.state="typing",e.debug&&console.log("[TypingPlayer] Fade in complete, starting typing")}))}),160);var n=this._currentLine();n&&n.imageName&&setTimeout((function(){e.debug&&console.log("[TypingPlayer] Showing first image after fade in:",n.imageName),e._showImage(n.imageName,n.clearImage)}),400),this.app.on("update",this._updateCb)}},TypingPlayer.prototype.setSpeedMultiplier=function(t){this.speedMultiplier=Math.max(1,t||1),this.debug&&console.log("[TypingPlayer] Speed multiplier set to:",this.speedMultiplier)},TypingPlayer.prototype.skip=function(){if(this.textEntity&&this.textEntity.element){for(var t=this.textEntity.element,e="",i=0;i<this.data.typeLines.length;i++)e+=(i>0?"\n":"")+(this.data.typeLines[i].text||"");this._applyLineStyle(this.data.typeLines[this.data.typeLines.length-1]),t.text=e;var n=this.data.typeLines[this.data.typeLines.length-1];n&&n.imageName&&this._showImage(n.imageName,!1),this._finish()}},TypingPlayer.prototype._finish=function(){this.app.off("update",this._updateCb),this.state="done";var t=this;setTimeout((function(){t.textEntity&&t.textEntity.element&&t._tweenOpacity(t.textEntity.element,1,0,800),t.imageCarouselContainer&&t.imageCarouselContainer.element&&(t._clearImage(!1),t.debug&&console.log("[TypingPlayer] Fading out image at finish"));var e=t.imageCarouselContainer&&t.imageCarouselContainer.element?500:0,i=Math.max(800,e);setTimeout((function(){t.overlayEntity&&t.bgFadeOutMs>0?t._overlayFadeOut(t.bgFadeOutMs,(function(){t._onComplete&&t._onComplete()})):t._onComplete&&t._onComplete()}),i)}),1500)},TypingPlayer.prototype._currentLine=function(){return this.data.typeLines[this.lineIndex]},TypingPlayer.prototype._nextCharDuration=function(){var t=this._currentLine();return t&&Array.isArray(t.durations)&&t.durations.length>this.charIndex?Math.max(0,0|t.durations[this.charIndex]):this.defaultCharMs},TypingPlayer.prototype._onUpdate=function(t){if(this._elapsed+=t,"done"!==this.state)if(this.textEntity&&this.textEntity.element){var e=this.textEntity.element;if("fade_in"!==this.state){if("typing"===this.state){this.timerMs+=1e3*t*this.speedMultiplier;var i=this._nextCharDuration();if(this.timerMs>=i){this.timerMs=0;var n=this._currentLine();if(!n)return void this._finish();var a=n.text?n.text.substring(0,this.charIndex+1):"";e.text=this.outputPrefix+a,this.debug&&console.log("[TypingPlayer] typing line",this.lineIndex,"char",this.charIndex,"clear=",!(!n||!n.clear),"outPrefixLen=",this.outputPrefix.length),this.charIndex++,this.charIndex>=(n.text?n.text.length:0)&&(n&&n.clear?(this.pendingClear=!0,this.nextOutputPrefix="",this.debug&&console.log("[TypingPlayer] line end -> schedule clear at next line start",this.lineIndex)):(this.pendingClear=!1,this.nextOutputPrefix=(e.text||"")+"\n",this.debug&&console.log("[TypingPlayer] line end -> schedule keep, next outPrefixLen=",this.nextOutputPrefix.length)),this.state="lineGap",this.timerMs=0)}}else if("lineGap"===this.state&&(this.timerMs+=1e3*t,this.timerMs>=(5==this.speedMultiplier?.2:this.lineGapMs))){if(this.timerMs=0,this.lineIndex++,this.charIndex=0,this.lineIndex>=this.data.typeLines.length)return void this._finish();this._applyLineStyle(this._currentLine()),this._updateLineFullWidth(this._currentLine()),this.pendingClear?(e.text="",this.outputPrefix="",this.debug&&console.log("[TypingPlayer] next line start -> applied clear")):(this.outputPrefix=this.nextOutputPrefix||this.outputPrefix,this.debug&&console.log("[TypingPlayer] next line start -> applied keep, outPrefixLen=",this.outputPrefix.length));var s=this._currentLine();s&&s.imageName&&(this._showImage(s.imageName,s.clearImage),this.debug&&console.log("[TypingPlayer] next line start -> showing image:",s.imageName,"useFadeIn:",s.clearImage)),this.state="typing"}this.textEntity&&this.textEntity.setLocalPosition(this.baseLocalPos.x,this.baseLocalPos.y,this.baseLocalPos.z)}}else this._finish()},TypingPlayer.prototype._measureTextWidth=function(t,e){if(!t)return 0;for(var i=0,n=0;n<t.length;n++){var a=t.charAt(n).charCodeAt(0);i+=(a>=11904&&a<=40959||a>=63744&&a<=64255||a>=65280&&a<=65519?this.widthFactorCJK:this.widthFactorAscii)*e}return i},TypingPlayer.prototype._updateLineFullWidth=function(t){var e=this.textEntity&&this.textEntity.element;if(e&&t){var i="number"==typeof t.size&&t.size>0?t.size:e.fontSize||32,n=this._measureTextWidth(t.text||"",i);this.currentFullWidth=n,this.debug&&console.log("[TypingPlayer] update full width:",this.currentFullWidth,"fsize=",i)}else this.currentFullWidth=0},UiTypingAnimation.createPlayer=function(t,e,i,n){return new TypingPlayer(t,e,i,n)};var TypingTypes=function(){function clampNum(e,a){return"number"==typeof e&&isFinite(e)?e:a}return{createLine:function createLine(e,a){a=a||{};var t={text:"string"==typeof e?e:"",durations:Array.isArray(a.durations)?a.durations.slice(0):null,bold:!!a.bold,clear:!!a.clear,color:"string"==typeof a.color?a.color:void 0,size:"number"==typeof a.size?a.size:void 0};return"string"==typeof a.imageName&&a.imageName&&(t.imageName=a.imageName,t.clearImage=!!a.clearImage),t},createData:function createData(e){return{typeLines:Array.isArray(e)?e.slice(0):[]}},createOptions:function createOptions(e){return{defaultCharMs:clampNum((e=e||{}).defaultCharMs,50),lineGapMs:clampNum(e.lineGapMs,300),fontAssetNormal:e.fontAssetNormal||null,fontAssetBold:e.fontAssetBold||null,enableDebugLog:!!e.enableDebugLog,overlayEntity:e.overlayEntity||null,bgHexColor:"string"==typeof e.bgHexColor?e.bgHexColor:"#FCFBDB",bgFadeOutMs:clampNum(e.bgFadeOutMs,1500),autoFadeOut:!1!==e.autoFadeOut,imageCarouselContainer:e.imageCarouselContainer||null,maxImageWidth:clampNum(e.maxImageWidth,1200),maxImageHeight:clampNum(e.maxImageHeight,400)}}}}();var Flucturating=pc.createScript("flucturating");Flucturating.attributes.add("amplitude",{type:"number",default:.25,title:"振幅(米)"}),Flucturating.attributes.add("speed",{type:"number",default:1,title:"速度(Hz比例)"}),Flucturating.attributes.add("phaseOffset",{type:"number",default:0,title:"相位偏移"}),Flucturating.attributes.add("useWorldSpace",{type:"boolean",default:!0,title:"世界空间(否则本地)"}),Flucturating.attributes.add("centerOffsetY",{type:"number",default:0,title:"中心额外偏移Y(米)"}),Flucturating.attributes.add("swayEnabled",{type:"boolean",default:!0,title:"启用摇摆(旋转)"}),Flucturating.attributes.add("swayAmpX",{type:"number",default:0,title:"摇摆幅度X(度)"}),Flucturating.attributes.add("swayAmpY",{type:"number",default:12,title:"摇摆幅度Y(度)"}),Flucturating.attributes.add("swayAmpZ",{type:"number",default:0,title:"摇摆幅度Z(度)"}),Flucturating.attributes.add("swayFreqX",{type:"number",default:.7,title:"摇摆频率X"}),Flucturating.attributes.add("swayFreqY",{type:"number",default:1,title:"摇摆频率Y"}),Flucturating.attributes.add("swayFreqZ",{type:"number",default:.9,title:"摇摆频率Z"}),Flucturating.attributes.add("swayPhaseX",{type:"number",default:0,title:"相位X"}),Flucturating.attributes.add("swayPhaseY",{type:"number",default:0,title:"相位Y"}),Flucturating.attributes.add("swayPhaseZ",{type:"number",default:0,title:"相位Z"}),Flucturating.prototype.initialize=function(){this._t=0,this._hasRb=!!this.entity.rigidbody,this._rb=this.entity.rigidbody||null,this.useWorldSpace?this._basePos=this.entity.getPosition().clone():this._basePos=this.entity.getLocalPosition().clone(),this._baseRot=this.entity.getRotation().clone(),this._tmpQuat=new pc.Quat,this._tmpEuler=new pc.Vec3,this._hasOwnPhase||(this.phaseOffset=(this.phaseOffset||0)+.5*Math.random(),this._hasOwnPhase=!0)},Flucturating.prototype.update=function(t){this._t+=t*(this.speed||1);var e,s=this._basePos.y+this.centerOffsetY+Math.sin(this._t+this.phaseOffset)*(this.amplitude||0);if(this.useWorldSpace){var i=this.entity.getPosition();e=new pc.Vec3(i.x,s,i.z)}else{var a=this.entity.getLocalPosition();e=new pc.Vec3(a.x,s,a.z)}var n=this._baseRot;if(this.swayEnabled){var r=this._t,u=(this.swayAmpX||0)*Math.sin(r*(this.swayFreqX||0)+(this.swayPhaseX||0)),h=(this.swayAmpY||0)*Math.sin(r*(this.swayFreqY||0)+(this.swayPhaseY||0)),l=(this.swayAmpZ||0)*Math.sin(r*(this.swayFreqZ||0)+(this.swayPhaseZ||0));this._tmpQuat.setFromEulerAngles(u,h,l),n=this._baseRot.clone().mul(this._tmpQuat)}if(this._rb)if(this.useWorldSpace)this._rb.teleport(e,n);else{var o=this.entity.parent?this.entity.parent.getWorldTransform().transformPoint(e,new pc.Vec3):e;this._rb.teleport(o,n)}else this.useWorldSpace?(this.entity.setPosition(e),this.swayEnabled&&this.entity.setRotation(n)):(this.entity.setLocalPosition(e),this.swayEnabled&&this.entity.setRotation(n))},Flucturating.prototype.destroy=function(){try{if(this._rb){var t=this.useWorldSpace?this._basePos.clone():this.entity.parent?this.entity.parent.getWorldTransform().transformPoint(this._basePos,new pc.Vec3):this._basePos.clone();this._rb.teleport(t,this._baseRot)}else this.useWorldSpace?this.entity.setPosition(this._basePos):this.entity.setLocalPosition(this._basePos),this.entity.setRotation(this._baseRot)}catch(t){}};var CameraTransition=pc.createScript("cameraTransition");CameraTransition._instance=null,CameraTransition.getInstance=function(){return CameraTransition._instance},CameraTransition.attributes.add("transitionDuration",{type:"number",default:2,title:"过渡时长(秒)"}),CameraTransition.attributes.add("easeType",{type:"string",default:"easeInOut",title:"缓动类型",enum:[{linear:"linear"},{easeIn:"easeIn"},{easeOut:"easeOut"},{easeInOut:"easeInOut"}]}),CameraTransition.attributes.add("enableDebugLog",{type:"boolean",default:!1,title:"调试日志"}),CameraTransition.attributes.add("mainMenuGroupName",{type:"string",default:"mainMenu",title:"主菜单机位组名"}),CameraTransition.attributes.add("mainMenuMainPos",{type:"string",default:"main",title:"主菜单默认子机位名"}),CameraTransition.prototype.initialize=function(){if(CameraTransition._instance&&CameraTransition._instance!==this){this.enableDebugLog&&console.log("[CameraTransition] 检测到场景切换，替换旧实例");var t=CameraTransition._instance;t&&"function"==typeof t.destroy&&t.destroy()}CameraTransition._instance=this,this._isTransitioning=!1,this._transitionTime=0,this._startPos=new pc.Vec3,this._startRot=new pc.Quat,this._targetPos=new pc.Vec3,this._targetRot=new pc.Quat,this._startParams={},this._targetParams={},this._onCompleteCallback=null,this._currentPositionGroup=null,this._currentPositionIndex=0,this._cameraPositions={},this._ready=!1,this._pendingCalls=[],this._setupKeyboardInput(),this._setupMobileInput(),this._loadCameraPositions(),this._inputEnabled=!0,this._uiState=null;var i=this;this._onUIStateChanged=function(t){t&&t.to&&(i._uiState=t.to,i.enableDebugLog&&console.log("[CameraTransition] UIManager state changed to:",t.to))},this.app.on("ui:state_changed",this._onUIStateChanged,this),this._onUiControlChanged=function(t){var n=t&&t.to;t&&t.from;if("first_time_intro"!==i._uiState&&"typewriter"!==i._uiState){var a=i._inputEnabled;i._inputEnabled="locked_multi"===n,(i.enableDebugLog||a!==i._inputEnabled)&&console.log("[CameraTransition] ui:control_state_changed event:",t,"inputEnabled:",a,"->",i._inputEnabled)}else i.enableDebugLog&&console.log("[CameraTransition] Ignoring camera state change during UIManager animation:",i._uiState)},this.app.on("ui:control_state_changed",this._onUiControlChanged,this)},CameraTransition.prototype._loadCameraPositions=function(){var t=this;this._cameraPositions={};var i=this.app.assets.find("cameraPosition.json","json");function onLoaded(i){t._cameraPositions=i&&i.resource||{},t._flushReady();try{t.app.fire("camera:positions:ready",Object.keys(t._cameraPositions||{}))}catch(t){}t.enableDebugLog&&console.log("[CameraTransition] positions ready:",Object.keys(t._cameraPositions||{}))}if(i)i.resource?onLoaded(i):(i.once("load",onLoaded),this.app.assets.load(i));else{this._cameraPositions={},this._flushReady();try{this.app.fire("camera:positions:ready",[])}catch(t){}this.enableDebugLog&&console.warn("[CameraTransition] cameraPosition.json not found, positions empty.")}},CameraTransition.prototype._ensureReady=function(t){this._ready?t():this._pendingCalls.push(t)},CameraTransition.prototype._flushReady=function(){this._ready=!0;var t=this._pendingCalls.slice();this._pendingCalls.length=0;for(var i=0;i<t.length;i++)try{t[i]()}catch(t){this.enableDebugLog&&console.warn("[CameraTransition] pending call error:",t)}},CameraTransition.prototype._isAt=function(t,i){if(this._currentPositionGroup!==t)return!1;try{var n=this._cameraPositions&&this._cameraPositions[t];if(!n||!n.positions||!n.positions.length)return!1;var a=0|this._currentPositionIndex;a=Math.max(0,Math.min(a,n.positions.length-1));var e=n.positions[a];return!(!e||e.name!==i)}catch(t){return!1}},CameraTransition.prototype._ease=function(t,i){switch(i){case"linear":default:return t;case"easeIn":return t*t;case"easeOut":return 1-(1-t)*(1-t);case"easeInOut":return t<.5?2*t*t:1-2*(1-t)*(1-t)}},CameraTransition.prototype._lerp=function(t,i,n){return t+(i-t)*n},CameraTransition.prototype._getCurrentCameraParams=function(){var t=this.entity.script&&this.entity.script.followCamera;return t?{pitchMin:null!=t.minPitch?t.minPitch:null!=t.pitchMin?t.pitchMin:-60,pitchMax:null!=t.maxPitch?t.maxPitch:null!=t.pitchMax?t.pitchMax:60,yawMin:null!=t.yawMin?t.yawMin:-180,yawMax:null!=t.yawMax?t.yawMax:180,mouseSensitivity:null!=t.mouseSensitivity?t.mouseSensitivity:.3}:{pitchMin:-60,pitchMax:60,yawMin:-180,yawMax:180,mouseSensitivity:.3}},CameraTransition.prototype._applyCameraParams=function(t){var i=this.entity.script&&this.entity.script.followCamera;i&&("minPitch"in i&&(i.minPitch=t.pitchMin),"maxPitch"in i&&(i.maxPitch=t.pitchMax),"pitchMin"in i&&(i.pitchMin=t.pitchMin),"pitchMax"in i&&(i.pitchMax=t.pitchMax),i.yawMin=t.yawMin,i.yawMax=t.yawMax,i.mouseSensitivity=t.mouseSensitivity);try{this.app.fire("camera:params:changed",t)}catch(t){}},CameraTransition.prototype.transitionToPosition=function(t,i,n){var a=this;if("function"==typeof i&&(n=i,i=null),this._ready){var e=a._getPositionConfig(t,i);if(!e)return a.enableDebugLog&&console.warn("[CameraTransition] no config for",t,i),!1;if(a._isTransitioning)return a.enableDebugLog&&console.warn("[CameraTransition] already transitioning, ignore."),!1;a._startPos.copy(a.entity.getPosition()),a._startRot.copy(a.entity.getRotation()),a._targetPos.set(e.position.x,e.position.y,e.position.z),a._targetRot.setFromEulerAngles(e.rotation.x,e.rotation.y,e.rotation.z),a._startParams=a._getCurrentCameraParams(),a._targetParams={pitchMin:e.pitchMin,pitchMax:e.pitchMax,yawMin:e.yawMin,yawMax:e.yawMax,mouseSensitivity:e.mouseSensitivity},a.setCurrentPositionGroup(t,i),a._isTransitioning=!0,a._transitionTime=0,a._onCompleteCallback=n||null;try{a.app.fire("camera:transition:start",t,e)}catch(t){}return!0}return this._ensureReady((function(){a.transitionToPosition(t,i,n)})),!0},CameraTransition.prototype.snapToPosition=function(t,i){var n=this;if(this._ready){var a=n._getPositionConfig(t,i);if(!a)return n.enableDebugLog&&console.warn("[CameraTransition] no config for",t,i),!1;n.entity.setPosition(a.position.x,a.position.y,a.position.z),n.entity.setEulerAngles(a.rotation.x,a.rotation.y,a.rotation.z),n._applyCameraParams({pitchMin:a.pitchMin,pitchMax:a.pitchMax,yawMin:a.yawMin,yawMax:a.yawMax,mouseSensitivity:a.mouseSensitivity}),n.setCurrentPositionGroup(t,i);try{n.app.fire("camera:transition:start",t,a)}catch(t){}return!0}return this._ensureReady((function(){n.snapToPosition(t,i)})),!0},CameraTransition.prototype.update=function(t){if(this._isTransitioning){this._transitionTime+=t;var i=Math.min(this._transitionTime/Math.max(1e-4,this.transitionDuration),1),n=this._ease(i,this.easeType),a=(new pc.Vec3).lerp(this._startPos,this._targetPos,n),e=(new pc.Quat).slerp(this._startRot,this._targetRot,n);this.entity.setPosition(a),this.entity.setRotation(e);var o={pitchMin:this._lerp(this._startParams.pitchMin,this._targetParams.pitchMin,n),pitchMax:this._lerp(this._startParams.pitchMax,this._targetParams.pitchMax,n),yawMin:this._lerp(this._startParams.yawMin,this._targetParams.yawMin,n),yawMax:this._lerp(this._startParams.yawMax,this._targetParams.yawMax,n),mouseSensitivity:this._lerp(this._startParams.mouseSensitivity,this._targetParams.mouseSensitivity,n)};if(this._applyCameraParams(o),i>=1){this._isTransitioning=!1;try{this.app.fire("camera:transition:complete",o)}catch(t){}if(this._onCompleteCallback){var s=this._onCompleteCallback;this._onCompleteCallback=null;try{s()}catch(t){}}}}},CameraTransition.prototype._getPositionConfig=function(t,i){"default"===i&&(i=null);var n=(this._cameraPositions||{})[t];if(!n)return null;if(n.positions&&Array.isArray(n.positions)){if(!n.positions.length)return null;if(!i)return n.positions[0];for(var a=0;a<n.positions.length;a++)if(n.positions[a].name===i)return n.positions[a];return null}return n},CameraTransition.prototype.getAvailablePositions=function(){var t={},i=this._cameraPositions||{};for(var n in i){var a=i[n];a&&Array.isArray(a.positions)?t[n]=a.positions.map((function(t){return t.name})):t[n]=[n]}return t},CameraTransition.prototype.getSubPositions=function(t){var i=(this._cameraPositions||{})[t];return i&&Array.isArray(i.positions)?i.positions.map((function(t){return t.name})):[]},CameraTransition.prototype.isTransitioning=function(){return this._isTransitioning},CameraTransition.prototype.stopTransition=function(){if(this._isTransitioning){this._isTransitioning=!1,this._onCompleteCallback=null;try{this.app.fire("camera:transition:stopped")}catch(t){}}},CameraTransition.prototype._setupKeyboardInput=function(){var t=this;this.app.keyboard.on(pc.EVENT_KEYDOWN,(function(i){t._inputEnabled&&t._currentPositionGroup===(t.mainMenuGroupName||"mainMenu")&&("first_time_intro"!==t._uiState&&"typewriter"!==t._uiState?i.key===pc.KEY_A?t._switchByKey("keyATo"):i.key===pc.KEY_D?t._switchByKey("keyDTo"):i.key===pc.KEY_W?t._switchByKey("keyWTo"):i.key===pc.KEY_S&&(t._isAt(t.mainMenuGroupName,t.mainMenuMainPos)||t._switchByKey("keySTo")):t.enableDebugLog&&console.log("[CameraTransition] Key input ignored during UIManager animation state:",t._uiState))}),this)},CameraTransition.prototype._setupMobileInput=function(){var t=this,i=null;this._onMobileJoystickMove=function(n){if(t._inputEnabled&&t._currentPositionGroup===(t.mainMenuGroupName||"mainMenu"))if("first_time_intro"!==t._uiState&&"typewriter"!==t._uiState)if(!n||n.magnitude<.3)i=null;else{var a=-n.x,e=-n.y,o=180*Math.atan2(e,a)/Math.PI,s=null;if((s=o>=-45&&o<45?"D":o>=45&&o<135?"W":o>=-135&&o<-45?"S":"A")!==i)if(i=s,"A"===s)t._switchByKey("keyATo");else if("D"===s)t._switchByKey("keyDTo");else if("W"===s)t._switchByKey("keyWTo");else if("S"===s)if(t._isAt(t.mainMenuGroupName,t.mainMenuMainPos)){if("undefined"!=typeof GlobalCameraManager){var r=GlobalCameraManager.getInstance();r&&r.setState(GlobalCameraManager.CONTROL_STATES.FREE_FOLLOW)}}else t._switchByKey("keySTo")}else t.enableDebugLog&&console.log("[CameraTransition] Mobile joystick input ignored during UIManager animation state:",t._uiState)},this.app.on("mobile:joystick:move",this._onMobileJoystickMove,this)},CameraTransition.prototype._switchByKey=function(t){if(this._currentPositionGroup&&!this._isTransitioning){var i=this._cameraPositions[this._currentPositionGroup];if(i&&Array.isArray(i.positions)){var n=i.positions[this._currentPositionIndex];if(n&&"number"==typeof n[t]){var a=0|n[t];if(!(a<0||a>=i.positions.length||a===this._currentPositionIndex)){var e=i.positions[a];this._currentPositionIndex=a,this.transitionToPosition(this._currentPositionGroup,e.name)}}}}},CameraTransition.prototype.setCurrentPositionGroup=function(t,i){this._currentPositionGroup=t;var n=this._cameraPositions[t];if(n&&Array.isArray(n.positions))if(i){for(var a=0;a<n.positions.length;a++)if(n.positions[a].name===i)return void(this._currentPositionIndex=a);this._currentPositionIndex=0}else this._currentPositionIndex=0;else this._currentPositionIndex=0},CameraTransition.prototype.destroy=function(){if(this.app&&this._onUIStateChanged)try{this.app.off("ui:state_changed",this._onUIStateChanged,this)}catch(t){}if(this.app&&this._onUiControlChanged)try{this.app.off("ui:control_state_changed",this._onUiControlChanged,this)}catch(t){}if(this.app&&this._onUiButtonsHide)try{this.app.off("ui:camera:buttons:hide",this._onUiButtonsHide,this)}catch(t){}if(this.app&&this._onUiCameraActive)try{this.app.off("ui:camera:active",this._onUiCameraActive,this)}catch(t){}if(this.app&&this._onMobileJoystickMove)try{this.app.off("mobile:joystick:move",this._onMobileJoystickMove,this)}catch(t){}CameraTransition._instance===this&&(CameraTransition._instance=null),this.enableDebugLog&&console.log("[CameraTransition] 已销毁并清理单例")};pc.script.createLoadingScreen((function(t){var e=(navigator.language||"en-US").toLowerCase().startsWith("zh"),a=[],n=0,i=null;var o=document.createElement("div");o.id="echoes-loading",o.innerHTML='\n    <div class="frame">\n      <div class="title">ECHOES</div>\n      <div class="ring">\n        <div class="circle"></div>\n        <svg class="petals" viewBox="-120 -140 240 260" aria-hidden="true"></svg>\n        <div class="pct">0%</div>\n      </div>\n      <div class="tip">Loading...</div>\n    </div>\n  ',document.body.appendChild(o);var s=document.createElement("style");s.textContent='\n    #echoes-loading{position:fixed;inset:0;display:grid;place-items:center;background:#F7F4D6;z-index:9999;\n      font-family:ui-sans-serif,system-ui,"Helvetica Neue",Arial;color:#3d2c1f;opacity:1;transition:opacity 3000ms ease}\n    #echoes-loading.hidden{opacity:0}\n    .frame{display:flex;flex-direction:column;align-items:center;gap:40px}\n    .title{letter-spacing:.35em;font-weight:800;font-size:26px;text-shadow:0 1px 0 #fff8;margin-bottom:20px}\n    .ring{position:relative;width:300px;height:300px;display:grid;place-items:center}\n    /* 中心圆固定为米黄色，不参与进度填充 */\n    .circle{width:160px;height:160px;border-radius:50%;\n      background:#F6D867;box-shadow:inset 0 0 0 8px rgba(0,0,0,.08)}\n    /* 花瓣：每片两层path，底层棕色、顶层黄色随进度渐显 */\n    .petals{position:absolute;width:300px;height:300px;pointer-events:none;top:-6px;opacity:1}\n    .petals.fadeout{opacity:0;transition:opacity 300ms ease}\n    .petals g.petal{transition:transform 180ms ease; transform-box: fill-box; transform-origin: center}\n    .petals path.base{fill:#4f3a2b;opacity:0;stroke:#F7F4D6;stroke-width:3;stroke-linecap:round;filter:drop-shadow(0 1px 0 #fff8)}\n    .petals path.fill{fill:#F6D867;opacity:0;transition:opacity 160ms linear;stroke:#F7F4D6;stroke-width:3;stroke-linecap:round;filter:drop-shadow(0 1px 0 #fff8)}\n    .pct{position:absolute;font-weight:800;font-size:18px;color:#6b4c37}\n    .tip{font-size:12px;opacity:.6;letter-spacing:.08em;transition:opacity 300ms ease}\n    @media (prefers-reduced-motion:no-preference){.circle{transition:background 120ms linear}}\n  ',document.head.appendChild(s);var r=o.querySelector(".petals"),l=[],c=[],p=[];function updateTipText(){var t=o.querySelector(".tip");t&&a.length>0&&(t.style.opacity=0,setTimeout((function(){t.textContent=a[n],t.style.opacity=.6}),150))}function stopTipRotation(){i&&(clearInterval(i),i=null)}!function buildPetals(t){r.innerHTML="",l=[],c=[],p=[];var e=t.count||12,a=90,n=t.length||45,i=t.width||30;for(let t=0;t<e;t++){var o=(t*(360/e)-90)*Math.PI/180,s=Math.cos(o)*a,d=Math.sin(o)*a-5,h=Math.cos(o)*(a+n),u=Math.sin(o)*(a+n)-5,g=-Math.sin(o)*i/2,f=Math.cos(o)*i/2,m=Math.cos(o)*(a+.6*n),y=Math.sin(o)*(a+.6*n)-5,v=`\n        M ${s+.4*g} ${d+.4*f}\n        C ${s+.8*g} ${d+.8*f}, ${m+.5*g} ${y+.5*f}, ${m+.2*g} ${y+.2*f}\n        C ${m+.05*g} ${y+.05*f}, ${h} ${u}, ${h} ${u}\n        C ${h} ${u}, ${m-.05*g} ${y-.05*f}, ${m-.2*g} ${y-.2*f}\n        C ${m-.5*g} ${y-.5*f}, ${s-.8*g} ${d-.8*f}, ${s-.4*g} ${d-.4*f}\n        C ${s-.1*g} ${d-.1*f}, ${s+.1*g} ${d+.1*f}, ${s+.4*g} ${d+.4*f}\n        Z`,x=document.createElementNS("http://www.w3.org/2000/svg","g");x.setAttribute("class","petal"),x.setAttribute("data-cos",Math.cos(o)),x.setAttribute("data-sin",Math.sin(o));var b=document.createElementNS("http://www.w3.org/2000/svg","path");b.setAttribute("d",v),b.setAttribute("class","base"),x.appendChild(b),l.push(b);var w=document.createElementNS("http://www.w3.org/2000/svg","path");w.setAttribute("d",v),w.setAttribute("class","fill"),x.appendChild(w),c.push(w),r.appendChild(x),p.push(x)}}({count:12,length:45,width:30});o.querySelector(".circle");var d=o.querySelector(".pct"),h=o.querySelector(".tip"),u=0;function setProgress(t){(t=Math.max(0,Math.min(1,t||0)))<u&&u<1&&(t=u),u=t,d.textContent=Math.round(100*t)+"%";for(var e=c.length,a=0;a<e;a++){var n=t*e-a,i=n<=0?0:n>=1?1:n;c[a].style.opacity=i;var o=p[a];if(o){var s=parseFloat(o.getAttribute("data-cos"))||0,l=parseFloat(o.getAttribute("data-sin"))||0,g=13*i,f=1+.3*i,m=(-s*g).toFixed(3),y=(-l*g).toFixed(3);o.setAttribute("transform","translate("+m+","+y+") scale("+f.toFixed(3)+")")}}t>=1&&!r.classList.contains("fadeout")&&(r.classList.add("fadeout"),d.style.transition="opacity 200ms linear",h.style.transition="opacity 200ms linear",d.style.opacity=0,h.style.opacity=0)}var onProgress=function(t){setProgress(t)};!function initTips(){a=e?["聆听回声中…","探索神秘领域中…","唤醒古老记忆中…","追寻虚空低语中…","发现隐藏真相中…","解开时间之线中…","拥抱未知旅程中…","寻找过往碎片中…","与光影共舞中…","开启新世界之门中…"]:["Listening to echoes…","Exploring mysterious realms…","Awakening ancient memories…","Following whispers in the void…","Discovering hidden truths…","Unraveling the threads of time…","Embracing the unknown journey…","Seeking fragments of the past…","Dancing with shadows and light…","Opening doors to new worlds…"]}(),updateTipText(),function startTipRotation(){a.length<=1||(i=setInterval((function(){n=(n+1)%a.length,updateTipText()}),7e3))}(),t.on("preload:progress",onProgress),t.once("preload:start",(function(){u=0,setProgress(0),r.classList.remove("fadeout");for(var t=0;t<c.length;t++)c[t].style.opacity=0;d.style.opacity=1,h.style.opacity=1,d.textContent="0%"})),t.once("preload:end",(function(){t.off("preload:progress",onProgress),setProgress(1),stopTipRotation(),GlobalGame.init(t,{defaultState:GlobalGame.STATES.MAIN_MENU,debug:!0});try{"undefined"!=typeof DialogueManager&&DialogueManager.setApp&&DialogueManager.setApp(t)}catch(t){}try{if("undefined"!=typeof DialogueManager&&DialogueManager.preloadMany&&t&&t.assets&&t.assets.list){for(var e=/^(.+?)_(zh-CN|en-US)\.json$/i,a=Object.create(null),n=t.assets.list(),i=0;i<n.length;i++){var o=n[i];if(o&&"json"===o.type&&o.name){var s=o.name.match(e);s&&s[1]&&(a[s[1]]=!0)}}var r=Object.keys(a);if(r.length){var l=null;try{"undefined"!=typeof GlobalGame&&GlobalGame.getLocale&&(l=GlobalGame.getLocale())}catch(t){}DialogueManager.preloadMany(r,{locale:l})}}}catch(t){}})),t.once("start",(function(){stopTipRotation(),o.classList.contains("hidden")||o.classList.add("hidden");var cleanup=function(t){t&&"opacity"!==t.propertyName||(o.removeEventListener("transitionend",cleanup),o&&o.parentNode&&o.parentNode.removeChild(o),s&&s.parentNode&&s.parentNode.removeChild(s))};o.addEventListener("transitionend",cleanup),setTimeout((function(){cleanup({propertyName:"opacity"})}),3500)}))}));var CameraUIController=pc.createScript("cameraUIController");CameraUIController._instances={},CameraUIController.attributes.add("targetCameraPosition",{type:"string",default:"main",title:"目标机位名称",description:"当相机切换到此机位时显示UI元素"}),CameraUIController.attributes.add("uiEntities",{type:"entity",array:!0,title:"UI实体数组",description:"需要统一控制的UI元素实体列表"}),CameraUIController.attributes.add("fadeInDuration",{type:"number",default:.5,title:"渐显时长(秒)",min:.1,max:5}),CameraUIController.attributes.add("fadeOutDuration",{type:"number",default:.3,title:"渐隐时长(秒)",min:.1,max:5}),CameraUIController.attributes.add("enableDebugLog",{type:"boolean",default:!1,title:"调试日志"}),CameraUIController.getInstance=function(t){return CameraUIController._instances[t]||null},CameraUIController.getAllInstances=function(){return CameraUIController._instances},CameraUIController.prototype.initialize=function(){(CameraUIController._instances||{})[this.targetCameraPosition]?console.warn('[CameraUIController] Controller for position "'+this.targetCameraPosition+'" already exists.'):(CameraUIController._instances||(CameraUIController._instances={}),CameraUIController._instances[this.targetCameraPosition]=this,this._isVisible=!1,this._isTransitioning=!1,this._activeTweens=[],this._uiElementsData=[],this._isUIManagerBlocking=!1,this._shouldBeVisibleAfterUnblock=!1,this._initializeUIElements(),this._setUIVisibility(!1,!0),this._setupUIManagerEvents(),this._setupCameraEvents(),this.enableDebugLog&&(console.log("[CameraUIController] Controller initialized for position:",this.targetCameraPosition),console.log("[CameraUIController] Managing",this.uiEntities.length,"UI entities"),console.log("[CameraUIController] Available positions: main, moai, flower, trophy, ocean")))},CameraUIController.prototype._initializeUIElements=function(){this._uiElementsData=[];for(var t=0;t<this.uiEntities.length;t++){var e=this.uiEntities[t];e&&e.element?this._uiElementsData.push({entity:e,element:e.element,originalOpacity:e.element.opacity,tween:null}):console.warn("[CameraUIController] Entity at index",t,"has no Element component")}this.enableDebugLog&&console.log("[CameraUIController] Initialized",this._uiElementsData.length,"UI elements")},CameraUIController.prototype._setupUIManagerEvents=function(){var t=this;this.app.on("ui:state_changed",(function(e){if(e&&e.to){var i=e.to;"typewriter"===i||"first_time_intro"===i?(t._shouldBeVisibleAfterUnblock=t._isVisible||t._isTransitioning,t._isUIManagerBlocking=!0,t._isVisible&&t._hideUI(),t.enableDebugLog&&console.log("[CameraUIController] UIManager blocking UI, state:",i,"shouldBeVisibleAfterUnblock:",t._shouldBeVisibleAfterUnblock)):"normal"===i&&(t._isUIManagerBlocking=!1,t.enableDebugLog&&console.log("[CameraUIController] UIManager unblocking UI, shouldBeVisibleAfterUnblock:",t._shouldBeVisibleAfterUnblock),t._shouldBeVisibleAfterUnblock&&!t._isVisible&&(t.enableDebugLog&&console.log("[CameraUIController] Restoring UI visibility after unblock"),t._showUI()),t._shouldBeVisibleAfterUnblock=!1)}}),this)},CameraUIController.prototype._setupCameraEvents=function(){var t=this;this.app.on("camera:transition:start",(function(e,i){t.enableDebugLog&&console.log("[CameraUIController] Camera transition start:",e),"mainMenu"===e&&i&&i.name===t.targetCameraPosition?(t._shouldBeVisibleAfterUnblock=!0,t._showUI()):(t._shouldBeVisibleAfterUnblock=!1,t._hideUI())}),this),this.app.on("camera:transition:complete",(function(e){t.enableDebugLog&&console.log("[CameraUIController] Camera transition complete")}),this)},CameraUIController.prototype._showUI=function(){if(!this._isVisible&&!this._isTransitioning)if(this._isUIManagerBlocking)this.enableDebugLog&&console.log("[CameraUIController] UIManager is blocking, skip showing UI for:",this.targetCameraPosition);else{this.enableDebugLog&&console.log("[CameraUIController] Showing UI for position:",this.targetCameraPosition),this._isTransitioning=!0,this._stopAllTweens();for(var t=0,e=this._uiElementsData.length,i=this,n=0;n<this._uiElementsData.length;n++){var o=this._uiElementsData[n];o.entity?this._tweenOpacity(o.entity,o.element.opacity,o.originalOpacity,1e3*this.fadeInDuration,(function(){++t>=e&&(i._isVisible=!0,i._isTransitioning=!1,i._setInputEnabled(!0),i.enableDebugLog&&console.log("[CameraUIController] All UI elements show complete, input enabled"))})):++t>=e&&(i._isVisible=!0,i._isTransitioning=!1,i._setInputEnabled(!0))}}},CameraUIController.prototype._hideUI=function(){if(this._isVisible||this._isTransitioning){this.enableDebugLog&&console.log("[CameraUIController] Hiding UI for position:",this.targetCameraPosition),this._setInputEnabled(!1),this._isTransitioning=!0,this._stopAllTweens();for(var t=0,e=this._uiElementsData.length,i=this,n=0;n<this._uiElementsData.length;n++){var o=this._uiElementsData[n];o.entity?this._tweenOpacity(o.entity,o.element.opacity,0,1e3*this.fadeOutDuration,(function(){++t>=e&&(i._isVisible=!1,i._isTransitioning=!1,i.enableDebugLog&&console.log("[CameraUIController] All UI elements hide complete, input disabled"))})):++t>=e&&(i._isVisible=!1,i._isTransitioning=!1)}}},CameraUIController.prototype._tweenOpacity=function(t,e,i,n,o){var a=this,l=0,r=Math.max(0,0|n);if(this._setEntityOpacity(t,e),r<=0)return this._setEntityOpacity(t,i),void(o&&o());var dtFunc=function(n){l+=1e3*n;var s=Math.min(1,l/r),h=e+(i-e)*s;if(a._setEntityOpacity(t,h),s>=1){var u=a._activeTweens.indexOf(dtFunc);u>-1&&a._activeTweens.splice(u,1),a.app.off("update",dtFunc),o&&o()}};this._activeTweens.push(dtFunc),this.app.on("update",dtFunc)},CameraUIController.prototype._setEntityOpacity=function(t,e){if(t&&(t.element&&(t.element.opacity=e),t.children))for(var i=t.children,n=0;n<i.length;n++)this._setEntityOpacity(i[n],e)},CameraUIController.prototype._stopAllTweens=function(){for(var t=0;t<this._activeTweens.length;t++)this.app.off("update",this._activeTweens[t]);this._activeTweens=[]},CameraUIController.prototype._setInputEnabled=function(t){for(var e=0;e<this._uiElementsData.length;e++){var i=this._uiElementsData[e].entity;if(i&&i.element){try{i.element&&void 0!==i.element.useInput&&(i.element.useInput=t)}catch(t){continue}try{i.button&&void 0!==i.button.enabled&&(i.button.enabled=t)}catch(t){}this._setChildrenInputEnabled(i,t)}}},CameraUIController.prototype._setChildrenInputEnabled=function(t,e){if(t&&t.children)for(var i=t.children,n=0;n<i.length;n++){var o=i[n];if(o){try{o.element&&void 0!==o.element.useInput&&(o.element.useInput=e)}catch(t){}try{o.button&&void 0!==o.button.enabled&&(o.button.enabled=e)}catch(t){}try{this._setChildrenInputEnabled(o,e)}catch(t){}}}},CameraUIController.prototype._setUIVisibility=function(t,e){if(e){for(var i=0;i<this._uiElementsData.length;i++){var n=this._uiElementsData[i];if(n.entity){var o=t?n.originalOpacity:0;this._setEntityOpacity(n.entity,o)}}this._isVisible=t,this._setInputEnabled(t)}else t?this._showUI():this._hideUI()},CameraUIController.prototype.show=function(){this._showUI()},CameraUIController.prototype.hide=function(){this._hideUI()},CameraUIController.prototype.isVisible=function(){return this._isVisible},CameraUIController.prototype.isTransitioning=function(){return this._isTransitioning},CameraUIController.prototype.addUIEntity=function(t){return t&&t.element?(this._uiElementsData.push({entity:t,element:t.element,originalOpacity:t.element.opacity,tween:null}),this._isVisible||(this._setEntityOpacity(t,0),this._setEntityInputEnabled(t,!1)),this.enableDebugLog&&console.log("[CameraUIController] Added UI entity, total:",this._uiElementsData.length),!0):(console.warn("[CameraUIController] Cannot add entity without Element component"),!1)},CameraUIController.prototype._setEntityInputEnabled=function(t,e){if(t){try{t.element&&void 0!==t.element.useInput&&(t.element.useInput=e)}catch(t){}try{t.button&&void 0!==t.button.enabled&&(t.button.enabled=e)}catch(t){}try{this._setChildrenInputEnabled(t,e)}catch(t){}}},CameraUIController.prototype.destroy=function(){this._stopAllTweens(),this.app.off("ui:state_changed",null,this),this.app.off("camera:transition:start",null,this),this.app.off("camera:transition:complete",null,this),CameraUIController._instances&&delete CameraUIController._instances[this.targetCameraPosition],this.enableDebugLog&&console.log("[CameraUIController] Controller destroyed for position:",this.targetCameraPosition)};var MenuMain=pc.createScript("MenuMain");MenuMain.attributes.add("buttonEntities",{type:"entity",array:!0,title:"按钮实体数组",description:"需要绑定点击事件的按钮，支持Button或Element组件"}),MenuMain.attributes.add("buttonTextKeys",{type:"string",array:!0,title:"按钮文本多语言键",description:"与按钮实体顺序一一对应，如 menu.buttons.start"}),MenuMain.attributes.add("buttonActionEvents",{type:"string",array:!0,title:"按钮动作事件",description:"点击后触发的全局事件名（app.fire(eventName)）"}),MenuMain.attributes.add("buttonDialogKeys",{type:"string",array:!0,title:"按钮对话框键",description:"可选：menu.dialogs.*，存在时优先弹出对话框"}),MenuMain.attributes.add("panelTitleKey",{type:"string",title:"面板标题键",description:"如 menu.panels.title.main",default:""}),MenuMain.attributes.add("enableDebugLog",{type:"boolean",default:!1,title:"调试日志"}),MenuMain.prototype.initialize=function(){this._boundClicks=[],this._onLangChanged=this.refreshTexts.bind(this),this._bindButtons(),this.refreshTexts(),this.app.on("i18n:changed",this._onLangChanged,this)},MenuMain.prototype.destroy=function(){for(var t=0;t<this._boundClicks.length;t++){var e=this._boundClicks[t];e&&e.entity&&e.entity.enabled&&(e.button&&e.cb&&e.button.off("click",e.cb,this),e.element&&e.cbElement&&e.element.off("click",e.cbElement,this))}this._boundClicks.length=0,this.app.off("i18n:changed",this._onLangChanged,this)},MenuMain.prototype._bindButtons=function(){for(var t=this,e=this.buttonEntities?this.buttonEntities.length:0,n=0;n<e;n++){var i=this.buttonEntities[n];i&&function(e,n){var clickHandler=function(){t._onButtonClick(e,n)};n.button?(n.button.on("click",clickHandler,t),t._boundClicks.push({entity:n,button:n.button,cb:clickHandler})):n.element?(n.element.on("click",clickHandler,t),t._boundClicks.push({entity:n,element:n.element,cbElement:clickHandler})):t.enableDebugLog&&console.warn("[MenuMain] Button entity without Button/Element:",n&&n.name)}(n,i)}},MenuMain.prototype._onButtonClick=function(t,e){this.enableDebugLog&&console.log("[MenuMain] Click index="+t+" entity="+(e&&e.name));var n=this.buttonDialogKeys&&this.buttonDialogKeys[t]||"",i=this.buttonActionEvents&&this.buttonActionEvents[t]||"";if(n){var o=this._dialogConfigByKey(n);if(o)return void this.app.fire("ui:dialog:open",o)}i&&this.app.fire(i,{source:"MenuMain",index:t,entity:e})},MenuMain.prototype.refreshTexts=function(){if(this.panelTitleKey){var t=this._findTitleEntity();t&&this._setEntityText(t,this._t(this.panelTitleKey,""))}for(var e=this.buttonEntities?this.buttonEntities.length:0,n=0;n<e;n++){var i=this.buttonEntities[n],o=this.buttonTextKeys&&this.buttonTextKeys[n]||(i&&i.name?"menu.Text."+i.name:"");i&&o&&this._setEntityText(i,this._t(o,i.name||""))}},MenuMain.prototype._dialogConfigByKey=function(t){var e=this._t(t+".title",""),n=this._t(t+".message",""),i=this._t(t+".confirm",this._t("menu.labels.yes","Yes")),o=this._t(t+".cancel",this._t("menu.labels.no","No"));return e||n?{title:e,message:n,confirm:i,cancel:o,key:t}:null},MenuMain.prototype._t=function(t,e){return"undefined"!=typeof window&&window.I18n&&"function"==typeof window.I18n.t?window.I18n.t(t,e):e||t},MenuMain.prototype._findTitleEntity=function(){var t=this.entity.findByName("Title");return t&&t.element?t:this.entity.element&&this.entity.element.type===pc.ELEMENTTYPE_TEXT?this.entity:null},MenuMain.prototype._setEntityText=function(t,e){if(t)if(t.element&&t.element.type===pc.ELEMENTTYPE_TEXT)t.element.text=e;else{var n=this._tempStack||[];for(n.length=0,n.push(t);n.length;){var i=n.shift();if((i&&i.element?1:0)&&i.element.type===pc.ELEMENTTYPE_TEXT)return void(i.element.text=e);for(var o=i&&i.children?i.children:[],s=0;s<o.length;s++)n.push(o[s])}}};var MenuFlower=pc.createScript("MenuFlower");MenuFlower.attributes.add("buttonEntities",{type:"entity",array:!0,title:"按钮实体数组",description:"需要绑定点击事件的按钮，支持Button或Element组件"}),MenuFlower.attributes.add("buttonTextKeys",{type:"string",array:!0,title:"按钮文本多语言键",description:"与按钮实体顺序一一对应，如 menu.buttons.start"}),MenuFlower.attributes.add("buttonActionEvents",{type:"string",array:!0,title:"按钮动作事件",description:"点击后触发的全局事件名（app.fire(eventName)）"}),MenuFlower.attributes.add("buttonDialogKeys",{type:"string",array:!0,title:"按钮对话框键",description:"可选：menu.dialogs.*，存在时优先弹出对话框"}),MenuFlower.attributes.add("panelTitleKey",{type:"string",title:"面板标题键",description:"如 menu.panels.title.flower",default:""}),MenuFlower.attributes.add("enableDebugLog",{type:"boolean",default:!1,title:"调试日志"}),MenuFlower.prototype.initialize=function(){this._boundClicks=[],this._onLangChanged=this.refreshTexts.bind(this),this._bindButtons(),this.refreshTexts(),this.app.on("i18n:changed",this._onLangChanged,this)},MenuFlower.prototype.destroy=function(){for(var t=0;t<this._boundClicks.length;t++){var e=this._boundClicks[t];e&&e.entity&&e.entity.enabled&&(e.button&&e.cb&&e.button.off("click",e.cb,this),e.element&&e.cbElement&&e.element.off("click",e.cbElement,this))}this._boundClicks.length=0,this.app.off("i18n:changed",this._onLangChanged,this)},MenuFlower.prototype._bindButtons=function(){for(var t=this,e=this.buttonEntities?this.buttonEntities.length:0,n=0;n<e;n++){var i=this.buttonEntities[n];i&&function(e,n){var clickHandler=function(){t._onButtonClick(e,n)};n.button?(n.button.on("click",clickHandler,t),t._boundClicks.push({entity:n,button:n.button,cb:clickHandler})):n.element?(n.element.on("click",clickHandler,t),t._boundClicks.push({entity:n,element:n.element,cbElement:clickHandler})):t.enableDebugLog&&console.warn("[MenuFlower] Button entity without Button/Element:",n&&n.name)}(n,i)}},MenuFlower.prototype._onButtonClick=function(t,e){this.enableDebugLog&&console.log("[MenuFlower] Click index="+t+" entity="+(e&&e.name));var n=this.buttonDialogKeys&&this.buttonDialogKeys[t]||"",i=this.buttonActionEvents&&this.buttonActionEvents[t]||"";if(n){var o=this._dialogConfigByKey(n);if(o)return void this.app.fire("ui:dialog:open",o)}i&&this.app.fire(i,{source:"MenuFlower",index:t,entity:e})},MenuFlower.prototype.refreshTexts=function(){if(this.panelTitleKey){var t=this._findTitleEntity();t&&this._setEntityText(t,this._t(this.panelTitleKey,""))}for(var e=this.buttonEntities?this.buttonEntities.length:0,n=0;n<e;n++){var i=this.buttonEntities[n],o=this.buttonTextKeys&&this.buttonTextKeys[n]||(i&&i.name?"menu.Text."+i.name:"");i&&o&&this._setEntityText(i,this._t(o,i.name||""))}},MenuFlower.prototype._dialogConfigByKey=function(t){var e=this._t(t+".title",""),n=this._t(t+".message",""),i=this._t(t+".confirm",this._t("menu.labels.yes","Yes")),o=this._t(t+".cancel",this._t("menu.labels.no","No"));return e||n?{title:e,message:n,confirm:i,cancel:o,key:t}:null},MenuFlower.prototype._t=function(t,e){return"undefined"!=typeof window&&window.I18n&&"function"==typeof window.I18n.t?window.I18n.t(t,e):e||t},MenuFlower.prototype._findTitleEntity=function(){var t=this.entity.findByName("Title");return t&&t.element?t:this.entity.element&&this.entity.element.type===pc.ELEMENTTYPE_TEXT?this.entity:null},MenuFlower.prototype._setEntityText=function(t,e){if(t)if(t.element&&t.element.type===pc.ELEMENTTYPE_TEXT)t.element.text=e;else{var n=this._tempStack||[];for(n.length=0,n.push(t);n.length;){var i=n.shift();if((i&&i.element?1:0)&&i.element.type===pc.ELEMENTTYPE_TEXT)return void(i.element.text=e);for(var o=i&&i.children?i.children:[],s=0;s<o.length;s++)n.push(o[s])}}};var MenuMoai=pc.createScript("MenuMoai");MenuMoai.attributes.add("buttonEntities",{type:"entity",array:!0,title:"按钮实体数组",description:"需要绑定点击事件的按钮，支持Button或Element组件"}),MenuMoai.attributes.add("buttonTextKeys",{type:"string",array:!0,title:"按钮文本多语言键",description:"与按钮实体顺序一一对应，如 menu.buttons.start"}),MenuMoai.attributes.add("buttonActionEvents",{type:"string",array:!0,title:"按钮动作事件",description:"点击后触发的全局事件名（app.fire(eventName)）"}),MenuMoai.attributes.add("buttonDialogKeys",{type:"string",array:!0,title:"按钮对话框键",description:"可选：menu.dialogs.*，存在时优先弹出对话框"}),MenuMoai.attributes.add("panelTitleKey",{type:"string",title:"面板标题键",description:"如 menu.panels.title.logo",default:""}),MenuMoai.attributes.add("enableDebugLog",{type:"boolean",default:!1,title:"调试日志"}),MenuMoai.prototype.initialize=function(){this._boundClicks=[],this._onLangChanged=this.refreshTexts.bind(this),this._bindButtons(),this.refreshTexts(),this.app.on("i18n:changed",this._onLangChanged,this)},MenuMoai.prototype.destroy=function(){for(var t=0;t<this._boundClicks.length;t++){var e=this._boundClicks[t];e&&e.entity&&e.entity.enabled&&(e.button&&e.cb&&e.button.off("click",e.cb,this),e.element&&e.cbElement&&e.element.off("click",e.cbElement,this))}this._boundClicks.length=0,this.app.off("i18n:changed",this._onLangChanged,this)},MenuMoai.prototype._bindButtons=function(){for(var t=this,e=this.buttonEntities?this.buttonEntities.length:0,n=0;n<e;n++){var i=this.buttonEntities[n];i&&function(e,n){var clickHandler=function(){t._onButtonClick(e,n)};n.button?(n.button.on("click",clickHandler,t),t._boundClicks.push({entity:n,button:n.button,cb:clickHandler})):n.element?(n.element.on("click",clickHandler,t),t._boundClicks.push({entity:n,element:n.element,cbElement:clickHandler})):t.enableDebugLog&&console.warn("[MenuMoai] Button entity without Button/Element:",n&&n.name)}(n,i)}},MenuMoai.prototype._onButtonClick=function(t,e){this.enableDebugLog&&console.log("[MenuMoai] Click index="+t+" entity="+(e&&e.name));var n=this.buttonDialogKeys&&this.buttonDialogKeys[t]||"",i=this.buttonActionEvents&&this.buttonActionEvents[t]||"";if(n){var o=this._dialogConfigByKey(n);if(o)return void this.app.fire("ui:dialog:open",o)}i&&this.app.fire(i,{source:"MenuMoai",index:t,entity:e})},MenuMoai.prototype.refreshTexts=function(){if(this.panelTitleKey){var t=this._findTitleEntity();t&&this._setEntityText(t,this._t(this.panelTitleKey,""))}for(var e=this.buttonEntities?this.buttonEntities.length:0,n=0;n<e;n++){var i=this.buttonEntities[n],o=this.buttonTextKeys&&this.buttonTextKeys[n]||(i&&i.name?"menu.Text."+i.name:"");i&&o&&this._setEntityText(i,this._t(o,i.name||""))}},MenuMoai.prototype._dialogConfigByKey=function(t){var e=this._t(t+".title",""),n=this._t(t+".message",""),i=this._t(t+".confirm",this._t("menu.labels.yes","Yes")),o=this._t(t+".cancel",this._t("menu.labels.no","No"));return e||n?{title:e,message:n,confirm:i,cancel:o,key:t}:null},MenuMoai.prototype._t=function(t,e){return"undefined"!=typeof window&&window.I18n&&"function"==typeof window.I18n.t?window.I18n.t(t,e):e||t},MenuMoai.prototype._findTitleEntity=function(){var t=this.entity.findByName("Title");return t&&t.element?t:this.entity.element&&this.entity.element.type===pc.ELEMENTTYPE_TEXT?this.entity:null},MenuMoai.prototype._setEntityText=function(t,e){if(t)if(t.element&&t.element.type===pc.ELEMENTTYPE_TEXT)t.element.text=e;else{var n=this._tempStack||[];for(n.length=0,n.push(t);n.length;){var i=n.shift();if((i&&i.element?1:0)&&i.element.type===pc.ELEMENTTYPE_TEXT)return void(i.element.text=e);for(var o=i&&i.children?i.children:[],s=0;s<o.length;s++)n.push(o[s])}}};var MenuTrophy=pc.createScript("MenuTrophy");MenuTrophy.attributes.add("buttonEntities",{type:"entity",array:!0,title:"按钮实体数组",description:"需要绑定点击事件的按钮，支持Button或Element组件"}),MenuTrophy.attributes.add("buttonTextKeys",{type:"string",array:!0,title:"按钮文本多语言键",description:"与按钮实体顺序一一对应，如 menu.buttons.start"}),MenuTrophy.attributes.add("buttonActionEvents",{type:"string",array:!0,title:"按钮动作事件",description:"点击后触发的全局事件名（app.fire(eventName)）"}),MenuTrophy.attributes.add("buttonDialogKeys",{type:"string",array:!0,title:"按钮对话框键",description:"可选：menu.dialogs.*，存在时优先弹出对话框"}),MenuTrophy.attributes.add("panelTitleKey",{type:"string",title:"面板标题键",description:"如 menu.panels.title.trophy",default:""}),MenuTrophy.attributes.add("enableDebugLog",{type:"boolean",default:!1,title:"调试日志"}),MenuTrophy.prototype.initialize=function(){this._boundClicks=[],this._onLangChanged=this.refreshTexts.bind(this),this._bindButtons(),this.refreshTexts(),this.app.on("i18n:changed",this._onLangChanged,this)},MenuTrophy.prototype.destroy=function(){for(var t=0;t<this._boundClicks.length;t++){var e=this._boundClicks[t];e&&e.entity&&e.entity.enabled&&(e.button&&e.cb&&e.button.off("click",e.cb,this),e.element&&e.cbElement&&e.element.off("click",e.cbElement,this))}this._boundClicks.length=0,this.app.off("i18n:changed",this._onLangChanged,this)},MenuTrophy.prototype._bindButtons=function(){for(var t=this,e=this.buttonEntities?this.buttonEntities.length:0,n=0;n<e;n++){var i=this.buttonEntities[n];i&&function(e,n){var clickHandler=function(){t._onButtonClick(e,n)};n.button?(n.button.on("click",clickHandler,t),t._boundClicks.push({entity:n,button:n.button,cb:clickHandler})):n.element?(n.element.on("click",clickHandler,t),t._boundClicks.push({entity:n,element:n.element,cbElement:clickHandler})):t.enableDebugLog&&console.warn("[MenuTrophy] Button entity without Button/Element:",n&&n.name)}(n,i)}},MenuTrophy.prototype._onButtonClick=function(t,e){this.enableDebugLog&&console.log("[MenuTrophy] Click index="+t+" entity="+(e&&e.name));var n=this.buttonDialogKeys&&this.buttonDialogKeys[t]||"",i=this.buttonActionEvents&&this.buttonActionEvents[t]||"";if(n){var o=this._dialogConfigByKey(n);if(o)return void this.app.fire("ui:dialog:open",o)}i&&this.app.fire(i,{source:"MenuTrophy",index:t,entity:e})},MenuTrophy.prototype.refreshTexts=function(){if(this.panelTitleKey){var t=this._findTitleEntity();t&&this._setEntityText(t,this._t(this.panelTitleKey,""))}for(var e=this.buttonEntities?this.buttonEntities.length:0,n=0;n<e;n++){var i=this.buttonEntities[n],o=this.buttonTextKeys&&this.buttonTextKeys[n]||(i&&i.name?"menu.Text."+i.name:"");i&&o&&this._setEntityText(i,this._t(o,i.name||""))}},MenuTrophy.prototype._dialogConfigByKey=function(t){var e=this._t(t+".title",""),n=this._t(t+".message",""),i=this._t(t+".confirm",this._t("menu.labels.yes","Yes")),o=this._t(t+".cancel",this._t("menu.labels.no","No"));return e||n?{title:e,message:n,confirm:i,cancel:o,key:t}:null},MenuTrophy.prototype._t=function(t,e){return"undefined"!=typeof window&&window.I18n&&"function"==typeof window.I18n.t?window.I18n.t(t,e):e||t},MenuTrophy.prototype._findTitleEntity=function(){var t=this.entity.findByName("Title");return t&&t.element?t:this.entity.element&&this.entity.element.type===pc.ELEMENTTYPE_TEXT?this.entity:null},MenuTrophy.prototype._setEntityText=function(t,e){if(t)if(t.element&&t.element.type===pc.ELEMENTTYPE_TEXT)t.element.text=e;else{var n=this._tempStack||[];for(n.length=0,n.push(t);n.length;){var i=n.shift();if((i&&i.element?1:0)&&i.element.type===pc.ELEMENTTYPE_TEXT)return void(i.element.text=e);for(var o=i&&i.children?i.children:[],s=0;s<o.length;s++)n.push(o[s])}}};var WindZone=pc.createScript("windZone");WindZone.attributes.add("force",{type:"vec3",default:[0,400,0],title:"风力(牛顿/帧)"}),WindZone.attributes.add("pulseStrength",{type:"number",default:.2,title:"脉动强度(0~1)"}),WindZone.attributes.add("turbulence",{type:"number",default:.1,title:"湍流(0~1, 轻微抖动)"}),WindZone.attributes.add("particlesEnabled",{type:"boolean",default:!0,title:"启用粒子外观"}),WindZone.attributes.add("emitterRate",{type:"number",default:30,title:"粒子发射率(每秒)"}),WindZone.attributes.add("particleLifetime",{type:"number",default:1.2,title:"粒子寿命(秒)"}),WindZone.attributes.add("particleStartSize",{type:"number",default:.15,title:"粒子起始尺寸"}),WindZone.attributes.add("particleEndSize",{type:"number",default:.05,title:"粒子结束尺寸"}),WindZone.attributes.add("particleSpeed",{type:"number",default:3,title:"粒子初速度(米/秒, 沿风向)"}),WindZone.attributes.add("emitterBoxScale",{type:"vec3",default:[1,1,1],title:"发射体积倍增(相对碰撞盒)"}),WindZone.attributes.add("tintStart",{type:"rgba",default:[.8,1,.9,.35],title:"粒子起始色(rgba)"}),WindZone.attributes.add("tintEnd",{type:"rgba",default:[.6,.9,1,0],title:"粒子结束色(rgba)"}),WindZone.prototype.initialize=function(){this.entity.collision&&this.entity.collision.isTrigger||console.warn("[WindZone] 需要 collision 且 Is Trigger = true"),this.entity.collision.on("triggerenter",this._onEnter,this),this.entity.collision.on("triggerleave",this._onLeave,this),this._makeOrUpdateParticles(),this._dir=new pc.Vec3(this.force.x,this.force.y,this.force.z),this._dir.lengthSq()<1e-6&&this._dir.set(0,1,0),this._dir.normalize()},WindZone.prototype._makeOrUpdateParticles=function(){this.particlesEnabled&&(this._fx&&this._fx.particlesystem?this._configureParticleComponent(this._fx.particlesystem):(this._fx=new pc.Entity("WindParticles"),this.entity.addChild(this._fx),this._fx.addComponent("particlesystem",{numParticles:Math.max(32,this.emitterRate*(this.particleLifetime||1)),lifetime:Math.max(.2,this.particleLifetime),rate:this.emitterRate,loop:!0,emitterShape:pc.EMITTERSHAPE_BOX,emitterExtents:this._calcEmitterExtents(),initialVelocity:this.particleSpeed,localSpace:!0,sort:pc.PARTICLESORT_NONE}),this._configureParticleComponent(this._fx.particlesystem),this._orientParticlesToForce()))},WindZone.prototype._calcEmitterExtents=function(){var t=new pc.Vec3(.5,.5,.5);return this.entity.collision&&"box"===this.entity.collision.type&&t.copy(this.entity.collision.halfExtents),t.x*=this.emitterBoxScale.x,t.y*=this.emitterBoxScale.y,t.z*=this.emitterBoxScale.z,t},WindZone.prototype._configureParticleComponent=function(t){t.colorGraph=new pc.CurveSet([[this.tintStart.r,this.tintEnd.r],[this.tintStart.g,this.tintEnd.g],[this.tintStart.b,this.tintEnd.b]]),t.alphaGraph=new pc.Curve([this.tintStart.a,this.tintEnd.a]),t.scaleGraph=new pc.Curve([this.particleStartSize,this.particleEndSize]);var e=new pc.Vec3(this.force.x,this.force.y,this.force.z).normalize();t.velocityGraph=new pc.CurveSet([[e.x*this.particleSpeed,e.x*this.particleSpeed],[e.y*this.particleSpeed,e.y*this.particleSpeed],[e.z*this.particleSpeed,e.z*this.particleSpeed]]);var i=Math.max(0,Math.min(1,this.turbulence));t.localVelocityGraph=new pc.CurveSet([[-i,i],[-i,i],[-i,i]]),t.rate=this.emitterRate,t.lifetime=this.particleLifetime,t.numParticles=Math.max(32,this.emitterRate*(this.particleLifetime||1)),t.emitterExtents=this._calcEmitterExtents(),t.reset(),t.play()},WindZone.prototype._orientParticlesToForce=function(){if(this._fx){var t=new pc.Vec3(this.force.x,this.force.y,this.force.z);t.lengthSq()<1e-6&&t.set(0,1,0),t.normalize();var e=this._fx.getPosition(),i=(new pc.Vec3).add2(e,t);this._fx.lookAt(i)}},WindZone.prototype._onEnter=function(t){if(t&&t.rigidbody){var e=this.app?.time??.001*pc.now(),i=1+Math.sin(2*e)*this.pulseStrength,r=new pc.Vec3(this.force.x*i,this.force.y*i,this.force.z*i);t.script&&t.script.windAff&&t.script.windAff.enter&&t.script.windAff.enter(r)}},WindZone.prototype._onLeave=function(t){t&&t.rigidbody&&t.script&&t.script.windAff&&t.script.windAff.leave&&t.script.windAff.leave()},WindZone.prototype.update=function(t){var e=this.force;this._lastF&&this._lastF.x===e.x&&this._lastF.y===e.y&&this._lastF.z===e.z||(this._lastF={x:e.x,y:e.y,z:e.z},this._orientParticlesToForce(),this._fx&&this._fx.particlesystem&&this._configureParticleComponent(this._fx.particlesystem))};var SAMPLE_COUNT=15;function computeGaussian(e,t){return 1/Math.sqrt(2*Math.PI*t)*Math.exp(-e*e/(2*t*t))}function calculateBlurValues(e,t,o,r,s){e[0]=computeGaussian(0,s),t[0]=0,t[1]=0;var i,a,l=e[0];for(i=0,a=Math.floor(SAMPLE_COUNT/2);i<a;i++){var u=computeGaussian(i+1,s);e[2*i]=u,e[2*i+1]=u,l+=2*u;var h=2*i+1.5;t[4*i]=o*h,t[4*i+1]=r*h,t[4*i+2]=-o*h,t[4*i+3]=-r*h}for(i=0,a=e.length;i<a;i++)e[i]/=l}function BloomEffect(e){pc.PostEffect.call(this,e);var t={aPosition:pc.SEMANTIC_POSITION},o=["varying vec2 vUv0;","","uniform sampler2D uBaseTexture;","uniform float uBloomThreshold;","","void main(void)","{","    vec4 color = texture2D(uBaseTexture, vUv0);","","    gl_FragColor = clamp((color - uBloomThreshold) / (1.0 - uBloomThreshold), 0.0, 1.0);","}"].join("\n"),r=["#define SAMPLE_COUNT "+SAMPLE_COUNT,"","varying vec2 vUv0;","","uniform sampler2D uBloomTexture;","uniform vec2 uBlurOffsets["+SAMPLE_COUNT+"];","uniform float uBlurWeights["+SAMPLE_COUNT+"];","","void main(void)","{","    vec4 color = vec4(0.0);","    for (int i = 0; i < SAMPLE_COUNT; i++)","    {","        color += texture2D(uBloomTexture, vUv0 + uBlurOffsets[i]) * uBlurWeights[i];","    }","","    gl_FragColor = color;","}"].join("\n"),s=["varying vec2 vUv0;","","uniform float uBloomEffectIntensity;","uniform sampler2D uBaseTexture;","uniform sampler2D uBloomTexture;","","void main(void)","{","    vec4 bloom = texture2D(uBloomTexture, vUv0) * uBloomEffectIntensity;","    vec4 base = texture2D(uBaseTexture, vUv0);","","    base *= (1.0 - clamp(bloom, 0.0, 1.0));","","    gl_FragColor = base + bloom;","}"].join("\n");this.extractShader=pc.createShaderFromCode(e,pc.PostEffect.quadVertexShader,o,"BloomExtractShader",t),this.blurShader=pc.createShaderFromCode(e,pc.PostEffect.quadVertexShader,r,"BloomBlurShader",t),this.combineShader=pc.createShaderFromCode(e,pc.PostEffect.quadVertexShader,s,"BloomCombineShader",t),this.targets=[],this.bloomThreshold=.25,this.blurAmount=4,this.bloomIntensity=1.25,this.sampleWeights=new Float32Array(SAMPLE_COUNT),this.sampleOffsets=new Float32Array(2*SAMPLE_COUNT)}BloomEffect.prototype=Object.create(pc.PostEffect.prototype),BloomEffect.prototype.constructor=BloomEffect,BloomEffect.prototype._destroy=function(){var e;if(this.targets)for(e=0;e<this.targets.length;e++)this.targets[e].destroyTextureBuffers(),this.targets[e].destroy();this.targets.length=0},BloomEffect.prototype._resize=function(e){var t,o=e.colorBuffer.width,r=e.colorBuffer.height;if(o!==this.width||r!==this.height)for(this.width=o,this.height=r,this._destroy(),t=0;t<2;t++){var s=new pc.Texture(this.device,{name:"Bloom Texture"+t,format:pc.PIXELFORMAT_RGBA8,width:o>>1,height:r>>1,mipmaps:!1});s.minFilter=pc.FILTER_LINEAR,s.magFilter=pc.FILTER_LINEAR,s.addressU=pc.ADDRESS_CLAMP_TO_EDGE,s.addressV=pc.ADDRESS_CLAMP_TO_EDGE,s.name="pe-bloom-"+t;var i=new pc.RenderTarget({name:"Bloom Render Target "+t,colorBuffer:s,depth:!1});this.targets.push(i)}},Object.assign(BloomEffect.prototype,{render:function(e,t,o){this._resize(e);var r=this.device.scope;r.resolve("uBloomThreshold").setValue(this.bloomThreshold),r.resolve("uBaseTexture").setValue(e.colorBuffer),this.drawQuad(this.targets[0],this.extractShader),calculateBlurValues(this.sampleWeights,this.sampleOffsets,1/this.targets[1].width,0,this.blurAmount),r.resolve("uBlurWeights[0]").setValue(this.sampleWeights),r.resolve("uBlurOffsets[0]").setValue(this.sampleOffsets),r.resolve("uBloomTexture").setValue(this.targets[0].colorBuffer),this.drawQuad(this.targets[1],this.blurShader),calculateBlurValues(this.sampleWeights,this.sampleOffsets,0,1/this.targets[0].height,this.blurAmount),r.resolve("uBlurWeights[0]").setValue(this.sampleWeights),r.resolve("uBlurOffsets[0]").setValue(this.sampleOffsets),r.resolve("uBloomTexture").setValue(this.targets[1].colorBuffer),this.drawQuad(this.targets[0],this.blurShader),r.resolve("uBloomEffectIntensity").setValue(this.bloomIntensity),r.resolve("uBloomTexture").setValue(this.targets[0].colorBuffer),r.resolve("uBaseTexture").setValue(e.colorBuffer),this.drawQuad(t,this.combineShader,o)}});var Bloom=pc.createScript("bloom");Bloom.attributes.add("bloomIntensity",{type:"number",default:1,min:0,title:"Intensity"}),Bloom.attributes.add("bloomThreshold",{type:"number",default:.25,min:0,max:1,title:"Threshold"}),Bloom.attributes.add("blurAmount",{type:"number",default:4,min:1,title:"Blur amount"}),Bloom.prototype.initialize=function(){this.effect=new BloomEffect(this.app.graphicsDevice),this.effect.bloomThreshold=this.bloomThreshold,this.effect.blurAmount=this.blurAmount,this.effect.bloomIntensity=this.bloomIntensity;var e=this.entity.camera.postEffects;e.addEffect(this.effect),this.on("attr",(function(e,t){this.effect[e]=t}),this),this.on("state",(function(t){t?e.addEffect(this.effect):e.removeEffect(this.effect)})),this.on("destroy",(function(){e.removeEffect(this.effect),this.effect._destroy()}))};function VignetteEffect(e){pc.PostEffect.call(this,e);var t=["uniform sampler2D uColorBuffer;","uniform float uDarkness;","uniform float uOffset;","","varying vec2 vUv0;","","void main() {","    vec4 texel = texture2D(uColorBuffer, vUv0);","    vec2 uv = (vUv0 - vec2(0.5)) * vec2(uOffset);","    gl_FragColor = vec4(mix(texel.rgb, vec3(1.0 - uDarkness), dot(uv, uv)), texel.a);","}"].join("\n");this.vignetteShader=pc.createShaderFromCode(e,pc.PostEffect.quadVertexShader,t,"VignetteShader",{aPosition:pc.SEMANTIC_POSITION}),this.offset=1,this.darkness=1}VignetteEffect.prototype=Object.create(pc.PostEffect.prototype),VignetteEffect.prototype.constructor=VignetteEffect,Object.assign(VignetteEffect.prototype,{render:function(e,t,f){var s=this.device.scope;s.resolve("uColorBuffer").setValue(e.colorBuffer),s.resolve("uOffset").setValue(this.offset),s.resolve("uDarkness").setValue(this.darkness),this.drawQuad(t,this.vignetteShader,f)}});var Vignette=pc.createScript("vignette");Vignette.attributes.add("offset",{type:"number",default:1,min:0,title:"Offset"}),Vignette.attributes.add("darkness",{type:"number",default:1,title:"Darkness"}),Vignette.prototype.initialize=function(){this.effect=new VignetteEffect(this.app.graphicsDevice),this.effect.offset=this.offset,this.effect.darkness=this.darkness,this.on("attr",(function(e,t){this.effect[e]=t}),this);var e=this.entity.camera.postEffects;e.addEffect(this.effect),this.on("state",(function(t){t?e.addEffect(this.effect):e.removeEffect(this.effect)})),this.on("destroy",(function(){e.removeEffect(this.effect)}))};function SSAOEffect(e,t){pc.PostEffect.call(this,e),this.ssaoScript=t,this.needsDepthBuffer=!0;var i=[pc.shaderChunks.screenDepthPS,"","varying vec2 vUv0;","","//uniform sampler2D uColorBuffer;","uniform vec4 uResolution;","","uniform float uAspect;","","#define saturate(x) clamp(x,0.0,1.0)","","// Largely based on 'Dominant Light Shadowing'","// 'Lighting Technology of The Last of Us Part II' by Hawar Doghramachi, Naughty Dog, LLC","","const float kSSCTLog2LodRate = 3.0;","","highp float getWFromProjectionMatrix(const mat4 p, const vec3 v) {","    // this essentially returns (p * vec4(v, 1.0)).w, but we make some assumptions","    // this assumes a perspective projection","    return -v.z;","    // this assumes a perspective or ortho projection","    // return p[2][3] * v.z + p[3][3];","}","","highp float getViewSpaceZFromW(const mat4 p, const float w) {","    // this assumes a perspective projection","    return -w;","    // this assumes a perspective or ortho projection","   // return (w - p[3][3]) / p[2][3];","}","","","const float kLog2LodRate = 3.0;","","vec2 sq(const vec2 a) {","    return a * a;","}","","uniform float uInvFarPlane;","","vec2 pack(highp float depth) {","// we need 16-bits of precision","    highp float z = clamp(depth * uInvFarPlane, 0.0, 1.0);","    highp float t = floor(256.0 * z);","    mediump float hi = t * (1.0 / 256.0);   // we only need 8-bits of precision","    mediump float lo = (256.0 * z) - t;     // we only need 8-bits of precision","    return vec2(hi, lo);","}","","// random number between 0 and 1, using interleaved gradient noise","float random(const highp vec2 w) {","    const vec3 m = vec3(0.06711056, 0.00583715, 52.9829189);","    return fract(m.z * fract(dot(w, m.xy)));","}","","// returns the frag coord in the GL convention with (0, 0) at the bottom-left","highp vec2 getFragCoord() {","    return gl_FragCoord.xy;","}","","highp vec3 computeViewSpacePositionFromDepth(highp vec2 uv, highp float linearDepth) {","    return vec3((0.5 - uv) * vec2(uAspect, 1.0) * linearDepth, linearDepth);","}","","highp vec3 faceNormal(highp vec3 dpdx, highp vec3 dpdy) {","    return normalize(cross(dpdx, dpdy));","}","","// Compute normals using derivatives, which essentially results in half-resolution normals","// this creates arifacts around geometry edges.","// Note: when using the spirv optimizer, this results in much slower execution time because","//       this whole expression is inlined in the AO loop below.","highp vec3 computeViewSpaceNormal(const highp vec3 position) {","    return faceNormal(dFdx(position), dFdy(position));","}","","// Compute normals directly from the depth texture, resulting in full resolution normals","// Note: This is actually as cheap as using derivatives because the texture fetches","//       are essentially equivalent to textureGather (which we don't have on ES3.0),","//       and this is executed just once.","highp vec3 computeViewSpaceNormal(const highp vec3 position, const highp vec2 uv) {","    highp vec2 uvdx = uv + vec2(uResolution.z, 0.0);","    highp vec2 uvdy = uv + vec2(0.0, uResolution.w);","    highp vec3 px = computeViewSpacePositionFromDepth(uvdx, -getLinearScreenDepth(uvdx));","    highp vec3 py = computeViewSpacePositionFromDepth(uvdy, -getLinearScreenDepth(uvdy));","    highp vec3 dpdx = px - position;","    highp vec3 dpdy = py - position;","    return faceNormal(dpdx, dpdy);","}","","// Ambient Occlusion, largely inspired from:","// 'The Alchemy Screen-Space Ambient Obscurance Algorithm' by Morgan McGuire","// 'Scalable Ambient Obscurance' by Morgan McGuire, Michael Mara and David Luebke","","uniform vec2 uSampleCount;","uniform float uSpiralTurns;","","#define PI (3.14159)","","vec3 tapLocation(float i, const float noise) {","    float offset = ((2.0 * PI) * 2.4) * noise;","    float angle = ((i * uSampleCount.y) * uSpiralTurns) * (2.0 * PI) + offset;","    float radius = (i + noise + 0.5) * uSampleCount.y;","    return vec3(cos(angle), sin(angle), radius * radius);","}","","highp vec2 startPosition(const float noise) {","    float angle = ((2.0 * PI) * 2.4) * noise;","    return vec2(cos(angle), sin(angle));","}","","uniform vec2 uAngleIncCosSin;","","highp mat2 tapAngleStep() {","    highp vec2 t = uAngleIncCosSin;","    return mat2(t.x, t.y, -t.y, t.x);","}","","vec3 tapLocationFast(float i, vec2 p, const float noise) {","    float radius = (i + noise + 0.5) * uSampleCount.y;","    return vec3(p, radius * radius);","}","","uniform float uMaxLevel;","uniform float uInvRadiusSquared;","uniform float uMinHorizonAngleSineSquared;","uniform float uBias;","uniform float uPeak2;","","void computeAmbientOcclusionSAO(inout float occlusion, float i, float ssDiskRadius,","        const highp vec2 uv,  const highp vec3 origin, const vec3 normal,","        const vec2 tapPosition, const float noise) {","","    vec3 tap = tapLocationFast(i, tapPosition, noise);","","    float ssRadius = max(1.0, tap.z * ssDiskRadius);","","    vec2 uvSamplePos = uv + vec2(ssRadius * tap.xy) * uResolution.zw;","","    float level = clamp(floor(log2(ssRadius)) - kLog2LodRate, 0.0, float(uMaxLevel));","    highp float occlusionDepth = -getLinearScreenDepth(uvSamplePos);","    highp vec3 p = computeViewSpacePositionFromDepth(uvSamplePos, occlusionDepth);","","    // now we have the sample, compute AO","    vec3 v = p - origin;        // sample vector","    float vv = dot(v, v);       // squared distance","    float vn = dot(v, normal);  // distance * cos(v, normal)","","    // discard samples that are outside of the radius, preventing distant geometry to","    // cast shadows -- there are many functions that work and choosing one is an artistic","    // decision.","    float w = max(0.0, 1.0 - vv * uInvRadiusSquared);","    w = w*w;","","    // discard samples that are too close to the horizon to reduce shadows cast by geometry","    // not sufficiently tessellated. The goal is to discard samples that form an angle 'beta'","    // smaller than 'epsilon' with the horizon. We already have dot(v,n) which is equal to the","    // sin(beta) * |v|. So the test simplifies to vn^2 < vv * sin(epsilon)^2.","    w *= step(vv * uMinHorizonAngleSineSquared, vn * vn);","","    occlusion += w * max(0.0, vn + origin.z * uBias) / (vv + uPeak2);","}","","uniform float uProjectionScaleRadius;","uniform float uIntensity;","","float scalableAmbientObscurance(highp vec2 uv, highp vec3 origin, vec3 normal) {","    float noise = random(getFragCoord());","    highp vec2 tapPosition = startPosition(noise);","    highp mat2 angleStep = tapAngleStep();","","    // Choose the screen-space sample radius","    // proportional to the projected area of the sphere","    float ssDiskRadius = -(uProjectionScaleRadius / origin.z);","","    float occlusion = 0.0;",e.webgl2?"    for (float i = 0.0; i < uSampleCount.x; i += 1.0) {":"   const float maxSampleCount = 256.0;   for (float i = 0.0; i < maxSampleCount; i += 1.0) {       if (i >= uSampleCount.x) break;","        computeAmbientOcclusionSAO(occlusion, i, ssDiskRadius, uv, origin, normal, tapPosition, noise);","        tapPosition = angleStep * tapPosition;","    }","    return sqrt(occlusion * uIntensity);","}","","uniform float uPower;","","void main() {","    highp vec2 uv = vUv0; //variable_vertex.xy; // interpolated to pixel center","","    highp float depth = -getLinearScreenDepth(vUv0);","    highp vec3 origin = computeViewSpacePositionFromDepth(uv, depth);","    vec3 normal = computeViewSpaceNormal(origin, uv);","","    float occlusion = 0.0;","","    if (uIntensity > 0.0) {","        occlusion = scalableAmbientObscurance(uv, origin, normal);","    }","","    // occlusion to visibility","    float aoVisibility = pow(saturate(1.0 - occlusion), uPower);","","    vec4 inCol = vec4(1.0, 1.0, 1.0, 1.0); //texture2D( uColorBuffer,  uv );","","    gl_FragColor.r = aoVisibility; //postProcess.color.rgb = vec3(aoVisibility, pack(origin.z));","}","","void main_old()","{","    vec2 aspectCorrect = vec2( 1.0, uAspect );","","    float depth = getLinearScreenDepth(vUv0);","    gl_FragColor.r = fract(floor(depth*256.0*256.0)),fract(floor(depth*256.0)),fract(depth);","}"].join("\n"),o=[pc.shaderChunks.screenDepthPS,"","varying vec2 vUv0;","","uniform sampler2D uSSAOBuffer;","uniform vec4 uResolution;","","uniform float uAspect;","","uniform int uBilatSampleCount;","uniform float uFarPlaneOverEdgeDistance;","uniform float uBrightness;","","float random(const highp vec2 w) {","    const vec3 m = vec3(0.06711056, 0.00583715, 52.9829189);","    return fract(m.z * fract(dot(w, m.xy)));","}","","float bilateralWeight(in float depth, in float sampleDepth) {","    float diff = (sampleDepth - depth) * uFarPlaneOverEdgeDistance;","    return max(0.0, 1.0 - diff * diff);","}","","void tap(inout float sum, inout float totalWeight, float weight, float depth, vec2 position) {","    // ambient occlusion sample","    float ssao = texture2D( uSSAOBuffer, position ).r;","    float tdepth = -getLinearScreenDepth( position );","","    // bilateral sample","    float bilateral = bilateralWeight(depth, tdepth);","    bilateral *= weight;","    sum += ssao * bilateral;","    totalWeight += bilateral;","}","","void main() {","    highp vec2 uv = vUv0; // variable_vertex.xy; // interpolated at pixel's center","","    // we handle the center pixel separately because it doesn't participate in bilateral filtering","    float depth = -getLinearScreenDepth(vUv0); // unpack(data.gb);","    float totalWeight = 0.0; // float(uBilatSampleCount*2+1)*float(uBilatSampleCount*2+1);","    float ssao = texture2D( uSSAOBuffer, vUv0 ).r;","    float sum = ssao * totalWeight;","",e.webgl2?"    for (int x = -uBilatSampleCount; x <= uBilatSampleCount; x++) {       for (int y = -uBilatSampleCount; y < uBilatSampleCount; y++) {":"    for (int x = -4; x <= 4; x++) {       for (int y = -4; y < 4; y++) {","           float weight = 1.0;","           vec2 offset = vec2(x,y)*uResolution.zw;","           tap(sum, totalWeight, weight, depth, uv + offset);","       }","    }","","    float ao = sum / totalWeight;","","    // simple dithering helps a lot (assumes 8 bits target)","    // this is most useful with high quality/large blurs","    // ao += ((random(gl_FragCoord.xy) - 0.5) / 255.0);","","    ao = mix(ao, 1.0, uBrightness);","    gl_FragColor.a = ao;","}"].join("\n"),a=["varying vec2 vUv0;","uniform sampler2D uColorBuffer;","uniform sampler2D uSSAOBuffer;","","void main(void)","{","    vec4 inCol = texture2D( uColorBuffer, vUv0 );","    float ssao = texture2D( uSSAOBuffer, vUv0 ).a;","    gl_FragColor.rgb = inCol.rgb * ssao;","    gl_FragColor.a = inCol.a;","}"].join("\n"),s={aPosition:pc.SEMANTIC_POSITION};this.ssaoShader=pc.createShaderFromCode(e,pc.PostEffect.quadVertexShader,i,"SsaoShader",s),this.blurShader=pc.createShaderFromCode(e,pc.PostEffect.quadVertexShader,o,"SsaoBlurShader",s),this.outputShader=pc.createShaderFromCode(e,pc.PostEffect.quadVertexShader,a,"SsaoOutputShader",s),this.radius=4,this.brightness=0,this.samples=20,this.downscale=1}SSAOEffect.prototype=Object.create(pc.PostEffect.prototype),SSAOEffect.prototype.constructor=SSAOEffect,SSAOEffect.prototype._destroy=function(){this.target&&(this.target.destroyTextureBuffers(),this.target.destroy(),this.target=null),this.blurTarget&&(this.blurTarget.destroyTextureBuffers(),this.blurTarget.destroy(),this.blurTarget=null)},SSAOEffect.prototype._resize=function(e){var t=Math.ceil(e.colorBuffer.width/this.downscale),i=Math.ceil(e.colorBuffer.height/this.downscale);if(t!==this.width||i!==this.height){this.width=t,this.height=i,this._destroy();var o=new pc.Texture(this.device,{format:pc.PIXELFORMAT_RGBA8,minFilter:pc.FILTER_LINEAR,magFilter:pc.FILTER_LINEAR,addressU:pc.ADDRESS_CLAMP_TO_EDGE,addressV:pc.ADDRESS_CLAMP_TO_EDGE,width:this.width,height:this.height,mipmaps:!1});o.name="SSAO Result",this.target=new pc.RenderTarget({name:"SSAO Result Render Target",colorBuffer:o,depth:!1});var a=new pc.Texture(this.device,{format:pc.PIXELFORMAT_RGBA8,minFilter:pc.FILTER_LINEAR,magFilter:pc.FILTER_LINEAR,addressU:pc.ADDRESS_CLAMP_TO_EDGE,addressV:pc.ADDRESS_CLAMP_TO_EDGE,width:this.width,height:this.height,mipmaps:!1});a.name="SSAO Blur",this.blurTarget=new pc.RenderTarget({name:"SSAO Blur Render Target",colorBuffer:a,depth:!1})}},Object.assign(SSAOEffect.prototype,{render:function(e,t,i){this._resize(e);var o=this.device,a=o.scope,s=this.samples,r=1/(s-.5)*10*2*3.141,n=this.radius,l=.1*n,u=2*l*3.141*.125,c=.5*o.height,h=this.ssaoScript.entity.camera.farClip;a.resolve("uAspect").setValue(this.width/this.height),a.resolve("uResolution").setValue([this.width,this.height,1/this.width,1/this.height]),a.resolve("uBrightness").setValue(this.brightness),a.resolve("uInvFarPlane").setValue(1/h),a.resolve("uSampleCount").setValue([s,1/s]),a.resolve("uSpiralTurns").setValue(10),a.resolve("uAngleIncCosSin").setValue([Math.cos(r),Math.sin(r)]),a.resolve("uMaxLevel").setValue(0),a.resolve("uInvRadiusSquared").setValue(1/(n*n)),a.resolve("uMinHorizonAngleSineSquared").setValue(0),a.resolve("uBias").setValue(.001),a.resolve("uPeak2").setValue(l*l),a.resolve("uIntensity").setValue(u),a.resolve("uPower").setValue(1),a.resolve("uProjectionScaleRadius").setValue(c*n),this.drawQuad(this.target,this.ssaoShader,i),a.resolve("uSSAOBuffer").setValue(this.target.colorBuffer),a.resolve("uFarPlaneOverEdgeDistance").setValue(1),a.resolve("uBilatSampleCount").setValue(4),this.drawQuad(this.blurTarget,this.blurShader,i),a.resolve("uSSAOBuffer").setValue(this.blurTarget.colorBuffer),a.resolve("uColorBuffer").setValue(e.colorBuffer),this.drawQuad(t,this.outputShader,i)}});var SSAO=pc.createScript("ssao");SSAO.attributes.add("radius",{type:"number",default:4,min:0,max:20,title:"Radius"}),SSAO.attributes.add("brightness",{type:"number",default:0,min:0,max:1,title:"Brightness"}),SSAO.attributes.add("samples",{type:"number",default:16,min:1,max:256,title:"Samples"}),SSAO.attributes.add("downscale",{type:"number",default:1,min:1,max:4,title:"Downscale"}),SSAO.prototype.initialize=function(){this.effect=new SSAOEffect(this.app.graphicsDevice,this),this.effect.radius=this.radius,this.effect.brightness=this.brightness,this.effect.samples=this.samples,this.effect.downscale=this.downscale,this.on("attr",(function(e,t){this.effect[e]=t}),this);var e=this.entity.camera.postEffects;e.addEffect(this.effect),this.on("state",(function(t){t?e.addEffect(this.effect):e.removeEffect(this.effect)})),this.on("destroy",(function(){e.removeEffect(this.effect),this.effect._destroy()}))};function HueSaturationEffect(t){pc.PostEffect.call(this,t);var e=["uniform sampler2D uColorBuffer;","uniform float uHue;","uniform float uSaturation;","","varying vec2 vUv0;","","void main() {","    gl_FragColor = texture2D( uColorBuffer, vUv0 );","","    float angle = uHue * 3.14159265;","    float s = sin(angle), c = cos(angle);","    vec3 weights = (vec3(2.0 * c, -sqrt(3.0) * s - c, sqrt(3.0) * s - c) + 1.0) / 3.0;","    float len = length(gl_FragColor.rgb);","    gl_FragColor.rgb = vec3(","        dot(gl_FragColor.rgb, weights.xyz),","        dot(gl_FragColor.rgb, weights.zxy),","        dot(gl_FragColor.rgb, weights.yzx)","    );","","    float average = (gl_FragColor.r + gl_FragColor.g + gl_FragColor.b) / 3.0;","    if (uSaturation > 0.0) {","        gl_FragColor.rgb += (average - gl_FragColor.rgb) * (1.0 - 1.0 / (1.001 - uSaturation));","    } else {","        gl_FragColor.rgb += (average - gl_FragColor.rgb) * (-uSaturation);","    }","}"].join("\n");this.shader=pc.createShaderFromCode(t,pc.PostEffect.quadVertexShader,e,"HueSaturationShader",{aPosition:pc.SEMANTIC_POSITION}),this.hue=0,this.saturation=0}HueSaturationEffect.prototype=Object.create(pc.PostEffect.prototype),HueSaturationEffect.prototype.constructor=HueSaturationEffect,Object.assign(HueSaturationEffect.prototype,{render:function(t,e,r){var a=this.device.scope;a.resolve("uHue").setValue(this.hue),a.resolve("uSaturation").setValue(this.saturation),a.resolve("uColorBuffer").setValue(t.colorBuffer),this.drawQuad(e,this.shader,r)}});var HueSaturation=pc.createScript("hueSaturation");HueSaturation.attributes.add("hue",{type:"number",default:0,min:-1,max:1,title:"Hue"}),HueSaturation.attributes.add("saturation",{type:"number",default:0,min:-1,max:1,title:"Saturation"}),HueSaturation.prototype.initialize=function(){this.effect=new HueSaturationEffect(this.app.graphicsDevice),this.effect.hue=this.hue,this.effect.saturation=this.saturation,this.on("attr",(function(t,e){this.effect[t]=e}),this);var t=this.entity.camera.postEffects;t.addEffect(this.effect),this.on("state",(function(e){e?t.addEffect(this.effect):t.removeEffect(this.effect)})),this.on("destroy",(function(){t.removeEffect(this.effect)}))};function FxaaEffect(e){pc.PostEffect.call(this,e);var o=["uniform sampler2D uColorBuffer;","uniform vec2 uResolution;","","#define FXAA_REDUCE_MIN   (1.0/128.0)","#define FXAA_REDUCE_MUL   (1.0/8.0)","#define FXAA_SPAN_MAX     8.0","","void main()","{","    vec3 rgbNW = texture2D( uColorBuffer, ( gl_FragCoord.xy + vec2( -1.0, -1.0 ) ) * uResolution ).xyz;","    vec3 rgbNE = texture2D( uColorBuffer, ( gl_FragCoord.xy + vec2( 1.0, -1.0 ) ) * uResolution ).xyz;","    vec3 rgbSW = texture2D( uColorBuffer, ( gl_FragCoord.xy + vec2( -1.0, 1.0 ) ) * uResolution ).xyz;","    vec3 rgbSE = texture2D( uColorBuffer, ( gl_FragCoord.xy + vec2( 1.0, 1.0 ) ) * uResolution ).xyz;","    vec4 rgbaM  = texture2D( uColorBuffer,  gl_FragCoord.xy  * uResolution );","    vec3 rgbM  = rgbaM.xyz;","    float opacity  = rgbaM.w;","","    vec3 luma = vec3( 0.299, 0.587, 0.114 );","","    float lumaNW = dot( rgbNW, luma );","    float lumaNE = dot( rgbNE, luma );","    float lumaSW = dot( rgbSW, luma );","    float lumaSE = dot( rgbSE, luma );","    float lumaM  = dot( rgbM,  luma );","    float lumaMin = min( lumaM, min( min( lumaNW, lumaNE ), min( lumaSW, lumaSE ) ) );","    float lumaMax = max( lumaM, max( max( lumaNW, lumaNE) , max( lumaSW, lumaSE ) ) );","","    vec2 dir;","    dir.x = -((lumaNW + lumaNE) - (lumaSW + lumaSE));","    dir.y =  ((lumaNW + lumaSW) - (lumaNE + lumaSE));","","    float dirReduce = max( ( lumaNW + lumaNE + lumaSW + lumaSE ) * ( 0.25 * FXAA_REDUCE_MUL ), FXAA_REDUCE_MIN );","","    float rcpDirMin = 1.0 / ( min( abs( dir.x ), abs( dir.y ) ) + dirReduce );","    dir = min( vec2( FXAA_SPAN_MAX, FXAA_SPAN_MAX), max( vec2(-FXAA_SPAN_MAX, -FXAA_SPAN_MAX), dir * rcpDirMin)) * uResolution;","","    vec3 rgbA = 0.5 * (","        texture2D( uColorBuffer, gl_FragCoord.xy  * uResolution + dir * ( 1.0 / 3.0 - 0.5 ) ).xyz +","        texture2D( uColorBuffer, gl_FragCoord.xy  * uResolution + dir * ( 2.0 / 3.0 - 0.5 ) ).xyz );","","    vec3 rgbB = rgbA * 0.5 + 0.25 * (","        texture2D( uColorBuffer, gl_FragCoord.xy  * uResolution + dir * -0.5 ).xyz +","        texture2D( uColorBuffer, gl_FragCoord.xy  * uResolution + dir * 0.5 ).xyz );","","    float lumaB = dot( rgbB, luma );","","    if ( ( lumaB < lumaMin ) || ( lumaB > lumaMax ) )","    {","        gl_FragColor = vec4( rgbA, opacity );","    }","    else","    {","        gl_FragColor = vec4( rgbB, opacity );","    }","}"].join("\n");this.fxaaShader=pc.createShaderFromCode(e,pc.PostEffect.quadVertexShader,o,"FxaaShader",{aPosition:pc.SEMANTIC_POSITION}),this.resolution=new Float32Array(2)}FxaaEffect.prototype=Object.create(pc.PostEffect.prototype),FxaaEffect.prototype.constructor=FxaaEffect,Object.assign(FxaaEffect.prototype,{render:function(e,o,a){var r=this.device.scope;this.resolution[0]=1/e.width,this.resolution[1]=1/e.height,r.resolve("uResolution").setValue(this.resolution),r.resolve("uColorBuffer").setValue(e.colorBuffer),this.drawQuad(o,this.fxaaShader,a)}});var Fxaa=pc.createScript("fxaa");Fxaa.prototype.initialize=function(){this.effect=new FxaaEffect(this.app.graphicsDevice);var e=this.entity.camera.postEffects;e.addEffect(this.effect),this.on("state",(function(o){o?e.addEffect(this.effect):e.removeEffect(this.effect)})),this.on("destroy",(function(){e.removeEffect(this.effect)}))};function BrightnessContrastEffect(t){pc.PostEffect.call(this,t);var e=["uniform sampler2D uColorBuffer;","uniform float uBrightness;","uniform float uContrast;","","varying vec2 vUv0;","","void main() {","    gl_FragColor = texture2D( uColorBuffer, vUv0 );","    gl_FragColor.rgb += uBrightness;","","    if (uContrast > 0.0) {","        gl_FragColor.rgb = (gl_FragColor.rgb - 0.5) / (1.0 - uContrast) + 0.5;","    } else {","        gl_FragColor.rgb = (gl_FragColor.rgb - 0.5) * (1.0 + uContrast) + 0.5;","    }","}"].join("\n");this.shader=pc.createShaderFromCode(t,pc.PostEffect.quadVertexShader,e,"BrightnessContrastShader",{aPosition:pc.SEMANTIC_POSITION}),this.brightness=0,this.contrast=0}BrightnessContrastEffect.prototype=Object.create(pc.PostEffect.prototype),BrightnessContrastEffect.prototype.constructor=BrightnessContrastEffect,Object.assign(BrightnessContrastEffect.prototype,{render:function(t,e,s){var r=this.device.scope;r.resolve("uBrightness").setValue(this.brightness),r.resolve("uContrast").setValue(this.contrast),r.resolve("uColorBuffer").setValue(t.colorBuffer),this.drawQuad(e,this.shader,s)}});var BrightnessContrast=pc.createScript("brightnessContrast");BrightnessContrast.attributes.add("brightness",{type:"number",default:0,min:-1,max:1,title:"Brightness"}),BrightnessContrast.attributes.add("contrast",{type:"number",default:0,min:-1,max:1,title:"Contrast"}),BrightnessContrast.prototype.initialize=function(){this.effect=new BrightnessContrastEffect(this.app.graphicsDevice),this.effect.brightness=this.brightness,this.effect.contrast=this.contrast,this.on("attr",(function(t,e){this.effect[t]=e}),this);var t=this.entity.camera.postEffects;t.addEffect(this.effect),this.on("state",(function(e){e?t.addEffect(this.effect):t.removeEffect(this.effect)})),this.on("destroy",(function(){t.removeEffect(this.effect)}))};function BokehEffect(e){pc.PostEffect.call(this,e),this.needsDepthBuffer=!0;var r=[pc.shaderChunks.screenDepthPS,"","varying vec2 vUv0;","","uniform sampler2D uColorBuffer;","","uniform float uMaxBlur;","uniform float uAperture;","","uniform float uFocus;","uniform float uAspect;","","void main()","{","    vec2 aspectCorrect = vec2( 1.0, uAspect );","","    float factor = ((getLinearScreenDepth(vUv0) * -1.0) - uFocus) / camera_params.y;","","    vec2 dofblur = vec2 ( clamp( factor * uAperture, -uMaxBlur, uMaxBlur ) );","","    vec2 dofblur9 = dofblur * 0.9;","    vec2 dofblur7 = dofblur * 0.7;","    vec2 dofblur4 = dofblur * 0.4;","","    vec4 col;","","    col  = texture2D( uColorBuffer, vUv0 );","    col += texture2D( uColorBuffer, vUv0 + ( vec2(  0.0,   0.4  ) * aspectCorrect ) * dofblur );","    col += texture2D( uColorBuffer, vUv0 + ( vec2(  0.15,  0.37 ) * aspectCorrect ) * dofblur );","    col += texture2D( uColorBuffer, vUv0 + ( vec2(  0.29,  0.29 ) * aspectCorrect ) * dofblur );","    col += texture2D( uColorBuffer, vUv0 + ( vec2( -0.37,  0.15 ) * aspectCorrect ) * dofblur );","    col += texture2D( uColorBuffer, vUv0 + ( vec2(  0.40,  0.0  ) * aspectCorrect ) * dofblur );","    col += texture2D( uColorBuffer, vUv0 + ( vec2(  0.37, -0.15 ) * aspectCorrect ) * dofblur );","    col += texture2D( uColorBuffer, vUv0 + ( vec2(  0.29, -0.29 ) * aspectCorrect ) * dofblur );","    col += texture2D( uColorBuffer, vUv0 + ( vec2( -0.15, -0.37 ) * aspectCorrect ) * dofblur );","    col += texture2D( uColorBuffer, vUv0 + ( vec2(  0.0,  -0.4  ) * aspectCorrect ) * dofblur );","    col += texture2D( uColorBuffer, vUv0 + ( vec2( -0.15,  0.37 ) * aspectCorrect ) * dofblur );","    col += texture2D( uColorBuffer, vUv0 + ( vec2( -0.29,  0.29 ) * aspectCorrect ) * dofblur );","    col += texture2D( uColorBuffer, vUv0 + ( vec2(  0.37,  0.15 ) * aspectCorrect ) * dofblur );","    col += texture2D( uColorBuffer, vUv0 + ( vec2( -0.4,   0.0  ) * aspectCorrect ) * dofblur );","    col += texture2D( uColorBuffer, vUv0 + ( vec2( -0.37, -0.15 ) * aspectCorrect ) * dofblur );","    col += texture2D( uColorBuffer, vUv0 + ( vec2( -0.29, -0.29 ) * aspectCorrect ) * dofblur );","    col += texture2D( uColorBuffer, vUv0 + ( vec2(  0.15, -0.37 ) * aspectCorrect ) * dofblur );","","    col += texture2D( uColorBuffer, vUv0 + ( vec2(  0.15,  0.37 ) * aspectCorrect ) * dofblur9 );","    col += texture2D( uColorBuffer, vUv0 + ( vec2( -0.37,  0.15 ) * aspectCorrect ) * dofblur9 );","    col += texture2D( uColorBuffer, vUv0 + ( vec2(  0.37, -0.15 ) * aspectCorrect ) * dofblur9 );","    col += texture2D( uColorBuffer, vUv0 + ( vec2( -0.15, -0.37 ) * aspectCorrect ) * dofblur9 );","    col += texture2D( uColorBuffer, vUv0 + ( vec2( -0.15,  0.37 ) * aspectCorrect ) * dofblur9 );","    col += texture2D( uColorBuffer, vUv0 + ( vec2(  0.37,  0.15 ) * aspectCorrect ) * dofblur9 );","    col += texture2D( uColorBuffer, vUv0 + ( vec2( -0.37, -0.15 ) * aspectCorrect ) * dofblur9 );","    col += texture2D( uColorBuffer, vUv0 + ( vec2(  0.15, -0.37 ) * aspectCorrect ) * dofblur9 );","","    col += texture2D( uColorBuffer, vUv0 + ( vec2(  0.29,  0.29 ) * aspectCorrect ) * dofblur7 );","    col += texture2D( uColorBuffer, vUv0 + ( vec2(  0.40,  0.0  ) * aspectCorrect ) * dofblur7 );","    col += texture2D( uColorBuffer, vUv0 + ( vec2(  0.29, -0.29 ) * aspectCorrect ) * dofblur7 );","    col += texture2D( uColorBuffer, vUv0 + ( vec2(  0.0,  -0.4  ) * aspectCorrect ) * dofblur7 );","    col += texture2D( uColorBuffer, vUv0 + ( vec2( -0.29,  0.29 ) * aspectCorrect ) * dofblur7 );","    col += texture2D( uColorBuffer, vUv0 + ( vec2( -0.4,   0.0  ) * aspectCorrect ) * dofblur7 );","    col += texture2D( uColorBuffer, vUv0 + ( vec2( -0.29, -0.29 ) * aspectCorrect ) * dofblur7 );","    col += texture2D( uColorBuffer, vUv0 + ( vec2(  0.0,   0.4  ) * aspectCorrect ) * dofblur7 );","","    col += texture2D( uColorBuffer, vUv0 + ( vec2(  0.29,  0.29 ) * aspectCorrect ) * dofblur4 );","    col += texture2D( uColorBuffer, vUv0 + ( vec2(  0.4,   0.0  ) * aspectCorrect ) * dofblur4 );","    col += texture2D( uColorBuffer, vUv0 + ( vec2(  0.29, -0.29 ) * aspectCorrect ) * dofblur4 );","    col += texture2D( uColorBuffer, vUv0 + ( vec2(  0.0,  -0.4  ) * aspectCorrect ) * dofblur4 );","    col += texture2D( uColorBuffer, vUv0 + ( vec2( -0.29,  0.29 ) * aspectCorrect ) * dofblur4 );","    col += texture2D( uColorBuffer, vUv0 + ( vec2( -0.4,   0.0  ) * aspectCorrect ) * dofblur4 );","    col += texture2D( uColorBuffer, vUv0 + ( vec2( -0.29, -0.29 ) * aspectCorrect ) * dofblur4 );","    col += texture2D( uColorBuffer, vUv0 + ( vec2(  0.0,   0.4  ) * aspectCorrect ) * dofblur4 );","","    gl_FragColor = col / 41.0;","    gl_FragColor.a = 1.0;","}"].join("\n");this.shader=pc.createShaderFromCode(e,pc.PostEffect.quadVertexShader,r,"BokehShader",{aPosition:pc.SEMANTIC_POSITION}),this.maxBlur=.02,this.aperture=1,this.focus=1}BokehEffect.prototype=Object.create(pc.PostEffect.prototype),BokehEffect.prototype.constructor=BokehEffect,Object.assign(BokehEffect.prototype,{render:function(e,r,t){var o=this.device,u=o.scope;u.resolve("uMaxBlur").setValue(this.maxBlur),u.resolve("uAperture").setValue(this.aperture),u.resolve("uFocus").setValue(this.focus),u.resolve("uAspect").setValue(o.width/o.height),u.resolve("uColorBuffer").setValue(e.colorBuffer),this.drawQuad(r,this.shader,t)}});var Bokeh=pc.createScript("bokeh");Bokeh.attributes.add("maxBlur",{type:"number",default:.02,min:0,max:1,title:"Max Blur"}),Bokeh.attributes.add("aperture",{type:"number",default:1,min:0,max:1,title:"Aperture"}),Bokeh.attributes.add("focus",{type:"number",default:1,title:"Focus"}),Bokeh.prototype.initialize=function(){this.effect=new BokehEffect(this.app.graphicsDevice),this.effect.maxBlur=this.maxBlur,this.effect.aperture=this.aperture,this.effect.focus=this.focus,this.on("attr",(function(e,r){this.effect[e]=r}),this);var e=this.entity.camera.postEffects;e.addEffect(this.effect),this.on("state",(function(r){r?e.addEffect(this.effect):e.removeEffect(this.effect)})),this.on("destroy",(function(){e.removeEffect(this.effect)}))};function BlendEffect(e){pc.PostEffect.call(this,e);var t=["uniform float uMixRatio;","uniform sampler2D uColorBuffer;","uniform sampler2D uBlendMap;","","varying vec2 vUv0;","","void main(void)","{","    vec4 texel1 = texture2D(uColorBuffer, vUv0);","    vec4 texel2 = texture2D(uBlendMap, vUv0);","    gl_FragColor = mix(texel1, texel2, uMixRatio);","}"].join("\n");this.shader=pc.createShaderFromCode(e,pc.PostEffect.quadVertexShader,t,"BlendShader",{aPosition:pc.SEMANTIC_POSITION}),this.mixRatio=.5,this.blendMap=new pc.Texture(e),this.blendMap.name="pe-blend"}BlendEffect.prototype=Object.create(pc.PostEffect.prototype),BlendEffect.prototype.constructor=BlendEffect,Object.assign(BlendEffect.prototype,{render:function(e,t,i){var a=this.device.scope;a.resolve("uMixRatio").setValue(this.mixRatio),a.resolve("uColorBuffer").setValue(e.colorBuffer),a.resolve("uBlendMap").setValue(this.blendMap),this.drawQuad(t,this.shader,i)}});var Blend=pc.createScript("blend");Blend.attributes.add("mixRatio",{type:"number",default:.5,min:0,max:1,title:"Mix Ratio"}),Blend.attributes.add("blendMap",{type:"asset",assetType:"texture",title:"Blend Map"}),Blend.prototype.initialize=function(){this.effect=new BlendEffect(this.app.graphicsDevice),this.effect.mixRatio=this.mixRatio,this.blendMap&&(this.effect.blendMap=this.blendMap.resource);var e=this.entity.camera.postEffects;e.addEffect(this.effect),this.on("state",(function(t){t?e.addEffect(this.effect):e.removeEffect(this.effect)})),this.on("destroy",(function(){e.removeEffect(this.effect)})),this.on("attr:mixRatio",(function(e){this.effect.mixRatio=e}),this),this.on("attr:blendMap",(function(e){this.effect.blendMap=e?e.resource:null}),this)};var MenuSpriteTripleFader=pc.createScript("menuSpriteTripleFader");MenuSpriteTripleFader.attributes.add("normalSprite",{type:"asset",assetType:"sprite",title:"Normal Sprite (默认取父Element)",default:null}),MenuSpriteTripleFader.attributes.add("hoverSprite",{type:"asset",assetType:"sprite",title:"Hover Sprite",default:null}),MenuSpriteTripleFader.attributes.add("pressedSprite",{type:"asset",assetType:"sprite",title:"Pressed Sprite",default:null}),MenuSpriteTripleFader.attributes.add("normalFrame",{type:"number",title:"Normal Frame",default:0}),MenuSpriteTripleFader.attributes.add("hoverFrame",{type:"number",title:"Hover Frame",default:0}),MenuSpriteTripleFader.attributes.add("pressedFrame",{type:"number",title:"Pressed Frame",default:0}),MenuSpriteTripleFader.attributes.add("fadeDuration",{type:"number",title:"淡入/淡出时长(秒)",default:.15,min:0}),MenuSpriteTripleFader.attributes.add("ease",{type:"string",title:"缓动",enum:[{Smoothstep:"smooth"},{Linear:"linear"},{"Ease In":"in"},{"Ease Out":"out"}],default:"smooth"}),MenuSpriteTripleFader.attributes.add("disableButtonTransitions",{type:"boolean",default:!0,title:"禁用 Button 视觉过渡"}),MenuSpriteTripleFader.attributes.add("integrateWithCameraUI",{type:"boolean",default:!0,title:"接入 CameraUIController"}),MenuSpriteTripleFader.attributes.add("cameraPositionScope",{type:"string",default:"main",title:"机位作用域（匹配 controller.targetCameraPosition）"}),MenuSpriteTripleFader.prototype.initialize=function(){this._baseEl=this.entity.element,this._btn=this.entity.button,this._baseEl&&this._baseEl.type===pc.ELEMENTTYPE_IMAGE?this._btn?(this.disableButtonTransitions&&void 0!==pc.BUTTON_TRANSITION_MODE_NONE&&(this._prevTransitionMode=this._btn.transitionMode,this._btn.transitionMode=pc.BUTTON_TRANSITION_MODE_NONE,this._btn.hoverSpriteAsset=null,this._btn.pressedSpriteAsset=null,this._btn.inactiveSpriteAsset=null),!this.normalSprite&&this._baseEl.spriteAsset&&(this.normalSprite=this._baseEl.spriteAsset,this.normalFrame=this._baseEl.spriteFrame||0),this._pendingRegister=[],this._layerNormal=this._createLayer("__fader_normal__",0),this._layerHover=this._createLayer("__fader_hover__",1),this._layerPressed=this._createLayer("__fader_pressed__",2),this._applySprite(this._layerNormal.element,this.normalSprite,this.normalFrame),this._applySprite(this._layerHover.element,this.hoverSprite||this.normalSprite,this.hoverSprite?this.hoverFrame:this.normalFrame),this._applySprite(this._layerPressed.element,this.pressedSprite||this.hoverSprite||this.normalSprite,this.pressedSprite?this.pressedFrame:this.hoverSprite?this.hoverFrame:this.normalFrame),this._setOpacity(this._layerNormal.element,1),this._setOpacity(this._layerHover.element,0),this._setOpacity(this._layerPressed.element,0),this._baseOrder=this._baseEl.drawOrder||0,this._applyDrawOrders(),this._anims={hover:null,pressed:null},this._updateBound=this._onUpdate.bind(this),this._animating=!1,this._isHovering=!1,this._bound=[],this._bind(this._btn,"mouseenter",this._onEnter),this._bind(this._btn,"mouseleave",this._onLeave),this._bind(this._btn,"mousedown",this._onDown),this._bind(this._btn,"mouseup",this._onUp),this._bind(this._btn,"touchstart",this._onDown),this._bind(this._btn,"touchend",this._onUp),this.integrateWithCameraUI&&(this._tryRegisterAllToCameraUI(),this._onCamEv=this._onCamEv||this._tryRegisterAllToCameraUI.bind(this),this.app.on("ui:camera:active",this._onCamEv,this))):console.warn("[menu-sprite-triple-fader] 需要 Button 组件提供输入事件"):console.warn("[menu-sprite-triple-fader] 需要挂在带 Element(Image) 的实体上")},MenuSpriteTripleFader.prototype.destroy=function(){if(this._bound){for(var e=0;e<this._bound.length;e++){var t=this._bound[e];t.tgt.off(t.ev,t.cb,this)}this._bound.length=0}this._animating&&(this.app.off("update",this._updateBound,this),this._animating=!1),this._onCamEv&&(this.app.off("ui:camera:active",this._onCamEv,this),this._onCamEv=null),this._btn&&null!=this._prevTransitionMode&&(this._btn.transitionMode=this._prevTransitionMode)},MenuSpriteTripleFader.prototype._bind=function(e,t,i){var r=i.bind(this);e.on(t,r,this),this._bound.push({tgt:e,ev:t,cb:r})},MenuSpriteTripleFader.prototype._onEnter=function(){this._isHovering=!0,this._fade(this._layerHover.element,"hover",1)},MenuSpriteTripleFader.prototype._onLeave=function(){this._isHovering=!1,this._fade(this._layerHover.element,"hover",0),this._fade(this._layerPressed.element,"pressed",0)},MenuSpriteTripleFader.prototype._onDown=function(){this._fade(this._layerPressed.element,"pressed",1)},MenuSpriteTripleFader.prototype._onUp=function(){this._fade(this._layerPressed.element,"pressed",0),this._isHovering&&this._fade(this._layerHover.element,"hover",1)},MenuSpriteTripleFader.prototype._fade=function(e,t,i){var r=Math.max(0,this.fadeDuration);if(0===r)return this._setOpacity(e,i),this._anims[t]=null,void this._checkStopUpdate();var s=e.opacity;this._anims[t]&&this._anims[t].target===i||(this._anims[t]={el:e,t:0,dur:r,start:s,target:i},this._ensureUpdate())},MenuSpriteTripleFader.prototype._onUpdate=function(e){var t=!1;t=this._stepAnim("hover",e)||t,(t=this._stepAnim("pressed",e)||t)||this._checkStopUpdate()},MenuSpriteTripleFader.prototype._stepAnim=function(e,t){var i=this._anims[e];if(!i)return!1;i.t+=t;var r=Math.min(1,i.t/Math.max(1e-4,i.dur)),s=this._ease(r),a=i.start+(i.target-i.start)*s;return this._setOpacity(i.el,a),!(r>=1)||(this._setOpacity(i.el,i.target),this._anims[e]=null,!1)},MenuSpriteTripleFader.prototype._ensureUpdate=function(){this._animating||(this.app.on("update",this._updateBound,this),this._animating=!0)},MenuSpriteTripleFader.prototype._checkStopUpdate=function(){this._anims.hover||this._anims.pressed||this._animating&&(this.app.off("update",this._updateBound,this),this._animating=!1)},MenuSpriteTripleFader.prototype._ease=function(e){switch(this.ease){case"linear":return e;case"in":return e*e;case"out":return e*(2-e);default:return e*e*(3-2*e)}},MenuSpriteTripleFader.prototype._tryRegisterAllToCameraUI=function(){if(this.integrateWithCameraUI){var e=function(e){try{if("undefined"!=typeof CameraUIController&&CameraUIController.getInstance){var t=CameraUIController.getInstance(this.cameraPositionScope);if(t&&t.addUIEntity)return t.addUIEntity(e),!0}}catch(e){}return!1}.bind(this);this._pendingRegister.length=0,e(this._layerNormal)||this._pendingRegister.push(this._layerNormal),e(this._layerHover)||this._pendingRegister.push(this._layerHover),e(this._layerPressed)||this._pendingRegister.push(this._layerPressed),0===this._pendingRegister.length&&this._onCamEv&&(this.app.off("ui:camera:active",this._onCamEv,this),this._onCamEv=null)}},MenuSpriteTripleFader.prototype._createLayer=function(e,t){var i=new pc.Entity(e),r=this._baseEl.layers&&this._baseEl.layers.length?this._baseEl.layers.slice():this.entity.element&&this.entity.element.layers&&this.entity.element.layers.length?this.entity.element.layers.slice():[pc.LAYERID_UI];if(i.addComponent("element",{type:pc.ELEMENTTYPE_IMAGE,anchor:this._baseEl.anchor.clone(),pivot:this._baseEl.pivot.clone(),width:this._baseEl.width,height:this._baseEl.height,useInput:!1,opacity:0,layers:r}),this.entity.addChild(i),i.element.drawOrder=(this._baseEl.drawOrder||0)+t,this.integrateWithCameraUI)try{if("undefined"!=typeof CameraUIController&&CameraUIController.getInstance){var s=CameraUIController.getInstance(this.cameraPositionScope);s&&s.addUIEntity?s.addUIEntity(i):this._pendingRegister.push(i)}else this._pendingRegister.push(i)}catch(e){this._pendingRegister.push(i)}return i},MenuSpriteTripleFader.prototype._applySprite=function(e,t,i){t&&(e.spriteAsset=t),"number"==typeof i&&(e.spriteFrame=0|i)},MenuSpriteTripleFader.prototype._applyDrawOrders=function(){var e=this._baseOrder;this._layerNormal.element.drawOrder=e+0,this._layerHover.element.drawOrder=e+1,this._layerPressed.element.drawOrder=e+2},MenuSpriteTripleFader.prototype._setOpacity=function(e,t){t<0&&(t=0),t>1&&(t=1),e.opacity=t};var AudioUnlocker=pc.createScript("audioUnlocker");AudioUnlocker.prototype.initialize=function(){var n=this.app,o=n.soundManager&&n.soundManager.context;if(o){var e=this;this._unlocked=!1,this._unlock=function(){try{"suspended"===o.state&&o.resume&&o.resume()}catch(n){}e._removeDomListeners(),e._unlocked=!0;try{n.fire("audio:unlocked")}catch(n){}},this._onPointerUp=function(){e._unlock()},this._onTouchEnd=function(){e._unlock()},this._onKeyDown=function(){e._unlock()},window.addEventListener("pointerup",this._onPointerUp,{once:!0}),window.addEventListener("touchend",this._onTouchEnd,{once:!0}),window.addEventListener("keydown",this._onKeyDown,{once:!0})}},AudioUnlocker.prototype._removeDomListeners=function(){this._onPointerUp&&window.removeEventListener("pointerup",this._onPointerUp),this._onTouchEnd&&window.removeEventListener("touchend",this._onTouchEnd),this._onKeyDown&&window.removeEventListener("keydown",this._onKeyDown)},AudioUnlocker.prototype.destroy=function(){this._removeDomListeners()};var AudioBusManager=pc.createScript("audioBusManager");AudioBusManager.attributes.add("buses",{type:"string",array:!0,default:["master","music","sfx","ui","ambience","voice"],title:"Bus 列表"}),AudioBusManager.attributes.add("enableDebugLog",{type:"boolean",default:!1,title:"调试日志"}),AudioBusManager.prototype.initialize=function(){var t=this.app;if(this.ctx=t.soundManager&&t.soundManager.context,this.bus={},this._shots={},this._onSetVolume=this.setVolume.bind(this),this._onMute=this.mute.bind(this),this._onRegShot=this.registerSnapshot.bind(this),this._onApplyShot=this.applySnapshot.bind(this),this._onDuck=this.duck.bind(this),this._onGetBus=this._handleGetBus.bind(this),t.on("audio:bus:setVolume",this._onSetVolume,this),t.on("audio:bus:mute",this._onMute,this),t.on("audio:snapshot:register",this._onRegShot,this),t.on("audio:snapshot:apply",this._onApplyShot,this),t.on("audio:duck",this._onDuck,this),t.on("audio:getBus",this._onGetBus,this),this.ctx){this.master=this.ctx.createGain(),this.master.gain.value=1,this.master.connect(this.ctx.destination);for(var s=0;s<this.buses.length;s++){var i=this.buses[s],e=this.ctx.createGain();e.gain.value=1,e.connect(this.master),this.bus[i]=e}this.bus.master||(this.bus.master=this.master)}else this.enableDebugLog&&console.warn("[AudioBusManager] No AudioContext; bus features limited.")},AudioBusManager.prototype._handleGetBus=function(t,s){"function"==typeof s&&s(this.bus&&this.bus[t]||this.master||null)},AudioBusManager.prototype._ramp=function(t,s,i){if(t){var e=this.ctx?this.ctx.currentTime:0;try{t.cancelScheduledValues&&t.cancelScheduledValues(e),t.setValueAtTime&&t.setValueAtTime(t.value,e),t.linearRampToValueAtTime&&t.linearRampToValueAtTime(s,e+Math.max(1e-4,i||0))}catch(t){}}},AudioBusManager.prototype.setVolume=function(t){if(t){var s=t.bus||"master",i=this.bus[s];if(i&&i.gain){var e=Math.max(0,Math.min(1,t.volume));this._ramp(i.gain,e,t.dur||0)}}},AudioBusManager.prototype.mute=function(t){if(t){var s=t.bus||"master",i=this.bus[s];i&&i.gain&&this._ramp(i.gain,t.mute?0:1,t.dur||0)}},AudioBusManager.prototype.registerSnapshot=function(t){t&&t.name&&(this._shots[t.name]=t.values||{})},AudioBusManager.prototype.applySnapshot=function(t){if(t&&t.name){var s=this._shots[t.name];if(s)for(var i in s)if(s.hasOwnProperty(i)&&this.bus[i]&&this.bus[i].gain){var e=Math.max(0,Math.min(1,s[i]));this._ramp(this.bus[i].gain,e,t.dur||0)}}},AudioBusManager.prototype.duck=function(t){if(t){var s=this.bus[t.duck];if(s&&s.gain&&this.ctx){var i=Math.max(0,Math.min(1,null!=t.amount?t.amount:.5)),e=t.attack||.05,a=t.hold||.1,u=t.release||.3,o=this.ctx.currentTime,n=s.gain;try{n.cancelScheduledValues(o),n.setValueAtTime(n.value,o),n.linearRampToValueAtTime(Math.max(0,n.value*(1-i)),o+e),n.setValueAtTime(n.value,o+e+a),n.linearRampToValueAtTime(1,o+e+a+u)}catch(t){}}}},AudioBusManager.prototype.destroy=function(){var t=this.app;t.off("audio:bus:setVolume",this._onSetVolume,this),t.off("audio:bus:mute",this._onMute,this),t.off("audio:snapshot:register",this._onRegShot,this),t.off("audio:snapshot:apply",this._onApplyShot,this),t.off("audio:duck",this._onDuck,this),t.off("audio:getBus",this._onGetBus,this)};!function(t){"use strict";var i={_initialized:!1,_app:null,storageKey:"game.audio.v1",data:{music:1,sfx:1,ui:1,master:1,mute:!1},initialize:function(t,i){if(this._initialized)console.warn("[GlobalAudioSettings] 已经初始化过了");else{this._app=t,this._initialized=!0,i&&(this.storageKey=i),console.log("[GlobalAudioSettings] 全局音频设置管理器初始化"),this._loadFromGameManager(),this._applyAll();var a=this;this._onSettingChanged=function(t,i){a._handleGameManagerSetting(t,i)},this._app.on("setting:changed",this._onSettingChanged,this),this._app.on("audio:settings:set",this.set,this),this._app.on("audio:settings:load",this.load,this),this._app.on("audio:settings:save",this.save,this)}},_loadFromGameManager:function(){if("undefined"!=typeof GlobalGame&&GlobalGame.getSetting){var t=GlobalGame.getSetting("masterVolume",80)/100,i=GlobalGame.getSetting("musicVolume",70)/100,a=GlobalGame.getSetting("sfxVolume",80)/100,s=GlobalGame.getSetting("uiVolume",80)/100,e=GlobalGame.getSetting("mute",!1);this.data={master:t,music:i,sfx:a,ui:s,mute:e},console.log("[GlobalAudioSettings] ✓ 从GameManager加载设置:",this.data)}else this.data=this._load()||{music:1,sfx:1,ui:1,master:1,mute:!1},console.log("[GlobalAudioSettings] 从localStorage加载设置:",this.data)},_handleGameManagerSetting:function(t,i){if(t){var a=!1;"masterVolume"===t?(this.data.master=i/100,a=!0):"musicVolume"===t?(this.data.music=i/100,a=!0):"sfxVolume"===t?(this.data.sfx=i/100,a=!0):"uiVolume"===t?(this.data.ui=i/100,a=!0):"mute"===t&&(this.data.mute=!!i,a=!0),a&&(console.log("[GlobalAudioSettings] GameManager设置变更:",t,"=",i),this._applyAll())}},set:function(t){if(this._initialized){if((t=t||{}).bus){var i=null!=t.volume?t.volume:this.data[t.bus];this.data[t.bus]=Math.max(0,Math.min(1,i))}null!=t.mute&&(this.data.mute=!!t.mute),this._applyAll(),this._save()}else console.warn("[GlobalAudioSettings] 未初始化")},load:function(){return this._initialized?(this.data=this._load()||this.data,this._applyAll(),this.data):null},save:function(){this._initialized&&this._save()},_applyAll:function(){this._app&&(this._app.fire("audio:bus:setVolume",{bus:"master",volume:this.data.mute?0:this.data.master,dur:0}),this._app.fire("audio:bus:setVolume",{bus:"music",volume:this.data.music,dur:0}),this._app.fire("audio:bus:setVolume",{bus:"sfx",volume:this.data.sfx,dur:0}),this._app.fire("audio:bus:setVolume",{bus:"ui",volume:this.data.ui,dur:0}))},_load:function(){try{var t=localStorage.getItem(this.storageKey);return t?JSON.parse(t):null}catch(t){return console.warn("[GlobalAudioSettings] 加载失败:",t),null}},_save:function(){try{localStorage.setItem(this.storageKey,JSON.stringify(this.data))}catch(t){console.warn("[GlobalAudioSettings] 保存失败:",t)}},destroy:function(){this._initialized&&(this._app.off("setting:changed",this._onSettingChanged,this),this._app.off("audio:settings:set",this.set,this),this._app.off("audio:settings:load",this.load,this),this._app.off("audio:settings:save",this.save,this),this._initialized=!1,console.log("[GlobalAudioSettings] 已销毁"))}};t.GlobalAudioSettings=i}(window);!function(o){"use strict";var t={_initialized:!1,_app:null,pool2D:[],pool3D:[],db:{},cooldown:{},instancesByKey:{},instancesData:{},_busMaster:1,_busSfx:1,initialize:function(o,t){if(this._initialized)console.warn("[GlobalSfx] 已经初始化过了");else{t=t||{},this._app=o,this._initialized=!0,console.log("[GlobalSfx] 全局SFX管理器初始化"),this.pool2D=[],this.pool3D=[],this._poolSize2D=t.poolSize2D||8,this._poolSize3D=t.poolSize3D||16;var s=this;this._onBusVol=function(o){if(o){var t=null!=o.volume?Math.max(0,Math.min(1,o.volume)):null;null!=t&&("master"===o.bus&&(s._busMaster=t),"sfx"===o.bus&&(s._busSfx=t),s._updateAllPlayingVolumes())}},this._app.on("audio:bus:setVolume",this._onBusVol,this),this._app.on("sfx:play",this.play,this),this._app.on("sfx:stop",this.stop,this),this._app.on("sfx:stopAll",this.stopAll,this)}},_updateAllPlayingVolumes:function(){var o=0;for(var t in this.instancesData){var s=this.instancesData[t];if(s){for(var i=null,l=0;l<this.pool2D.length;l++)if(this.pool2D[l]._guid===t){i=this.pool2D[l];break}if(!i)for(var n=0;n<this.pool3D.length;n++)if(this.pool3D[n]._guid===t){i=this.pool3D[n];break}if(i&&i.enabled&&i.sound){var a=i.sound.slot("one");if(a&&a.isPlaying){var e=s.configVol*this._busMaster*this._busSfx;a.volume=e,o++}}}}o>0&&console.log("[GlobalSfx] 更新了",o,"个正在播放音频的音量")},_makePool:function(o,t){for(var s=[],i=t?"SFX3D_":"SFX2D_",l=0;l<o;l++){var n=new pc.Entity(i+l+"_"+Date.now());n.addComponent("sound",{volume:1,slots:[{name:"one",loop:!1,autoPlay:!1,overlap:!0,volume:1}]}),this._app.root.addChild(n),s.push(n)}return console.log("[GlobalSfx] 创建音频池:",t?"3D":"2D","数量:",o),s},_validateEntity:function(o){return!!o&&(!!o.sound&&!!o.sound.slot("one"))},_borrow:function(o){var t=o?this.pool3D:this.pool2D,s=o?this._poolSize3D:this._poolSize2D;if(0===t.length){console.log("[GlobalSfx] 首次创建音频池:",o?"3D":"2D","数量:",s);for(var i=0;i<s;i++)t.push(this._createSingleEntity(o))}for(var l=0;l<t.length;l++){var n=t[l];if(this._validateEntity(n)||(console.log("[GlobalSfx] 检测到无效实体，重新创建..."),t[l]=this._createSingleEntity(o),n=t[l]),!n.sound.slot("one").isPlaying&&!n.enabled)return n}for(var a=0;a<t.length;a++){var e=t[a];if(this._validateEntity(e))return e}return t.length>0&&!this._validateEntity(t[0])&&(t[0]=this._createSingleEntity(o)),t[0]||this._createSingleEntity(o)},_createSingleEntity:function(o){var t=o?"SFX3D_":"SFX2D_",s=new pc.Entity(t+Date.now());return s.addComponent("sound",{volume:1,slots:[{name:"one",loop:!1,autoPlay:!1,overlap:!0,volume:1}]}),this._app.root.addChild(s),s},play:function(o){if(!this._initialized)return console.warn("[GlobalSfx] 未初始化"),null;var t=(o=o||{}).key,s=this.db[t]||{};if(s.cooldown&&s.cooldown>0){var i=Date.now();if(i-(this.cooldown[t]||0)<s.cooldown)return null;this.cooldown[t]=i}var l=null!=o.is3D?o.is3D:s.is3D,n=this._borrow(l);if(!n||!n.sound)return null;var a=n.sound.slot("one");if(!a)return null;var e=o.asset;if(!e&&s.assets&&s.assets.length>0){var h=s.assets[Math.floor(Math.random()*s.assets.length)];e=this._app.assets.find(h,"audio")}if(!e)return console.warn("[GlobalSfx] 音频资源未找到:",t),null;var r=this,configureAndPlay=function(){a.asset=e.id;var i=o.loop||!1;a.loop=i;var h=null!=o.vol?o.vol:null!=s.vol?s.vol:1,u=h*r._busMaster*r._busSfx;if(a.volume=u,l&&o.pos&&n.setPosition(o.pos),r.instancesData[n._guid]={key:t,configVol:h,isLoop:i},n.enabled=!0,a.play(),t&&(r.instancesByKey[t]||(r.instancesByKey[t]=[]),r.instancesByKey[t].push(n)),!i){var onEnd=function(){delete r.instancesData[n._guid],a.off("end",onEnd)};a.on("end",onEnd)}};if(e.resource)configureAndPlay();else if(e.loaded)configureAndPlay();else{var onLoad=function(){e.off("load",onLoad),configureAndPlay()};e.once("load",onLoad),e.loading||this._app.assets.load(e)}return n},stop:function(o){if(this._initialized){var t=(o=o||{}).key;if(t){var s=this.instancesByKey[t];if(s&&0!==s.length){for(var i=0;i<s.length;i++){var l=s[i];if(l&&l.sound&&l.enabled){var n=l.sound.slot("one");n&&n.isPlaying&&n.stop(),l.enabled=!1,delete this.instancesData[l._guid]}}this.instancesByKey[t]=[]}}}},stopAll:function(){if(this._initialized){console.log("[GlobalSfx] ========== stopAll 被调用 ==========");var o,t=0;for(o=0;o<this.pool2D.length;o++){var s=this.pool2D[o];if(s&&s.sound&&s.enabled){var i=s.sound.slot("one");i&&i.isPlaying&&(i.stop(),t++),s.enabled=!1,delete this.instancesData[s._guid]}}for(o=0;o<this.pool3D.length;o++){var l=this.pool3D[o];if(l&&l.sound&&l.enabled){var n=l.sound.slot("one");n&&n.isPlaying&&(n.stop(),t++),l.enabled=!1,delete this.instancesData[l._guid]}}this.instancesByKey={},this.instancesData={},console.log("[GlobalSfx] 已停止所有SFX，停止数量:",t),console.log("[GlobalSfx] ==========================================")}},destroy:function(){if(this._initialized){var o;for(this._app.off("sfx:play",this.play,this),this._app.off("sfx:stop",this.stop,this),this._app.off("sfx:stopAll",this.stopAll,this),this._app.off("audio:bus:setVolume",this._onBusVol,this),o=0;o<this.pool2D.length;o++)try{this.pool2D[o]&&this.pool2D[o].destroy()}catch(o){}for(o=0;o<this.pool3D.length;o++)try{this.pool3D[o]&&this.pool3D[o].destroy()}catch(o){}this.pool2D=[],this.pool3D=[],this.db={},this.cooldown={},this.instancesByKey={},this._initialized=!1,console.log("[GlobalSfx] 已销毁")}}};o.GlobalSfx=t}(window);!function(t){"use strict";var s={_initialized:!1,_app:null,_busMaster:1,_busMusic:1,_configVolume:1,_trackA:null,_trackB:null,_active:null,_idle:null,_currentId:null,_updateHandlers:[],enableDebugLog:!1,initialize:function(t){if(this._initialized)console.warn("[GlobalBgm] 已经初始化过了");else{this._app=t,this._initialized=!0,console.log("[GlobalBgm] 全局BGM管理器初始化"),this._trackA=null,this._trackB=null,this._active=null,this._idle=null;var s=this;this._onBusVol=function(t){if(t){var i=null!=t.volume?Math.max(0,Math.min(1,t.volume)):null;if(null!=i&&("master"===t.bus&&(s._busMaster=i),"music"===t.bus&&(s._busMusic=i),s._active&&0===s._updateHandlers.length&&s._active.slot)){var l=s._configVolume||1;try{s._active.slot.volume=l*s._busMaster*s._busMusic}catch(t){}}}},this._app.on("audio:bus:setVolume",this._onBusVol,this),this._app.on("bgm:play",this.play,this),this._app.on("bgm:stop",this.stop,this),this._app.on("bgm:pause",this.pause,this),this._app.on("bgm:resume",this.resume,this)}},_makePlayer:function(){var t=new pc.Entity("BGM_Player_"+Date.now());t.addComponent("sound",{volume:1,slots:[{name:"bgm",loop:!0,autoPlay:!1,overlap:!1,volume:1}]}),this._app.root.addChild(t);var s=t.sound.slot("bgm");return console.log("[GlobalBgm] 创建播放器:",t.name,"实体有效:",!!t,"sound组件有效:",!!t.sound,"slot有效:",!!s),{ent:t,slot:s}},_validatePlayer:function(t){if(!t||!t.ent||!t.slot)return!1;if(!t.ent.sound)return!1;var s=t.ent.sound.slot("bgm");return!!s&&(t.slot=s,!0)},_setClip:function(t,s,i){if(!s||!s.resource)return console.warn("[GlobalBgm] 无效的音频资源"),!1;if(!this._validatePlayer(t))return console.error("[GlobalBgm] 播放器仍然无效"),!1;try{t.slot.isPlaying&&t.slot.stop(),t.slot.asset=s.id;var l=null==i||i;return t.slot.loop=l,t.slot.loop!==l&&(console.warn("[GlobalBgm] loop 设置被重置，再次设置"),t.slot.loop=l),this.enableDebugLog&&console.log("[GlobalBgm] ✓ 音频资源设置成功:",s.name,"loop:",t.slot.loop,"期望 loop:",l),!0}catch(t){return console.error("[GlobalBgm] 设置音频失败:",t),!1}},play:function(t){if(this._initialized){var s=(t=t||{}).asset,i=t.id||"default",l=null!=t.crossfade?t.crossfade:.8,o=null==t.loop||t.loop;if(this._configVolume=t.volume||1,this._trackA&&this._validatePlayer(this._trackA)||(console.log("[GlobalBgm] 创建/重建 TrackA..."),this._trackA=this._makePlayer()),this._trackB&&this._validatePlayer(this._trackB)||(console.log("[GlobalBgm] 创建/重建 TrackB..."),this._trackB=this._makePlayer()),this._active?(this._validatePlayer(this._active)||(this._active=this._trackA),this._validatePlayer(this._idle)||(this._idle=this._trackB)):(this._active=this._trackA,this._idle=this._trackB),!(this._currentId===i&&this._active&&this._active.slot&&this._active.slot.isPlaying))if(this._currentId=i,this._setClip(this._idle,s,o)){var a=this,e=this._active,n=this._idle;if(this._active=n,this._idle=e,s&&s.resource)this._crossfade(e,n,l);else if(s&&!s.loaded){console.log("[GlobalBgm] 等待资源加载:",s.name);var onLoad=function(){console.log("[GlobalBgm] 资源加载完成:",s.name),s.off("load",onLoad),a._crossfade(e,n,l)};s.once("load",onLoad),s.loading||this._app.assets.load(s)}else this._crossfade(e,n,l)}else console.warn("[GlobalBgm] 无法设置音频资源")}else console.warn("[GlobalBgm] 未初始化")},_crossfade:function(t,s,i){var l=this,o=0,a=this._busMaster*this._busMusic*this._configVolume;s.slot.volume=0,!1!==s.slot.loop&&void 0!==s.slot.loop||(console.warn("[GlobalBgm] 检测到 loop 为 false，强制设置为 true"),s.slot.loop=!0),this.enableDebugLog&&console.log("[GlobalBgm] 开始播放，loop 状态:",s.slot.loop),s.slot.play();var handler=function(e){o+=e;var n=Math.min(1,o/i);if(s.slot.volume=n*a,t&&t.slot&&(t.slot.volume=(1-n)*a),n>=1){if(t&&t.slot)try{t.slot.stop()}catch(t){}l._app.off("update",handler);var h=l._updateHandlers.indexOf(handler);-1!==h&&l._updateHandlers.splice(h,1)}};this._updateHandlers.push(handler),this._app.on("update",handler)},stop:function(t){if(this._initialized){var s=(t=t||{}).fadeOut||0;if(s>0)this._fadeOut(this._active,s);else if(this._active&&this._active.slot)try{this._active.slot.stop()}catch(t){}this._currentId=null}},_fadeOut:function(t,s){if(t&&t.slot&&t.slot.isPlaying){var i=this,l=0,o=t.slot.volume,handler=function(a){l+=a;var e=Math.min(1,l/s);if(t.slot.volume=o*(1-e),e>=1){try{t.slot.stop()}catch(t){}i._app.off("update",handler);var n=i._updateHandlers.indexOf(handler);-1!==n&&i._updateHandlers.splice(n,1)}};this._updateHandlers.push(handler),this._app.on("update",handler)}},pause:function(){if(this._initialized&&this._active&&this._active.slot)try{this._active.slot.pause()}catch(t){}},resume:function(){if(this._initialized&&this._active&&this._active.slot)try{this._active.slot.resume()}catch(t){}},destroy:function(){if(this._initialized){this._app.off("bgm:play",this.play,this),this._app.off("bgm:stop",this.stop,this),this._app.off("bgm:pause",this.pause,this),this._app.off("bgm:resume",this.resume,this),this._app.off("audio:bus:setVolume",this._onBusVol,this);for(var t=0;t<this._updateHandlers.length;t++)this._app.off("update",this._updateHandlers[t]);this._updateHandlers=[];try{this._trackA&&this._trackA.ent&&this._trackA.ent.destroy()}catch(t){}try{this._trackB&&this._trackB.ent&&this._trackB.ent.destroy()}catch(t){}this._initialized=!1,console.log("[GlobalBgm] 已销毁")}}};t.GlobalBgm=s}(window);var InteractableHint=pc.createScript("interactableHint");InteractableHint.attributes.add("playerEntity",{type:"entity",title:"玩家实体(可选)"}),InteractableHint.attributes.add("distance",{type:"number",default:2,title:"提示距离(米)"}),InteractableHint.attributes.add("cameraEntity",{type:"entity",title:"主摄像机(可选)"}),InteractableHint.attributes.add("viewAngleThreshold",{type:"number",default:30,title:"选中角度阈值(°)"}),InteractableHint.attributes.add("emissiveBoost",{type:"number",default:.6,title:"高亮：Emissive 增量"}),InteractableHint.attributes.add("uniqueMaterial",{type:"boolean",default:!0,title:"高亮：克隆独立材质"}),InteractableHint.attributes.add("i18nKey",{type:"string",default:"",title:"提示文本 i18n 键"}),InteractableHint.attributes.add("hintText",{type:"string",default:"按E键交互",title:"提示文本(兜底)"}),InteractableHint.attributes.add("keyCode",{type:"number",default:69,title:"触发键 KeyCode (E=69)"}),InteractableHint.attributes.add("keyName",{type:"string",default:"E",title:"键名(事件名展示用)"}),InteractableHint.attributes.add("actionName",{type:"string",default:"sit",title:"动作名(如 sit / open / talk)"}),InteractableHint.attributes.add("showHintWhenNear",{type:"boolean",default:!0,title:"靠近时显示提示"}),InteractableHint.attributes.add("hideHintOnExit",{type:"boolean",default:!0,title:"离开时隐藏提示"}),InteractableHint.attributes.add("oneTimeOnly",{type:"boolean",default:!1,title:"单次交互（交互后禁用）"}),InteractableHint.attributes.add("enableDebugLog",{type:"boolean",default:!1,title:"调试日志"}),InteractableHint.prototype.initialize=function(){this._player=this.playerEntity||this.app.root.findByName("Player")||null,this._near=!1,this._hintVisible=!1,this._highlighted=!1,this._origMats=null,this._hasInteracted=!1,this._dialogueActive=!1,this._tmpA=new pc.Vec3,this._tmpB=new pc.Vec3,this._i18nReady=!1;var t=this;this._onI18nReady=function(){t._i18nReady=!0,t._near&&t.showHintWhenNear&&t._showHint()},this._onMobileInteract=function(){t._hintVisible&&t._handleInteract()},this.app.on("mobile:interact",this._onMobileInteract,this),this._onDialogueStarted=function(){t._dialogueActive=!0,t._hintVisible&&t._hideHint()},this._onDialogueStopped=function(){t._dialogueActive=!1,!t._near||!t.showHintWhenNear||t.oneTimeOnly&&t._hasInteracted||t._showHint()},this.app.on("dialogue:started",this._onDialogueStarted,this),this.app.on("dialogue:stopped",this._onDialogueStopped,this),this.app.on("i18n:ready",this._onI18nReady,this),this._onKeyDown=this._handleKeyDown.bind(this),this.app.keyboard.on(pc.EVENT_KEYDOWN,this._onKeyDown,this)},InteractableHint.prototype._setHighlight=function(t){var e=this.entity&&(this.entity.render||this.entity.model)||null,i=null;if(e&&e.meshInstances?i=e.meshInstances:e&&e.model&&e.model.meshInstances&&(i=e.model.meshInstances),i&&i.length)if(t){if(this._origMats||(this._origMats=[]),0===this._origMats.length)for(var n=0;n<i.length;n++){var a=i[n],s=a.material;if(s){if(this.uniqueMaterial&&!s._interactableCloned){var h=s.clone();h._interactableCloned=!0,a.material=h,s=h}var o={mi:a,mat:s,emissive:null,emissiveIntensity:null};try{s.emissive&&(o.emissive=s.emissive.clone()),"number"==typeof s.emissiveIntensity&&(o.emissiveIntensity=s.emissiveIntensity)}catch(t){}this._origMats.push(o)}}for(var r=0;r<this._origMats.length;r++){var l=this._origMats[r],d=l.mat;if(d)try{"number"==typeof d.emissiveIntensity?d.emissiveIntensity=(null!=l.emissiveIntensity?l.emissiveIntensity:0)+(this.emissiveBoost||0):d.emissive&&(d.emissive=new pc.Color(Math.min(1,(l.emissive?l.emissive.r:d.emissive.r)+this.emissiveBoost),Math.min(1,(l.emissive?l.emissive.g:d.emissive.g)+this.emissiveBoost),Math.min(1,(l.emissive?l.emissive.b:d.emissive.b)+this.emissiveBoost),1)),d.update()}catch(t){}}this._highlighted=!0}else{if(this._origMats)for(var c=0;c<this._origMats.length;c++){var p=this._origMats[c],y=p.mat;if(y)try{p.emissive&&y.emissive&&y.emissive.copy(p.emissive),null!=p.emissiveIntensity&&"number"==typeof y.emissiveIntensity&&(y.emissiveIntensity=p.emissiveIntensity),y.update()}catch(t){}}this._highlighted=!1}else this._highlighted=!1},InteractableHint.prototype._tryFindMainCamera=function(){try{this.app.scene&&this.app.scene.layers;return this.app.root.findByName&&this.app.root.findByName("Camera")||null}catch(t){return null}},InteractableHint.prototype.update=function(t){var e=this._player;if(e&&e.getPosition){var i=this._tmpA.copy(this.entity.getPosition()),n=this._tmpB.copy(e.getPosition()),a=i.x-n.x,s=i.y-n.y,h=i.z-n.z,o=a*a+s*s+h*h<=this.distance*this.distance;if(this.enableDebugLog)Math.sqrt(a*a+s*s+h*h);var r=!1;try{var l=this._tmpForward||(this._tmpForward=new pc.Vec3),d=this._tmpToObj||(this._tmpToObj=new pc.Vec3);if(e&&e.forward)l.copy(e.forward).mulScalar(-1);else{l.set(0,0,1);try{e.getWorldTransform().transformVector(l,l)}catch(t){}}d.sub2(i,n).normalize();var c=pc.math.clamp(l.normalize().dot(d),-1,1);r=180*Math.acos(c)/Math.PI<=(0|this.viewAngleThreshold)||0}catch(t){r=!1}var p=o&&r;p!==this._hintVisible&&(this._hintVisible=p,p?this.showHintWhenNear&&this._showHint():this.hideHintOnExit&&this._hideHint());var y=p;y!==this._highlighted&&this._setHighlight(y)}},InteractableHint.prototype._handleKeyDown=function(t){if(this._hintVisible){var e=0|this.keyCode||0;(t&&t.key)===e&&(t&&t.repeat||this._handleInteract())}},InteractableHint.prototype._handleInteract=function(){if(!(this.oneTimeOnly&&this._hasInteracted||this._dialogueActive)){var t="interactableHint:"+(this.keyName||String(this.keyCode));this.app.fire(t,{entity:this.entity,player:this._player,key:this.keyName||this.keyCode,action:this.actionName||"action"}),this.app.fire("interactable:action",{id:t,entity:this.entity,player:this._player,key:this.keyName||this.keyCode,action:this.actionName||"action"}),this.oneTimeOnly&&(this._hasInteracted=!0,this._hideHint(),this.app.fire("interactable:one_time_completed",{entity:this.entity,action:this.actionName||"action"}))}},InteractableHint.prototype.resetOneTimeInteraction=function(){this._hasInteracted=!1,this._near&&this.showHintWhenNear&&this._showHint()},InteractableHint.prototype.hasInteracted=function(){return this._hasInteracted},InteractableHint.prototype._getHintText=function(){var t=this.hintText||"";try{if(this.i18nKey&&"undefined"!=typeof I18n&&I18n.get){var e=I18n.get("ui",this.i18nKey);e&&"string"==typeof e&&(t=e)}}catch(t){}return t||(t="Press "+(this.keyName||"E")),t},InteractableHint.prototype._showHint=function(){if(!(this.oneTimeOnly&&this._hasInteracted||this._dialogueActive)){var t=this._getHintText(),e=this._detectMobileDevice();if(this.app.fire("interactable:hint:show",{hintKey:this.i18nKey||this.hintText,hint:t,entity:this.entity,source:"interactableHint"}),!e){var i="undefined"!=typeof UIManager&&UIManager.getInstance?UIManager.getInstance():null;if(i&&"function"==typeof i.showRightHint)try{return void i.showRightHint(t,{source:"interactableHint",entity:this.entity,keyName:this.keyName||String(this.keyCode),slideMs:160})}catch(t){}this.app.fire("ui:hint:show",{side:"right",text:t,entity:this.entity,source:"interactableHint",keyName:this.keyName||String(this.keyCode),slideMs:160})}}},InteractableHint.prototype._hideHint=function(){var t=this._detectMobileDevice();if(this.app.fire("interactable:hint:hide",{entity:this.entity,source:"interactableHint"}),!t){var e="undefined"!=typeof UIManager&&UIManager.getInstance?UIManager.getInstance():null;if(e&&"function"==typeof e.hideRightHint)try{return void e.hideRightHint({source:"interactableHint",entity:this.entity,slideMs:140})}catch(t){}this.app.fire("ui:hint:hide",{side:"right",entity:this.entity,source:"interactableHint",slideMs:140})}},InteractableHint.prototype._detectMobileDevice=function(){if("undefined"!=typeof GlobalGame&&GlobalGame.device)return GlobalGame.device.isMobile||!1;if("undefined"!=typeof UIMobile&&UIMobile.getInstance){var t=UIMobile.getInstance();return t&&t.enabled}var e=navigator.userAgent||navigator.vendor||window.opera||"",i=/android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i.test(e.toLowerCase()),n="ontouchstart"in window||navigator.maxTouchPoints>0;return i||n&&window.innerWidth<1024},InteractableHint.prototype.destroy=function(){this._hintVisible&&(this._hideHint(),this._hintVisible=!1),this._highlighted&&(this._setHighlight(!1),this._highlighted=!1),this.app&&this.app.keyboard&&this._onKeyDown&&(this.app.keyboard.off(pc.EVENT_KEYDOWN,this._onKeyDown,this),this._onKeyDown=null),this.app&&(this._onI18nReady&&(this.app.off("i18n:ready",this._onI18nReady,this),this._onI18nReady=null),this._onMobileInteract&&(this.app.off("mobile:interact",this._onMobileInteract,this),this._onMobileInteract=null),this._onDialogueStarted&&(this.app.off("dialogue:started",this._onDialogueStarted,this),this._onDialogueStarted=null),this._onDialogueStopped&&(this.app.off("dialogue:stopped",this._onDialogueStopped,this),this._onDialogueStopped=null)),this._player=null,this._origMats=null,this._tmpA=null,this._tmpB=null,this._tmpForward=null,this._tmpToObj=null,this._near=!1,this._dialogueActive=!1,this._hasInteracted=!1,this._i18nReady=!1,this.enableDebugLog&&console.log("[InteractableHint] Destroyed and cleaned up:",this.entity&&this.entity.name)};var RightHint=function(){var t=null,n=null,i=null,e=null,o=null,l=null,a=null,c=null,u=null,d=null,p=!1,s=!1;function _log(){s&&console.log.apply(console,arguments)}function _stopAnim(){d&&d.killToken&&(d.killToken.dead=!0),t&&d&&d.tick&&t.off("update",d.tick),d=null}function _bind(t){n=(t=t||{}).panel||n,i=t.text||i,e=t.key||e,o=n&&n.element||null,l=i&&i.element||null,a=e&&e.element||null,o&&(o.opacity=o.opacity||0),l&&(l.opacity=l.opacity||0),a&&(a.opacity=a.opacity||0),c&&u||function _captureBaselines(){if(n){var t=n.getLocalPosition().clone();c=t.clone();var d=200;try{var s=o&&(o.calculatedWidth||o.width)||0;s>0&&(d=s+24)}catch(t){}(u=t.clone()).x+=d,n.setLocalPosition(u),o&&(o.opacity=0),l&&(l.opacity=0),a&&(a.opacity=0),n.enabled=!1,i&&(i.enabled=!1),e&&(e.enabled=!1),p=!1}}()}function _animate(c,u,s){if(t&&n){_stopAnim();var f=n.getLocalPosition().clone(),y=o?o.opacity:1,b=l?l.opacity:1,g=a?a.opacity:1,r=Math.max(0,0|s),h={dead:!1},_=0;n.enabled=!0,i&&(i.enabled=!0),e&&(e.enabled=!0);var tick=function(s){if(!h.dead){_+=1e3*s;var k=r>0?Math.min(1,_/r):1,m=k*k*(3-2*k),x=f.x+(c.x-f.x)*m,v=f.y+(c.y-f.y)*m,L=f.z+(c.z-f.z)*m;n.setLocalPosition(x,v,L),o&&(o.opacity=y+(u.p-y)*m),l&&(l.opacity=b+(u.t-b)*m),a&&(a.opacity=g+(u.k-g)*m),k>=1&&(t.off("update",tick),0===u.p?(n.enabled=!1,i&&(i.enabled=!1),e&&(e.enabled=!1),p=!1):p=!0,d=null)}};d={tick:tick,killToken:h},t.on("update",tick)}}return{init:function init(n,i){t=n,s=!(!i||!i.debug),_bind(i),_log("[RightHint] init")},configure:function configure(t){t&&void 0!==t.debug&&(s=!!t.debug),_bind(t),_log("[RightHint] configured")},show:function show(t,i){if(i=i||{},n){if(l)try{l.text=t||""}catch(t){_log("[RightHint] set text failed",t)}if(a)try{a.text=i.keyName||""}catch(t){}_animate((c||n.getLocalPosition()).clone(),{p:1,t:1,k:1},Math.max(0,0|i.slideMs)||160)}else _log("[RightHint] show: panel not bound")},hide:function hide(t){t=t||{},n&&_animate((u||n.getLocalPosition()).clone(),{p:0,t:0,k:0},Math.max(0,0|t.slideMs)||140)},reset:function reset(){_stopAnim(),n&&u&&n.setLocalPosition(u),o&&(o.opacity=0),l&&(l.opacity=0),a&&(a.opacity=0),n&&(n.enabled=!1),i&&(i.enabled=!1),e&&(e.enabled=!1),p=!1},isVisible:function isVisible(){return p}}}();var Sittable=pc.createScript("sittable");Sittable.attributes.add("playerEntity",{type:"entity",title:"玩家实体(可选)"}),Sittable.attributes.add("isMenu",{type:"boolean",default:!1,title:"是否菜单座位(进入多机位)"}),Sittable.attributes.add("menuGroupName",{type:"string",default:"mainMenu",title:"菜单机位组名(如 mainMenu)"}),Sittable.attributes.add("menuSubPos",{type:"string",default:"main",title:"菜单子机位名(如 main)"}),Sittable.attributes.add("useEntityPosition",{type:"boolean",default:!0,title:"使用实体位置(世界坐标)"}),Sittable.attributes.add("sitWorldPosition",{type:"vec3",default:[0,0,0],title:"坐下位置(世界坐标)"}),Sittable.attributes.add("useOffset",{type:"boolean",default:!1,title:"是否叠加偏移"}),Sittable.attributes.add("sitOffset",{type:"vec3",default:[0,0,0],title:"坐下偏移(可选，叠加到上面的位置)"}),Sittable.attributes.add("useEntityRotation",{type:"boolean",default:!0,title:"使用玩家当前朝向"}),Sittable.attributes.add("sitEuler",{type:"vec3",default:[0,0,0],title:"坐下朝向Euler(绝对°: x,y,z)"}),Sittable.attributes.add("enableDebugLog",{type:"boolean",default:!1,title:"调试日志"}),Sittable.prototype.initialize=function(){this._player=this.playerEntity||this.app.root.findByName("Player")||null,this.enableDebugLog&&console.log("[Sittable:init]",this.entity&&this.entity.name,"player=",this._player&&this._player.name),this._onInteract=this._handleInteract.bind(this),this.app.on("interactable:action",this._onInteract,this)},Sittable.prototype.destroy=function(){this.app&&this._onInteract&&this.app.off("interactable:action",this._onInteract,this)},Sittable.prototype._handleInteract=function(t){if(t&&t.entity===this.entity&&"sit"===(t.action||"").toLowerCase()){var e=this._player||t.player||null;if(e){var i=new pc.Vec3;if(this.useEntityPosition)i.copy(this.entity.getPosition());else{var a=this.sitWorldPosition||{x:0,y:0,z:0};i.set(0|a.x,0|a.y,0|a.z)}if(this.useOffset){var n=this.sitOffset||{x:0,y:0,z:0};i.add(new pc.Vec3(n.x||0,n.y||0,n.z||0))}var s=new pc.Quat;if(this.useEntityRotation)e&&e.getRotation?s.copy(e.getRotation()):s.copy(this.entity.getRotation());else{var o=this.sitEuler||{x:0,y:0,z:0};s.setFromEulerAngles(o.x||0,o.y||0,o.z||0)}try{var l=e.rigidbody;if(l){l.teleport(i,s);try{l.angularFactor=new pc.Vec3(0,0,0)}catch(o){}}else e.setPosition(i),e.setRotation(s)}catch(o){}try{this.app.fire("player:set_sitting",!0)}catch(o){}var r="undefined"!=typeof UIManager&&UIManager.getInstance?UIManager.getInstance():null;if(this.isMenu){try{this.app.fire("ui:control:set","LOCKED_MULTI")}catch(o){}try{var u=r&&(r.camera||r.entity&&r.entity.screen&&r.entity.screen.camera)||this.app.root.findByName("Camera")||null,p=u&&u.script?u.script.cameraTransition:null;if(p){var y=p.getAvailablePositions?p.getAvailablePositions():null;if(!!(y&&this.menuGroupName&&y[this.menuGroupName])){try{p.snapToPosition(this.menuGroupName,this.menuSubPos||null)}catch(o){}try{p.setCurrentPositionGroup(this.menuGroupName,this.menuSubPos||null)}catch(o){}}}}catch(o){this.enableDebugLog&&console.warn("[Sittable] switch menu failed:",o)}}else try{this.app.fire("ui:control:set","FREE_FIXED")}catch(o){}this.enableDebugLog&&console.log("[Sittable] sit triggered ->",{isMenu:!!this.isMenu,menuGroup:this.menuGroupName,menuSub:this.menuSubPos,pos:{x:i.x,y:i.y,z:i.z},rot:s})}}};var PlayerManager=pc.createScript("playerManager");PlayerManager.attributes.add("saveKey",{type:"string",default:"game.save",title:"本地存档键"}),PlayerManager.attributes.add("autosaveOnChange",{type:"boolean",default:!1,title:"每次变更自动存档（开发期）"}),PlayerManager.attributes.add("clampHP",{type:"boolean",default:!0,title:"限制HP在[0,hpMax]"}),PlayerManager.attributes.add("clampStamina",{type:"boolean",default:!0,title:"限制体力在[0,staminaMax]"}),PlayerManager.attributes.add("enableDebugLog",{type:"boolean",default:!1,title:"调试日志"}),PlayerManager._instance=null,PlayerManager.getInstance=function(){return PlayerManager._instance},PlayerManager.get=function(){return PlayerManager._instance},PlayerManager.prototype._now=function(){return"undefined"!=typeof performance&&performance.now?performance.now():Date.now()},PlayerManager.prototype._fire=function(a,e){this.app&&this.app.fire(a,e||{})},PlayerManager.prototype._log=function(){this.enableDebugLog&&console.log.apply(console,arguments)},PlayerManager.prototype._clamp=function(a,e,t){return Math.max(e,Math.min(t,a))},PlayerManager.prototype._clone=function(a){if(null===a||"object"!=typeof a)return a;if(a instanceof Date)return new Date(a.getTime());if(Array.isArray(a))return a.map((function(a){return this._clone(a)}),this);var e={};for(var t in a)a.hasOwnProperty(t)&&(e[t]=this._clone(a[t]));return e},PlayerManager.prototype._makeDefaultData=function(){return{meta:{version:1,createdAt:Date.now(),updatedAt:Date.now(),totalPlayTimeMs:0,sessions:0,device:this._detectDevice()},player:{name:"Player",level:1,xp:0,hp:100,hpMax:100,stamina:100,staminaMax:100,coins:0,stats:{}},flags:{},inventory:{},quests:{},bookmarks:{},dialogue:{graphs:{},stages:{},nodes:{}},knownNpcs:{},collectibles:{},_sys:{lastSaveHash:""}}},PlayerManager.prototype._detectDevice=function(){var a="undefined"!=typeof navigator?navigator:null;return{type:"undefined"!=typeof window&&("ontouchstart"in window||a&&(0|a.maxTouchPoints)>0)?"mobile":"desktop",platform:a&&a.platform||"",ua:a&&a.userAgent||""}},PlayerManager.prototype.initialize=function(){if(PlayerManager._instance)return this.debug&&console.warn("[PlayerManager] Multiple instances detected. Using the first one."),void this.entity.destroy();PlayerManager._instance=this,this._cfg={saveKey:this.saveKey||"game.save",autoload:!!this.autoload,autosaveOnChange:!!this.autosaveOnChange,clampHP:!!this.clampHP,clampStamina:!!this.clampStamina},this._data=this._makeDefaultData(),this._rt={sessionStartMs:this._now(),dirty:!1},this._data.meta.sessions++,this._cfg.autoload&&this.load(),"undefined"!=typeof window&&(window.PlayerManagerAPI=this._buildPublicAPI()),this.app.on("player:learn_npc_name",this._handleLearnNpcName,this),this._log("[PlayerManager] Ready. Device:",this._data.meta.device)},PlayerManager.prototype.destroy=function(){this.app.off("player:learn_npc_name",this._handleLearnNpcName,this),PlayerManager._instance===this&&(PlayerManager._instance=null)},PlayerManager.prototype._handleLearnNpcName=function(a){a&&a.npcId&&a.name&&(this.learnNpcName(a.npcId,a.name),this._log("[PlayerManager] Learned NPC name via event:",a.npcId,"->",a.name))},PlayerManager.prototype._touch=function(a,e,t,n){this._data.meta.updatedAt=Date.now(),this._rt.dirty=!0,this._cfg.autosaveOnChange&&this.save(),this._fire("player:changed",{path:a,value:this._clone(e)}),t&&this._fire(t,n||{})},PlayerManager.prototype.save=function(){try{var a=JSON.stringify(this._data);return"undefined"!=typeof localStorage&&localStorage.setItem(this._cfg.saveKey,a),this._rt.dirty=!1,this._fire("player:saved",{saveKey:this._cfg.saveKey,bytes:a.length}),this._log("[PlayerManager] Saved ->",this._cfg.saveKey),!0}catch(a){return console.warn("[PlayerManager] save failed:",a),!1}},PlayerManager.prototype.load=function(){try{if("undefined"==typeof localStorage)return this._fire("player:loaded",{saveKey:this._cfg.saveKey,ok:!1}),!1;var a=localStorage.getItem(this._cfg.saveKey);if(!a)return this._fire("player:loaded",{saveKey:this._cfg.saveKey,ok:!0}),!0;var e=JSON.parse(a),t=this._data;t.flags=Object.assign({},t.flags,e.flags||{}),t.inventory=Object.assign({},t.inventory,e.inventory||{}),t.quests=Object.assign({},t.quests,e.quests||{}),t.player.stats=Object.assign({},t.player.stats,e.player&&e.player.stats||{});var n=e.player||{};return["name","level","xp","hp","hpMax","stamina","staminaMax","coins"].forEach((function(a){void 0!==n[a]&&(t.player[a]=n[a])})),e.bookmarks&&(t.bookmarks=e.bookmarks),e.collectibles&&(t.collectibles=Object.assign({},t.collectibles,e.collectibles)),t.dialogue||(t.dialogue={graphs:{},stages:{},nodes:{}}),e.dialogue&&(t.dialogue.graphs=Object.assign({},t.dialogue.graphs,e.dialogue.graphs||{}),t.dialogue.stages=Object.assign({},t.dialogue.stages,e.dialogue.stages||{}),t.dialogue.nodes=Object.assign({},t.dialogue.nodes,e.dialogue.nodes||{})),this._touch("load",this._clone(t)),this._fire("player:loaded",{saveKey:this._cfg.saveKey,ok:!0}),this._log("[PlayerManager] Loaded."),!0}catch(a){return console.warn("[PlayerManager] load failed:",a),this._fire("player:loaded",{saveKey:this._cfg.saveKey,ok:!1}),!1}},PlayerManager.prototype.resetAll=function(){this._data=this._makeDefaultData(),this._rt.dirty=!0,this._fire("player:reset",{}),this._log("[PlayerManager] Reset to defaults.")},PlayerManager.prototype.setName=function(a){this._data.player.name=String(a||"Player"),this._touch("player.name",this._data.player.name)},PlayerManager.prototype.addXP=function(a){var e=this._data.player;e.xp=Math.max(0,(0|e.xp)+(0|a)),this._touch("player.xp",e.xp,"player:stat",{key:"xp",value:e.xp,delta:0|a})},PlayerManager.prototype.setLevel=function(a){var e=this._data.player;e.level=Math.max(1,0|a),this._touch("player.level",e.level,"player:stat",{key:"level",value:e.level})},PlayerManager.prototype.addCoins=function(a){var e=this._data.player,t=0|e.coins;return e.coins=Math.max(0,t+(0|a)),this._touch("player.coins",e.coins,"player:stat",{key:"coins",value:e.coins,delta:e.coins-t}),e.coins},PlayerManager.prototype.spendCoins=function(a){return this.addCoins(-(0|a))},PlayerManager.prototype.setHPMax=function(a){var e=this._data.player;e.hpMax=Math.max(1,0|a),this._cfg.clampHP&&(e.hp=this._clamp(e.hp,0,e.hpMax)),this._touch("player.hpMax",e.hpMax,"player:stat",{key:"hpMax",value:e.hpMax})},PlayerManager.prototype.addHP=function(a){var e=this._data.player,t=0|e.hp;return e.hp=t+(0|a),this._cfg.clampHP&&(e.hp=this._clamp(e.hp,0,e.hpMax)),this._touch("player.hp",e.hp,"player:stat",{key:"hp",value:e.hp,delta:e.hp-t}),e.hp},PlayerManager.prototype.setStaminaMax=function(a){var e=this._data.player;e.staminaMax=Math.max(1,0|a),this._cfg.clampStamina&&(e.stamina=this._clamp(e.stamina,0,e.staminaMax)),this._touch("player.staminaMax",e.staminaMax,"player:stat",{key:"staminaMax",value:e.staminaMax})},PlayerManager.prototype.addStamina=function(a){var e=this._data.player,t=0|e.stamina;return e.stamina=t+(0|a),this._cfg.clampStamina&&(e.stamina=this._clamp(e.stamina,0,e.staminaMax)),this._touch("player.stamina",e.stamina,"player:stat",{key:"stamina",value:e.stamina,delta:e.stamina-t}),e.stamina},PlayerManager.prototype.setStat=function(a,e){var t="number"==typeof e?e:0|e;this._data.player.stats[a]=t,this._touch("player.stats."+a,t,"player:stat",{key:a,value:t})},PlayerManager.prototype.addStat=function(a,e){var t=(this._data.player.stats[a]||0)+(e||0);return this._data.player.stats[a]=t,this._touch("player.stats."+a,t,"player:stat",{key:a,value:t,delta:e||0}),t},PlayerManager.prototype.getStat=function(a,e){var t=this._data.player.stats[a];return void 0===t?e:t},PlayerManager.prototype.setFlag=function(a,e){this._data.flags[a]=e,this._touch("flags."+a,e,"player:flag",{key:a,value:this._clone(e)})},PlayerManager.prototype.getFlag=function(a,e){var t=this._data.flags[a];return void 0===t?e:t},PlayerManager.prototype.toggleFlag=function(a){var e=!!this._data.flags[a];return this.setFlag(a,!e),!e},PlayerManager.prototype.getItemCount=function(a){return this._data.inventory[a]||0},PlayerManager.prototype.addItem=function(a,e){e=null==e?1:0|e;var t=this.getItemCount(a),n=Math.max(0,t+e);return this._data.inventory[a]=n,this._touch("inventory."+a,n,"player:inventory",{id:a,count:n,delta:n-t}),n},PlayerManager.prototype.removeItem=function(a,e){return this.addItem(a,-(e||1))},PlayerManager.prototype.hasItem=function(a,e){return this.getItemCount(a)>=(e||1)},PlayerManager.prototype.setQuestStage=function(a,e,t){var n=this._data.quests[a]||{stage:"none",vars:{}};return n.stage=e||"none",t&&"object"==typeof t&&(n.vars=Object.assign({},n.vars,t)),this._data.quests[a]=n,this._touch("quests."+a,n,"player:quest",{id:a,stage:n.stage,vars:this._clone(n.vars)}),n},PlayerManager.prototype.getQuest=function(a){return this._clone(this._data.quests[a]||null)},PlayerManager.prototype.setDialogueGraphKey=function(a,e){return!!a&&(this._data.dialogue||(this._data.dialogue={graphs:{},stages:{},nodes:{}}),this._data.dialogue.graphs[a]=String(e||""),this._touch("dialogue.graphs."+a,this._data.dialogue.graphs[a],"dialogue:graph_set",{npcId:a,graphKey:this._data.dialogue.graphs[a]}),!0)},PlayerManager.prototype.getDialogueGraphKey=function(a,e){var t=this._data.dialogue&&this._data.dialogue.graphs[a];return void 0===t?e||"":String(t)},PlayerManager.prototype.setDialogueStage=function(a,e){return!!a&&(this._data.dialogue||(this._data.dialogue={graphs:{},stages:{},nodes:{}}),this._data.dialogue.stages[a]=e,this._touch("dialogue.stages."+a,this._data.dialogue.stages[a],"dialogue:stage_set",{npcId:a,stage:this._clone(e)}),!0)},PlayerManager.prototype.getDialogueStage=function(a,e){var t=this._data.dialogue&&this._data.dialogue.stages[a];return void 0===t?e:this._clone(t)},PlayerManager.prototype.setDialogueNode=function(a,e){return!!a&&(this._data.dialogue||(this._data.dialogue={graphs:{},stages:{},nodes:{}}),this._data.dialogue.nodes[a]=String(e||""),this._touch("dialogue.nodes."+a,this._data.dialogue.nodes[a],"dialogue:node_set",{npcId:a,nodeId:this._data.dialogue.nodes[a]}),!0)},PlayerManager.prototype.getDialogueNode=function(a,e){var t=this._data.dialogue&&this._data.dialogue.nodes[a];return void 0===t?e||"":String(t)},PlayerManager.prototype.setBookmark=function(a,e){this._data.bookmarks[a]=this._clone(e),this._touch("bookmarks."+a,this._data.bookmarks[a])},PlayerManager.prototype.getBookmark=function(a,e){var t=this._data.bookmarks[a];return void 0===t?e:this._clone(t)},PlayerManager.prototype.addCollectible=function(a,e,t){return!!a&&(this._data.collectibles||(this._data.collectibles={}),this._data.collectibles[a]?(this._log("[PlayerManager] Collectible already found:",a),!1):(this._data.collectibles[a]={found:!0,timestamp:Date.now(),location:e||"unknown",metadata:t||{}},this._touch("collectibles."+a,this._data.collectibles[a],"player:collectible",{id:a,location:e,total:this.getCollectiblesCount()}),this._log("[PlayerManager] Collectible added:",a,"in",e),!0))},PlayerManager.prototype.hasCollectible=function(a){return!(!this._data.collectibles||!this._data.collectibles[a])},PlayerManager.prototype.getCollectible=function(a){return this._data.collectibles?this._clone(this._data.collectibles[a]||null):null},PlayerManager.prototype.getAllCollectibles=function(){return this._data.collectibles?this._clone(this._data.collectibles):{}},PlayerManager.prototype.getCollectiblesCount=function(){return this._data.collectibles?Object.keys(this._data.collectibles).length:0},PlayerManager.prototype.removeCollectible=function(a){return!(!this._data.collectibles||!this._data.collectibles[a])&&(delete this._data.collectibles[a],this._touch("collectibles."+a,null,"player:collectible",{id:a,removed:!0,total:this.getCollectiblesCount()}),!0)},PlayerManager.prototype.learnNpcName=function(a,e){if(!a||!e)return!1;this._data.knownNpcs||(this._data.knownNpcs={});var t=!!this._data.knownNpcs[a];return this._data.knownNpcs[a]={name:e,knownAt:Date.now()},this._touch("knownNpcs."+a,this._data.knownNpcs[a],"player:npc:learned",{npcId:a,name:e,wasKnown:t}),this._log("[PlayerManager] Learned NPC name:",a,"->",e),!0},PlayerManager.prototype.isNpcKnown=function(a){return!(!a||!this._data.knownNpcs)&&!!this._data.knownNpcs[a]},PlayerManager.prototype.getNpcName=function(a,e){return a&&this._data.knownNpcs&&this._data.knownNpcs[a]?this._data.knownNpcs[a].name||e||"???":e||"???"},PlayerManager.prototype.forgetNpcName=function(a){if(!a||!this._data.knownNpcs||!this._data.knownNpcs[a])return!1;var e=this._data.knownNpcs[a].name;return delete this._data.knownNpcs[a],this._touch("knownNpcs."+a,null,"player:npc:forgotten",{npcId:a,oldName:e}),this._log("[PlayerManager] Forgot NPC name:",a),!0},PlayerManager.prototype.getAllKnownNpcs=function(){return this._clone(this._data.knownNpcs||{})},PlayerManager.prototype.snapshot=function(){return this._clone(this._data)},PlayerManager.prototype.isDirty=function(){return!!this._rt.dirty},PlayerManager.prototype._buildPublicAPI=function(){var a=this;return{get:function(){return a.snapshot()},save:a.save.bind(a),load:a.load.bind(a),reset:a.resetAll.bind(a),setName:a.setName.bind(a),addXP:a.addXP.bind(a),setLevel:a.setLevel.bind(a),addCoins:a.addCoins.bind(a),spendCoins:a.spendCoins.bind(a),setHPMax:a.setHPMax.bind(a),addHP:a.addHP.bind(a),setStaminaMax:a.setStaminaMax.bind(a),addStamina:a.addStamina.bind(a),setStat:a.setStat.bind(a),addStat:a.addStat.bind(a),getStat:a.getStat.bind(a),setFlag:a.setFlag.bind(a),getFlag:a.getFlag.bind(a),toggleFlag:a.toggleFlag.bind(a),addItem:a.addItem.bind(a),removeItem:a.removeItem.bind(a),hasItem:a.hasItem.bind(a),itemCount:a.getItemCount.bind(a),setQuestStage:a.setQuestStage.bind(a),getQuest:a.getQuest.bind(a),setDialogueGraphKey:a.setDialogueGraphKey.bind(a),getDialogueGraphKey:a.getDialogueGraphKey.bind(a),setDialogueStage:a.setDialogueStage.bind(a),getDialogueStage:a.getDialogueStage.bind(a),setDialogueNode:a.setDialogueNode.bind(a),getDialogueNode:a.getDialogueNode.bind(a),learnNpcName:a.learnNpcName.bind(a),isNpcKnown:a.isNpcKnown.bind(a),getNpcName:a.getNpcName.bind(a),forgetNpcName:a.forgetNpcName.bind(a),getAllKnownNpcs:a.getAllKnownNpcs.bind(a),setBookmark:a.setBookmark.bind(a),getBookmark:a.getBookmark.bind(a),addCollectible:a.addCollectible.bind(a),hasCollectible:a.hasCollectible.bind(a),getCollectible:a.getCollectible.bind(a),getAllCollectibles:a.getAllCollectibles.bind(a),getCollectiblesCount:a.getCollectiblesCount.bind(a),removeCollectible:a.removeCollectible.bind(a)}};!function(e){"use strict";var a=function(){function getPlayerManager(){if("undefined"!=typeof PlayerManager){if(PlayerManager.get)return PlayerManager.get();if(PlayerManager._instance)return PlayerManager._instance}return"undefined"!=typeof window&&window.PlayerManagerAPI?window.PlayerManagerAPI:void 0!==e&&e.PlayerManager?e.PlayerManager.get?e.PlayerManager.get():e.PlayerManager._instance:null}var a=getPlayerManager();if(a&&a.getFlag&&a.setFlag&&a.addItem&&a.getItemCount&&a.setQuestStage&&a.getQuestStage)return{getFlag:function(e){var a=getPlayerManager();return!!a&&!!a.getFlag(e)},setFlag:function(e,a){var n=getPlayerManager();n&&n.setFlag(e,!!a)},addItem:function(e,a){var n=getPlayerManager();n&&n.addItem(e,0|a)},getItemCount:function(e){var a=getPlayerManager();return a?0|a.getItemCount(e):0},setQuestStage:function(e,a){var n=getPlayerManager();n&&n.setQuestStage(e,0|a)},getQuestStage:function(e){var a=getPlayerManager();return a?0|a.getQuestStage(e):0}};var n=Object.create(null),r=Object.create(null),t=Object.create(null);return{getFlag:function(e){return!!n[e]},setFlag:function(e,a){n[e]=!!a},addItem:function(e,a){r[e]=(0|r[e])+(0|a)},getItemCount:function(e){return 0|r[e]},setQuestStage:function(e,a){t[e]=0|a},getQuestStage:function(e){return 0|t[e]}}}(),n=function(){var e=Object.create(null);function register(a,n){e[a]=n}return register("flag",(function(e,n,r){return!!a.getFlag(r)})),register("notFlag",(function(e,n,r){return!a.getFlag(r)})),register("hasItem",(function(e,n,r,t){return a.getItemCount(r)>=(0|t)})),register("questStageAtLeast",(function(e,n,r,t){return(0|a.getQuestStage(r))>=(0|t)})),{register:register,eval:function evalCond(a,n,r,t){var o=e[a];if(!o)return console.warn("[DialogueConditions] not found:",a),!1;try{return!!o.apply(null,[r,t].concat(n||[]))}catch(e){return console.warn("[DialogueConditions]",a,"error:",e),!1}}}}(),r=function(){var n=Object.create(null);function register(e,a){n[e]=a}return register("setFlag",(function(e,n,r,t){a.setFlag(r,!!t)})),register("giveItem",(function(e,n,r,t){a.addItem(r,0|t),e._fire("ui:toast",{text:"Get "+r+" x"+(0|t)})})),register("setQuestStage",(function(e,n,r,t){a.setQuestStage(r,0|t),e._fire("quest:stage_changed",{id:r,stage:0|t})})),register("playSfx",(function(e,a,n,r){e._fire("audio:sfx",{bus:n||"ui",cue:r||"click"})})),register("fadeInBgm",(function(e,a,n,r){e._fire("audio:bgm:fadein",{track:n,duration:r||1})})),register("fadeOutBgm",(function(e,a,n){e._fire("audio:bgm:fadeout",{duration:n||1})})),register("addMapMarker",(function(e,a,n,r,t,o){e._fire("map:add_marker",{id:n,x:r||0,y:t||0,label:o||""})})),register("removeMapMarker",(function(e,a,n){e._fire("map:remove_marker",{id:n})})),register("endDialogue",(function(e){e.stop()})),register("learnNpcName",(function(a,n,r,t){try{var o=null;"undefined"!=typeof PlayerManager&&(PlayerManager.get?o=PlayerManager.get():PlayerManager._instance&&(o=PlayerManager._instance)),!o&&"undefined"!=typeof window&&window.PlayerManagerAPI&&(o=window.PlayerManagerAPI),!o&&void 0!==e&&e.PlayerManager&&(o=e.PlayerManager.get?e.PlayerManager.get():e.PlayerManager._instance),o&&o.learnNpcName?(o.learnNpcName(r,t),a._fire("player:npc:learned",{npcId:r,name:t}),console.log("[DialogueActions] Learned NPC name:",r,"->",t)):(console.warn("[DialogueActions] PlayerManager not available directly, using event fallback"),a._fire("player:learn_npc_name",{npcId:r,name:t}),console.log("[DialogueActions] Fired learn_npc_name event:",r,"->",t))}catch(e){console.error("[DialogueActions] learnNpcName failed:",e)}})),{register:register,run:function run(e,a,r,t){var o=n[e];if(o)try{o.apply(null,[r,t].concat(a||[]))}catch(a){console.warn("[DialogueActions]",e,"error:",a)}else console.warn("[DialogueActions] not found:",e)}}}(),t=function(){var e=null,o=null,l=null,i=null,s=!1,u={},g=!0,c=null;function _log(){g&&console.log.apply(console,["[DialogueManager]"].concat([].slice.call(arguments)))}function _err(){console.error.apply(console,["[DialogueManager]"].concat([].slice.call(arguments)))}function _fire(a,n){e&&e.fire(a,n||{})}function _detectLocale(){try{if("undefined"!=typeof GlobalGame&&GlobalGame.getLocale){var e=GlobalGame.getLocale();if("zh-CN"===e||"en-US"===e)return e}}catch(e){}var a="undefined"!=typeof navigator?navigator:null,n=a&&(a.language||a.languages&&a.languages[0])||"en-US";return/^zh(?:-Hans)?(?:-CN)?/i.test(n)?"zh-CN":(/^en/i.test(n),"en-US")}function _loadJsonAssetByName(a,n){var r=function _findJsonAssetByName(a){return e&&e.assets&&(e.assets.find(a,"json")||e.assets.find(a))||null}(a);if(r)if(r.resource)n&&n(r);else{r.once("load",(function(e){n&&n(e)}));try{e.assets.load(r)}catch(e){n&&n(null)}}else n&&n(null)}function _goto(e){var a=e&&o&&o.nodes[e];if(!a)return _log("node not found",e),void stop();l=e,function _checkAndUpdateNpcName(e){if(e&&e.speaker&&c)try{var a=null;if("undefined"!=typeof PlayerManager&&(PlayerManager.get?a=PlayerManager.get():PlayerManager._instance&&(a=PlayerManager._instance)),!a&&"undefined"!=typeof window&&window.PlayerManagerAPI&&(a=window.PlayerManagerAPI),a&&a.getLearnedNpcName){var n=a.getLearnedNpcName(e.speaker);n&&(_fire("dialogue:npc_name_update",{npcId:e.speaker,learnedName:n,originalName:e.speaker}),console.log("[DialogueManager] Updated NPC name display:",e.speaker,"->",n))}}catch(e){console.error("[DialogueManager] Error checking NPC name:",e)}}(a);try{c&&("end"===a.type?console.log("[DialogueManager] Skipping save for end node:",c,"->",e):"undefined"!=typeof GlobalGame&&GlobalGame.setDialogueNode?(GlobalGame.setDialogueNode(c,e),console.log("[DialogueManager] Saved dialogue progress:",c,"->",e)):console.warn("[DialogueManager] GlobalGame not available for saving dialogue progress"))}catch(e){console.error("[DialogueManager] Error saving dialogue progress:",e)}_run(a.onEnter),function _present(e){var a=_resolveOuts(e);if("auto"===e.type){var n=a.length?a[0].to:null;return void(n?_goto(n):stop())}if("end"===e.type)return _run(e.onExit),void stop();var r=a.map((function(e,a){return{index:a,text:e.text||"Answer "+(a+1)}}));_fire("dialogue:node",{node:e,answers:r}),i&&i.showNode?i.showNode(e,r):_log("UI missing ->",e.text,r.map((function(e){return e.text})))}(a)}function _resolveOuts(e){for(var a=e.outs||[],n=[],r=0;r<a.length;r++){var t=a[r];_check(t.when)&&n.push(t)}return n}function _check(e){if(!e||!e.length)return!0;for(var a=!0,r="and",o=0;o<e.length;o++){var l=e[o],i=l.op||r,s=n.eval(l.name,l.args||[],t,u);"and"===i?a=a&&s:"or"===i&&(a=a||s),r=i}return!!a}function _run(e){if(e&&e.length)for(var a=0;a<e.length;a++){var n=e[a];r.run(n.name,n.args||[],t,u)}}function loadGraph(e){o=function _normalizeGraph(e){if(!e)return null;for(var a={},n=e.nodes||[],r=0;r<n.length;r++)a[n[r].id]=n[r];return{nodes:a,start:e.start||n[0]&&n[0].id||null}}(e),o?_log("graph loaded, nodes=",Object.keys(o.nodes).length,"start=",o.start):_err("loadGraph failed: invalid data")}function start(a,n){e?o?(s=!0,u=n&&n.bb?n.bb:{},_goto(a||o.start),_fire("dialogue:started",{id:l})):_err("graph not loaded"):_err("setApp(app) first")}function stop(){if(s){if(s=!1,l=null,i&&i.hide)try{i.hide()}catch(e){}_fire("dialogue:stopped")}}return{setApp:function setApp(a){e=a},setDebug:function setDebug(e){g=!!e},setUI:function setUI(e){if((i=e||null)&&i.setManager)try{i.setManager(t)}catch(e){}},loadGraph:loadGraph,loadGraphFromAsset:function loadGraphFromAsset(a){a?a.resource?loadGraph(a.resource):a.once?(a.once("load",(function(e){loadGraph(e.resource)})),e&&e.assets&&e.assets.load(a)):_err("loadGraphFromAsset: not a PlayCanvas json asset"):_err("loadGraphFromAsset: asset is null")},start:start,startFor:function startFor(a,n){if(e){var r=n&&n.locale||_detectLocale(),t=n&&n.fallbacks||("zh-CN"===r?["en-US"]:["zh-CN"]);c=a;var decideStartAndBegin=function(){var e=null;try{"undefined"!=typeof GlobalGame&&GlobalGame.getDialogueNode?(e=GlobalGame.getDialogueNode(a)||null)?"end"===e?(console.warn("[DialogueManager] Found invalid saved node (end), clearing progress for",a),GlobalGame.clearDialogueProgressFor(a),e=null):console.log("[DialogueManager] Found saved dialogue node for",a,":",e):console.log("[DialogueManager] No saved dialogue node for",a,", starting from beginning"):console.warn("[DialogueManager] GlobalGame not available for dialogue progress")}catch(e){console.error("[DialogueManager] Error reading dialogue progress:",e)}"undefined"!=typeof GlobalGame&&GlobalGame.debug&&console.log("[DialogueManager] Using dialogue graph:",a+"_"+r),start(e,n)},tryFallbacks=function(e){e>=t.length?_err("startFor: no dialogue asset found for",a):_loadJsonAssetByName(a+"_"+t[e]+".json",(function(a){a&&a.resource?(loadGraph(a.resource),decideStartAndBegin()):tryFallbacks(e+1)}))};_loadJsonAssetByName(a+"_"+r+".json",(function(e){e&&e.resource?(loadGraph(e.resource),decideStartAndBegin()):tryFallbacks(0)}))}else _err("setApp(app) first")},stop:stop,choose:function choose(e){if(s&&l){var a=o.nodes[l],n=_resolveOuts(a)[0|e];if(n){_run(a.onExit),_run(n.actions);var r=n.to;r?_goto(r):stop()}}},getCurrentNode:function getCurrentNode(){return l?o&&o.nodes[l]:null},isActive:function isActive(){return s},preloadFor:function(a,n){if(e){var r=n&&n.locale||_detectLocale(),t=n&&n.fallbacks||("zh-CN"===r?["en-US"]:["zh-CN"]);[a+"_"+r+".json"].concat(t.map((function(e){return a+"_"+e+".json"}))).forEach((function(e){_loadJsonAssetByName(e,(function(){}))}))}else _err("setApp(app) first")},preloadMany:function(e,a){if(Array.isArray(e))for(var n=0;n<e.length;n++)this.preloadFor(e[n],a)},Conditions:n,Actions:r,State:a,_fire:_fire}}();e.DialogueManager=t}("undefined"!=typeof window?window:this);var Talkable=pc.createScript("talkable");Talkable.attributes.add("npcKey",{type:"string",default:"moai",title:"角色键(NPC Key)"}),Talkable.attributes.add("autoExit",{type:"boolean",default:!0,title:"对话结束自动退出控制态"}),Talkable.attributes.add("enableDebugLog",{type:"boolean",default:!1,title:"调试日志"}),Talkable.attributes.add("useCustomButtonPos",{type:"boolean",default:!1,title:"自定义按钮位置"}),Talkable.attributes.add("buttonPosX",{type:"number",default:0,title:"按钮X"}),Talkable.attributes.add("buttonPosY",{type:"number",default:0,title:"按钮Y"}),Talkable.attributes.add("buttonPosZ",{type:"number",default:0,title:"按钮Z"}),Talkable.prototype.initialize=function(){this._onInteract=this._handleInteract.bind(this),this.app.on("interactable:action",this._onInteract,this),this._onDialogueStopped=null,this.enableDebugLog&&console.log("[Talkable] init on",this.entity&&this.entity.name,"npcKey=",this.npcKey)},Talkable.prototype.destroy=function(){this._onInteract&&this.app.off("interactable:action",this._onInteract,this),this._onDialogueStopped&&this.app.off("dialogue:stopped",this._onDialogueStopped,this),this.enableDebugLog&&console.log("[Talkable] destroy on",this.entity&&this.entity.name)},Talkable.prototype._handleInteract=function(e){if(this.enableDebugLog&&console.log("[Talkable] event interactable:action received:",e),e){var t=e.entity||e.target||null;if(t===this.entity){var a=(e.action||e.name||"").toLowerCase();if("talk"===a){var o=(this.npcKey||"").trim();if(o){e={npc:o,entity:this.entity};this.useCustomButtonPos&&(e.buttonsPos={x:this.buttonPosX||0,y:this.buttonPosY||0,z:this.buttonPosZ||0});try{this.enableDebugLog&&console.log("[Talkable] firing ui:dialogue:begin"),this.app.fire("ui:dialogue:begin",e)}catch(e){this.enableDebugLog&&console.warn("[Talkable] ui:dialogue:begin failed",e)}try{this.enableDebugLog&&console.log("[Talkable] firing ui:control:set DIALOGUE"),this.app.fire("ui:control:set","DIALOGUE")}catch(e){this.enableDebugLog&&console.warn("[Talkable] ui:control:set failed",e)}try{var i=this;if("undefined"==typeof DialogueManager)this.enableDebugLog&&console.warn("[Talkable] DialogueManager undefined");else if(DialogueManager.startFor&&DialogueManager.setApp){this.enableDebugLog&&console.log("[Talkable] starting DialogueManager for",o);try{DialogueManager._fire||DialogueManager.setApp(this.app)}catch(e){}DialogueManager.startFor(o)}else this.enableDebugLog&&console.warn("[Talkable] DialogueManager missing startFor/setApp")}catch(e){this.enableDebugLog&&console.warn("[Talkable] startFor failed:",e)}if(this.autoExit){i=this;this._onDialogueStopped=function(){i.enableDebugLog&&console.log("[Talkable] dialogue:stopped -> exit");try{i.app.fire("ui:dialogue:end",{npc:o,entity:i.entity})}catch(e){}try{i.app.fire("player:unlock_action"),i.enableDebugLog&&console.log("[Talkable] player:unlock_action sent")}catch(e){}try{i.app.fire("ui:control:set","FREE_FOLLOW")}catch(e){}},this.app.once("dialogue:stopped",this._onDialogueStopped,this),this.enableDebugLog&&console.log("[Talkable] once(dialogue:stopped) registered")}}else this.enableDebugLog&&console.warn("[Talkable] npcKey empty, abort")}else this.enableDebugLog&&console.log("[Talkable] skip: action is",a)}else this.enableDebugLog&&console.log("[Talkable] skip: target mismatch. expected=",this.entity&&this.entity.name,"got=",t&&t.name)}};var DialogueUI=function(){"use strict";var e=null,t=null,n=null,o=null,a=null,i=null,l=null,r=8,c=300,u=new pc.Vec3(-30,-300,0),g=50,s=[],d=!1,f=!1,p=null,m=!1,y=0,_=0,h="",x=50,v=300;function _log(){d&&console.log.apply(console,["[DialogueUI]"].concat([].slice.call(arguments)))}function _num(e,t){e=null==e?t:e;var n=Number(e);return isNaN(n)?t||0:n}var b=!1;function _bindNpcNameEvents(){e&&!b&&(b=!0,_log("NPC name events bound for npcKey:",p))}function _applyUIBindingsFromManager(){try{var e=UIManager&&UIManager.getInstance&&UIManager.getInstance();if(!e)return;t=t||e.dialogueRootEntity||t,n=n||e.dialogueTextEntity||n,o=o||e.dialogueBackgroundEntity||o,a=a||e.dialogueButtonsContainer||a||t,i=i||e.dialogueButtonTemplate||i,l=l||e.dialogueNpcNameEntity||l,r=0|e.dialogueButtonSpacing||r,c=0|e.dialogueButtonMaxTextWidth||c,null!=e.typewriterSpeed&&(x=Math.max(10,0|e.typewriterSpeed)),null!=e.fadeSpeed&&(v=Math.max(100,0|e.fadeSpeed)),_log("UIManager config loaded - spacing:",e.dialogueButtonSpacing,"final _spacing:",r,"maxTextWidth:",c,"typewriterSpeed:",x,"fadeSpeed:",v);try{i&&(i.enabled=!1)}catch(e){}}catch(e){_log("bind from UIManager failed:",e)}}function _computeBaseFromTemplate(){if(i&&a)try{var e=i.getPosition(),t=i.parent||a,n=new pc.Vec3;t.getWorldTransform().transformPoint(e,n);var o=new pc.Mat4;if(o.copy(a.getWorldTransform()).invert(),o.transformPoint(n,u),g=50,i.element)g=i.element.height||i.element.calculatedHeight||g;else{var l=_findFirstTextElement(i);l&&l.element&&(g=l.element.height||l.element.calculatedHeight||g)}!0,_log("Base computed:",u,"btnHeight=",g,"spacing=",r)}catch(e){!1,_log("compute base failed:",e)}else!1}function _findFirstTextElement(e){if(!e)return null;if(e.element&&e.element.type===pc.ELEMENTTYPE_TEXT)return e;for(var t=[e];t.length;)for(var n=t.shift().children||[],o=0;o<n.length;o++){var a=n[o];if(a.element&&a.element.type===pc.ELEMENTTYPE_TEXT)return a;t.push(a)}return null}function _clearButtons(){for(var e=0;e<s.length;e++){var t=s[e];try{t&&t.parent&&t.parent.removeChild(t)}catch(e){}try{t&&t.destroy&&t.destroy()}catch(e){}}s.length=0}function _bindClick(t,o){var a=!1,handler=function(t){try{if(a||f)return void _log("Button click ignored - processing:",a,"creating:",f);t&&t.stopPropagation&&t.stopPropagation(),t&&t.preventDefault&&t.preventDefault(),a=!0,_log("Button clicked - meta:",o),setTimeout((function(){try{!function _fadeTextOut(t){if(n&&n.element){var o=n.element.opacity||1,a=Date.now();_log("Starting text fade out");var animate=function(){var i=Date.now()-a,l=Math.min(i/v,1),r=o*(1-l);try{n.element.opacity=r}catch(e){_log("Fade out opacity update failed:",e)}l<1?e&&e.once("update",animate):(_log("Text fade out completed"),t&&t())};e&&e.once("update",animate)}else t&&t()}((function(){return _clearButtons(),o&&null!=o.action?(_log("Executing action:",o.action,"with meta:",o),void(DialogueManager&&"function"==typeof DialogueManager.runAction?DialogueManager.runAction(o.action,o):e&&e.fire("dialogue:action",o.action,o))):o&&null!=o.next?(_log("Going to next node:",o.next,"npcKey:",o.npcKey),void(DialogueManager&&"function"==typeof DialogueManager.go?DialogueManager.go(o.npcKey,o.next):e&&e.fire("dialogue:go",o.npcKey,o.next))):(_log("Choosing option index:",o.index,"meta:",o),void(DialogueManager&&"function"==typeof DialogueManager.choose?DialogueManager.choose(0|o.index):e&&e.fire("dialogue:choose",0|o.index,o)))}))}finally{setTimeout((function(){a=!1}),500)}}),50)}catch(e){console.warn("[DialogueUI] click handler failed:",e),a=!1}};t.element&&t.element.on&&t.element.on("click",handler),t.button&&t.button.on&&t.button.on("click",handler)}function _createButton(e,n,o){if(!i)return null;var l=i.clone();l.enabled=!0,l.name=(i.name||"DialogueBtn")+"_"+(0|o);var u=null;try{var g=UIManager&&UIManager.getInstance&&UIManager.getInstance();u=g&&g.dialogueButtonGroup}catch(e){}var s=u||a||t;try{s.addChild(l),_log("Button",o,"added to parent:",s.name),_log("Button parent check - btn.parent:",l.parent&&l.parent.name),_log("Parent container info:",s.name,"position:",s.getLocalPosition(),"world:",s.getPosition())}catch(e){_log("addChild failed:",e)}var d=Math.max(r,100),f=120,p=-o*d;_log("Button spacing calculation - _spacing:",r,"final buttonSpacing:",d,"index:",o,"calculated x:",f,"calculated y:",p,"z:",10);try{l.setLocalPosition(f,p,10),_log("Button",o,"positioned at LOCAL:",f,p,10,"spacing:",d),l.element&&(l.element.drawOrder=1e3+o,_log("Button",o,"drawOrder set to:",l.element.drawOrder)),l.syncHierarchy&&l.syncHierarchy();var m=l.getLocalPosition();if(_log("Button",o,"after setLocalPosition - LOCAL:",m,"WORLD:",l.getPosition()),Math.abs(m.y-p)>1)_log("Button",o,"position mismatch, retrying..."),l.setLocalPosition(f,p,10),l.syncHierarchy&&l.syncHierarchy(),_log("Button",o,"after retry - LOCAL:",l.getLocalPosition())}catch(e){_log("setLocalPosition failed:",e)}var y=_findFirstTextElement(l);try{if(y&&y.element){var _=String(e||"Option "+(o+1)),h=function _calculateFontSize(e,t,n){if(!e||0===e.length)return n||24;for(var o=0,a=0,i=0;i<e.length;i++){var l=e.charAt(i);/[\u4e00-\u9fff]/.test(l)?o++:a++}var estimateWidth=function(e){return o*e*1+a*e*.6},r=n||24,c=estimateWidth(r);return c>t&&(r=Math.floor(r*(t/c)),r=Math.max(r,12)),_log("Font size calculation - text:",e,"length:",e.length,"chinese:",o,"english:",a,"initial fontSize:",n,"estimated width:",estimateWidth(r),"maxWidth:",t,"final fontSize:",r),r}(_,c,28);_log("Button",o,"Setting fontSize BEFORE text - fontSize:",h),_log("Button",o,"BEFORE fontSize change - old:",y.element.fontSize,"new:",h),y.element.fontSize=h,y.element.font&&y.element.font.resource&&(y.element.fontAsset=y.element.fontAsset,y.element.fontSize=h),y.element.text=_,y.element&&(y.element.drawOrder=1100+o,_log("Button",o,"text drawOrder set to:",y.element.drawOrder)),_log("Button",o,"AFTER fontSize set - actual:",y.element.fontSize,"expected:",h);try{y.element._dirtifyText&&y.element._dirtifyText(),y.syncHierarchy&&y.syncHierarchy(),y.element._markDirty&&y.element._markDirty();var x=y.element.text;y.element.text="",y.element.text=x}catch(e){_log("Font refresh failed:",e)}_log("Button",o,"text:",_,"fontSize set to:",h,"maxWidth:",c)}}catch(e){_log("Text setup failed:",e)}var v=n||{index:0|o};return _log("Creating button",o,"with label:",e,"and meta:",v),_bindClick(l,v),l}function _t(e,t){try{if(!I18n)return t;var n=I18n.get("dialogue",e);return null!=n?n:null==(n=I18n.get("dialogue."+e))?t:n}catch(e){return t}}return{init:function init(t,n){e=t,(n=n||{}).screen||null,d=!!n.debug,_applyUIBindingsFromManager(),_computeBaseFromTemplate(),e&&e.on("dialogue:npc_name_update",(function(e){e&&e.learnedName&&l&&l.element&&(l.element.text=e.learnedName,_log("NPC name updated via event:",e.npcId,"->",e.learnedName))}))},configure:function configure(e){t=(e=e||{}).root||t,n=e.text||n,o=e.bg||o,a=e.container||a||t,i=e.template||i,r=0|e.spacing||r;try{i&&(i.enabled=!1)}catch(e){}_computeBaseFromTemplate(),_log("configure: root=",t&&t.name,"text=",n&&n.name,"container=",a&&a.name,"template=",i&&i.name,"spacing=",r,"basePos=",u)},setDebug:function setDebug(e){d=!!e},setButtonsPosition:function setButtonsPosition(e){if(a||t){var n=_num(e&&e.x,0),o=_num(e&&e.y,0),i=_num(e&&e.z,0),l=a||t;try{l.setLocalPosition(n,o,i),_log("setButtonsPosition",n,o,i)}catch(e){}_computeBaseFromTemplate()}},show:function show(l,r){if(d=!0,_applyUIBindingsFromManager(),function _ensureBound(){return t?(n||_log("Text entity missing"),a||(a=t),i||_log("Button template missing"),!0):(_log("UI root missing"),!1)}()){try{o&&(o.enabled=!0)}catch(e){}try{t&&(t.enabled=!0)}catch(e){}var c="",u=[];if(l&&"object"==typeof l&&(l.npcKey||l.nodeId)){var g=String(l.npcKey||""),b=String(l.nodeId||"start"),B=function _readGraph(e){var t=_t(e,null);if(t&&"object"==typeof t)return t;try{var n=I18n.get("dialogue",e);if(n&&"object"==typeof n)return n}catch(e){}return null}(g);c=function _resolveNodeTextFromGraph(e,t){if(!e)return"";var n=(e.nodes||e)[t||e.start||"start"]||null;return n?"string"==typeof n.text&&n.text.length?n.text:"string"==typeof n.textKey&&n.textKey.length?_t(n.textKey,""):"string"==typeof n?n:"":""}(B,b),u=function _resolveOptionsFromGraph(e,t,n){for(var o=(e&&(e.nodes||e)||{})[n||e.start||"start"]||{},a=o.options||o.answers||[],i=[],l=0;l<a.length;l++){var r=a[l]||{},c="string"==typeof r.text?r.text:"string"==typeof r.textKey?_t(r.textKey,""):"Option "+(l+1),u=null!=r.index?r.index:l,g={npcKey:t,action:null!=r.action?r.action:null,next:null!=r.next?r.next:null,index:u};_log("Option",l,"parsed - label:",c,"original option:",r,"final meta:",g),i.push({label:c,meta:g})}return i}(B,g,b),c||"string"!=typeof l.textKey||(c=_t(l.textKey,"")),c||"string"!=typeof l.text||(c=l.text),p=g,_bindNpcNameEvents()}else{var T=l||{},w=Array.isArray(r)?r:[];c=String(T.text||""),(g=T.speaker||"")&&(p=g,_bindNpcNameEvents());for(var M=0;M<w.length;M++){var I=w[M]||{};u.push({label:I.text||"Option "+(M+1),meta:{index:null!=I.index?I.index:M}})}}!function _fadeTextIn(t){if(n&&n.element){var o=Date.now();_log("Starting text fade in");var animate=function(){var a=Date.now()-o,i=Math.min(a/v,1),l=i;try{n.element.opacity=l}catch(e){_log("Fade in opacity update failed:",e)}i<1?e&&e.once("update",animate):(_log("Text fade in completed"),t&&t())};e&&e.once("update",animate)}else t&&t()}((function(){!function _showTextWithTypewriter(t,o){!function _stopTypewriter(){m=!1,y=0,_=0}();try{n&&n.element&&(n.element.opacity=1,n.element.text="")}catch(e){}!function _startTypewriter(t,o){if(n&&n.element){m=!0,_=0,h=t||"",y=0,_log("Starting typewriter animation for text:",t);var animate=function(){if(m)if((y+=16)>=x)if(y=0,_<h.length){var t=h.substring(0,_+1);try{n.element.text=t}catch(e){_log("Typewriter text update failed:",e)}_++,e&&e.once("update",animate)}else m=!1,_log("Typewriter animation completed"),o&&o();else e&&e.once("update",animate)};e&&e.once("update",animate)}else o&&o()}(t,o)}(c,(function(){!function _createButtonsWithAnimation(e){f=!0,_clearButtons();try{for(var t=0;t<e.length;t++){var n=e[t],o=_createButton(n.label,n.meta,t);o&&s.push(o)}}finally{setTimeout((function(){f=!1,_log("Button creation completed, clicks now enabled")}),100)}}(u)}))}))}else _log("show aborted: UI not bound")},hide:function hide(){_clearButtons();try{n&&n.element&&(n.element.text="")}catch(e){}try{o&&(o.enabled=!1)}catch(e){}try{t&&(t.enabled=!1)}catch(e){}p=null,function _unbindNpcNameEvents(){e&&b&&(e.off("player:npc:learned"),b=!1,_log("NPC name events unbound"))}()},debugNpcNameStatus:function debugNpcNameStatus(){console.log("[DialogueUI Debug] Current NPC Key:",p),console.log("[DialogueUI Debug] NPC Name Element:",!!l),console.log("[DialogueUI Debug] Events Bound:",b)}}}();var GlobalCameraManager=pc.createScript("globalCameraManager");GlobalCameraManager.attributes.add("camera",{type:"entity",title:"摄像机实体（含 CameraTransition/FollowCamera）"}),GlobalCameraManager.attributes.add("playerEntity",{type:"entity",title:"玩家实体(锁定/解锁动作事件)"}),GlobalCameraManager.attributes.add("mainMenuGroupName",{type:"string",default:"mainMenu",title:"主菜单机位组名"}),GlobalCameraManager.attributes.add("mainMenuMainPos",{type:"string",default:"main",title:"主菜单默认子机位名"}),GlobalCameraManager.attributes.add("fixedGroupName",{type:"string",default:"fixed",title:"固定机位组名"}),GlobalCameraManager.attributes.add("fixedSubPos",{type:"string",default:"main",title:"固定机位子名"}),GlobalCameraManager.attributes.add("dialogueYawRange",{type:"number",default:50,title:"对话-左右夹角(°)"}),GlobalCameraManager.attributes.add("dialoguePitchRange",{type:"number",default:50,title:"对话-上下夹角(°)"}),GlobalCameraManager.attributes.add("enableDebugLog",{type:"boolean",default:!0,title:"调试日志"}),GlobalCameraManager.CONTROL_STATES={LOCKED_MULTI:"locked_multi",FREE_FIXED:"free_fixed",FREE_FOLLOW:"free_follow",LOCKED_FIXED:"locked_fixed",DIALOGUE:"dialogue"},GlobalCameraManager._instance=null,GlobalCameraManager.getInstance=function(){return GlobalCameraManager._instance},GlobalCameraManager.prototype.initialize=function(){GlobalCameraManager._instance?console.warn("[GlobalCameraManager] Duplicate instance."):(GlobalCameraManager._instance=this,this._state=GlobalCameraManager.CONTROL_STATES.LOCKED_MULTI,this._controlRetry=null,this._sKeyBlockedUntil=0,this._onCamTransStart=function(a,t){this._sKeyBlockedUntil=Date.now()+1400,this.enableDebugLog&&console.log("[GCam] S-key blocked 1400ms due to camera:transition:start ->",a,t)},this.app.on("camera:transition:start",this._onCamTransStart,this),this._bindMenuHotkeys(),this.app.on("ui:control:set",(function(a){var t=GlobalCameraManager.CONTROL_STATES,e=a;"string"==typeof e&&(e=t[e]||e),e||(e=t.LOCKED_MULTI);try{this.setState(e)}catch(a){this.enableDebugLog&&console.warn("[GCam] setState failed:",a)}}),this))},GlobalCameraManager.prototype.getState=function(){return this._state},GlobalCameraManager.prototype.setState=function(a){if(a&&this._state!==a){var t=this._state;this._state=a,this.enableDebugLog&&console.log("[GCam] setState:",t,"->",a);try{this._applyState(a)}catch(a){this.enableDebugLog&&console.warn("[GCam] apply state failed:",a)}this.app.fire("ui:control_state_changed",{from:t,to:a})}},GlobalCameraManager.prototype.snapToMainMenu=function(){var a=this,t=this.mainMenuGroupName||"mainMenu",e=this.mainMenuMainPos||"main";this._withCameraTransition((function(n){var i=!1;try{n.snapToPosition&&(i=n.snapToPosition(t,e))}catch(a){}if(!i){try{n.setCurrentPositionGroup&&n.setCurrentPositionGroup(t,e)}catch(a){}try{n.transitionToPosition&&(i=n.transitionToPosition(t,e))}catch(a){}}try{a.app.fire("camera:transition:start",t,{name:e})}catch(a){}try{a.app.fire("ui:camera:active",{position:t,name:e})}catch(a){}a.enableDebugLog&&console.log("[GCam] snap main menu ->",t,"/",e,"ok=",!!i)}),{retries:30,delayMs:150})},GlobalCameraManager.prototype.stepMenuCamera=function(a){var t=this,e=this.mainMenuGroupName||"mainMenu";this._withCameraTransition((function(n){var i=n._cameraPositions&&n._cameraPositions[e],r=i&&i.positions||[];if(r.length){var o=n._currentPositionGroup===e?0|n._currentPositionIndex:0,s=o;"left"===a&&(s=(o-1+r.length)%r.length),"right"===a&&(s=(o+1)%r.length);var l=r[s]&&(r[s].name||null);if(l){var c=!1;try{n.transitionToPosition&&(c=n.transitionToPosition(e,l))}catch(a){}if(!c)try{n.snapToPosition&&(c=n.snapToPosition(e,l))}catch(a){}try{n.setCurrentPositionGroup&&n.setCurrentPositionGroup(e,l)}catch(a){}try{t.app.fire("camera:transition:start",e,{name:l})}catch(a){}try{t.app.fire("ui:camera:active",{position:e,name:l})}catch(a){}t.enableDebugLog&&console.log("[GCam] step menu cam:",a,"->",e,"/",l,"ok=",!!c)}}else t.enableDebugLog&&console.warn("[GCam] no positions in group",e)}))},GlobalCameraManager.prototype.isAtCamPosition=function(a,t){var e=this._getCameraTransition();if(!e)return!1;if(e._currentPositionGroup!==a)return!1;try{var n=e._cameraPositions&&e._cameraPositions[a];if(!n||!n.positions||!n.positions.length)return!1;var i=0|e._currentPositionIndex;i=Math.max(0,Math.min(i,n.positions.length-1));var r=n.positions[i];return!(!r||r.name!==t)}catch(a){return!1}},GlobalCameraManager.prototype._applyState=function(a){var t=this._getPlayer(),e=this._getFollowCamera(),n=this._getCameraTransition();if(n)this._controlRetry=null;else{if(this._controlRetry||(this._controlRetry={tries:0,state:a}),this._controlRetry.tries<10){var i=this,r=++this._controlRetry.tries;return this.enableDebugLog&&console.warn("[GCam] cameraTransition not ready, retry",r),void setTimeout((function(){i._applyState(i._state)}),120)}this.enableDebugLog&&console.warn("[GCam] cameraTransition not found after retries")}var lockPlayer=function(a,t){try{t.fire("player:set_sitting",!!a)}catch(a){}};switch(a){case GlobalCameraManager.CONTROL_STATES.LOCKED_MULTI:if(lockPlayer(!0,this.app),e&&e.disable&&e.disable(),n){i=this;var applyMainMenuPosition=function(){try{n.snapToPosition(i.mainMenuGroupName,i.mainMenuMainPos)}catch(a){}try{n.setCurrentPositionGroup(i.mainMenuGroupName,i.mainMenuMainPos)}catch(a){}try{i.app.fire("ui:camera:active",{position:i.mainMenuGroupName,name:i.mainMenuMainPos})}catch(a){}try{i.app.fire("camera:transition:start",i.mainMenuGroupName,{name:i.mainMenuMainPos})}catch(a){}};if(n._ready)applyMainMenuPosition();else{var onPositionsReady=function(){applyMainMenuPosition(),i.app.off("camera:positions:ready",onPositionsReady)};i.app.once("camera:positions:ready",onPositionsReady)}}else{try{this.app.fire("ui:camera:active",{position:this.mainMenuGroupName,name:this.mainMenuMainPos})}catch(a){}try{this.app.fire("camera:transition:start",this.mainMenuGroupName,{name:this.mainMenuMainPos})}catch(a){}}break;case GlobalCameraManager.CONTROL_STATES.FREE_FIXED:if(lockPlayer(!1,this.app),e&&e.disable&&e.disable(),n){try{n.snapToPosition(this.fixedGroupName,this.fixedSubPos)}catch(a){}try{n.setCurrentPositionGroup(this.fixedGroupName,this.fixedSubPos)}catch(a){}}break;case GlobalCameraManager.CONTROL_STATES.FREE_FOLLOW:if(lockPlayer(!1,this.app),e){try{!e.targetEntity&&t&&(e.targetEntity=t)}catch(a){}e.enable&&e.enable()}if(n){try{"function"==typeof n.setCurrentPositionGroup&&n.setCurrentPositionGroup(null,null)}catch(a){}try{n._currentPositionGroup=null}catch(a){}try{n._currentPositionIndex=-1}catch(a){}}try{this.app.fire("ui:camera:active",{position:null,name:null})}catch(a){}try{this.app.fire("camera:transition:start","freeFollow",{name:""})}catch(a){}break;case GlobalCameraManager.CONTROL_STATES.LOCKED_FIXED:if(lockPlayer(!0,this.app),e&&e.disable&&e.disable(),n){try{n.snapToPosition(this.fixedGroupName,this.fixedSubPos)}catch(a){}try{n.setCurrentPositionGroup(this.fixedGroupName,this.fixedSubPos)}catch(a){}}break;case GlobalCameraManager.CONTROL_STATES.DIALOGUE:try{this.app.fire("player:lock_action")}catch(a){}if(e&&e.disable&&e.disable(),n){try{"function"==typeof n.setCurrentPositionGroup&&n.setCurrentPositionGroup(null,null)}catch(a){}try{n._currentPositionGroup=null}catch(a){}try{n._currentPositionIndex=-1}catch(a){}}this._applyDialogueClamp(!0)}},GlobalCameraManager.prototype._bindMenuHotkeys=function(){var a=this;this._menuHotkeysBound||(this._menuHotkeysBound=!0,this._onKeyDown=function(t){if(a._state===GlobalCameraManager.CONTROL_STATES.LOCKED_MULTI&&t.key===pc.KEY_S){if(Date.now()<(a._sKeyBlockedUntil||0))return void(a.enableDebugLog&&console.log("[GCam] KEY_S ignored (blocked window)"));var e=!1;try{if("undefined"!=typeof UIManager){var n=UIManager.getInstance();n&&n.currentState&&(e=n.currentState===UIManager.UI_STATES.FIRST_TIME_INTRO||n.currentState===UIManager.UI_STATES.TYPEWRITER)}}catch(t){}if(e)return void(a.enableDebugLog&&console.log("[GCam] KEY_S ignored (prologue playing)"));a.isAtCamPosition(a.mainMenuGroupName,a.mainMenuMainPos)&&(a.setState(GlobalCameraManager.CONTROL_STATES.FREE_FOLLOW),a.enableDebugLog&&console.log("[GCam] FREE_FOLLOW by S at main menu"))}},this.app.keyboard.on(pc.EVENT_KEYDOWN,this._onKeyDown,this))},GlobalCameraManager.prototype._applyDialogueClamp=function(a){var t=this._getFollowCamera();if(a){var e=this._getPlayerYawPitch(),n=Math.max(0,0|this.dialogueYawRange)||50,i=Math.max(0,0|this.dialoguePitchRange)||50;try{this.app.fire("camera:clamp:set",{centerYaw:e.yaw,centerPitch:e.pitch,yawRange:n,pitchRange:i})}catch(a){}try{t&&("function"==typeof t.setClamp&&t.setClamp(e.yaw,n,e.pitch,i),"function"==typeof t.setYawClamp&&t.setYawClamp(e.yaw-n,e.yaw+n),"function"==typeof t.setPitchClamp&&t.setPitchClamp(e.pitch-i,e.pitch+i),"function"==typeof t.enableClamp&&t.enableClamp(!0),void 0!==t.clampEnabled&&(t.clampEnabled=!0),void 0!==t.centerYaw&&(t.centerYaw=e.yaw),void 0!==t.centerPitch&&(t.centerPitch=e.pitch),void 0!==t.yawRange&&(t.yawRange=n),void 0!==t.pitchRange&&(t.pitchRange=i))}catch(a){this.enableDebugLog&&console.warn("[GCam] apply dialogue clamp failed:",a)}this.enableDebugLog&&console.log("[GCam] Dialogue clamp set:",e,"range=",n,i)}else{try{this.app.fire("camera:clamp:clear")}catch(a){}try{t&&"function"==typeof t.enableClamp&&t.enableClamp(!1),t&&void 0!==t.clampEnabled&&(t.clampEnabled=!1)}catch(a){}this.enableDebugLog&&console.log("[GCam] Dialogue clamp cleared")}},GlobalCameraManager.prototype._getPlayer=function(){if(this.playerEntity)return this.playerEntity;try{return this.app.root.findByName("Player")}catch(a){return null}},GlobalCameraManager.prototype._getFollowCamera=function(){var a=this.camera||null;return a&&a.script?a.script.followCamera:null},GlobalCameraManager.prototype._getCameraTransition=function(){var a=this.camera||null;if(a&&a.script&&a.script.cameraTransition)return a.script.cameraTransition;var t=this.entity&&this.entity.screen&&this.entity.screen.camera||null;if(t&&t.script&&t.script.cameraTransition)return t.script.cameraTransition;try{var e=this.app.root.findByName&&this.app.root.findByName("Camera");if(e&&e.script&&e.script.cameraTransition)return e.script.cameraTransition}catch(a){}try{for(var n=[this.app.root];n.length;){var i=n.pop();if(i&&i.script&&i.script.cameraTransition)return i.script.cameraTransition;for(var r=i&&i.children||[],o=0;o<r.length;o++)n.push(r[o])}}catch(a){}return null},GlobalCameraManager.prototype._withCameraTransition=function(a,t){var e=0|(t=t||{}).retries||20,n=0|t.delayMs||150,i=this;!function tryOnce(t){var e=i._getCameraTransition();if(e)try{a(e)}catch(a){i.enableDebugLog&&console.warn("[GCam] withCameraTransition fn error:",a)}else t<=0?i.enableDebugLog&&console.warn("[GCam] CameraTransition not found after retries"):setTimeout((function(){tryOnce(t-1)}),n)}(e)},GlobalCameraManager.prototype._getPlayerYawPitch=function(){var a=this._getPlayer(),t=0,e=0;try{if(a&&a.getEulerAngles){var n=a.getEulerAngles();t=n.y||0,e=n.x||0}}catch(n){}return{yaw:t,pitch:e}},GlobalCameraManager.prototype.destroy=function(){GlobalCameraManager._instance===this&&(GlobalCameraManager._instance=null),this._onCamTransStart&&this.app.off("camera:transition:start",this._onCamTransStart,this),this._onKeyDown&&this.app.keyboard.off(pc.EVENT_KEYDOWN,this._onKeyDown,this)};var MenuSettingsUI=function(){"use strict";var e=null,t=null,n=null,l=!0,o=null,a=!1,i=!1,r="left",c={setting:{sections:[{titleKey:"menu.panels.settings.audio.title",items:[{key:"masterVolume",type:"slider",labelKey:"menu.panels.subtitles.masterVolume",min:0,max:100,default:80},{key:"musicVolume",type:"slider",labelKey:"menu.panels.subtitles.musicVolume",min:0,max:100,default:70},{key:"sfxVolume",type:"slider",labelKey:"menu.panels.subtitles.sfxVolume",min:0,max:100,default:80},{key:"voiceVolume",type:"slider",labelKey:"menu.panels.subtitles.voiceVolume",min:0,max:100,default:80},{key:"language",type:"dropdown",labelKey:"menu.panels.subtitles.language",options:["zh-CN","en-US"],default:"zh-CN"}]},{titleKey:"menu.panels.settings.video.title",items:[{key:"fullscreen",type:"toggle",labelKey:"menu.panels.subtitles.fullscreen",default:!1},{key:"vSync",type:"toggle",labelKey:"menu.panels.subtitles.vSync",default:!0},{key:"brightness",type:"slider",labelKey:"menu.panels.subtitles.brightness",min:0,max:100,default:50}]},{titleKey:"menu.panels.settings.controls.title",items:[{key:"mouseSensitivity",type:"slider",labelKey:"menu.panels.subtitles.mouseSensitivity",min:.1,max:2,default:1},{key:"invertY",type:"toggle",labelKey:"menu.panels.subtitles.invertY",default:!1},{key:"clearProgress",type:"toggle",labelKey:"menu.panels.clearProgress.button",default:!1,special:"clearProgress"}]}]},video:{titleKey:"menu.panels.settings.video.title",items:[{key:"fullscreen",type:"toggle",labelKey:"menu.panels.subtitles.fullscreen",default:!1},{key:"vSync",type:"toggle",labelKey:"menu.panels.subtitles.vSync",default:!0},{key:"brightness",type:"slider",labelKey:"menu.panels.subtitles.brightness",min:0,max:100,default:50}]},controls:{titleKey:"menu.panels.settings.controls.title",items:[{key:"mouseSensitivity",type:"slider",labelKey:"menu.panels.subtitles.mouseSensitivity",min:.1,max:2,default:1},{key:"invertY",type:"toggle",labelKey:"menu.panels.subtitles.invertY",default:!1},{key:"clearProgress",type:"toggle",labelKey:"menu.panels.clearProgress.button",default:!1,special:"clearProgress"}]},appearance:"collectibles",prologue:"story",help:"help",clearRecord:"clear_record",achievements:"achievements",worldCompletion:"world_completion",redemption:"redemption",heartKeyGallery:"heart_key_gallery"},m={},s=null;function _translateText(e){try{if("undefined"!=typeof I18n&&I18n.t){var t=I18n.t(e,e);if(t&&"string"==typeof t)return t}}catch(e){}return e}function toggle(e){i||(a&&o===e?hide():show(e))}function show(l){t&&n&&!i&&(o=l,_clearContent(),_loadCurrentSettings(l),_generateOptions(l),function _slideIn(){if(!t)return;t.enabled=!0,i=!0,a=!1;var n=e.graphicsDevice.width,l="left"===r?-n:n,o=0;t.element&&(t.element.opacity=1);t.setLocalPosition(l,0,0),function _createCloseButton(){if(!t)return;if(t.findByName("CloseButton"))return;var e=new pc.Entity("CloseButton");e.addComponent("element",{type:pc.ELEMENTTYPE_IMAGE,anchor:[1,1,1,1],pivot:[1,1],width:40,height:40,color:new pc.Color(.8,.2,.2),useInput:!0}),e.setLocalPosition(-10,-50,0);var n=new pc.Entity("XLabel");n.addComponent("element",{type:pc.ELEMENTTYPE_TEXT,anchor:[.5,.5,.5,.5],pivot:[.5,.5],width:40,height:40,text:"×",fontSize:32,color:new pc.Color(1,1,1),alignment:new pc.Vec2(.5,.5)}),e.addChild(n),e.element.on("click",(function(){hide()})),t.addChild(e)}();var c=Date.now(),m=400,s=setInterval((function(){var e=Date.now()-c,n=Math.min(e/m,1),r=1-Math.pow(1-n,3),p=l+(o-l)*r;t&&t.setLocalPosition(p,0,0),n>=1&&(clearInterval(s),i=!1,a=!0)}),16)}())}function _clearContent(){if(n)for(var e=n.children.slice(),t=0;t<e.length;t++)try{e[t].destroy()}catch(e){}}function _loadCurrentSettings(e){var t=c[e];if(m={},"collectibles"!==t&&"story"!==t&&"help"!==t&&"clear_record"!==t&&"achievements"!==t&&"world_completion"!==t&&"redemption"!==t&&"heart_key_gallery"!==t){var n=[];if(t&&t.sections&&Array.isArray(t.sections))for(var l=0;l<t.sections.length;l++){var o=t.sections[l];o.items&&(n=n.concat(o.items))}else t&&t.items?n=t.items:Array.isArray(t)&&(n=t);for(var a=0;a<n.length;a++){var i=n[a],r=_getSetting(i.key);m[i.key]=null!=r?r:i.default}}}function _getSetting(e){try{if("undefined"!=typeof GlobalGame&&GlobalGame.getSetting)return GlobalGame.getSetting(e)}catch(e){}return null}function _generateOptions(t){var o=c[t];if("collectibles"!==o)if("story"!==o)if("help"!==o)if("clear_record"!==o)if("achievements"!==o)if("world_completion"!==o)if("redemption"!==o)if("heart_key_gallery"!==o){var a=0;if(o&&o.sections&&Array.isArray(o.sections))for(var i=0;i<o.sections.length;i++){var r=o.sections[i];r.titleKey&&(_createSectionTitle(r.titleKey,a),a+=30);for(var m=r.items||[],s=0;s<m.length;s++)_createOptionUI(m[s],s,a+90*s);a+=90*m.length,m.length,i<o.sections.length-1&&(a+=70)}else if(o&&o.titleKey&&o.items){_createSectionTitle(o.titleKey,a),a+=90;for(m=o.items,s=0;s<m.length;s++)_createOptionUI(m[s],s,a+90*s);m.length,a+=90*m.length}else if(Array.isArray(o)){for(s=0;s<o.length;s++)_createOptionUI(o[s],s,a);o.length,a+=90*o.length}var p=a+80;n.element&&(n.element.height=Math.max(p,n.element.height))}else(function _generateHeartKeyGalleryUI(){var e=_createLabel("menu.heartKey.title",50,-20);e.element.fontSize=48,e.element.color=new pc.Color(1,.2,.8),e.element.anchor=[0,1,0,1],e.element.pivot=[0,1],e.element.alignment=new pc.Vec2(0,.5),n.addChild(e);var t=[];try{if("undefined"!=typeof GlobalGame&&GlobalGame.getSettings)t=GlobalGame.getSettings().heartKeys||[]}catch(e){}var l=-80;if(0===t.length){var o=_createLabel("🔐",50,l);o.element.fontSize=128,o.element.anchor=[0,1,0,1],o.element.pivot=[0,1],o.element.alignment=new pc.Vec2(0,.5),n.addChild(o);var a=_createLabel("menu.heartKey.empty",50,l-=100);a.element.color=new pc.Color(.7,.7,.7),a.element.fontSize=40,a.element.anchor=[0,1,0,1],a.element.pivot=[0,1],a.element.alignment=new pc.Vec2(0,.5),a.element.wrapLines=!0,a.element.width=800,n.addChild(a);var i=_createLabel("menu.heartKey.hint",50,l-=80);i.element.fontSize=32,i.element.color=new pc.Color(.5,.5,.5),i.element.anchor=[0,1,0,1],i.element.pivot=[0,1],i.element.alignment=new pc.Vec2(0,.5),i.element.wrapLines=!0,i.element.width=800,n.addChild(i)}else for(var r=0;r<t.length;r++){var c=t[r],m=new pc.Entity("HeartKey_"+r);m.addComponent("element",{type:pc.ELEMENTTYPE_GROUP,anchor:[0,1,1,1],pivot:[0,1],width:0,height:120}),m.setLocalPosition(0,l,0);var s=_createLabel("💖",30,-60);s.element.fontSize=96,s.element.anchor=[0,1,0,1],s.element.pivot=[0,1],m.addChild(s);var p=_createLabel(c.name||"menu.heartKey.unknown",100,-30);p.element.fontSize=40,p.element.color=new pc.Color(1,.6,.9),p.element.anchor=[0,1,1,1],p.element.pivot=[0,1],p.element.alignment=new pc.Vec2(0,.5),m.addChild(p);var d=_createLabel("location",100,-60);if(d.element.text=_translateText("menu.heartKey.location")+": "+(c.location||"???"),d.element.fontSize=32,d.element.color=new pc.Color(.7,.7,.7),d.element.anchor=[0,1,1,1],d.element.pivot=[0,1],d.element.alignment=new pc.Vec2(0,.5),m.addChild(d),c.timestamp){var h=new Date(c.timestamp),u=_createLabel("time",100,-85);u.element.text=_translateText("menu.heartKey.obtainedAt")+": "+h.toLocaleDateString(),u.element.fontSize=28,u.element.color=new pc.Color(.5,.5,.5),u.element.anchor=[0,1,1,1],u.element.pivot=[0,1],u.element.alignment=new pc.Vec2(0,.5),m.addChild(u)}n.addChild(m),l-=130}n.element&&(n.element.height=Math.max(Math.abs(l)+100,400))})();else(function _generateRedemptionUI(){var e=_createLabel("menu.redemption.title",50,-20);e.element.fontSize=48,e.element.color=new pc.Color(1,.5,.5),e.element.anchor=[0,1,0,1],e.element.pivot=[0,1],e.element.alignment=new pc.Vec2(0,.5),n.addChild(e);var t=0,o={};try{"undefined"!=typeof GlobalGame&&GlobalGame.getSetting?(t=GlobalGame.getSetting("totalRespawns",0),o=GlobalGame.getSetting("respawnsByScene",{}),l&&(console.log("[MenuSettingsUI] Redemption data loaded:"),console.log("  Total respawns:",t),console.log("  Respawns by scene:",o))):l&&console.warn("[MenuSettingsUI] GlobalGame or getSetting method not available")}catch(e){l&&console.error("[MenuSettingsUI] Error loading redemption data:",e)}var a=-80,i=_createLabel("menu.redemption.totalRespawns",50,a);i.element.text=_translateText("menu.redemption.totalRespawns")+": "+t,i.element.fontSize=44,i.element.color=new pc.Color(1,1,1),i.element.anchor=[0,1,0,1],i.element.pivot=[0,1],i.element.alignment=new pc.Vec2(0,.5),n.addChild(i);var r=_createLabel("💔",50,a-=60);r.element.fontSize=96,r.element.anchor=[0,1,0,1],r.element.pivot=[0,1],r.element.alignment=new pc.Vec2(0,.5),n.addChild(r);var c=_createLabel("menu.redemption.hint",50,a-=80);c.element.fontSize=32,c.element.color=new pc.Color(.7,.7,.7),c.element.anchor=[0,1,0,1],c.element.pivot=[0,1],c.element.alignment=new pc.Vec2(0,.5),c.element.wrapLines=!0,c.element.width=800,n.addChild(c),a-=60;var m=Object.keys(o);if(m.length>0){var s=_createLabel("menu.redemption.byScene",50,a);s.element.fontSize=36,s.element.color=new pc.Color(.9,.9,.9),s.element.anchor=[0,1,0,1],s.element.pivot=[0,1],s.element.alignment=new pc.Vec2(0,.5),n.addChild(s),a-=40;for(var p=0;p<m.length;p++){var d=m[p],h=o[d],u=_createLabel("scene",40,a);u.element.text=d+": "+h+" "+_translateText("menu.redemption.times"),u.element.fontSize=32,u.element.color=new pc.Color(.6,.6,.6),u.element.anchor=[0,1,1,1],u.element.pivot=[0,1],u.element.alignment=new pc.Vec2(0,.5),n.addChild(u),a-=30}}n.element&&(n.element.height=Math.max(Math.abs(a)+100,500))})();else(function _generateWorldCompletionUI(){var e=_createLabel("menu.worldCompletion.title",50,-20);e.element.fontSize=48,e.element.color=new pc.Color(.5,.8,1),e.element.anchor=[0,1,0,1],e.element.pivot=[0,1],e.element.alignment=new pc.Vec2(0,.5),n.addChild(e);var t={totalScenes:0,completedScenes:0,totalCollectibles:0,foundCollectibles:0,totalCheckpoints:0,reachedCheckpoints:0};try{if("undefined"!=typeof GlobalGame&&GlobalGame.getSettings)t=GlobalGame.getSettings().worldCompletion||t}catch(e){}var l=-80,o=700,a=50,i=_createLabel("menu.worldCompletion.scenes",a,l);i.element.text=_translateText("menu.worldCompletion.scenes")+": "+t.completedScenes+"/"+t.totalScenes,i.element.fontSize=36,i.element.anchor=[0,1,0,1],i.element.pivot=[0,1],i.element.width=o,i.element.alignment=new pc.Vec2(0,.5),n.addChild(i),l-=40;var r=t.totalScenes>0?Math.round(t.completedScenes/t.totalScenes*100):0;_createProgressBar(a,l,o,r);var c=_createLabel("menu.worldCompletion.collectibles",a,l-=60);c.element.text=_translateText("menu.worldCompletion.collectibles")+": "+t.foundCollectibles+"/"+t.totalCollectibles,c.element.fontSize=36,c.element.anchor=[0,1,0,1],c.element.pivot=[0,1],c.element.width=o,c.element.alignment=new pc.Vec2(0,.5),n.addChild(c),l-=40;var m=t.totalCollectibles>0?Math.round(t.foundCollectibles/t.totalCollectibles*100):0;_createProgressBar(a,l,o,m);var s=_createLabel("menu.worldCompletion.checkpoints",a,l-=60);s.element.text=_translateText("menu.worldCompletion.checkpoints")+": "+t.reachedCheckpoints+"/"+t.totalCheckpoints,s.element.fontSize=36,s.element.anchor=[0,1,0,1],s.element.pivot=[0,1],s.element.width=o,s.element.alignment=new pc.Vec2(0,.5),n.addChild(s),l-=40;var p=t.totalCheckpoints>0?Math.round(t.reachedCheckpoints/t.totalCheckpoints*100):0;_createProgressBar(a,l,o,p),l-=60;var d=Math.round((r+m+p)/3),h=_createLabel("menu.worldCompletion.total",a,l);h.element.text=_translateText("menu.worldCompletion.total")+": "+d+"%",h.element.fontSize=40,h.element.color=new pc.Color(1,1,0),h.element.anchor=[0,1,0,1],h.element.pivot=[0,1],h.element.width=o,h.element.alignment=new pc.Vec2(0,.5),n.addChild(h),n.element&&(n.element.height=Math.max(Math.abs(l)+100,500))})();else(function _generateAchievementsUI(){var e=_createLabel("menu.achievements.title",50,-20);e.element.fontSize=48,e.element.color=new pc.Color(1,.6,0),e.element.anchor=[0,1,0,1],e.element.pivot=[0,1],e.element.alignment=new pc.Vec2(0,.5),n.addChild(e);var t=[{id:"first_step",key:"menu.achievements.first_step",icon:"🚶"},{id:"explorer",key:"menu.achievements.explorer",icon:"🗺️"},{id:"collector",key:"menu.achievements.collector",icon:"💎"},{id:"speedrunner",key:"menu.achievements.speedrunner",icon:"⚡"},{id:"perfectionist",key:"menu.achievements.perfectionist",icon:"⭐"}],l={};try{if("undefined"!=typeof GlobalGame&&GlobalGame.getSettings)l=GlobalGame.getSettings().achievements||{}}catch(e){}for(var o=-80,a=0,i=0;i<t.length;i++){var r=t[i],c=l[r.id]||!1;c&&a++;var m=new pc.Entity("Achievement_"+r.id);m.addComponent("element",{type:pc.ELEMENTTYPE_GROUP,anchor:[0,1,1,1],pivot:[0,1],width:0,height:90}),m.setLocalPosition(0,o,0);var s=_createLabel(r.icon,30,-30);s.element.fontSize=64,s.element.anchor=[0,1,0,1],s.element.pivot=[0,1],m.addChild(s);var p=_createLabel(r.key,80,-20);p.element.fontSize=36,p.element.color=c?new pc.Color(1,1,1):new pc.Color(.3,.3,.3),p.element.anchor=[0,1,1,1],p.element.pivot=[0,1],p.element.alignment=new pc.Vec2(0,.5),m.addChild(p);var d=_createLabel(c?"menu.achievements.unlocked":"menu.achievements.locked",80,-65);d.element.fontSize=28,d.element.color=c?new pc.Color(0,1,0):new pc.Color(.5,.5,.5),d.element.anchor=[0,1,1,1],d.element.pivot=[0,1],d.element.alignment=new pc.Vec2(0,.5),m.addChild(d),n.addChild(m),o-=100}var h=_createLabel("menu.achievements.progress",50,-70);h.element.text=_translateText("menu.achievements.progress")+": "+a+"/"+t.length,h.element.fontSize=32,h.element.color=new pc.Color(.8,.8,.8),h.element.anchor=[0,1,0,1],h.element.pivot=[0,1],h.element.alignment=new pc.Vec2(0,.5),n.addChild(h),n.element&&(n.element.height=Math.max(Math.abs(o)+100,600))})();else(function _generateClearRecordUI(){var e=_createLabel("menu.clearRecord.title",50,-20);e.element.fontSize=48,e.element.color=new pc.Color(1,.8,.2),e.element.anchor=[0,1,0,1],e.element.pivot=[0,1],e.element.alignment=new pc.Vec2(0,.5),n.addChild(e);var t={};try{if("undefined"!=typeof GlobalGame&&GlobalGame.getSettings)t=GlobalGame.getSettings().clearRecord||{}}catch(e){}var l=-80,o=Object.keys(t);if(0===o.length){var a=_createLabel("menu.clearRecord.empty",50,l);a.element.color=new pc.Color(.5,.5,.5),a.element.fontSize=36,a.element.anchor=[0,1,0,1],a.element.pivot=[0,1],a.element.alignment=new pc.Vec2(0,.5),n.addChild(a)}else for(var i=0;i<o.length;i++){var r=o[i],c=t[r],m=_createLabel("menu.clearRecord.scene",20,l);m.element.text=_translateText("menu.clearRecord.scene")+": "+r,m.element.fontSize=40,m.element.anchor=[0,1,1,1],m.element.pivot=[0,1],m.element.alignment=new pc.Vec2(0,.5),n.addChild(m);var s=_createLabel("menu.clearRecord.time",40,l-=30);s.element.text=_translateText("menu.clearRecord.time")+": "+(c.time||"00:00:00"),s.element.fontSize=32,s.element.color=new pc.Color(.7,.7,.7),s.element.anchor=[0,1,1,1],s.element.pivot=[0,1],s.element.alignment=new pc.Vec2(0,.5),n.addChild(s);var p=_createLabel("menu.clearRecord.date",40,l-=30);if(c.timestamp){var d=new Date(c.timestamp);p.element.text=_translateText("menu.clearRecord.date")+": "+d.toLocaleDateString()}p.element.fontSize=28,p.element.color=new pc.Color(.5,.5,.5),p.element.anchor=[0,1,1,1],p.element.pivot=[0,1],p.element.alignment=new pc.Vec2(0,.5),n.addChild(p),l-=50}n.element&&(n.element.height=Math.max(Math.abs(l)+100,400))})();else(function _generateHelpUI(){var e=-20,t=_createLabel("menu.help.title",50,e);t.element.fontSize=48,t.element.color=new pc.Color(0,0,0),t.element.anchor=[0,1,0,1],t.element.pivot=[0,1],n.addChild(t);var o=_createLabel("menu.help.pc.title",50,e-=70);o.element.fontSize=32,o.element.color=new pc.Color(0,0,0),o.element.anchor=[0,1,0,1],o.element.pivot=[0,1],n.addChild(o);var a=_createLabel("menu.help.pc.movement.title",70,e-=60);a.element.fontSize=24,a.element.color=new pc.Color(.2,.2,.2),a.element.anchor=[0,1,0,1],a.element.pivot=[0,1],n.addChild(a);var i=_createLabel("menu.help.pc.movement.wasd",90,e-=40);i.element.fontSize=20,i.element.color=new pc.Color(0,0,0),i.element.anchor=[0,1,0,1],i.element.pivot=[0,1],n.addChild(i);var r=_createLabel("menu.help.pc.movement.shift",90,e-=35);r.element.fontSize=20,r.element.color=new pc.Color(0,0,0),r.element.anchor=[0,1,0,1],r.element.pivot=[0,1],n.addChild(r);var c=_createLabel("menu.help.pc.movement.space",90,e-=35);c.element.fontSize=20,c.element.color=new pc.Color(0,0,0),c.element.anchor=[0,1,0,1],c.element.pivot=[0,1],n.addChild(c);var m=_createLabel("menu.help.pc.movement.exit",90,e-=40);m.element.fontSize=23,m.element.color=new pc.Color(0,0,0),m.element.anchor=[0,1,0,1],m.element.pivot=[0,1],n.addChild(m);var s=_createLabel("menu.help.pc.interaction.title",70,e-=50);s.element.fontSize=24,s.element.color=new pc.Color(.2,.2,.2),s.element.anchor=[0,1,0,1],s.element.pivot=[0,1],n.addChild(s);var p=_createLabel("menu.help.pc.interaction.key",90,e-=40);p.element.fontSize=20,p.element.color=new pc.Color(0,0,0),p.element.anchor=[0,1,0,1],p.element.pivot=[0,1],n.addChild(p);var d=_createLabel("menu.help.pc.interaction.description",90,e-=35);d.element.fontSize=18,d.element.color=new pc.Color(.4,.4,.4),d.element.anchor=[0,1,0,1],d.element.pivot=[0,1],n.addChild(d);var h=_createLabel("menu.help.pc.system.title",70,e-=50);h.element.fontSize=24,h.element.color=new pc.Color(.2,.2,.2),h.element.anchor=[0,1,0,1],h.element.pivot=[0,1],n.addChild(h);var u=_createLabel("menu.help.pc.system.respawn",90,e-=40);u.element.fontSize=20,u.element.color=new pc.Color(0,0,0),u.element.anchor=[0,1,0,1],u.element.pivot=[0,1],n.addChild(u);var g=_createLabel("menu.help.pc.system.respawnHint",90,e-=35);g.element.fontSize=18,g.element.color=new pc.Color(.4,.4,.4),g.element.anchor=[0,1,0,1],g.element.pivot=[0,1],n.addChild(g);var f=_createLabel("menu.help.pc.system.esc",90,e-=35);f.element.fontSize=20,f.element.color=new pc.Color(0,0,0),f.element.anchor=[0,1,0,1],f.element.pivot=[0,1],n.addChild(f);var v=_createLabel("menu.help.pc.narrative.title",70,e-=50);v.element.fontSize=24,v.element.color=new pc.Color(.2,.2,.2),v.element.anchor=[0,1,0,1],v.element.pivot=[0,1],n.addChild(v);var y=_createLabel("menu.help.pc.narrative.click",90,e-=40);y.element.fontSize=20,y.element.color=new pc.Color(0,0,0),y.element.anchor=[0,1,0,1],y.element.pivot=[0,1],n.addChild(y);var C=_createLabel("menu.help.pc.narrative.description",90,e-=35);C.element.fontSize=18,C.element.color=new pc.Color(.4,.4,.4),C.element.anchor=[0,1,0,1],C.element.pivot=[0,1],n.addChild(C);var w=_createLabel("menu.help.mobile.title",50,e-=80);w.element.fontSize=32,w.element.color=new pc.Color(0,0,0),w.element.anchor=[0,1,0,1],w.element.pivot=[0,1],n.addChild(w);var E=_createLabel("menu.help.mobile.movement.title",70,e-=60);E.element.fontSize=24,E.element.color=new pc.Color(.2,.2,.2),E.element.anchor=[0,1,0,1],E.element.pivot=[0,1],n.addChild(E);var b=_createLabel("menu.help.mobile.movement.joystick",90,e-=40);b.element.fontSize=20,b.element.color=new pc.Color(0,0,0),b.element.anchor=[0,1,0,1],b.element.pivot=[0,1],n.addChild(b);var _=_createLabel("menu.help.mobile.movement.run",90,e-=35);_.element.fontSize=20,_.element.color=new pc.Color(0,0,0),_.element.anchor=[0,1,0,1],_.element.pivot=[0,1],n.addChild(_);var S=_createLabel("menu.help.mobile.movement.jump",90,e-=35);S.element.fontSize=20,S.element.color=new pc.Color(0,0,0),S.element.anchor=[0,1,0,1],S.element.pivot=[0,1],n.addChild(S);var L=_createLabel("menu.help.mobile.movement.exit",90,e-=40);L.element.fontSize=23,L.element.color=new pc.Color(0,0,0),L.element.anchor=[0,1,0,1],L.element.pivot=[0,1],n.addChild(L);var G=_createLabel("menu.help.mobile.interaction.title",70,e-=50);G.element.fontSize=24,G.element.color=new pc.Color(.2,.2,.2),G.element.anchor=[0,1,0,1],G.element.pivot=[0,1],n.addChild(G);var T=_createLabel("menu.help.mobile.interaction.button",90,e-=40);T.element.fontSize=20,T.element.color=new pc.Color(0,0,0),T.element.anchor=[0,1,0,1],T.element.pivot=[0,1],n.addChild(T);var x=_createLabel("menu.help.mobile.system.title",70,e-=50);x.element.fontSize=24,x.element.color=new pc.Color(.2,.2,.2),x.element.anchor=[0,1,0,1],x.element.pivot=[0,1],n.addChild(x);var M=_createLabel("menu.help.mobile.system.respawn",90,e-=40);M.element.fontSize=20,M.element.color=new pc.Color(0,0,0),M.element.anchor=[0,1,0,1],M.element.pivot=[0,1],n.addChild(M);var I=_createLabel("menu.help.mobile.system.respawnHint",90,e-=35);I.element.fontSize=18,I.element.color=new pc.Color(.4,.4,.4),I.element.anchor=[0,1,0,1],I.element.pivot=[0,1],n.addChild(I);var P=_createLabel("menu.help.mobile.narrative.title",70,e-=50);P.element.fontSize=24,P.element.color=new pc.Color(.2,.2,.2),P.element.anchor=[0,1,0,1],P.element.pivot=[0,1],n.addChild(P);var z=_createLabel("menu.help.mobile.narrative.hold",90,e-=40);z.element.fontSize=20,z.element.color=new pc.Color(0,0,0),z.element.anchor=[0,1,0,1],z.element.pivot=[0,1],n.addChild(z);var k=_createLabel("menu.help.mobile.narrative.description",90,e-=35);if(k.element.fontSize=18,k.element.color=new pc.Color(.4,.4,.4),k.element.anchor=[0,1,0,1],k.element.pivot=[0,1],n.addChild(k),e-=50,n&&n.element){var U=Math.abs(e)+150;n.element.height=Math.max(U,900),l&&console.log("[MenuSettingsUI] Help panel content height set to:",n.element.height)}})();else(function _generateStoryUI(){var t={};try{if("undefined"!=typeof GlobalGame&&GlobalGame._prologueVisited)t=GlobalGame._prologueVisited;else if("undefined"!=typeof localStorage){var o=localStorage.getItem("echoSoul_prologueVisited");o&&(t=JSON.parse(o))}}catch(e){}var a=Object.keys(t);if(0===a.length){var i=_createLabel("menu.story.empty",50,-40);return i.element.color=new pc.Color(.5,.5,.5),i.element.fontSize=20,i.element.anchor=[0,1,0,1],i.element.pivot=[0,1],i.element.alignment=new pc.Vec2(0,.5),n.addChild(i),void(n.element&&(n.element.height=200))}var r={};try{if("undefined"!=typeof I18n&&I18n.get){var c=I18n.get("prologue");c&&"object"==typeof c&&(r=c)}}catch(e){}for(var m=-20,s=0;s<a.length;s++){var p=a[s],d=r[p],h=new pc.Entity("Story_"+p);h.addComponent("element",{type:pc.ELEMENTTYPE_GROUP,anchor:[0,1,1,1],pivot:[0,1],width:980,height:160}),h.setLocalPosition(150,m,0),h.element&&(h.element.width=980);var u=new pc.Entity("Thumbnail");if(u.addComponent("element",{type:pc.ELEMENTTYPE_IMAGE,anchor:[0,.5,0,.5],pivot:[0,.5],width:220,height:140,color:new pc.Color(.15,.15,.2)}),u.setLocalPosition(10,0,0),d&&d.typeLines&&d.typeLines[0]&&d.typeLines[0].imageName){var g=d.typeLines[0].imageName,f=e.assets.find(g,"texture");f&&f.resource&&(u.element.texture=f.resource,u.element.color=new pc.Color(1,1,1))}h.addChild(u);var v=p;v=d&&d.title?d.title:_translateText("menu.story."+p);var y=new pc.Entity("Title");y.addComponent("element",{type:pc.ELEMENTTYPE_TEXT,anchor:[0,.5,0,.5],pivot:[0,.5],width:500,height:40,text:v,fontSize:24,color:new pc.Color(0,0,0)}),y.setLocalPosition(250,30,0),y.element.fontAsset=_getFontAsset(),h.addChild(y);var C=_createLabel("menu.story.completed",250,0);C.element.fontSize=16,C.element.color=new pc.Color(.2,.7,.3),h.addChild(C);var w=new pc.Entity("PlayButton_"+p);w.addComponent("element",{type:pc.ELEMENTTYPE_IMAGE,anchor:[1,.5,1,.5],pivot:[1,.5],width:100,height:40,color:new pc.Color(.3,.6,.3),useInput:!0}),w.setLocalPosition(-20,0,0);var E=new pc.Entity("PlayLabel");E.addComponent("element",{type:pc.ELEMENTTYPE_TEXT,anchor:[.5,.5,.5,.5],pivot:[.5,.5],width:100,height:40,text:_translateText("menu.story.play")||"▶ 播放",fontSize:20,color:new pc.Color(1,1,1),alignment:new pc.Vec2(.5,.5)});try{var b=UIManager&&UIManager.getInstance&&UIManager.getInstance();b&&b.textElement&&b.textElement.element&&b.textElement.element.fontAsset&&(E.element.fontAsset=b.textElement.element.fontAsset)}catch(e){}if(w.addChild(E),function(t){w.element.on("click",(function(){if(l&&console.log("[MenuSettingsUI] 播放 prologue:",t),"undefined"!=typeof GlobalGame){if(l&&(console.log("[MenuSettingsUI] GlobalGame 可用:",!!GlobalGame),console.log("[MenuSettingsUI] GlobalGame.playPrologue 存在:",typeof GlobalGame.playPrologue),console.log("[MenuSettingsUI] GlobalGame 所有方法:",Object.keys(GlobalGame).filter((function(e){return"function"==typeof GlobalGame[e]})))),"function"==typeof GlobalGame.playPrologue)try{GlobalGame.playPrologue(t),l&&console.log("[MenuSettingsUI] GlobalGame.playPrologue 调用成功")}catch(e){console.error("[MenuSettingsUI] 播放 prologue 失败:",e)}else console.error("[MenuSettingsUI] GlobalGame.playPrologue 方法不存在"),console.error("[MenuSettingsUI] GlobalGame.playPrologue 类型:",typeof GlobalGame.playPrologue);e.fire("menu:play:prologue",{key:t}),setTimeout((function(){hide()}),100)}else console.error("[MenuSettingsUI] GlobalGame 对象未定义")}))}(p),h.addChild(w),d&&d.typeLines&&d.typeLines[0]){var _=d.typeLines[0].text||"";_.length>60&&(_=_.substring(0,60)+"...");var S=new pc.Entity("Description");S.addComponent("element",{type:pc.ELEMENTTYPE_TEXT,anchor:[0,.5,0,.5],pivot:[0,.5],width:500,height:80,text:_,fontSize:16,color:new pc.Color(0,0,0),wrapLines:!0}),S.setLocalPosition(250,-30,0);try{var L=UIManager&&UIManager.getInstance&&UIManager.getInstance();L&&L.textElement&&L.textElement.element&&L.textElement.element.fontAsset&&(S.element.fontAsset=L.textElement.element.fontAsset)}catch(e){}h.addChild(S)}h.element&&(h.element.width=980),n&&!n.enabled&&(n.enabled=!0),n&&n.parent&&!n.parent.enabled&&(n.parent.enabled=!0),n.addChild(h),m-=180}n.element&&(n.element.height=Math.max(Math.abs(m)+100,400))})();else(function _generateCollectiblesUI(){var e="undefined"!=typeof PlayerManager?PlayerManager.get():null,t=e?e.getAllCollectibles():{},l=Object.keys(t);if(0===l.length){var o=_createLabel("menu.collectibles.empty",50,-40);return o.element.color=new pc.Color(.5,.5,.5),o.element.fontSize=20,o.element.anchor=[0,1,0,1],o.element.pivot=[0,1],o.element.alignment=new pc.Vec2(0,.5),n.addChild(o),void(n.element&&(n.element.height=200))}for(var a=-20,i=0;i<l.length;i++){var r=l[i],c=t[r],m=new pc.Entity("Collectible_"+r);m.addComponent("element",{type:pc.ELEMENTTYPE_GROUP,anchor:[0,1,1,1],pivot:[0,1],width:0,height:100}),m.setLocalPosition(0,a,0);var s=new pc.Entity("Icon");s.addComponent("element",{type:pc.ELEMENTTYPE_IMAGE,anchor:[0,.5,0,.5],pivot:[0,.5],width:80,height:80,color:new pc.Color(.2,.6,.8)}),s.setLocalPosition(20,0,0),m.addChild(s);var p=new pc.Entity("Name");p.addComponent("element",{type:pc.ELEMENTTYPE_TEXT,anchor:[0,.5,0,.5],pivot:[0,.5],width:400,height:40,text:c.displayName||r,fontSize:20,color:new pc.Color(0,0,0),alignment:new pc.Vec2(0,.5)}),p.setLocalPosition(120,15,0);try{var d=UIManager&&UIManager.getInstance&&UIManager.getInstance();d&&d.textElement&&d.textElement.element&&d.textElement.element.fontAsset&&(p.element.fontAsset=d.textElement.element.fontAsset)}catch(e){}m.addChild(p);var h=_translateText("menu.collectibles.location")+": "+(c.location||_translateText("menu.collectibles.unknown")),u=new pc.Entity("Location");u.addComponent("element",{type:pc.ELEMENTTYPE_TEXT,anchor:[0,.5,0,.5],pivot:[0,.5],width:400,height:40,text:h,fontSize:16,color:new pc.Color(.4,.4,.4),alignment:new pc.Vec2(0,.5)}),u.setLocalPosition(120,-15,0);try{var g=UIManager&&UIManager.getInstance&&UIManager.getInstance();g&&g.textElement&&g.textElement.element&&g.textElement.element.fontAsset&&(u.element.fontAsset=g.textElement.element.fontAsset)}catch(e){}if(m.addChild(u),c.timestamp){var f=new Date(c.timestamp),v=f.toLocaleDateString()+" "+f.toLocaleTimeString(),y=_createLabel(_translateText("menu.collectibles.foundAt")+": "+v,120,-35);y.element.fontSize=14,y.element.color=new pc.Color(.5,.5,.5),m.addChild(y)}n.addChild(m),a-=110}n.element&&(n.element.height=Math.max(Math.abs(a)+100,400))})()}function _createSectionTitle(e,t){var l=new pc.Entity("SectionTitle");l.addComponent("element",{type:pc.ELEMENTTYPE_GROUP,anchor:[0,1,1,1],pivot:[0,1],width:0,height:50}),l.setLocalPosition(0,-t-25,0);var o=new pc.Entity("TitleText");o.addComponent("element",{type:pc.ELEMENTTYPE_TEXT,anchor:[0,.5,0,.5],pivot:[0,.5],width:400,height:40,text:_translateText(e),fontSize:32,color:new pc.Color(0,0,0),fontWeight:"bold"}),o.setLocalPosition(50,0,0);try{var a=UIManager&&UIManager.getInstance&&UIManager.getInstance();a&&a.textElement&&a.textElement.element&&a.textElement.element.fontAsset&&(o.element.fontAsset=a.textElement.element.fontAsset)}catch(e){}l.addChild(o),n.addChild(l)}function _showClearProgressConfirmation(){if(e){var n=new pc.Entity("ClearProgressOverlay");n.addComponent("element",{type:pc.ELEMENTTYPE_IMAGE,anchor:[0,0,1,1],pivot:[.5,.5],width:0,height:0,color:new pc.Color(0,0,0,.7),useInput:!0});var l=new pc.Entity("ConfirmDialog");l.addComponent("element",{type:pc.ELEMENTTYPE_IMAGE,anchor:[.5,.5,.5,.5],pivot:[.5,.5],width:400,height:200,color:new pc.Color(.9,.9,.9),useInput:!0});var o=new pc.Entity("DialogTitle");o.addComponent("element",{type:pc.ELEMENTTYPE_TEXT,anchor:[.5,.8,.5,.8],pivot:[.5,.5],width:350,height:30,text:_translateText("menu.panels.clearProgress.title")||"确认清除进度",fontSize:24,color:new pc.Color(0,0,0),fontWeight:"bold"});var a=new pc.Entity("DialogContent");a.addComponent("element",{type:pc.ELEMENTTYPE_TEXT,anchor:[.5,.6,.5,.6],pivot:[.5,.5],width:350,height:60,text:_translateText("menu.panels.clearProgress.message")||"这将清除所有游戏进度和对话记录，\n此操作不可撤销。确定要继续吗？",fontSize:16,color:new pc.Color(.2,.2,.2),wrapLines:!0});var i=new pc.Entity("ConfirmButton");i.addComponent("element",{type:pc.ELEMENTTYPE_IMAGE,anchor:[.3,.2,.3,.2],pivot:[.5,.5],width:100,height:40,color:new pc.Color(.8,.2,.2),useInput:!0});var r=new pc.Entity("ConfirmText");r.addComponent("element",{type:pc.ELEMENTTYPE_TEXT,anchor:[.5,.5,.5,.5],pivot:[.5,.5],width:90,height:30,text:_translateText("menu.panels.clearProgress.confirm")||"确认",fontSize:16,color:new pc.Color(1,1,1)});var c=new pc.Entity("CancelButton");c.addComponent("element",{type:pc.ELEMENTTYPE_IMAGE,anchor:[.7,.2,.7,.2],pivot:[.5,.5],width:100,height:40,color:new pc.Color(.5,.5,.5),useInput:!0});var m=new pc.Entity("CancelText");m.addComponent("element",{type:pc.ELEMENTTYPE_TEXT,anchor:[.5,.5,.5,.5],pivot:[.5,.5],width:90,height:30,text:_translateText("menu.panels.clearProgress.cancel")||"取消",fontSize:16,color:new pc.Color(1,1,1)});try{var s=UIManager&&UIManager.getInstance&&UIManager.getInstance();s&&s.textElement&&s.textElement.element&&s.textElement.element.fontAsset&&(o.element.fontAsset=s.textElement.element.fontAsset,a.element.fontAsset=s.textElement.element.fontAsset,r.element.fontAsset=s.textElement.element.fontAsset,m.element.fontAsset=s.textElement.element.fontAsset)}catch(e){}i.addChild(r),c.addChild(m),l.addChild(o),l.addChild(a),l.addChild(i),l.addChild(c),n.addChild(l),t&&t.parent&&t.parent.addChild(n),i.element.on("click",(function(){!function _executeClearProgress(){try{if("undefined"!=typeof GlobalGame){GlobalGame.clearDialogueProgress&&GlobalGame.clearDialogueProgress(),GlobalGame.clearGameProgress&&GlobalGame.clearGameProgress(),GlobalGame.clearPrologueVisited&&(GlobalGame.clearPrologueVisited(),console.log("[MenuSettingsUI] Cleared all prologue visited marks"));for(var t=[],n=0;n<localStorage.length;n++){var l=localStorage.key(n);l&&l.startsWith("echoSoul_")&&"echoSoul_settings"!==l&&"echoSoul_locale"!==l&&!l.includes("_language")&&!l.includes("_i18n")&&t.push(l)}for(var o=0;o<t.length;o++)localStorage.removeItem(t[o]);e&&e.fire("game:progress:cleared"),console.log("[MenuSettingsUI] 游戏进度已清除，正在刷新页面..."),console.log("[MenuSettingsUI] 清除的键包括: echoSoul_prologueVisited, 对话记录, 存档点等"),setTimeout((function(){window.location.reload()}),500)}else console.warn("[MenuSettingsUI] GlobalGame not available for clearing progress")}catch(e){console.error("[MenuSettingsUI] Error clearing progress:",e)}}(),n.destroy()})),c.element.on("click",(function(){n.destroy()})),n.element.on("click",(function(e){e.element===n.element&&n.destroy()}))}}function _createOptionUI(t,l,o){o=o||0;var a=new pc.Entity("Option_"+t.key);a.addComponent("element",{type:pc.ELEMENTTYPE_GROUP,anchor:[0,1,1,1],pivot:[0,1],width:0,height:160}),a.setLocalPosition(0,-o-40,0);var i=t.labelKey?_translateText(t.labelKey):t.label||t.key,r=new pc.Entity("Label");r.addComponent("element",{type:pc.ELEMENTTYPE_TEXT,anchor:[0,.5,0,.5],pivot:[0,.5],width:200,height:40,text:i,fontSize:24,color:new pc.Color(0,0,0)}),r.setLocalPosition(50,0,0);try{var c=UIManager&&UIManager.getInstance&&UIManager.getInstance();c&&c.textElement&&c.textElement.element&&c.textElement.element.fontAsset&&(r.element.fontAsset=c.textElement.element.fontAsset)}catch(e){}a.addChild(r);var s=null;if("slider"===t.type?s=function _createSlider(t){var n=new pc.Entity("Slider_"+t.key);n.addComponent("element",{type:pc.ELEMENTTYPE_GROUP,anchor:[0,.5,0,.5],pivot:[0,.5],width:520,height:60});var l=new pc.Entity("SliderBG");l.addComponent("element",{type:pc.ELEMENTTYPE_IMAGE,anchor:[0,.5,0,.5],pivot:[0,.5],width:400,height:20,color:new pc.Color(.988,.984,.859),useInput:!0}),n.addChild(l);var o=new pc.Entity("Handle");o.addComponent("element",{type:pc.ELEMENTTYPE_IMAGE,anchor:[0,.5,0,.5],pivot:[.5,.5],width:24,height:24,color:new pc.Color(1,.6,0)}),n.addChild(o);var a=_createLabel("",420,0);a.element.fontSize=20,n.addChild(a);var i=m[t.key];null==i&&(i=t.default);var r=(i-t.min)/(t.max-t.min);function applyRatio(e){var n=e*l.element.width;o.setLocalPosition(n,0,0);var i=t.min+e*(t.max-t.min);"mouseSensitivity"===t.key?(i=Math.round(10*i)/10,m[t.key]=i,a.element.text=i.toFixed(1)):(i=Math.round(i),m[t.key]=i,a.element.text=i+"%")}applyRatio(r=Math.max(0,Math.min(1,r)));var c=!1;function updateFromPointer(e){if(l.element.canvasCorners){var t=l.element.canvasCorners,n=t[0].x,o=t[2].x-n,a=e.x-n;applyRatio(Math.max(0,Math.min(o,a))/o)}}l.element.on("mousedown",(function(e){c=!0,updateFromPointer(e)})),e.mouse.on("mousemove",(function(e){c&&updateFromPointer(e)})),e.mouse.on("mouseup",(function(){c=!1})),e.touch&&(l.element.on("touchstart",(function(e){c=!0,e.touches&&e.touches[0]&&updateFromPointer(e.touches[0])})),e.touch.on("touchmove",(function(e){c&&e.touches&&e.touches[0]&&updateFromPointer(e.touches[0])})),e.touch.on("touchend",(function(){c=!1})));return n}(t):"toggle"===t.type?s=function _createToggle(e){var t=new pc.Entity("Toggle_"+e.key);t.addComponent("element",{type:pc.ELEMENTTYPE_IMAGE,anchor:[0,.5,0,.5],pivot:[.5,.5],width:60,height:40,color:new pc.Color(.5,.5,.5),useInput:!0});var n=m[e.key]||e.default;"clearProgress"===e.special?t.element.color=new pc.Color(.8,.2,.2):t.element.color=n?new pc.Color(0,1,0):new pc.Color(.5,.5,.5);return t.element.on("click",(function(){if("clearProgress"!==e.special){var n=!m[e.key];m[e.key]=n,t.element.color=n?new pc.Color(0,1,0):new pc.Color(.5,.5,.5)}else _showClearProgressConfirmation()})),t}(t):"dropdown"===t.type&&(s=function _createDropdown(e){var t=new pc.Entity("Dropdown_"+e.key);function getDisplayText(t){if("language"===e.key){var n="zh-CN";return"undefined"!=typeof GlobalGame&&GlobalGame.getSetting?n=GlobalGame.getSetting("language","zh-CN"):"undefined"!=typeof I18n&&I18n.getCurrentLanguage&&(n=I18n.getCurrentLanguage()),0===n.indexOf("en")?"zh-CN"===t?"Chinese":"English":"zh-CN"===t?"简体中文":"English"}return t}t.addComponent("element",{type:pc.ELEMENTTYPE_IMAGE,anchor:[0,.5,0,.5],pivot:[.5,.5],width:150,height:40,color:new pc.Color(.988,.984,.859),useInput:!0});var n=_createLabel(getDisplayText(m[e.key]||e.default),0,0);return t.addChild(n),t.element.on("click",(function(){var t=e.options||[],l=t.indexOf(m[e.key]),o=t[(l+1)%t.length];m[e.key]=o,n.element.text=getDisplayText(o)})),t}(t)),s){var p="dropdown"===t.type?380:300;s.setLocalPosition(p,0,0),a.addChild(s)}n.addChild(a)}function _createLabel(e,t,n){var l=new pc.Entity("Label");l.addComponent("element",{type:pc.ELEMENTTYPE_TEXT,anchor:[0,.5,0,.5],pivot:[0,.5],width:200,height:40,text:_translateText(e)||"",fontSize:24,color:new pc.Color(0,0,0)});try{var o=UIManager&&UIManager.getInstance&&UIManager.getInstance();o&&o.textElement&&o.textElement.element&&o.textElement.element.fontAsset&&(l.element.fontAsset=o.textElement.element.fontAsset)}catch(e){}return l.setLocalPosition(t,n,0),l}function _getFontAsset(){try{var e=UIManager&&UIManager.getInstance&&UIManager.getInstance();if(e&&e.textElement&&e.textElement.element&&e.textElement.element.fontAsset)return e.textElement.element.fontAsset}catch(e){}return null}function hide(){i||(_saveSettings(),function _slideOut(n){if(t){i=!0;var l=e.graphicsDevice.width,o="left"===r?-l:l,c=Date.now(),m=setInterval((function(){var e=Date.now()-c,l=Math.min(e/400,1),r=1-Math.pow(1-l,3),s=0+(o-0)*r;t&&t.setLocalPosition(s,0,0),l>=1&&(clearInterval(m),t.enabled=!1,i=!1,a=!1,n&&n())}),16)}else n&&n()}((function(){_clearContent(),o=null})))}function _saveSettings(){if(m)try{if("undefined"!=typeof GlobalGame&&GlobalGame.setSetting){for(var t in m)if(m.hasOwnProperty(t)){var n=GlobalGame.getSetting(t),l=m[t];n!==l&&(GlobalGame.setSetting(t,l),_applySettingEffect(t,l,n),e&&e.fire("setting:changed",{key:t,value:l,oldValue:n}))}GlobalGame.saveSettings&&GlobalGame.saveSettings()}else console.warn("[MenuSettingsUI] GlobalGame not available for saving settings")}catch(e){console.error("[MenuSettingsUI] Error saving settings:",e)}}function _applySettingEffect(t,n,l){try{switch(t){case"masterVolume":case"musicVolume":case"sfxVolume":case"voiceVolume":e&&e.fire("audio:volume:changed",{type:t.replace("Volume",""),volume:n/100});break;case"language":e&&e.fire("i18n:change_language",{language:n});break;case"fullscreen":e&&e.graphicsDevice&&(n?e.graphicsDevice.canvas.requestFullscreen():document.exitFullscreen&&document.exitFullscreen());break;case"brightness":e&&e.fire("graphics:brightness:changed",{brightness:n/100});break;case"mouseSensitivity":e&&e.fire("input:mouse_sensitivity:changed",{sensitivity:n});break;case"invertY":e&&e.fire("input:invert_y:changed",{inverted:n})}}catch(e){console.error("[MenuSettingsUI] Error applying setting effect:",t,e)}}function _createProgressBar(e,t,l,o){var a=new pc.Entity("ProgressBarBG");a.addComponent("element",{type:pc.ELEMENTTYPE_IMAGE,anchor:[0,1,0,1],pivot:[0,1],width:l,height:20,color:new pc.Color(.2,.2,.2)}),a.setLocalPosition(e,t,0);var i=new pc.Entity("ProgressBarFill");return i.addComponent("element",{type:pc.ELEMENTTYPE_IMAGE,anchor:[0,.5,0,.5],pivot:[0,.5],width:Math.floor(l*o/100),height:16,color:new pc.Color(.3,.8,.3)}),i.setLocalPosition(2,0,0),a.addChild(i),n.addChild(a),a}return{init:function init(i,c){e=i,l=!!(c=c||{}).debug,function _bindUIFromManager(){try{var e=UIManager&&UIManager.getInstance&&UIManager.getInstance();if(!e)return;t=e.menuScrollView||null,n=e.menuScrollViewContent||null,t&&(t.element&&(t.element.anchor=new pc.Vec4(.5,.5,.5,.5),t.element.pivot=new pc.Vec2(.5,.5),t.element.width=1e3,t.element.height=900,t.setLocalPosition(-60,0,0)),t.enabled=!1),n&&n.element&&(n.element.width=980)}catch(e){}}(),function _bindMenuEvents(){if(!e)return;e.on("menu:show_setting",(function(){toggle("setting")})),e.on("menu:show_appearance",(function(){toggle("appearance")})),e.on("menu:show_prologue",(function(){toggle("prologue")})),e.on("menu:show_help",(function(){toggle("help")})),e.on("menu:show_clear_record",(function(){toggle("clearRecord")})),e.on("menu:show_achievements",(function(){toggle("achievements")})),e.on("menu:show_world_completion",(function(){toggle("worldCompletion")})),e.on("menu:show_redemption",(function(){toggle("redemption")})),e.on("menu:show_heart_key_gallery",(function(){toggle("heartKeyGallery")})),s=function(e,t){"language"===e&&a&&o&&setTimeout((function(){_clearContent(),_loadCurrentSettings(o),_generateOptions(o)}),500)},e.on("setting:changed",s)}(),function _loadSlideDirection(){try{if("undefined"!=typeof I18n&&I18n.t){var e=I18n.t("ui.menuSlideDirection","");"left"!==e&&"right"!==e||(r=e)}}catch(e){}}()},show:show,hide:hide,toggle:toggle,applySettings:function applySettings(){_saveSettings()},resetSettings:function resetSettings(){if(o){var e=c[o];if(e){var t=[];if(e.sections&&Array.isArray(e.sections))for(var n=0;n<e.sections.length;n++){var l=e.sections[n];l.items&&(t=t.concat(l.items))}else e.items&&(t=e.items);for(var a=0;a<t.length;a++){var i=t[a];m[i.key]=i.default}_clearContent(),_generateOptions(o)}}},destroy:function destroy(){e&&s&&(e.off("setting:changed",s),s=null)}}}();var UIMobile=pc.createScript("uiMobile");UIMobile.attributes.add("mobileGroup",{type:"entity",title:"移动端UI组(包含背景和摇杆)"}),UIMobile.attributes.add("joystickBase",{type:"entity",title:"虚拟摇杆底盘"}),UIMobile.attributes.add("joystickStick",{type:"entity",title:"虚拟摇杆"}),UIMobile.attributes.add("interactButton",{type:"entity",title:"互动按钮(Button组件)"}),UIMobile.attributes.add("interactHintText",{type:"entity",title:"互动提示文字(Text Element)"}),UIMobile.attributes.add("jumpButton",{type:"entity",title:"跳跃按钮(Button组件)"}),UIMobile.attributes.add("respawnButton",{type:"entity",title:"重生按钮(Button组件)"}),UIMobile.attributes.add("soulShoreButton",{type:"entity",title:"心灵彼岸按钮(Button组件)"}),UIMobile.attributes.add("touchCenterOffsetX",{type:"number",default:0,title:"触摸中心偏移X(px, 右为正)"}),UIMobile.attributes.add("touchCenterOffsetY",{type:"number",default:0,title:"触摸中心偏移Y(px, 下为正)"}),UIMobile.attributes.add("enableOffsetAutoScale",{type:"boolean",default:!0,title:"偏移随分辨率自动缩放"}),UIMobile.attributes.add("referenceScreenWidth",{type:"number",default:830,title:"参考分辨率宽(用于偏移缩放)"}),UIMobile.attributes.add("referenceScreenHeight",{type:"number",default:1080,title:"参考分辨率高(用于偏移缩放)"}),UIMobile.attributes.add("joystickMaxRadius",{type:"number",default:0,title:"摇杆最大半径(px, 0=自动)"}),UIMobile.attributes.add("joystickReturnSpeed",{type:"number",default:8,title:"摇杆回中速度"}),UIMobile.attributes.add("walkThreshold",{type:"number",default:.3,title:"行走阈值(0~1)"}),UIMobile.attributes.add("runThreshold",{type:"number",default:.7,title:"跑步阈值(0~1)"}),UIMobile.attributes.add("cameraSensitivity",{type:"number",default:.3,title:"相机灵敏度"}),UIMobile.attributes.add("cameraZone",{type:"string",default:"right",title:"相机控制区域(left/right/full)"}),UIMobile.attributes.add("enableDebugLog",{type:"boolean",default:!1,title:"启用调试日志"}),UIMobile._instance=null,UIMobile.prototype.initialize=function(){if(UIMobile._instance&&UIMobile._instance!==this){console.log("[UIMobile] 检测到场景切换，替换旧实例");var e=UIMobile._instance;e&&"function"==typeof e.destroy&&e.destroy()}if(UIMobile._instance=this,this._isMobile=this._detectMobileDevice(),this._isPCMode=!1,this._isMobile||(this.enableDebugLog&&console.log("[UIMobile] Not a mobile device, hiding mobile UI elements"),this._hideMobileUIForPC()),this._disabledMobileNodes=[],this._isMobile&&(this.enableDebugLog&&console.log("[UIMobile] Mobile device detected, initializing mobile UI"),this.joystickActive=!1,this.joystickTouchId=-1,this.joystickStartPos=new pc.Vec2(0,0),this.joystickCurrentPos=new pc.Vec2(0,0),this.joystickDelta=new pc.Vec2(0,0),this._interactButtonVisible=!1,this._currentInteractHint="",this.cameraTouchId=-1,this.cameraLastPos=new pc.Vec2(0,0),this.cameraDelta=new pc.Vec2(0,0),this.interactPressed=!1,this._tempVec2=new pc.Vec2,this._tempVec3=new pc.Vec3,this._validateEntities()?(this.joystickBase&&this.joystickBase.element&&(this.joystickBase.element.useInput=!0),this.joystickStick&&(this.joystickStick.enabled=!0,this.joystickStick.setLocalPosition(0,0,0)),this._bindTouchEvents(),this._bindMobileButtons(),this._disableMobileGroupBackgroundInput(),this._onInteractHintShow=this._handleInteractHintShow.bind(this),this._onInteractHintHide=this._handleInteractHintHide.bind(this),this.app.on("interactable:hint:show",this._onInteractHintShow,this),this.app.on("interactable:hint:hide",this._onInteractHintHide,this),this._dialogueActive=!1,this._onDialogueStarted=this._handleDialogueStarted.bind(this),this._onDialogueStopped=this._handleDialogueStopped.bind(this),this.app.on("dialogue:started",this._onDialogueStarted,this),this.app.on("dialogue:stopped",this._onDialogueStopped,this),this._lastScreenWidth=this.app.graphicsDevice.width,this._lastScreenHeight=this.app.graphicsDevice.height,this._onResizeHandler=this._handleResize.bind(this),this.app.graphicsDevice.on("resizecanvas",this._onResizeHandler,this),this._onMobileUIHide=this._handleMobileUIHide.bind(this),this._onMobileUIShow=this._handleMobileUIShow.bind(this),this.app.on("mobile:ui:hide",this._onMobileUIHide,this),this.app.on("mobile:ui:show",this._onMobileUIShow,this)):console.error("[UIMobile] Required entities missing.")),this._onUIStateChanged=this._handleUIStateChanged.bind(this),this.app.on("ui:state_changed",this._onUIStateChanged,this),console.log("[UIMobile] State change listener bound, _isMobile:",this._isMobile,"_isPCMode:",this._isPCMode),"undefined"!=typeof UIManager){var t=UIManager.getInstance();t&&t.currentState&&(console.log("[UIMobile] Checking initial UIManager state:",t.currentState),this._handleUIStateChanged({from:null,to:t.currentState}))}if(this.enableDebugLog){var i=this._getElementBoundsCanvas(this.joystickBase);console.log("[UIMobile] ===== Initialized ====="),i&&console.log("[UIMobile] Base center:",i.centerX.toFixed(0),i.centerY.toFixed(0),"size:",i.width.toFixed(0),"x",i.height.toFixed(0)),console.log("[UIMobile] Max radius(px):",this._getJoystickMaxRadius().toFixed(1)),console.log("[UIMobile] Touch scale:",(100*this.joystickTouchScale).toFixed(0)+"%"),console.log("[UIMobile] Screen:",this.app.graphicsDevice.width,"x",this.app.graphicsDevice.height),console.log("[UIMobile] =======================")}},UIMobile.prototype._validateEntities=function(){var e=!0;(this.mobileGroup&&this.mobileGroup.element||(console.error("[UIMobile] mobileGroup must be a valid UI Element (Group)."),e=!1),this.joystickBase&&this.joystickBase.element||(console.error("[UIMobile] joystickBase must be an Image Element."),e=!1),this.joystickStick&&this.joystickStick.element||(console.error("[UIMobile] joystickStick must be an Image Element."),e=!1),this.interactButton&&!this.interactButton.element&&(console.warn("[UIMobile] interactButton is not a valid Element. Ignored."),this.interactButton=null),this.respawnButton&&!this.respawnButton.element&&(console.warn("[UIMobile] respawnButton is not a valid Element. Ignored."),this.respawnButton=null),this.soulShoreButton&&!this.soulShoreButton.element&&(console.warn("[UIMobile] soulShoreButton is not a valid Element. Ignored."),this.soulShoreButton=null),e&&this.mobileGroup&&this.joystickBase)&&(this._isChildOf(this.joystickBase,this.mobileGroup)||console.warn("[UIMobile] joystickBase should be a child of mobileGroup for proper alignment."));return e},UIMobile.prototype._isChildOf=function(e,t){for(var i=e;i&&i.parent;){if(i.parent===t)return!0;i=i.parent}return!1},UIMobile.prototype._disableMobileGroupBackgroundInput=function(){if(this.mobileGroup){for(var e=this.mobileGroup.children||[],t=0,i=0;i<e.length;i++){var o=e[i];if(o&&o.element){var n=(o.name||"").toLowerCase(),s=n.includes("background")||n.includes("bg")||n.includes("mask")||n.includes("panel"),l=n.includes("button")||n.includes("joystick")||n.includes("stick")||n.includes("interact")||n.includes("jump")||n.includes("respawn")||n.includes("soul")||n.includes("shore");s&&!l&&o.element.useInput&&(o.element.useInput=!1,t++,this.enableDebugLog&&console.log("[UIMobile] 自动禁用背景输入:",o.name,"(防止阻挡按钮点击)"))}}(t>0||this.enableDebugLog)&&console.log("[UIMobile] 已禁用",t,"个背景元素的useInput，确保按钮可点击")}},UIMobile.prototype._bindTouchEvents=function(){if(this.app.touch){var e=this;this.onTouchStart=function(t){for(var i=t.touches||[],o=0;o<i.length;o++){var n=i[o],s=new pc.Vec2(n.x,n.y);if(-1===e.joystickTouchId&&e._isTouchInJoystick(s))e._startJoystick(n.id,s),e.enableDebugLog&&console.log("[UIMobile] Joystick START id=",n.id,"x=",s.x,"y=",s.y);else{var l=!1;e.interactButton&&e._isTouchInElement(s,e.interactButton)?(e._pressInteract(),l=!0):e.jumpButton&&e._isTouchInElement(s,e.jumpButton)?(e._pressJump(),l=!0):e.respawnButton&&e._isTouchInElement(s,e.respawnButton)?(e._pressRespawn(),l=!0):e.soulShoreButton&&e._isTouchInElement(s,e.soulShoreButton)&&(e._pressSoulShore(),l=!0),l||-1===e.cameraTouchId&&e._isTouchInCameraZone(s)&&e._startCamera(n.id,s)}}t.event&&t.event.preventDefault()},this.onTouchMove=function(t){for(var i=t.touches||[],o=0;o<i.length;o++){var n=i[o],s=new pc.Vec2(n.x,n.y);n.id===e.joystickTouchId&&e._updateJoystick(s),n.id===e.cameraTouchId&&e._updateCamera(s)}t.event&&t.event.preventDefault()},this.onTouchEnd=function(t){for(var i=t.changedTouches||[],o=0;o<i.length;o++){var n=i[o];n.id===e.joystickTouchId&&e._endJoystick(),n.id===e.cameraTouchId&&e._endCamera()}t.event&&t.event.preventDefault()},this.app.touch.on(pc.EVENT_TOUCHSTART,this.onTouchStart,this),this.app.touch.on(pc.EVENT_TOUCHMOVE,this.onTouchMove,this),this.app.touch.on(pc.EVENT_TOUCHEND,this.onTouchEnd,this),this.app.touch.on(pc.EVENT_TOUCHCANCEL,this.onTouchEnd,this)}},UIMobile.prototype._getElementBoundsCanvas=function(e){if(!e||!e.element)return null;var t=e.element,i=t.canvasCorners||t.screenCorners||t.worldCorners;if(!i)return null;for(var o=1/0,n=1/0,s=-1/0,l=-1/0,a=0;a<i.length;a++){var r=i[a],h=r.x,c=r.y;h<o&&(o=h),c<n&&(n=c),h>s&&(s=h),c>l&&(l=c)}var u=s-o,b=l-n;return{minX:o,minY:n,maxX:s,maxY:l,width:u,height:b,centerX:o+.5*u,centerY:n+.5*b}},UIMobile.prototype._getBaseSize=function(){var e=this._getElementBoundsCanvas(this.joystickBase);return e?Math.min(e.width,e.height):100},UIMobile.prototype._getMobileGroupBounds=function(){return this.mobileGroup?this._getElementBoundsCanvas(this.mobileGroup):null},UIMobile.prototype._getJoystickMaxRadius=function(){return this.joystickMaxRadius>0?this.joystickMaxRadius:.5*this._getBaseSize()},UIMobile.prototype._isTouchInJoystick=function(e){var t=this._screenToBaseLocal(e.x,e.y),i=this._getJoystickMaxRadius();i*=this.joystickTouchScale>0?this.joystickTouchScale:1;var o=t.x*t.x+t.y*t.y<=i*i;if(this.enableDebugLog){var n=this._getElementBoundsCanvas(this.joystickBase),s=this._getBaseCenterWithOffset();console.log("[UIMobile] HitTest Joystick:",o?"IN":"OUT","| touch(",e.x.toFixed(0),",",e.y.toFixed(0),")","| baseCenter(",n?n.centerX.toFixed(0)+","+n.centerY.toFixed(0):"?,?",")","| offset(",this.touchCenterOffsetX||0,",",this.touchCenterOffsetY||0,")","| usedCenter(",s?s.x.toFixed(0)+","+s.y.toFixed(0):"?,?",")","| local(",t.x.toFixed(0),",",t.y.toFixed(0),")","| r=",i.toFixed(0))}return o},UIMobile.prototype._isTouchInElement=function(e,t){var i=this._getElementBoundsCanvas(t);return!!i&&(e.x>=i.minX&&e.x<=i.maxX&&e.y>=i.minY&&e.y<=i.maxY)},UIMobile.prototype._startJoystick=function(e,t){this.joystickActive=!0,this.joystickTouchId=e,this.joystickStartPos.set(0,0);var i=this._screenToBaseLocal(t.x,t.y);this.joystickCurrentPos.copy(i),this.enableDebugLog&&console.log("[UIMobile] Joystick START local:",i.x.toFixed(1),i.y.toFixed(1),"id:",e)},UIMobile.prototype._updateJoystick=function(e){if(this.joystickActive){var t=this._screenToBaseLocal(e.x,e.y),i=t.x,o=t.y,n=this._getJoystickMaxRadius(),s=Math.hypot(i,o);if(s>n){var l=n/s;i*=l,o*=l}this.joystickStick.setLocalPosition(i,o,0);var a=i/n,r=o/n;this.joystickDelta.set(a,r);var h=Math.sqrt(a*a+r*r),c="idle";(h=Math.min(h,1))>this.walkThreshold&&(c=h>this.runThreshold?"running":"walking"),this.app.fire("mobile:joystick:move",{x:-a,y:-r,magnitude:h,moveState:c})}},UIMobile.prototype._getScreenScaleFactor=function(){try{var e=null,t=this.mobileGroup||this.joystickBase;if(t&&t.screen)e=t.screen;else for(var i=t;i&&!e;){if(i.screen){e=i.screen;break}i=i.parent}if(e&&e.scale)return e.scale}catch(e){this.enableDebugLog&&console.warn("[UIMobile] Failed to get screen scale factor:",e)}return 1},UIMobile.prototype._getBaseCenterWithOffset=function(){var e=this._getMobileGroupBounds(),t=this._getElementBoundsCanvas(this.joystickBase),i=e||t;if(!i)return null;var o=this.app.graphicsDevice.width,n=this.app.graphicsDevice.height,s=this._getScreenScaleFactor(),l=this.enableOffsetAutoScale&&this.referenceScreenWidth>0?o/this.referenceScreenWidth:1,a=this.enableOffsetAutoScale&&this.referenceScreenHeight>0?n/this.referenceScreenHeight:1;l*=s,a*=s;var r=(this.touchCenterOffsetX||0)*l,h=(this.touchCenterOffsetY||0)*a,c=i.centerX,u=i.centerY;if(e&&t){var b=t.centerX-e.centerX,d=t.centerY-e.centerY;c=e.centerX+b,u=e.centerY+d,this.enableDebugLog&&console.log("[UIMobile] Using mobileGroup coordinate system - groupCenter:",e.centerX.toFixed(1),e.centerY.toFixed(1),"baseCenter:",t.centerX.toFixed(1),t.centerY.toFixed(1),"relativeOffset:",b.toFixed(1),d.toFixed(1))}var p={x:c+r,y:u+h};return this.enableDebugLog&&console.log("[UIMobile] Center calculation - screenScale:",s.toFixed(3),"scaleX:",l.toFixed(3),"scaleY:",a.toFixed(3),"referenceCenter:",c.toFixed(1),u.toFixed(1),"offset:",r.toFixed(1),h.toFixed(1),"finalCenter:",p.x.toFixed(1),p.y.toFixed(1),"usingGroup:",!!e),p},UIMobile.prototype._screenToBaseLocal=function(e,t){var i=this._getBaseCenterWithOffset();return i?new pc.Vec2(e-i.x,-(t-i.y)):new pc.Vec2(0,0)},UIMobile.prototype._endJoystick=function(){this.joystickActive=!1,this.joystickTouchId=-1,this.joystickDelta.set(0,0),this.app.fire("mobile:joystick:move",{x:0,y:0}),this.enableDebugLog&&console.log("[UIMobile] Joystick END")},UIMobile.prototype._isTouchInCameraZone=function(e){var t=this.app.graphicsDevice.width,i=this.cameraZone||"right";return!this.joystickActive&&("full"===i||("left"===i?e.x<t/2:"right"===i&&e.x>=t/2))},UIMobile.prototype._startCamera=function(e,t){this.cameraTouchId=e,this.cameraLastPos.copy(t),this.cameraDelta.set(0,0),this.enableDebugLog&&console.log("[UIMobile] Camera START",t.x,t.y,"id:",e)},UIMobile.prototype._updateCamera=function(e){if(-1!==this.cameraTouchId){var t=e.x-this.cameraLastPos.x,i=e.y-this.cameraLastPos.y;if(!(Math.abs(t)<1&&Math.abs(i)<1)){this.cameraDelta.set(t,i),this.cameraLastPos.copy(e);try{var o="undefined"!=typeof GlobalCameraManager?GlobalCameraManager.getInstance():null;o&&o.applyMouseDelta&&o.applyMouseDelta(t*this.cameraSensitivity,i*this.cameraSensitivity)}catch(e){this.enableDebugLog&&console.warn("[UIMobile] applyMouseDelta failed:",e)}this.app.fire("mobile:camera:rotate",{dx:t*this.cameraSensitivity,dy:i*this.cameraSensitivity})}}},UIMobile.prototype._endCamera=function(){this.cameraTouchId=-1,this.cameraDelta.set(0,0),this.enableDebugLog&&console.log("[UIMobile] Camera END")},UIMobile.prototype._pressInteract=function(){this.interactPressed=!0,this.app.fire("mobile:interact:press"),this.enableDebugLog&&console.log("[UIMobile] Interact PRESS");var e=this;setTimeout((function(){e.interactPressed=!1,e.app.fire("mobile:interact:release")}),100)},UIMobile.prototype._pressJump=function(){this.app.fire("mobile:jump:press"),this.app.fire("input:key:space"),this.enableDebugLog&&console.log("[UIMobile] Jump PRESS")},UIMobile.prototype._pressRespawn=function(){console.log("[UIMobile] Respawn button pressed");var e=!1;try{var t=this.app.root.findByName("DeathController")||this.app.root.findByTag("deathcontroller");e=!!(t&&t.length>0),console.log("[UIMobile] DeathController found:",e)}catch(e){console.warn("[UIMobile] Failed to check DeathController:",e)}if("undefined"!=typeof GlobalGame&&GlobalGame.getCheckpoint){var i=GlobalGame.getCheckpoint();console.log("[UIMobile] Has checkpoint:",!!i),i?console.log("[UIMobile] Checkpoint position:",i):console.warn("[UIMobile] No checkpoint set!")}console.log("[UIMobile] Firing player:respawn event for DeathController..."),this.app.fire("player:respawn"),this.enableDebugLog&&console.log("[UIMobile] Respawn event fired: player:respawn")},UIMobile.prototype._pressSoulShore=function(){this.app.fire("mobile:soulshore:press");try{var e="undefined"!=typeof UIManager?UIManager.getInstance():null;e&&e._showEscConfirm?e._showEscConfirm():console.warn("[UIMobile] UIManager或_showEscConfirm方法不可用")}catch(e){console.error("[UIMobile] 调用ESC界面失败:",e)}this.enableDebugLog&&console.log("[UIMobile] SoulShore PRESS - 触发ESC界面")},UIMobile.prototype.update=function(e){if(this._tempVec3&&this.joystickStick&&!this.joystickActive&&this.joystickStick.element)try{var t=this.joystickStick.getLocalPosition();if(!t)return;var i=this._tempVec3.set(0,0,0),o=Math.min(1,e*this.joystickReturnSpeed);this._tempVec3.lerp(t,i,o),this.joystickStick.setLocalPosition(this._tempVec3)}catch(e){this.enableDebugLog&&console.warn("[UIMobile] Update error (scene switching?):",e)}},UIMobile.prototype.getJoystickInput=function(){return{x:this.joystickDelta.x,y:-this.joystickDelta.y}},UIMobile.prototype.getCameraDelta=function(){return{dx:this.cameraDelta.x*this.cameraSensitivity,dy:this.cameraDelta.y*this.cameraSensitivity}},UIMobile.prototype.isInteractPressed=function(){return this.interactPressed},UIMobile.prototype._bindMobileButtons=function(){var e=this;this.jumpButton&&this.jumpButton.button&&(this._onJumpButtonClick=function(){e.enableDebugLog&&console.log("[UIMobile] Jump button clicked"),e.app.fire("mobile:jump")},this.jumpButton.button.on("click",this._onJumpButtonClick,this)),this.interactButton&&this.interactButton.button&&(this._onInteractButtonClick=function(){e.enableDebugLog&&console.log("[UIMobile] Interact button clicked"),e.app.fire("mobile:interact")},this.interactButton.button.on("click",this._onInteractButtonClick,this),this.interactButton.enabled=!1),this.respawnButton&&this.respawnButton.button?(this._onRespawnButtonClick=function(){e.enableDebugLog&&console.log("[UIMobile] Respawn button clicked (G key equivalent)"),e.app.fire("mobile:respawn"),e.app.fire("input:key:g")},this.respawnButton.button.on("click",this._onRespawnButtonClick,this),e.enableDebugLog&&console.log("[UIMobile] Respawn button event bound successfully")):e.enableDebugLog&&console.warn("[UIMobile] Respawn button not found or missing button component"),this.soulShoreButton&&this.soulShoreButton.button?(this._onSoulShoreButtonClick=function(){e.enableDebugLog&&console.log("[UIMobile] Soul Shore button clicked - 触发ESC界面");try{var t="undefined"!=typeof UIManager?UIManager.getInstance():null;t&&t._showEscConfirm?t._showEscConfirm():console.warn("[UIMobile] UIManager或_showEscConfirm方法不可用")}catch(e){console.error("[UIMobile] 调用ESC界面失败:",e)}},this.soulShoreButton.button.on("click",this._onSoulShoreButtonClick,this),e.enableDebugLog&&console.log("[UIMobile] Soul Shore button event bound successfully")):e.enableDebugLog&&console.warn("[UIMobile] Soul Shore button not found or missing button component"),this.interactHintText&&(this.interactHintText.enabled=!1)},UIMobile.prototype._unbindMobileButtons=function(){this.jumpButton&&this.jumpButton.button&&this._onJumpButtonClick&&this.jumpButton.button.off("click",this._onJumpButtonClick,this),this.interactButton&&this.interactButton.button&&this._onInteractButtonClick&&this.interactButton.button.off("click",this._onInteractButtonClick,this),this.respawnButton&&this.respawnButton.button&&this._onRespawnButtonClick&&this.respawnButton.button.off("click",this._onRespawnButtonClick,this),this.soulShoreButton&&this.soulShoreButton.button&&this._onSoulShoreButtonClick&&this.soulShoreButton.button.off("click",this._onSoulShoreButtonClick,this)},UIMobile.prototype._handleInteractHintShow=function(e){if(this.enableDebugLog&&(console.log("[UIMobile] _handleInteractHintShow called, data:",e),console.log("[UIMobile] interactButton:",this.interactButton),console.log("[UIMobile] interactHintText:",this.interactHintText)),e)if(this.interactButton?(this.interactButton.enabled=!0,this._interactButtonVisible=!0,this.enableDebugLog&&console.log("[UIMobile] Interact button enabled")):this.enableDebugLog&&console.warn("[UIMobile] interactButton is null!"),this.interactHintText&&this.interactHintText.element){var t="",i=e.hintKey||"",o=e.hint||"";if(this.enableDebugLog&&console.log("[UIMobile] Processing hint - hintKey:",i,"preTranslatedHint:",o,"data:",e),o&&"string"==typeof o)t=o,this.enableDebugLog&&console.log("[UIMobile] Using pre-translated hint:",t);else if(i)if("undefined"!=typeof I18n&&I18n.get)try{t=I18n.get("ui",i),this.enableDebugLog&&console.log('[UIMobile] I18n.get("ui", "'+i+'") ->',t),t&&"string"==typeof t||(t=I18n.get(i),this.enableDebugLog&&console.log('[UIMobile] I18n.get("'+i+'") ->',t)),t&&"string"==typeof t||(t=i,this.enableDebugLog&&console.log("[UIMobile] I18n lookup failed, using key as fallback:",i))}catch(e){this.enableDebugLog&&console.warn("[UIMobile] I18n.get failed:",e),t=i}else t=i,this.enableDebugLog&&console.log("[UIMobile] I18n not available, using hintKey:",t);else t="Interact",this.enableDebugLog&&console.log("[UIMobile] No hint data available, using default:",t);this.interactHintText.element.text=t,this.interactHintText.enabled=!0,this._currentInteractHint=t,this.enableDebugLog&&console.log("[UIMobile] Final hint text set:",t)}else this.enableDebugLog&&console.warn("[UIMobile] interactHintText is null or has no element!")},UIMobile.prototype._handleInteractHintHide=function(){this.interactButton&&(this.interactButton.enabled=!1,this._interactButtonVisible=!1),this.interactHintText&&(this.interactHintText.enabled=!1,this._currentInteractHint=""),this.enableDebugLog&&console.log("[UIMobile] Interact hint hide")},UIMobile.prototype._handleDialogueStarted=function(){this._isPCMode||(this._dialogueActive=!0,this._hideMobileControls(),this.enableDebugLog&&console.log("[UIMobile] Dialogue started - mobile controls hidden"))},UIMobile.prototype._handleDialogueStopped=function(){this._isPCMode||(this._dialogueActive=!1,this._showMobileControls(),this.enableDebugLog&&console.log("[UIMobile] Dialogue stopped - mobile controls restored"))},UIMobile.prototype._hideMobileControls=function(){this.joystickBase&&(this.joystickBase.enabled=!1),this.joystickStick&&(this.joystickStick.enabled=!1),this.jumpButton&&(this.jumpButton.enabled=!1),this.interactButton&&(this.interactButton.enabled=!1,this._interactButtonVisible=!1),this.interactHintText&&(this.interactHintText.enabled=!1),this._resetJoystickState(),this.enableDebugLog&&console.log("[UIMobile] Mobile controls hidden for dialogue",this.mobileGroup?"(mobileGroup available)":"")},UIMobile.prototype._showMobileControls=function(){this._isMobile&&(this.mobileGroup&&(this.mobileGroup.enabled=!0),this.joystickBase&&(this.joystickBase.enabled=!0),this.joystickStick&&(this.joystickStick.enabled=!0),this.jumpButton&&(this.jumpButton.enabled=!0),this.respawnButton&&(this.respawnButton.enabled=!0),this.soulShoreButton&&(this.soulShoreButton.enabled=!0),this.enableDebugLog&&console.log("[UIMobile] Mobile controls restored after dialogue",this.mobileGroup?"(via mobileGroup)":""))},UIMobile.prototype._resetJoystickState=function(){this.joystickActive=!1,this.joystickTouchId=-1,this.joystickCurrentPos.set(0,0),this.joystickDelta.set(0,0),this.joystickStick&&this.joystickStick.setLocalPosition(0,0,0),this.app.fire("mobile:move",{x:0,z:0,magnitude:0})},UIMobile.prototype._handleMobileUIHide=function(){!this._isPCMode&&this._isMobile&&(this.enableDebugLog&&console.log("[UIMobile] Hiding mobile UI (prologue/cutscene)"),this.mobileGroup&&(this.mobileGroup.enabled=!1),this._resetJoystickState())},UIMobile.prototype._handleMobileUIShow=function(){!this._isPCMode&&this._isMobile&&(this.enableDebugLog&&console.log("[UIMobile] Showing mobile UI"),this.mobileGroup&&(this.mobileGroup.enabled=!0))},UIMobile.prototype._handleUIStateChanged=function(e){if(console.log("[UIMobile] _handleUIStateChanged called with data:",e),console.log("[UIMobile] _isPCMode:",this._isPCMode,"_isMobile:",this._isMobile),!this._isPCMode&&this._isMobile)if(e){var t=e.from,i=e.to;console.log("[UIMobile] UI state changed:",t,"->",i),console.log("[UIMobile] Current _disabledMobileNodes count:",this._disabledMobileNodes?this._disabledMobileNodes.length:"undefined");var o=["typewriter","first_time_intro"],n=-1!==o.indexOf(i),s=-1!==o.indexOf(t);console.log("[UIMobile] shouldDisableScreen:",n,"wasScreenDisabled:",s),console.log("[UIMobile] disableScreenStates:",o),console.log("[UIMobile] to state in array:",o.indexOf(i)),n&&!s?(console.log("[UIMobile] Entering typing/intro state, disabling UIScreen"),this._disableUIScreen()):!n&&s?(console.log("[UIMobile] Leaving typing/intro state, enabling UIScreen"),this._enableUIScreen()):console.log("[UIMobile] No action needed for state change - shouldDisableScreen:",n,"wasScreenDisabled:",s)}else console.log("[UIMobile] No data provided for state change");else console.log("[UIMobile] Skipping state change handling - PC mode or not mobile")},UIMobile.prototype._disableUIScreen=function(){var e=this._findUIScreen();if(e){if(this._disabledMobileNodes&&this._disabledMobileNodes.length>0&&console.log("[UIMobile] Warning: _disabledMobileNodes already has",this._disabledMobileNodes.length,"entries, clearing first"),this._disabledMobileNodes=[],this._findAndDisableMobileNodes(e),console.log("[UIMobile] Disabled",this._disabledMobileNodes.length,"mobile nodes for typewriter state"),this.enableDebugLog)for(var t=0;t<this._disabledMobileNodes.length;t++){var i=this._disabledMobileNodes[t];console.log("[UIMobile] Disabled node["+t+"]:",i.name,"originalEnabled:",i.originalEnabled)}}else this.enableDebugLog&&console.warn("[UIMobile] UIScreen not found, falling back to hiding mobileGroup"),this._handleMobileUIHide()},UIMobile.prototype._enableUIScreen=function(){if(console.log("[UIMobile] _enableUIScreen called, _disabledMobileNodes count:",this._disabledMobileNodes?this._disabledMobileNodes.length:"undefined"),this._disabledMobileNodes&&this._disabledMobileNodes.length>0){for(var e=0,t=0,i=0;i<this._disabledMobileNodes.length;i++){var o=this._disabledMobileNodes[i];o&&o.entity?void 0!==o.entity.enabled?(o.entity.enabled=o.originalEnabled,e++,console.log("[UIMobile] Restored mobile node["+i+"]:",o.name,"to originalEnabled:",o.originalEnabled)):(t++,console.warn("[UIMobile] Failed to restore node["+i+"]:",o.name,"- entity may be destroyed")):(t++,console.warn("[UIMobile] Invalid node["+i+"]:",o))}console.log("[UIMobile] Restore summary: restored="+e+", failed="+t+", total="+this._disabledMobileNodes.length),this._disabledMobileNodes=[]}else console.warn("[UIMobile] No disabled mobile nodes to restore (count:",this._disabledMobileNodes?this._disabledMobileNodes.length:"undefined","), falling back to showing mobileGroup"),this._handleMobileUIShow()},UIMobile.prototype._findAndDisableMobileNodes=function(e){if(e&&e.children){var t=e.children;console.log("[UIMobile] _findAndDisableMobileNodes: searching in",e.name,"with",t.length,"children");for(var i=0;i<t.length;i++){var o=t[i];if(o){var n=(o.name||"").toLowerCase();if(console.log("[UIMobile] Checking child["+i+"]:",o.name,"lowercase:",n),0===n.indexOf("mobile")){var s={entity:o,originalEnabled:o.enabled,name:o.name};this._disabledMobileNodes.push(s),o.enabled=!1,console.log("[UIMobile] ✓ Disabled mobile node:",o.name,"originalEnabled:",s.originalEnabled)}else console.log("[UIMobile] Recursing into child:",o.name),this._findAndDisableMobileNodes(o)}}}else console.log("[UIMobile] _findAndDisableMobileNodes: parentEntity is null or has no children")},UIMobile.prototype._findUIScreen=function(){if(console.log("[UIMobile] _findUIScreen called"),console.log("[UIMobile] Current entity (UIScreen):",this.entity?this.entity.name:"null"),console.log("[UIMobile] Entity has screen component:",!!this.entity.screen),this.entity&&this.entity.screen)return console.log("[UIMobile] Using current entity as UIScreen:",this.entity.name),this.entity;console.log("[UIMobile] Fallback: searching from mobileGroup/joystickBase");for(var e=this.mobileGroup||this.joystickBase;e;){if(console.log("[UIMobile] Checking entity:",e.name,"hasScreen:",!!e.screen),e.screen)return console.log("[UIMobile] Found UIScreen via fallback:",e.name),e;e=e.parent}return console.warn("[UIMobile] No UIScreen found - current entity has no screen component"),null},UIMobile.prototype._handleResize=function(e,t){if(this._isMobile&&!this._isPCMode){var i=Math.abs(e-this._lastScreenWidth)>1,o=Math.abs(t-this._lastScreenHeight)>1;if(i||o){this.enableDebugLog&&console.log("[UIMobile] Screen resized from",this._lastScreenWidth+"x"+this._lastScreenHeight,"to",e+"x"+t);var n=this;setTimeout((function(){n.updateJoystickAlignment()}),100),this._lastScreenWidth=e,this._lastScreenHeight=t}}},UIMobile.prototype.updateJoystickAlignment=function(){if(this._isMobile&&this.joystickBase&&this.joystickStick){var e=this._getBaseCenterWithOffset();if(e)if(this.joystickActive){var t=this._getJoystickMaxRadius(),i=this.joystickDelta,o=i.x*t,n=i.y*t;this.joystickStick.setLocalPosition(o,n,0),this.enableDebugLog&&console.log("[UIMobile] Joystick alignment updated - center:",e.x.toFixed(1),e.y.toFixed(1),"stick pos:",o.toFixed(1),n.toFixed(1),"mobileGroup:",!!this.mobileGroup)}else this.joystickStick.setLocalPosition(0,0,0),this.enableDebugLog&&console.log("[UIMobile] Joystick reset to center - mobileGroup:",!!this.mobileGroup)}},UIMobile.prototype._detectMobileDevice=function(){if("undefined"!=typeof GlobalGame&&GlobalGame.device)return GlobalGame.device.isMobile||!1;var e=navigator.userAgent||navigator.vendor||window.opera||"",t=/android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i.test(e.toLowerCase()),i="ontouchstart"in window||navigator.maxTouchPoints>0;return t||i&&window.innerWidth<1024},UIMobile.prototype.isPCMode=function(){return this._isPCMode||!1},UIMobile.prototype._hideAllMobileUI=function(){this.mobileGroup?this.mobileGroup.enabled=!1:(this.joystickBase&&(this.joystickBase.enabled=!1),this.joystickStick&&(this.joystickStick.enabled=!1),this.interactButton&&(this.interactButton.enabled=!1),this.interactHintText&&(this.interactHintText.enabled=!1),this.jumpButton&&(this.jumpButton.enabled=!1),this.respawnButton&&(this.respawnButton.enabled=!1),this.soulShoreButton&&(this.soulShoreButton.enabled=!1)),this.enableDebugLog&&console.log("[UIMobile] All mobile UI elements hidden",this.mobileGroup?"(via mobileGroup)":"(individually)")},UIMobile.prototype._hideMobileUIForPC=function(){this.mobileGroup&&(this.mobileGroup.enabled=!1,this.enableDebugLog&&console.log("[UIMobile] PC detected: Hidden entire mobileGroup")),this.joystickBase&&(this.joystickBase.enabled=!1),this.joystickStick&&(this.joystickStick.enabled=!1),this.jumpButton&&(this.jumpButton.enabled=!1),this.interactButton&&(this.interactButton.enabled=!1),this.interactHintText&&(this.interactHintText.enabled=!1),this.respawnButton&&(this.respawnButton.enabled=!1),this.soulShoreButton&&(this.soulShoreButton.enabled=!1),this.enableDebugLog&&(console.log("[UIMobile] PC detected: Hidden individual mobile UI elements"),console.log("[UIMobile] - jumpButton:",!!this.jumpButton,"enabled:",this.jumpButton?this.jumpButton.enabled:"N/A"),console.log("[UIMobile] - interactButton:",!!this.interactButton,"enabled:",this.interactButton?this.interactButton.enabled:"N/A"),console.log("[UIMobile] - respawnButton:",!!this.respawnButton,"enabled:",this.respawnButton?this.respawnButton.enabled:"N/A"),console.log("[UIMobile] - soulShoreButton:",!!this.soulShoreButton,"enabled:",this.soulShoreButton?this.soulShoreButton.enabled:"N/A")),this._isPCMode=!0},UIMobile.prototype.destroy=function(){UIMobile._instance===this&&(UIMobile._instance=null),this._onInteractHintShow&&this.app.off("interactable:hint:show",this._onInteractHintShow,this),this._onInteractHintHide&&this.app.off("interactable:hint:hide",this._onInteractHintHide,this),this._onDialogueStarted&&this.app.off("dialogue:started",this._onDialogueStarted,this),this._onDialogueStopped&&this.app.off("dialogue:stopped",this._onDialogueStopped,this),this._onResizeHandler&&this.app.graphicsDevice.off("resizecanvas",this._onResizeHandler,this),this._onMobileUIHide&&this.app.off("mobile:ui:hide",this._onMobileUIHide,this),this._onMobileUIShow&&this.app.off("mobile:ui:show",this._onMobileUIShow,this),this._onUIStateChanged&&this.app.off("ui:state_changed",this._onUIStateChanged,this),this._unbindMobileButtons(),this.app.touch&&(this.onTouchStart&&this.app.touch.off(pc.EVENT_TOUCHSTART,this.onTouchStart,this),this.onTouchMove&&this.app.touch.off(pc.EVENT_TOUCHMOVE,this.onTouchMove,this),this.onTouchEnd&&(this.app.touch.off(pc.EVENT_TOUCHEND,this.onTouchEnd,this),this.app.touch.off(pc.EVENT_TOUCHCANCEL,this.onTouchEnd,this))),this.enableDebugLog&&console.log("[UIMobile] Destroyed")};var UIUtils=function(){"use strict";function getElementScreenBounds(e){if(!e||!e.element)return null;var n=e.element.screenCorners;if(!n||n.length<4)return null;var t=Math.min(n[0].x,n[1].x,n[2].x,n[3].x),r=Math.max(n[0].x,n[1].x,n[2].x,n[3].x),c=Math.min(n[0].y,n[1].y,n[2].y,n[3].y),i=Math.max(n[0].y,n[1].y,n[2].y,n[3].y);return{minX:t,maxX:r,minY:c,maxY:i,centerX:(t+r)/2,centerY:(c+i)/2,width:r-t,height:i-c}}return{getElementScreenBounds:getElementScreenBounds,getElementScreenCenter:function getElementScreenCenter(e){var n=getElementScreenBounds(e);return n?new pc.Vec2(n.centerX,n.centerY):null},isPointInElement:function isPointInElement(e,n){var t=getElementScreenBounds(n);return!!t&&(e.x>=t.minX&&e.x<=t.maxX&&e.y>=t.minY&&e.y<=t.maxY)},worldToLocal:function worldToLocal(e,n,t){if(!n||!t)return e.clone();var r=t.getWorldTransform(),c=new pc.Vec3;r.transformPoint(e,c);var i=new pc.Mat4;i.copy(n.getWorldTransform()).invert();var a=new pc.Vec3;return i.transformPoint(c,a),a},getTouchScreenPosition:function getTouchScreenPosition(e){return new pc.Vec2(e.x,e.y)},getScreenDistance:function getScreenDistance(e,n){var t=n.x-e.x,r=n.y-e.y;return Math.sqrt(t*t+r*r)},clampToCircle:function clampToCircle(e,n,t){var r=e.x-n.x,c=e.y-n.y,i=Math.sqrt(r*r+c*c);if(i<=t)return e.clone();var a=t/i;return new pc.Vec2(n.x+r*a,n.y+c*a)},clampToRect:function clampToRect(e,n){return new pc.Vec2(Math.max(n.minX,Math.min(n.maxX,e.x)),Math.max(n.minY,Math.min(n.maxY,e.y)))},lerpScreenPos:function lerpScreenPos(e,n,t){return t=Math.max(0,Math.min(1,t)),new pc.Vec2(e.x+(n.x-e.x)*t,e.y+(n.y-e.y)*t)},getElementSize:function getElementSize(e){if(!e||!e.element)return null;var n=e.element;return{width:n.calculatedWidth||n.width||0,height:n.calculatedHeight||n.height||0}},areElementsOverlapping:function areElementsOverlapping(e,n){var t=getElementScreenBounds(e),r=getElementScreenBounds(n);return!(!t||!r)&&!(t.maxX<r.minX||t.minX>r.maxX||t.maxY<r.minY||t.minY>r.maxY)}}}();"undefined"!=typeof window&&(window.UIUtils=UIUtils);var ScenePortal=pc.createScript("scenePortal");ScenePortal.attributes.add("playerEntity",{type:"entity",title:"玩家实体（可选）"}),ScenePortal.attributes.add("triggerDistance",{type:"number",default:2.5,title:"触发距离（米）"}),ScenePortal.attributes.add("targetSceneName",{type:"string",default:"level1",title:"目标场景名称"}),ScenePortal.attributes.add("promptKey",{type:"string",default:"portal.confirm",title:"提示文本 i18n 键"}),ScenePortal.attributes.add("promptText",{type:"string",default:"前往下一关？",title:"提示文本（兜底）"}),ScenePortal.attributes.add("yesButtonKey",{type:"string",default:"ui.yes",title:'"是"按钮 i18n 键'}),ScenePortal.attributes.add("yesButtonText",{type:"string",default:"是",title:'"是"按钮文本（兜底）'}),ScenePortal.attributes.add("noButtonKey",{type:"string",default:"ui.no",title:'"否"按钮 i18n 键'}),ScenePortal.attributes.add("noButtonText",{type:"string",default:"否",title:'"否"按钮文本（兜底）'}),ScenePortal.attributes.add("autoHideOnNo",{type:"boolean",default:!0,title:'点击"否"自动隐藏'}),ScenePortal.attributes.add("cooldownSeconds",{type:"number",default:2,title:"冷却时间（秒）"}),ScenePortal.attributes.add("enableDebugLog",{type:"boolean",default:!1,title:"调试日志"}),ScenePortal.prototype.initialize=function(){if(this._isPlayerNear=!1,this._dialogVisible=!1,this._lastTriggerTime=0,this._player=this.playerEntity||this.app.root.findByName("Player"),this._player){this._tmpVec=new pc.Vec3;var e=this;this._onYesClick=function(){e._handleYesClick()},this._onNoClick=function(){e._handleNoClick()},this.app.on("portal:yes",this._onYesClick,this),this.app.on("portal:no",this._onNoClick,this),this.enableDebugLog&&console.log("[ScenePortal] Initialized for scene:",this.targetSceneName)}else console.error("[ScenePortal] Player entity not found")},ScenePortal.prototype.update=function(e){if(this._player){var t=this.entity.getPosition(),o=this._player.getPosition(),i=this._tmpVec.sub2(t,o).length()<=this.triggerDistance;i&&!this._isPlayerNear?(this._isPlayerNear=!0,this._onPlayerEnter()):!i&&this._isPlayerNear&&(this._isPlayerNear=!1,this._onPlayerLeave())}},ScenePortal.prototype._onPlayerEnter=function(){var e=Date.now();e-this._lastTriggerTime<1e3*this.cooldownSeconds?this.enableDebugLog&&console.log("[ScenePortal] Cooldown active, ignoring trigger"):(this._lastTriggerTime=e,this.enableDebugLog&&console.log("[ScenePortal] Player entered portal range"),this._showConfirmDialog())},ScenePortal.prototype._onPlayerLeave=function(){this.enableDebugLog&&console.log("[ScenePortal] Player left portal range")},ScenePortal.prototype._showConfirmDialog=function(){if(!this._dialogVisible){var e=this._getText(this.promptKey,this.promptText),t=this._getText(this.yesButtonKey,this.yesButtonText),o=this._getText(this.noButtonKey,this.noButtonText);try{this.app.fire("player:lock_action"),this.enableDebugLog&&console.log("[ScenePortal] Player locked")}catch(e){this.enableDebugLog&&console.warn("[ScenePortal] Failed to lock player:",e)}this.app.fire("ui:portal:show",{prompt:e,yesButton:t,noButton:o,targetScene:this.targetSceneName,portal:this.entity}),this._dialogVisible=!0,this.enableDebugLog&&console.log("[ScenePortal] Dialog shown:",e)}},ScenePortal.prototype._hideConfirmDialog=function(){if(this._dialogVisible){this.app.fire("ui:portal:hide"),this._dialogVisible=!1;try{this.app.fire("player:unlock_action"),this.enableDebugLog&&console.log("[ScenePortal] Player unlocked")}catch(e){this.enableDebugLog&&console.warn("[ScenePortal] Failed to unlock player:",e)}this.enableDebugLog&&console.log("[ScenePortal] Dialog hidden")}},ScenePortal.prototype._getText=function(e,t){try{if("undefined"!=typeof I18n&&I18n.get){var o=I18n.get(e);if(o&&"string"==typeof o)return o}}catch(t){this.enableDebugLog&&console.warn("[ScenePortal] i18n get failed for key:",e,t)}return t||e},ScenePortal.prototype._handleYesClick=function(){console.log("[ScenePortal] _handleYesClick called, _dialogVisible:",this._dialogVisible),this._dialogVisible?(console.log("[ScenePortal] Yes clicked, loading scene:",this.targetSceneName),this._hideConfirmDialog(),this._loadScene(this.targetSceneName)):console.warn("[ScenePortal] Dialog not visible, ignoring yes click")},ScenePortal.prototype._handleNoClick=function(){this._dialogVisible&&(this.enableDebugLog&&console.log("[ScenePortal] No clicked"),this.autoHideOnNo&&this._hideConfirmDialog())},ScenePortal.prototype._loadScene=function(e){this.enableDebugLog&&console.log("[ScenePortal] _loadScene called with:",e);var t=this;if("undefined"!=typeof GlobalGame&&GlobalGame.loadScene)return this.enableDebugLog&&console.log("[ScenePortal] Using GlobalGame.loadScene"),void GlobalGame.loadScene(e,(function(o,i){o?console.error("[ScenePortal] Failed to load scene:",o):t.enableDebugLog&&console.log("[ScenePortal] Scene loaded successfully:",e)}));this.enableDebugLog&&console.log("[ScenePortal] GlobalGame not available, using app.scenes.changeScene");try{this.app.scenes.changeScene(e,(function(o,i){o?console.error("[ScenePortal] Failed to load scene:",o):t.enableDebugLog&&console.log("[ScenePortal] Scene loaded successfully:",e)}))}catch(e){console.error("[ScenePortal] Exception loading scene:",e)}},ScenePortal.prototype.destroy=function(){this.app&&(this.app.off("portal:yes",this._onYesClick,this),this.app.off("portal:no",this._onNoClick,this)),this._dialogVisible&&this._hideConfirmDialog()};var PortalConfirmUI=pc.createScript("portalConfirmUI");PortalConfirmUI.attributes.add("dialogPanel",{type:"entity",title:"对话框面板"}),PortalConfirmUI.attributes.add("promptText",{type:"entity",title:"提示文本"}),PortalConfirmUI.attributes.add("yesButton",{type:"entity",title:'"是"按钮'}),PortalConfirmUI.attributes.add("noButton",{type:"entity",title:'"否"按钮'}),PortalConfirmUI.attributes.add("fadeInMs",{type:"number",default:200,title:"淡入时间（毫秒）"}),PortalConfirmUI.attributes.add("fadeOutMs",{type:"number",default:150,title:"淡出时间（毫秒）"}),PortalConfirmUI.attributes.add("enableDebugLog",{type:"boolean",default:!1,title:"调试日志"}),PortalConfirmUI._instance=null,PortalConfirmUI.getInstance=function(){return PortalConfirmUI._instance},PortalConfirmUI.prototype.initialize=function(){if(PortalConfirmUI._instance)console.warn("[PortalConfirmUI] Multiple instances detected");else if(PortalConfirmUI._instance=this,this._isVisible=!1,this._currentTargetScene=null,this._isPCPlatform=this._detectPCPlatform(),console.log("[PortalConfirmUI] Initializing..."),console.log("[PortalConfirmUI] Platform: PC =",this._isPCPlatform),console.log("[PortalConfirmUI] dialogPanel:",this.dialogPanel),console.log("[PortalConfirmUI] promptText:",this.promptText),console.log("[PortalConfirmUI] yesButton:",this.yesButton),console.log("[PortalConfirmUI] noButton:",this.noButton),this._validateElements()){this._setVisible(!1,!0),this.yesButton&&(this.yesButton.enabled=!1),this.noButton&&(this.noButton.enabled=!1),console.log("[PortalConfirmUI] Initial hide complete, dialogPanel.enabled:",this.dialogPanel.enabled),this._bindButtons(),this._isPCPlatform&&this._bindKeyboardShortcuts();var t=this;this._onShow=function(o){console.log("[PortalConfirmUI] ui:portal:show event received, data:",o),t._show(o)},this._onHide=function(){console.log("[PortalConfirmUI] ui:portal:hide event received"),t._hide()},this.app.on("ui:portal:show",this._onShow,this),this.app.on("ui:portal:hide",this._onHide,this),console.log("[PortalConfirmUI] Initialized successfully, listening for ui:portal:show")}else console.error("[PortalConfirmUI] Required elements missing - UI will not work!")},PortalConfirmUI.prototype._validateElements=function(){return this.dialogPanel?this.promptText&&this.promptText.element?this.yesButton&&this.yesButton.button?!(!this.noButton||!this.noButton.button)||(console.error("[PortalConfirmUI] noButton is null or missing button component"),!1):(console.error("[PortalConfirmUI] yesButton is null or missing button component"),!1):(console.error("[PortalConfirmUI] promptText is null or missing element"),!1):(console.error("[PortalConfirmUI] dialogPanel is null"),!1)},PortalConfirmUI.prototype._detectPCPlatform=function(){if(this.app&&this.app.touch&&this.app.touch.supported)return!1;var t=navigator.userAgent||"",o=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(t),e="ontouchstart"in window||navigator.maxTouchPoints>0;return!o&&!e},PortalConfirmUI.prototype._bindButtons=function(){var t=this;this._onYesButtonClick=function(){console.log("[PortalConfirmUI] Yes button clicked, firing portal:yes"),t.dialogPanel&&(t.dialogPanel.enabled=!1,t.dialogPanel.element&&(t.dialogPanel.element.opacity=0)),t.yesButton&&(t.yesButton.enabled=!1),t.noButton&&(t.noButton.enabled=!1),t._isVisible=!1,t._currentTargetScene=null,t.app.fire("portal:yes")},this._onNoButtonClick=function(){console.log("[PortalConfirmUI] No button clicked"),t.dialogPanel&&(t.dialogPanel.enabled=!1,t.dialogPanel.element&&(t.dialogPanel.element.opacity=0)),t.yesButton&&(t.yesButton.enabled=!1),t.noButton&&(t.noButton.enabled=!1),t._isVisible=!1,t._currentTargetScene=null,t.app.fire("portal:no")},this.yesButton.button.on("click",this._onYesButtonClick,this),this.noButton.button.on("click",this._onNoButtonClick,this)},PortalConfirmUI.prototype._bindKeyboardShortcuts=function(){var t=this;this._onKeyDown=function(o){if(t._isVisible){var e=o.key;e===pc.KEY_Q?(t.enableDebugLog&&console.log("[PortalConfirmUI] Q key pressed, triggering No button"),t._onNoButtonClick()):e===pc.KEY_E&&(t.enableDebugLog&&console.log("[PortalConfirmUI] E key pressed, triggering Yes button"),t._onYesButtonClick())}},this.app.keyboard&&(this.app.keyboard.on(pc.EVENT_KEYDOWN,this._onKeyDown,this),console.log("[PortalConfirmUI] Keyboard shortcuts bound: Q=No, E=Yes"))},PortalConfirmUI.prototype._show=function(t){if(console.log("[PortalConfirmUI] _show called, data:",t),t){if(this._currentTargetScene=t.targetScene,this.promptText&&this.promptText.element){var o=t.prompt||"确认前往？";"undefined"!=typeof I18n&&"function"==typeof I18n.t&&o.indexOf(".")>0&&(o=I18n.t(o,o)),this.promptText.element.text=o,console.log("[PortalConfirmUI] Updated prompt text to:",o)}else console.error("[PortalConfirmUI] Cannot update prompt text - element missing");var e=this._translateButtonText(t.yesButton)||"yes",n=this._translateButtonText(t.noButton)||"no";this._isPCPlatform&&(e="[E] "+e,n="[Q] "+n,this.enableDebugLog&&console.log("[PortalConfirmUI] PC platform - added key hints")),this.enableDebugLog&&(console.log("[PortalConfirmUI] Button text translation - Yes:",t.yesButton,"->",e),console.log("[PortalConfirmUI] Button text translation - No:",t.noButton,"->",n)),this._updateButtonText(this.yesButton,e),this._updateButtonText(this.noButton,n),this.yesButton&&(this.yesButton.enabled=!0),this.noButton&&(this.noButton.enabled=!0),console.log("[PortalConfirmUI] Calling _setVisible(true)"),this._setVisible(!0),console.log("[PortalConfirmUI] Dialog shown, target:",this._currentTargetScene)}else console.warn("[PortalConfirmUI] _show called with no data")},PortalConfirmUI.prototype._hide=function(){this._setVisible(!1),this._currentTargetScene=null,this.yesButton&&(this.yesButton.enabled=!1),this.noButton&&(this.noButton.enabled=!1),this.enableDebugLog&&console.log("[PortalConfirmUI] Hidden")},PortalConfirmUI.prototype._setVisible=function(t,o){if(console.log("[PortalConfirmUI] _setVisible called, visible:",t,"immediate:",o,"current _isVisible:",this._isVisible),this._isVisible!==t||o)if(this._isVisible=t,o)this.dialogPanel.enabled=t,this.dialogPanel.element&&(this.dialogPanel.element.opacity=t?1:0),console.log("[PortalConfirmUI] Set immediately, enabled:",t);else{var e=this,n=t?this.fadeInMs:this.fadeOutMs,i=t?0:1,l=t?1:0;if(t&&(this.dialogPanel.enabled=!0),this.dialogPanel.element){this.dialogPanel.element.opacity=i;var a=Date.now(),animate=function(){var o=Date.now()-a,s=Math.min(o/n,1);e.dialogPanel&&e.dialogPanel.element&&(e.dialogPanel.element.opacity=i+(l-i)*s),s<1?requestAnimationFrame(animate):t||e.dialogPanel&&(e.dialogPanel.enabled=!1)};requestAnimationFrame(animate)}}else console.log("[PortalConfirmUI] Already in desired state, skipping")},PortalConfirmUI.prototype._translateButtonText=function(t){if(!t)return null;if("undefined"!=typeof I18n&&"function"==typeof I18n.t&&t.indexOf(".")>0)return I18n.t(t,t);if("是"===t||"否"===t){var o="zh-CN";if("undefined"!=typeof I18n&&I18n.getCurrentLanguage?o=I18n.getCurrentLanguage():"undefined"!=typeof GlobalGame&&GlobalGame.getSetting&&(o=GlobalGame.getSetting("language","zh-CN")),this.enableDebugLog&&(console.log("[PortalConfirmUI] Language detection for button text:"),console.log("  Input text:",t),console.log("  Current language:",o),console.log("  I18n available:","undefined"!=typeof I18n),console.log("  GlobalGame available:","undefined"!=typeof GlobalGame)),0===o.indexOf("en")){var e="是"===t?"Yes":"No";return this.enableDebugLog&&console.log("  English environment, translating to:",e),e}return this.enableDebugLog&&console.log("  Chinese environment, keeping original text:",t),t}return t},PortalConfirmUI.prototype._updateButtonText=function(t,o){if(t){var e=null;if(!(e=t.findByName("Text")))for(var n=t.children||[],i=0;i<n.length;i++)if(n[i].element&&n[i].element.type===pc.ELEMENTTYPE_TEXT){e=n[i];break}e&&e.element&&(e.element.text=o)}},PortalConfirmUI.prototype.destroy=function(){PortalConfirmUI._instance===this&&(PortalConfirmUI._instance=null),this.yesButton&&this.yesButton.button&&this._onYesButtonClick&&this.yesButton.button.off("click",this._onYesButtonClick,this),this.noButton&&this.noButton.button&&this._onNoButtonClick&&this.noButton.button.off("click",this._onNoButtonClick,this),this._isPCPlatform&&this.app&&this.app.keyboard&&this._onKeyDown&&this.app.keyboard.off(pc.EVENT_KEYDOWN,this._onKeyDown,this),this.app&&(this.app.off("ui:portal:show",this._onShow,this),this.app.off("ui:portal:hide",this._onHide,this))};var Climbable=pc.createScript("climbable");Climbable.attributes.add("minClimbAngle",{type:"number",default:60,title:"最小攀爬角度（度）"}),Climbable.attributes.add("climbSpeed",{type:"number",default:2,title:"攀爬速度"}),Climbable.attributes.add("climbKey",{type:"string",default:"KeyF",title:"攀爬按键"}),Climbable.attributes.add("enableDebugLog",{type:"boolean",default:!1,title:"调试日志"}),Climbable.prototype.initialize=function(){return this.entity.collision?this.entity.rigidbody?(this.entity.rigidbody.type!==pc.BODYTYPE_STATIC&&console.warn("[Climbable] Rigidbody type should be STATIC for climbable surfaces"),this.entity.collision.on("collisionstart",this._onCollisionStart,this),this.entity.collision.on("collisionend",this._onCollisionEnd,this),this._playerInContact=null,void console.log("[Climbable] Initialized:",this.entity.name,"Rigidbody type:",this.entity.rigidbody.type)):(console.error("[Climbable] Entity missing rigidbody component:",this.entity.name),void console.error("[Climbable] Please add a Rigidbody component (Type: Static) in the editor")):(console.error("[Climbable] Entity missing collision component:",this.entity.name),void console.error("[Climbable] Please add a Collision component in the editor"))},Climbable.prototype._onCollisionStart=function(i){if(console.log("[Climbable] collisionstart event fired, other entity:",i.other.name),this._isPlayer(i.other))if(console.log("[Climbable] Player detected!"),i.contacts&&0!==i.contacts.length){var t=i.contacts[0].normal,e=this._getAngleFromVertical(t);console.log("[Climbable] Collision with player, angle:",e.toFixed(1),"°","normal:",t.toString()),e>=this.minClimbAngle&&(this._playerInContact=i.other,this.app.fire("climbable:enter",{climbable:this.entity,normal:t,angle:e,climbSpeed:this.climbSpeed,climbKey:this.climbKey}),this.enableDebugLog&&console.log("[Climbable] Player can climb (angle >= "+this.minClimbAngle+"°)"))}else console.warn("[Climbable] No contact points in collision result");else console.log("[Climbable] Not a player, ignoring")},Climbable.prototype._onCollisionEnd=function(i){this._isPlayer(i.other)&&this._playerInContact===i.other&&(this._playerInContact=null,this.app.fire("climbable:exit",{climbable:this.entity}),this.enableDebugLog&&console.log("[Climbable] Player left climbable surface"))},Climbable.prototype._isPlayer=function(i){return!!i&&("Player"===i.name||i.tags&&i.tags.has("player"))},Climbable.prototype._getAngleFromVertical=function(i){var t=new pc.Vec3(0,1,0),e=i.dot(t);return Math.acos(pc.math.clamp(e,-1,1))*pc.math.RAD_TO_DEG},Climbable.prototype.destroy=function(){this.entity.collision&&(this.entity.collision.off("collisionstart",this._onCollisionStart,this),this.entity.collision.off("collisionend",this._onCollisionEnd,this)),this._playerInContact&&this.app.fire("climbable:exit",{climbable:this.entity})};var CheckingPoint=pc.createScript("checkingPoint");CheckingPoint.attributes.add("visualEntities",{type:"entity",array:!0,title:"视觉反馈实体列表"}),CheckingPoint.attributes.add("scaleAmount",{type:"number",default:1.3,title:"缩放倍数"}),CheckingPoint.attributes.add("emissiveBoost",{type:"number",default:2,title:"发光增强倍数"}),CheckingPoint.attributes.add("emissiveDuration",{type:"number",default:.5,title:"发光持续时间（秒）"}),CheckingPoint.attributes.add("interactKey",{type:"string",default:"interact.checkpoint",title:"交互提示 i18n 键"}),CheckingPoint.attributes.add("interactHint",{type:"string",default:"存档",title:"交互提示文本（兜底）"}),CheckingPoint.attributes.add("cooldownSeconds",{type:"number",default:2,title:"冷却时间（秒）"}),CheckingPoint.attributes.add("onlyOnce",{type:"boolean",default:!0,title:"只能激活一次"}),CheckingPoint.attributes.add("checkpointId",{type:"string",default:"",title:"存档点ID",description:"用于跟踪和管理的唯一标识符，留空则自动生成"}),CheckingPoint.attributes.add("particleEntity",{type:"entity",title:"粒子系统实体（可选）"}),CheckingPoint.attributes.add("sceneName",{type:"string",default:"",title:"场景名称",description:'如果设置为 "Start"，则不会保存存档点位置到 GameManager'}),CheckingPoint.attributes.add("enableDebugLog",{type:"boolean",default:!1,title:"调试日志"}),CheckingPoint.attributes.add("isLevelCheckpoint",{type:"boolean",default:!1,title:"关卡存档点",description:"勾选后，到达存档点时会自动加载并淡入显示下一部分内容"}),CheckingPoint.attributes.add("nextPartIndex",{type:"number",default:1,title:"下一部分索引",description:"激活存档点时要显示的 Part 索引（配合 LevelManager 使用）"}),CheckingPoint.attributes.add("hidePreviousPart",{type:"boolean",default:!1,title:"隐藏前一部分",description:"激活下一部分时是否隐藏当前部分（勾选可隐藏前一部分）"}),CheckingPoint.attributes.add("prologueKey",{type:"string",default:"",title:"Prologue 键名",description:"要播放的 prologue 内容键名（如 ethanShell, ethanMind 等），留空则不播放"}),CheckingPoint.attributes.add("playPrologueBeforeUnlock",{type:"boolean",default:!0,title:"播放 Prologue 后解锁",description:"勾选后会先播放 prologue，播放完成后再解锁玩家和激活下一部分"}),CheckingPoint.attributes.add("titleKey",{type:"string",default:"",title:"主标题 i18n 键名",description:"激活 Part 动画时显示的主标题键名（如 level.ethans_wind.shell.title），留空则不显示"}),CheckingPoint.attributes.add("subtitleKey",{type:"string",default:"",title:"副标题 i18n 键名",description:"激活 Part 动画时显示的副标题键名（如 level.ethans_wind.shell.subtitle），留空则不显示"}),CheckingPoint.attributes.add("showTitleWithAnimation",{type:"boolean",default:!0,title:"与动画同步显示标题",description:"勾选后标题会在 Part 弹出动画完成后显示"}),CheckingPoint.attributes.add("titleDisplayDelay",{type:"number",default:.2,title:"副标题延迟（秒）",description:"副标题相对于主标题的显示延迟时间"}),CheckingPoint.attributes.add("scaleDuration",{type:"number",default:.8,title:"缩放动画时长（秒）",description:"下一部分子节点的缩放动画时长"}),CheckingPoint.attributes.add("scaleDelay",{type:"number",default:.3,title:"缩放延迟（秒）",description:"激活存档点后，延迟多久开始缩放"}),CheckingPoint.attributes.add("scaleOvershoot",{type:"number",default:1.2,title:"缩放过冲值",description:"弹出动画的最大缩放值（会超出然后回弹）"}),CheckingPoint.attributes.add("itemDelay",{type:"number",default:.05,title:"子节点间隔（秒）",description:"每个子节点顺序弹出的时间间隔"}),CheckingPoint.prototype.initialize=function(){if(this._isActivated=!1,this._lastActivateTime=0,this._animatingEntities=[],this._checkpointId=this.checkpointId||this.entity.name+"_"+this.entity.getGuid(),this.onlyOnce&&"undefined"!=typeof GlobalGame&&GlobalGame.isCheckpointActivated&&(this._isActivated=GlobalGame.isCheckpointActivated(this._checkpointId),this._isActivated)){this.enableDebugLog&&console.log("[CheckingPoint] Checkpoint already activated:",this._checkpointId);var e=this.entity.script&&this.entity.script.interactableHint;e&&(e.enabled=!1,this.enableDebugLog&&console.log("[CheckingPoint] Disabled InteractableHint component (already activated)"))}this._originalStates=[];for(var t=0;t<this.visualEntities.length;t++){var i=this.visualEntities[t];if(i){var n={entity:i,originalScale:i.getLocalScale().clone(),originalEmissive:null,material:null};if(i.model&&i.model.meshInstances&&i.model.meshInstances.length>0){var o=i.model.meshInstances[0];o.material&&(n.material=o.material,n.originalEmissive=o.material.emissive.clone())}this._originalStates.push(n)}}var a=this;this._onInteractableAction=function(e){e&&e.entity===a.entity&&a._activate()},this.app.on("interactable:action",this._onInteractableAction,this),this.enableDebugLog&&console.log("[CheckingPoint] Initialized with ID:",this._checkpointId,"visual entities:",this.visualEntities.length)},CheckingPoint.prototype._activate=function(){if((console.log("[CheckingPoint] _activate called"),this.onlyOnce&&"undefined"!=typeof GlobalGame&&GlobalGame.isCheckpointActivated)&&GlobalGame.isCheckpointActivated(this._checkpointId))return this.enableDebugLog&&console.log("[CheckingPoint] 存档点已在GameManager中标记为激活，ID:",this._checkpointId),void(this._isActivated=!0);if(this.onlyOnce&&this._isActivated)this.enableDebugLog&&console.log("[CheckingPoint] 存档点已激活，只能激活一次");else{var e=Date.now()/1e3,t=e-this._lastActivateTime;if(console.log("[CheckingPoint] Time since last activate:",t,"cooldown:",this.cooldownSeconds),t<this.cooldownSeconds)console.log("[CheckingPoint] Still in cooldown, remaining:",this.cooldownSeconds-t);else{if(this.app.fire("ui:hint:hide",{side:"right"}),this._lastActivateTime=e,this._isActivated=!0,this.onlyOnce){var i=this.entity.script&&this.entity.script.interactableHint;i&&(i.enabled=!1,this.enableDebugLog&&console.log("[CheckingPoint] Disabled InteractableHint component")),this.app.fire("ui:hint:hide",{side:"right"})}console.log("[CheckingPoint] Activated at position:",this.entity.getPosition()),this._saveCheckpoint(),this._playVisualFeedback(),this.app.fire("checkpoint:saved",{position:this.entity.getPosition().clone(),checkpoint:this.entity}),this.prologueKey&&""!==this.prologueKey.trim()?this.playPrologueBeforeUnlock?this._lockPlayerAndPlayPrologue():(this._playPrologue(),this.isLevelCheckpoint&&this._activateNextPart()):this.isLevelCheckpoint&&this._activateNextPart()}}},CheckingPoint.prototype._saveCheckpoint=function(){if(console.log("[CheckingPoint] _saveCheckpoint 被调用"),this.sceneName&&"start"===this.sceneName.trim().toLowerCase()){this.enableDebugLog&&console.log('[CheckingPoint] 场景名称为 "Start"，跳过保存存档点位置');try{"undefined"!=typeof GlobalGame&&GlobalGame.markCheckpointActivated&&(GlobalGame.markCheckpointActivated(this._checkpointId),this.enableDebugLog&&console.log("[CheckingPoint] 已标记存档点为已激活（不保存位置）:",this._checkpointId))}catch(e){console.error("[CheckingPoint] 标记存档点激活失败:",e)}}else try{if("undefined"!=typeof GlobalGame)if(GlobalGame&&"function"==typeof GlobalGame.setCheckpoint){var e=null;"function"==typeof GlobalGame.getCurrentScene?(e=GlobalGame.getCurrentScene(),console.log("[CheckingPoint] 获取到场景名称:",e)):console.warn("[CheckingPoint] GlobalGame.getCurrentScene 方法不存在");var t={};this.isLevelCheckpoint&&"number"==typeof this.nextPartIndex&&(t.partIndex=this.nextPartIndex),this.prologueKey&&""!==this.prologueKey.trim()&&(t.prologueKey=this.prologueKey),t.entityName=this.entity.name,e&&(t.sceneName=e);var i=this.entity.getPosition().clone();console.log("[CheckingPoint] 保存全局存档点，位置:",i),GlobalGame.setCheckpoint(i,this._checkpointId,t),console.log("[CheckingPoint] 检查场景专属API，currentScene:",e,"setSceneCheckpoint存在:","function"==typeof GlobalGame.setSceneCheckpoint),e&&"function"==typeof GlobalGame.setSceneCheckpoint?(console.log("[CheckingPoint] 调用 setSceneCheckpoint，场景:",e,"位置:",i),GlobalGame.setSceneCheckpoint(e,i),console.log("[CheckingPoint] 场景存档点已保存")):e?"function"!=typeof GlobalGame.setSceneCheckpoint&&console.warn("[CheckingPoint] 无法保存场景存档点：GlobalGame.setSceneCheckpoint 方法不存在"):console.warn("[CheckingPoint] 无法保存场景存档点：场景名称为空"),console.log("[CheckingPoint] 存档点保存完成，ID:",this._checkpointId)}else console.warn("[CheckingPoint] GlobalGame.setCheckpoint not found");else console.warn("[CheckingPoint] GlobalGame not found")}catch(e){console.error("[CheckingPoint] Failed to save checkpoint:",e)}},CheckingPoint.prototype._playVisualFeedback=function(){for(var e=0;e<this._originalStates.length;e++){var t=this._originalStates[e];t.entity&&t.entity.enabled&&this._animateEntity(t)}},CheckingPoint.prototype._animateEntity=function(e){var t=e.entity,i=e.originalScale,n=i.clone().mulScalar(this.scaleAmount),o={entity:t,originalScale:i,targetScale:n,scaleProgress:0,scalingUp:!0,emissiveProgress:0,material:e.material,originalEmissive:e.originalEmissive};this._animatingEntities.push(o),this.enableDebugLog&&console.log("[CheckingPoint] Started animation for entity:",t.name)},CheckingPoint.prototype.update=function(e){if(0!==this._animatingEntities.length)for(var t=this.scaleDuration,i=this.emissiveDuration,n=this.emissiveBoost,o=this._animatingEntities.length-1;o>=0;o--){var a=this._animatingEntities[o],l=a.entity;if(l&&l.enabled){a.scalingUp?(a.scaleProgress+=e/t,a.scaleProgress>=1&&(a.scaleProgress=1,a.scalingUp=!1)):(a.scaleProgress-=e/t,a.scaleProgress<=0&&(a.scaleProgress=0));var s=this._easeOutBack(a.scaleProgress),c=new pc.Vec3;c.lerp(a.originalScale,a.targetScale,s);var r=a.originalScale.clone();if(r.z=c.z,l.setLocalScale(r),a.material&&a.originalEmissive){a.emissiveProgress+=e/i,a.emissiveProgress>1&&(a.emissiveProgress=1);var h=Math.sin(a.emissiveProgress*Math.PI),g=a.originalEmissive.clone().mulScalar(1+(n-1)*h);a.material.emissive.copy(g),a.material.update()}a.scaleProgress<=0&&a.emissiveProgress>=1&&(l.setLocalScale(a.originalScale),a.material&&a.originalEmissive&&(a.material.emissive.copy(a.originalEmissive),a.material.update()),this._animatingEntities.splice(o,1),console.log("[CheckingPoint] Animation completed for entity:",l.name),0===this._animatingEntities.length&&this._playParticleSystem())}else this._animatingEntities.splice(o,1)}},CheckingPoint.prototype._playParticleSystem=function(){if(this.particleEntity)try{var e=this.particleEntity.particlesystem;e?(e.play(),console.log("[CheckingPoint] Particle system started:",this.particleEntity.name)):console.warn("[CheckingPoint] Particle entity has no particlesystem component:",this.particleEntity.name)}catch(e){console.error("[CheckingPoint] Failed to play particle system:",e)}else console.log("[CheckingPoint] No particle entity configured")},CheckingPoint.prototype._easeOutBack=function(e){var t=1.70158;return 1+2.70158*Math.pow(e-1,3)+t*Math.pow(e-1,2)},CheckingPoint.prototype._activateNextPart=function(){if("undefined"!=typeof LevelManager&&LevelManager.getInstance){var e=LevelManager.getInstance();if(e){this.enableDebugLog&&console.log("[CheckingPoint] 通过 LevelManager 激活 Part["+this.nextPartIndex+"]");var t={duration:this.scaleDuration||.8,delay:this.scaleDelay||.3,itemDelay:this.itemDelay||.05,overshoot:this.scaleOvershoot||1.2,hidePrevious:this.hidePreviousPart};if(e.activatePartWithAnimation(this.nextPartIndex,t),this.showTitleWithAnimation&&(this.titleKey||this.subtitleKey)){var i=this,n=1e3*(t.delay+t.duration+.2);this.enableDebugLog&&(console.log("[CheckingPoint] 将在Part动画完成后显示双标题，延迟时间:",n+"ms"),this.titleKey&&console.log("[CheckingPoint] 主标题键名:",this.titleKey),this.subtitleKey&&console.log("[CheckingPoint] 副标题键名:",this.subtitleKey)),setTimeout((function(){i._showDualTitles()}),n)}this.app.fire("checkpoint:activated",{checkpoint:this.entity,nextPartIndex:this.nextPartIndex,animOptions:t,titleKey:this.titleKey||null,subtitleKey:this.subtitleKey||null}),this.enableDebugLog&&(console.log("[CheckingPoint] Part 激活请求已发送，动画参数:",t),this.titleKey&&""!==this.titleKey.trim()&&console.log("[CheckingPoint] 标题键名:",this.titleKey))}else this.enableDebugLog&&console.warn("[CheckingPoint] LevelManager 实例不存在")}else this.enableDebugLog&&console.warn("[CheckingPoint] LevelManager 不可用，跳过 Part 激活")},CheckingPoint.prototype._showDualTitles=function(){var e=this.titleKey&&""!==this.titleKey.trim(),t=this.subtitleKey&&""!==this.subtitleKey.trim();if(e||t)try{this.enableDebugLog&&(console.log("[CheckingPoint] 准备显示双标题（顺序播放）:"),e&&console.log("  - 主标题键名:",this.titleKey),t&&console.log("  - 副标题键名:",this.subtitleKey));var i=this;if(e&&!t)return this.app.fire("title:show",this.titleKey),void(this.enableDebugLog&&console.log("[CheckingPoint] 显示主标题（无副标题）:",this.titleKey));if(!e&&t)return this.app.fire("title:show",this.subtitleKey),void(this.enableDebugLog&&console.log("[CheckingPoint] 显示副标题（无主标题）:",this.subtitleKey));if(e&&t){var onTitleComplete=function(e){if(e&&e.i18nKey===i.titleKey){i.app.off("title:complete",onTitleComplete);var t=1e3*(i.titleDisplayDelay||.2);setTimeout((function(){i.app.fire("title:show",i.subtitleKey),i.enableDebugLog&&console.log("[CheckingPoint] 主标题完成，开始显示副标题:",i.subtitleKey)}),t)}};this.app.on("title:complete",onTitleComplete,this),this.app.fire("title:show",this.titleKey),this.enableDebugLog&&console.log("[CheckingPoint] 开始显示主标题（等待完成后播放副标题）:",this.titleKey)}this.app.fire("checkpoint:title:show",{checkpoint:this.entity,mainTitleKey:e?this.titleKey:null,subtitleKey:t?this.subtitleKey:null,titleDisplayDelay:this.titleDisplayDelay||.2})}catch(e){console.error("[CheckingPoint] 显示双标题失败:",e)}else this.enableDebugLog&&console.warn("[CheckingPoint] 主标题和副标题键名都为空，跳过标题显示")},CheckingPoint.prototype._lockPlayerAndPlayPrologue=function(){this.enableDebugLog&&console.log("[CheckingPoint] 锁定玩家并播放 prologue:",this.prologueKey);try{if(this.app.fire("player:set_sitting",!0),"undefined"!=typeof GlobalCameraManager){var e=GlobalCameraManager.getInstance();e&&(e.setState(GlobalCameraManager.CONTROL_STATES.LOCKED_MULTI),this.enableDebugLog&&console.log("[CheckingPoint] 相机状态设置为 LOCKED_MULTI"))}else this.app.fire("ui:control:set","LOCKED_MULTI");this._playPrologue()}catch(e){console.error("[CheckingPoint] 锁定玩家失败:",e),this._onPrologueComplete()}},CheckingPoint.prototype._playPrologue=function(){this.enableDebugLog&&console.log("[CheckingPoint] 开始播放 prologue:",this.prologueKey);try{if("undefined"!=typeof GlobalGame&&GlobalGame.recordProloguePlay&&(GlobalGame.recordProloguePlay(this.prologueKey,this._checkpointId,{entityName:this.entity.name,position:{x:this.entity.getPosition().x,y:this.entity.getPosition().y,z:this.entity.getPosition().z}}),this.enableDebugLog&&console.log("[CheckingPoint] Prologue play recorded in GameManager for:",this._checkpointId)),"undefined"==typeof UIManager||!UIManager.getInstance)return console.warn("[CheckingPoint] UIManager 不可用，无法播放 prologue"),void this._onPrologueComplete();var e=UIManager.getInstance();if(!e)return console.warn("[CheckingPoint] UIManager 实例不存在"),void this._onPrologueComplete();var t=this;"function"==typeof e.playLevelPrologue?e.playLevelPrologue(this.prologueKey,(function(){t._onPrologueComplete()})):(console.warn("[CheckingPoint] UIManager.playLevelPrologue 方法不存在"),this._onPrologueComplete())}catch(e){console.error("[CheckingPoint] 播放 prologue 失败:",e),this._onPrologueComplete()}},CheckingPoint.prototype._onPrologueComplete=function(){this.enableDebugLog&&console.log("[CheckingPoint] Prologue 播放完成，处理后续逻辑");try{if(this.playPrologueBeforeUnlock)if(this.enableDebugLog&&console.log("[CheckingPoint] 解锁玩家坐姿状态"),this.app.fire("player:set_sitting",!1),"undefined"!=typeof GlobalCameraManager){var e=GlobalCameraManager.getInstance();e&&(e.setState(GlobalCameraManager.CONTROL_STATES.FREE_FOLLOW),this.enableDebugLog&&console.log("[CheckingPoint] 相机状态恢复为 FREE_FOLLOW"))}else this.app.fire("ui:control:set","FREE_FOLLOW");this.isLevelCheckpoint&&this._activateNextPart(),this.app.fire("checkpoint:prologue:complete",{checkpoint:this.entity,prologueKey:this.prologueKey})}catch(e){console.error("[CheckingPoint] Prologue 完成处理失败:",e)}},CheckingPoint.prototype.destroy=function(){this.app&&this._onInteractableAction&&this.app.off("interactable:action",this._onInteractableAction,this);for(var e=0;e<this._originalStates.length;e++){var t=this._originalStates[e];t.entity&&t.entity.enabled&&(t.entity.setLocalScale(t.originalScale),t.material&&t.originalEmissive&&(t.material.emissive.copy(t.originalEmissive),t.material.update()))}};var DeathController=pc.createScript("deathController");DeathController.attributes.add("player",{type:"entity",title:"Player Root"}),DeathController.attributes.add("playerModel",{type:"entity",title:"Player Model/Render"}),DeathController.attributes.add("uiRoot",{type:"entity",title:"UI Root (Screen)"}),DeathController.attributes.add("fadeOverlay",{type:"entity",title:"Fade Overlay (Image Element)"}),DeathController.attributes.add("respawnPoint",{type:"entity",title:"Default Respawn Point"}),DeathController.attributes.add("defaultSpawnOffset",{type:"vec3",default:[0,0,0],title:"默认重生点位置偏移"}),DeathController.attributes.add("scaleDownTime",{type:"number",default:.6,title:"缩小到光点耗时(秒)"}),DeathController.attributes.add("fadeOutTime",{type:"number",default:.5,title:"黑幕淡出耗时(秒)"}),DeathController.attributes.add("blackHoldTime",{type:"number",default:.3,title:"黑幕停留(秒)"}),DeathController.attributes.add("fadeInTime",{type:"number",default:.6,title:"黑幕淡入耗时(秒)"}),DeathController.attributes.add("emissiveBoost",{type:"number",default:3,title:"死亡缩小时的自发光增强(倍数)"}),DeathController.attributes.add("disableInputEvent",{type:"string",default:"player:lock_action",title:"禁用输入事件名"}),DeathController.attributes.add("enableInputEvent",{type:"string",default:"player:unlock_action",title:"启用输入事件名"}),DeathController.attributes.add("lightFxEntity",{type:"entity",title:"Death Light FX (可选)"}),DeathController.attributes.add("useCheckpoint",{type:"boolean",default:!0,title:"使用存档点（否则用默认复活点）"}),DeathController.attributes.add("respawnKey",{type:"string",default:"G",title:"手动回档键位"}),DeathController.attributes.add("respawnKeyCode",{type:"number",default:71,title:"手动回档键码（G=71）"}),DeathController.attributes.add("enableDebugLog",{type:"boolean",default:!1,title:"调试日志"}),DeathController.prototype.initialize=function(){if(this._isDying=!1,this._origScale=this.playerModel?this.playerModel.getLocalScale().clone():new pc.Vec3(.02,.02,.02),this.fadeOverlay&&this.fadeOverlay.element&&(this.fadeOverlay.element.opacity=0,console.log("[DeathController] FadeOverlay opacity initialized to 0")),this._savedMats=[],this.playerModel&&this.playerModel.model)for(var e=this.playerModel.model.meshInstances||[],t=0;t<e.length;t++){var a=e[t],o=a.material;o&&o.emissive&&this._savedMats.push({mi:a,mat:o,emissive:o.emissive.clone(),emissiveIntensity:o.emissiveIntensity||1})}var n=this;this._onPlayerDie=function(){n.startDeathSequence()},this.app.on("player:die",this._onPlayerDie,this),this._onManualRespawn=function(){n.manualRespawn()},this.app.on("player:respawn",this._onManualRespawn,this),this._onKeyDown=function(e){if(e.key===n.respawnKeyCode&&!n._isDying){if("undefined"!=typeof UIManager){var t=UIManager.getInstance();if(t&&("typewriter"===t.currentState||"first_time_intro"===t.currentState))return void(n.enableDebugLog&&console.log("[DeathController] Respawn key ignored during UIManager animation state:",t.currentState))}n.manualRespawn()}},this.app.keyboard.on(pc.EVENT_KEYDOWN,this._onKeyDown,this),this._onSceneChange=function(){console.log("[DeathController] Scene changing, cleaning up..."),n.destroy()},this.app.on("scene:beforeunload",this._onSceneChange,this),this.enableDebugLog&&console.log("[DeathController] Initialized with",this._savedMats.length,"materials")},DeathController.prototype.manualRespawn=function(){if(this._isDying)console.log("[DeathController] Already in respawn sequence, ignoring manual respawn");else{this._isDying=!0,console.log("[DeathController] Manual respawn triggered"),console.log("[DeathController] fadeOverlay:",this.fadeOverlay),this.fadeOverlay&&(console.log("[DeathController] fadeOverlay.element:",this.fadeOverlay.element),this.fadeOverlay.element&&console.log("[DeathController] Current opacity:",this.fadeOverlay.element.opacity)),this.app.fire(this.disableInputEvent);var e=this;console.log("[DeathController] Starting fade to black..."),this._fadeToBlack().then((function(){return console.log("[DeathController] Fade to black done, starting respawn..."),e._respawnAtCheckpoint()})).then((function(){return console.log("[DeathController] Respawn done, starting fade in..."),e._fadeInFromBlack()})).then((function(){return console.log("[DeathController] Fade in done, restoring..."),e._restoreAfterDeath()})).catch((function(t){console.error("[DeathController] manual respawn error:",t),e._isDying=!1}))}},DeathController.prototype.startDeathSequence=function(){if(this._isDying)this.enableDebugLog&&console.log("[DeathController] Already dying, ignoring");else{this._isDying=!0,this.enableDebugLog&&console.log("[DeathController] Starting death sequence"),this.app.fire(this.disableInputEvent),this.uiRoot&&(this.uiRoot.enabled=!1);var e=this;this._toLightPoint(this.scaleDownTime).then((function(){return e._fadeToBlack()})).then((function(){return e._respawnAtCheckpoint()})).then((function(){return e._fadeInFromBlack()})).then((function(){return e._restoreAfterDeath()})).catch((function(t){console.error("[DeathController] sequence error:",t),e._isDying=!1}))}},DeathController.prototype._toLightPoint=function(e){var t=this;return new Promise((function(a){if(!t.playerModel)return console.warn("[DeathController] No playerModel, skipping scale animation"),void a();var o=0,n=t.playerModel.getLocalScale().clone(),l=new pc.Vec3(.05,.05,.05);t.lightFxEntity&&(t.lightFxEntity.enabled=!0,t.enableDebugLog&&console.log("[DeathController] Light FX enabled"));var onUpdate=function(i){o+=i;var r=pc.math.clamp(o/e,0,1),s=(new pc.Vec3).lerp(n,l,r);t.playerModel.setLocalScale(s);for(var p=0;p<t._savedMats.length;p++){var h=t._savedMats[p],c=h.mat,d=pc.math.lerp(h.emissiveIntensity,h.emissiveIntensity*t.emissiveBoost,r);c.emissive=h.emissive.clone(),c.emissiveIntensity=d,c.update()}r>=1&&(t.app.off("update",onUpdate),t.enableDebugLog&&console.log("[DeathController] Light point animation completed"),a())};t.app.on("update",onUpdate)}))},DeathController.prototype._fadeToBlack=function(){var e=this,t=this.fadeOverlay&&this.fadeOverlay.element;return t?new Promise((function(a){var o=0,n=e.fadeOutTime,l=t.opacity,onUpdate=function(i){o+=i;var r=pc.math.clamp(o/n,0,1);if(t.opacity=pc.math.lerp(l,1,r),r>=1)if(e.app.off("update",onUpdate),e.blackHoldTime>0){var s=0,holdUpdate=function(t){(s+=t)>=e.blackHoldTime&&(e.app.off("update",holdUpdate),e.enableDebugLog&&console.log("[DeathController] Fade to black completed"),a())};e.app.on("update",holdUpdate)}else e.enableDebugLog&&console.log("[DeathController] Fade to black completed"),a()};e.app.on("update",onUpdate)})):(console.warn("[DeathController] No fadeOverlay element, skipping fade"),Promise.resolve())},DeathController.prototype._respawnAtCheckpoint=function(){var e=null,t=null;if(this.useCheckpoint&&"undefined"!=typeof GlobalGame){var a=GlobalGame.getCheckpoint();a?(e=a.clone(),console.log("[DeathController] Using checkpoint position:",e)):console.warn("[DeathController] No checkpoint found, using default respawn point")}if(!e&&this.respawnPoint){var o=this.respawnPoint.getPosition().clone();if(console.log("[DeathController] Default respawn point base position:",o),console.log("[DeathController] defaultSpawnOffset raw value:",this.defaultSpawnOffset),e=o,this.defaultSpawnOffset){var n=this.defaultSpawnOffset;n instanceof pc.Vec3||(n=new pc.Vec3(n.x||n[0]||0,n.y||n[1]||0,n.z||n[2]||0)),console.log("[DeathController] Offset as Vec3:",n),e.add(n),console.log("[DeathController] Final respawn position after offset:",e)}else console.log("[DeathController] No offset specified, using base position:",e);t=this.respawnPoint.getRotation().clone()}else e||console.error("[DeathController] No respawn position available! respawnPoint:",this.respawnPoint);try{if(this.player){var l=this.player.rigidbody;l&&(l.linearVelocity=new pc.Vec3(0,0,0),l.angularVelocity=new pc.Vec3(0,0,0),l.type!==pc.BODYTYPE_DYNAMIC&&(l.type=pc.BODYTYPE_DYNAMIC),console.log("[DeathController] Rigidbody velocities cleared and type set to DYNAMIC")),e&&(l&&t?l.teleport(e,t):l?l.teleport(e,this.player.getRotation()):(this.player.setPosition(e),t&&this.player.setRotation(t))),console.log("[DeathController] Player respawned at:",this.player.getPosition())}}catch(e){console.error("[DeathController] Failed to respawn player:",e)}this._updateRespawnStats(),this.playerModel&&this.playerModel.setLocalScale(this._origScale);for(var i=0;i<this._savedMats.length;i++){var r=this._savedMats[i];r.mat.emissive=r.emissive.clone(),r.mat.emissiveIntensity=r.emissiveIntensity,r.mat.update()}return this.lightFxEntity&&(this.lightFxEntity.enabled=!1),Promise.resolve()},DeathController.prototype._fadeInFromBlack=function(){var e=this,t=this.fadeOverlay&&this.fadeOverlay.element;return t?new Promise((function(a){var o=0,n=e.fadeInTime,l=t.opacity,onUpdate=function(i){o+=i;var r=pc.math.clamp(o/n,0,1);t.opacity=pc.math.lerp(l,0,r),r>=1&&(e.app.off("update",onUpdate),e.enableDebugLog&&console.log("[DeathController] Fade in completed"),a())};e.app.on("update",onUpdate)})):Promise.resolve()},DeathController.prototype._restoreAfterDeath=function(){return this.uiRoot&&(this.uiRoot.enabled=!0),this.app.fire(this.enableInputEvent),this._isDying=!1,this.enableDebugLog&&console.log("[DeathController] Death sequence completed, player restored"),Promise.resolve()},DeathController.prototype._updateRespawnStats=function(){try{if("undefined"!=typeof GlobalGame&&GlobalGame.getSetting&&GlobalGame.setSetting){var e=GlobalGame.getSetting("totalRespawns",0),t=GlobalGame.getSetting("respawnsByScene",{});e++,GlobalGame.setSetting("totalRespawns",e);var a=GlobalGame.getCurrentScene?GlobalGame.getCurrentScene():"unknown";t[a]=(t[a]||0)+1,GlobalGame.setSetting("respawnsByScene",t),GlobalGame.saveSettings&&GlobalGame.saveSettings(),this.enableDebugLog&&console.log("[DeathController] Respawn stats updated - Total:",e,"Scene:",a,":",t[a]),this.app&&this.app.fire("player:respawn:stats_updated",{totalRespawns:e,currentScene:a,sceneRespawns:t[a]})}else this.enableDebugLog&&(console.warn("[DeathController] GlobalGame not available, cannot update respawn stats"),console.warn("[DeathController] Available methods:","undefined"!=typeof GlobalGame?Object.keys(GlobalGame):"GlobalGame undefined"))}catch(e){console.error("[DeathController] Failed to update respawn stats:",e)}},DeathController.prototype.destroy=function(){console.log("[DeathController] Destroying..."),this.app&&this._onPlayerDie&&this.app.off("player:die",this._onPlayerDie,this),this.app&&this._onManualRespawn&&this.app.off("player:respawn",this._onManualRespawn,this),this.app&&this.app.keyboard&&this._onKeyDown&&this.app.keyboard.off(pc.EVENT_KEYDOWN,this._onKeyDown,this),this.app&&this._onSceneChange&&this.app.off("scene:beforeunload",this._onSceneChange,this),this.app&&this.app.off("update"),console.log("[DeathController] Destroyed successfully")};var TitleTyper=pc.createScript("titleTyper");TitleTyper.attributes.add("titleGroup",{type:"entity",title:"Title Group（容器）"}),TitleTyper.attributes.add("sampleChar",{type:"entity",title:"Sample Single Text（模板）"}),TitleTyper.attributes.add("align",{type:"string",default:"center",enum:[{Left:"left"},{Center:"center"},{Right:"right"}],title:"对齐方式"}),TitleTyper.attributes.add("monoSpacing",{type:"number",default:0,title:"等宽排布(0=关闭)"}),TitleTyper.attributes.add("letterSpacing",{type:"number",default:2,title:"额外字距(px)"}),TitleTyper.attributes.add("maxWidth",{type:"number",default:0,title:"最大宽度(0=不限制)"}),TitleTyper.attributes.add("duration",{type:"number",default:1.5,title:"播放总时长(秒)"}),TitleTyper.attributes.add("fadeIn",{type:"number",default:.25,title:"单字淡入(秒)"}),TitleTyper.attributes.add("fadeOutDelay",{type:"number",default:0,title:"整体淡出延迟(秒, 0不淡出)"}),TitleTyper.attributes.add("fadeOut",{type:"number",default:.4,title:"整体淡出(秒)"}),TitleTyper.attributes.add("yRise",{type:"number",default:6,title:"淡入上飘(px)"}),TitleTyper.attributes.add("splitMode",{type:"string",default:"char",enum:[{Character:"char"},{Word:"word"}],title:"拆分模式"}),TitleTyper.attributes.add("usePool",{type:"boolean",default:!0,title:"使用对象池"}),TitleTyper.attributes.add("poolSize",{type:"number",default:64,title:"池大小"}),TitleTyper.attributes.add("floatAmplitude",{type:"number",default:3,title:"浮动幅度(px)"}),TitleTyper.attributes.add("floatSpeed",{type:"number",default:2,title:"浮动速度(Hz)"}),TitleTyper.attributes.add("configAsset",{type:"asset",assetType:"json",title:"Title 配置 JSON（可选）"}),TitleTyper.prototype.initialize=function(){this._pool=[],this._inUse=[],this._tweens=[],this._playing=!1,this._floatItems=[],this._config={},this._isDestroyed=!1,this._configReady=!1,this.sampleChar&&(this.sampleChar.enabled=!1),this.usePool&&this._warmPool(),this._loadConfig();var t=this;this._onTitleShow=function(e,i){t.showTitle(e,i)},this.app.on("title:show",this._onTitleShow,this),this._onSceneBeforeUnload=function(e){t._isDestroyed=!0,t._recycleAll(),t.app&&t._onTitleShow&&t.app.off("title:show",t._onTitleShow,t),t.titleGroup=null,t.sampleChar=null,t._pool.length=0,t._inUse.length=0},this.app.on("scene:beforeunload",this._onSceneBeforeUnload,this)},TitleTyper.prototype._loadConfig=function(){if(this.configAsset)try{var t;if(t="object"==typeof this.configAsset&&void 0!==this.configAsset.resource?this.configAsset:this.app.assets.get(this.configAsset))if(t.resource)this._config=t.resource,this._configReady=!0;else if(t.loaded)this._config={},this._configReady=!0;else{var e=this;t.once("load",(function(t){e._config=t.resource||{},e._configReady=!0})),t.once("error",(function(){e._config={},e._configReady=!0})),this.app.assets.load(t)}}catch(t){}else this._configReady=!0},TitleTyper.prototype._warmPool=function(){for(var t=0;t<this.poolSize;t++){var e=this._spawnCharEntity();e&&this._pool.push(e)}},TitleTyper.prototype._spawnCharEntity=function(){if(!this.sampleChar||!this.titleGroup)return null;var t=this.sampleChar.clone();t.enabled=!1,this.titleGroup.addChild(t);var e=t.element;if(e)e.anchor=new pc.Vec4(0,.5,0,.5),e.pivot=new pc.Vec2(0,.5),e.opacity=0,e.text="";else try{t.addComponent("element",{type:pc.ELEMENTTYPE_TEXT,anchor:[0,.5,0,.5],pivot:[0,.5],text:"",fontAsset:this.sampleChar.element?this.sampleChar.element.fontAsset:null,fontSize:this.sampleChar.element?this.sampleChar.element.fontSize:48,opacity:0})}catch(t){return null}return t.element?t:null},TitleTyper.prototype._getCharEntity=function(){var t=this.usePool&&this._pool.length>0?this._pool.pop():this._spawnCharEntity();return t?(this._inUse.push(t),t.enabled=!0,t):null},TitleTyper.prototype._getConfig=function(t){return this._config&&t&&this._config[t]||null},TitleTyper.prototype._applyStyle=function(t,e){if(t&&e)try{e.color&&(t.color=this._parseColor(e.color)),e.outlineColor&&(t.outlineColor=this._parseColor(e.outlineColor)),void 0!==e.outlineThickness&&(t.outlineThickness=e.outlineThickness),void 0!==e.fontSize&&(t.fontSize=e.fontSize)}catch(t){console.warn("[TitleTyper] Failed to apply style:",t)}},TitleTyper.prototype._parseColor=function(t){if(!t||!t.startsWith("#"))return new pc.Color(1,1,1);var e=t.substring(1),i=parseInt(e.substring(0,2),16)/255,o=parseInt(e.substring(2,4),16)/255,n=parseInt(e.substring(4,6),16)/255,l=e.length>6?parseInt(e.substring(6,8),16)/255:1;return new pc.Color(i,o,n,l)},TitleTyper.prototype._recycleAll=function(){for(var t=0;t<this._tweens.length;t++){var e=this._tweens[t];e&&e.stop&&e.stop()}this._tweens.length=0,this._floatItems.length=0;for(var i=0;i<this._inUse.length;i++){var o=this._inUse[i];o.element&&(o.element.text="",o.element.opacity=0),o.enabled=!1,this.usePool?this._pool.push(o):o.destroy()}this._inUse.length=0},TitleTyper.prototype._splitText=function(t){return"word"===this.splitMode?t.match(/[^\s]+|\s/g)||[]:Array.from(t)},TitleTyper.prototype._measureWidth=function(t,e){if(this.monoSpacing>0)return this.monoSpacing;var i=t.element;return i.text=e,i.calculatedWidth||i.width||.6*i.fontSize},TitleTyper.prototype._layoutLine=function(t){for(var e=0,i=0;i<t.length;i++)e+=t[i].width+(i>0?this.letterSpacing:0);var o=0;"center"===this.align?o=-e/2:"right"===this.align&&(o=-e);var n=1;this.maxWidth>0&&e>this.maxWidth&&(n=this.maxWidth/e);var l=o;for(i=0;i<t.length;i++){var a=t[i],s=o+(l-o)*n;a.entity.setLocalPosition(s,0,0),l+=a.width+this.letterSpacing}},TitleTyper.prototype.showTitle=function(t,e){if(!this._isDestroyed&&this.titleGroup&&void 0!==!this.titleGroup.enabled&&!this.titleGroup._destroyed&&this.sampleChar&&void 0!==!this.sampleChar.enabled&&!this.sampleChar._destroyed&&this.sampleChar.element){this._recycleAll();var i=this._getConfig(t),o="";if(e&&e.text)o=e.text;else if("undefined"!=typeof I18n&&I18n.t)o=I18n.t("title."+t,"");else if("undefined"!=typeof I18n&&I18n.get){var n=I18n.get("title");if(n){for(var l=t.split("."),a=n,s=0;s<l.length&&null!=a;s++)a=a[l[s]];o=a||""}}if(o){var r={duration:this.duration,fadeIn:this.fadeIn,fadeOutDelay:this.fadeOutDelay,fadeOut:this.fadeOut,yRise:this.yRise,align:this.align,monoSpacing:this.monoSpacing,letterSpacing:this.letterSpacing,splitMode:this.splitMode,floatAmplitude:this.floatAmplitude,floatSpeed:this.floatSpeed,offsetX:0,offsetY:0};if(i)for(var p in i)i.hasOwnProperty(p)&&(r[p]=i[p]);if(e)for(var p in e)e.hasOwnProperty(p)&&(r[p]=e[p]);var u=(l=this._splitText(o)).length,f=u>0?r.duration/u:.03,d=[];for(s=0;s<l.length;s++){var y=l[s],c=this._getCharEntity();if(c&&c.element){var _=c.element;_.opacity=0,_.text=y,this._applyStyle(_,i),c.setLocalPosition(0,0,0);var T=this._measureWidth(c,y);d.push({entity:c,text:y,width:T})}}if(this._layoutLine(d),0!==r.offsetX||0!==r.offsetY)for(s=0;s<d.length;s++){var g=d[s].entity.getLocalPosition();d[s].entity.setLocalPosition(g.x+r.offsetX,g.y+r.offsetY,g.z)}var m=this;if(this._playing=!0,d.forEach((function(t,e){var i=t.entity.element,o=t.entity.getLocalPosition().y-r.yRise,n=t.entity.getLocalPosition().y,l=i.outlineColor?i.outlineColor.clone():null,a=i.shadowColor?i.shadowColor.clone():null;t.entity.setLocalPosition(t.entity.getLocalPosition().x,o,0),i.opacity=0,i.outlineColor&&(i.outlineColor=new pc.Color(i.outlineColor.r,i.outlineColor.g,i.outlineColor.b,0)),i.shadowColor&&(i.shadowColor=new pc.Color(i.shadowColor.r,i.shadowColor.g,i.shadowColor.b,0)),m._delayedRun(f*e,(function(){m._animate(i,t.entity,r.fadeIn,o,n,l,a,(function(){m._floatItems.push({entity:t.entity,baseY:n,phase:Math.random()*Math.PI*2,amplitude:r.floatAmplitude,speed:r.floatSpeed})}))}))})),r.fadeOutDelay>0&&r.fadeOut>0){var C=r.duration+r.fadeOutDelay;this._delayedRun(C,(function(){m._fadeOutAll(r.fadeOut,t)}))}else{var v=r.duration+.1;this._delayedRun(v,(function(){m.app.fire("title:complete",{i18nKey:t,hasSubtitle:!1})}))}}}},TitleTyper.prototype._delayedRun=function(t,e){var i=0,o=this,h=function(n){(i+=n)>=t&&(o.app.off("update",h),e&&e())};this.app.on("update",h),this._tweens.push({stop:function(){o.app.off("update",h)}})},TitleTyper.prototype._animate=function(t,e,i,o,n,l,a,s){var r=0,p=this,h=function(u){r+=u;var f=Math.min(1,r/i),d=1-Math.pow(1-f,3);t.opacity=d,l&&t.outlineColor&&(t.outlineColor=new pc.Color(l.r,l.g,l.b,l.a*d)),a&&t.shadowColor&&(t.shadowColor=new pc.Color(a.r,a.g,a.b,a.a*d));var y=o+(n-o)*d,c=e.getLocalPosition();e.setLocalPosition(c.x,y,0),f>=1&&(p.app.off("update",h),s&&s())};this.app.on("update",h),this._tweens.push({stop:function(){p.app.off("update",h)}})},TitleTyper.prototype.update=function(t){if(0!==this._floatItems.length)for(var e=.001*Date.now(),i=0;i<this._floatItems.length;i++){var o=this._floatItems[i];if(o.entity&&o.entity.enabled){var n=Math.sin(e*o.speed+o.phase)*o.amplitude,l=o.entity.getLocalPosition();o.entity.setLocalPosition(l.x,o.baseY+n,l.z)}}},TitleTyper.prototype._fadeOutAll=function(t,e){for(var i=0,o=this,n=[],l=[],a=0;a<o._inUse.length;a++){var s=o._inUse[a].element;s&&s.outlineColor?n[a]=s.outlineColor.clone():n[a]=null,s&&s.shadowColor?l[a]=s.shadowColor.clone():l[a]=null}var update=function(a){i+=a;for(var s=Math.min(1,i/t),r=1-s*s,p=0;p<o._inUse.length;p++){var u=o._inUse[p].element;if(u){u.opacity=r;var f=n[p];f&&u.outlineColor&&(u.outlineColor=new pc.Color(f.r,f.g,f.b,f.a*r));var d=l[p];d&&u.shadowColor&&(u.shadowColor=new pc.Color(d.r,d.g,d.b,d.a*r))}}s>=1&&(o.app.off("update",update),o._recycleAll(),o.app.fire("title:complete",{i18nKey:e,hasSubtitle:!1}))};this.app.on("update",update),this._tweens.push({stop:function(){o.app.off("update",update)}})},TitleTyper.prototype.destroy=function(){this._recycleAll(),this.app&&(this._onTitleShow&&this.app.off("title:show",this._onTitleShow,this),this._onSceneBeforeUnload&&this.app.off("scene:beforeunload",this._onSceneBeforeUnload,this));for(var t=0;t<this._pool.length;t++)this._pool[t]&&this._pool[t].destroy&&this._pool[t].destroy();this._pool.length=0};var WindAff=pc.createScript("windAff");WindAff.attributes.add("accelerationMode",{type:"boolean",default:!1,title:"按加速度施力(与质量无关)"}),WindAff.attributes.add("airDrag",{type:"number",default:.6,title:"空气阻力(越大越刹)"}),WindAff.attributes.add("liftFactor",{type:"number",default:0,title:"升力系数(基于水平速度)"}),WindAff.attributes.add("maxWindSpeed",{type:"number",default:12,title:"风下最大速度(米/秒, 0=不限)"}),WindAff.prototype.initialize=function(){this.force=null,this._tmp=new pc.Vec3},WindAff.prototype.enter=function(t){this.force=new pc.Vec3(t.x,t.y,t.z)},WindAff.prototype.leave=function(){this.force=null},WindAff.prototype.update=function(t){var e=this.entity.rigidbody;if(e){var i=e.linearVelocity.clone();if(i.lengthSq()>1e-6&&this.airDrag>0){var a=i.scale(-this.airDrag);e.applyForce(a)}if(this.liftFactor>0){var r=i.clone();r.y=0;var f=r.length()*this.liftFactor;f>0&&e.applyForce(0,f,0)}if(this.force){if(this.accelerationMode){var n=this.force,o=e.mass||1;e.applyForce(n.x*o,n.y*o,n.z*o)}else e.applyForce(this.force);if(this.maxWindSpeed>0){var c=this.force.clone().normalize(),d=i.dot(c);if(d>this.maxWindSpeed){var l=d-this.maxWindSpeed,p=c.scale(10*-l);e.applyForce(p)}}}}};var LevelManager=pc.createScript("levelManager");LevelManager.attributes.add("sceneName",{type:"string",default:"",title:"场景名称",description:"当前场景的名称，用于保存/恢复Part状态（如：level1, ethans_wind等）"}),LevelManager.attributes.add("parts",{type:"entity",array:!0,title:"Part 实体列表",description:"按顺序挂载 part-0, part-1, part-2 等实体"}),LevelManager.attributes.add("enableDebugLog",{type:"boolean",default:!1,title:"启用调试日志"}),LevelManager._instance=null,LevelManager.getInstance=function(){return LevelManager._instance},LevelManager.prototype.initialize=function(){if(LevelManager._instance&&LevelManager._instance!==this){this.enableDebugLog&&console.log("[LevelManager] 检测到场景切换，替换旧实例");var e=LevelManager._instance;e&&"function"==typeof e.destroy&&e.destroy()}LevelManager._instance=this,this.enableDebugLog&&(console.log("[LevelManager] 初始化"),console.log("[LevelManager] Part 数量:",this.parts.length)),this.sceneName&&""!==this.sceneName.trim()?"undefined"!=typeof GlobalGame?"function"==typeof GlobalGame.setCurrentScene?(GlobalGame.setCurrentScene(this.sceneName,!0),this.enableDebugLog&&console.log("[LevelManager] 已通过setCurrentScene通知GlobalGame当前场景:",this.sceneName,"(skipInitialization)")):(GlobalGame.currentScene=this.sceneName,this.enableDebugLog&&console.log("[LevelManager] 已直接设置GlobalGame.currentScene:",this.sceneName)):console.warn("[LevelManager] GlobalGame不可用，无法设置当前场景名称"):this.enableDebugLog&&console.warn("[LevelManager] sceneName未配置，无法通知GlobalGame"),this._tempScale=new pc.Vec3,this._currentPartIndex=0,this._originalScales={},this._partsInitialized=!1,this._onSceneLoaded=this._onSceneLoaded.bind(this),this.app.on("scene:loaded",this._onSceneLoaded,this),this.enableDebugLog&&console.log("[LevelManager] 立即初始化 Parts");var a=this;setTimeout((function(){a._initializeParts(),a._restorePartStateFromStorage()}),0)},LevelManager.prototype.destroy=function(){this.app&&this.app.off("scene:loaded",this._onSceneLoaded,this),LevelManager._instance===this&&(LevelManager._instance=null),this.enableDebugLog&&console.log("[LevelManager] 已销毁")},LevelManager.prototype._onSceneLoaded=function(e){var a=e&&e.sceneName;a&&(this.enableDebugLog&&console.log("[LevelManager] 场景已加载:",a),this._isLevelScene(a)&&(this.enableDebugLog&&console.log("[LevelManager] 检测到 level 场景，初始化 Parts"),this._initializeParts()))},LevelManager.prototype._initializeParts=function(){if(this._partsInitialized)this.enableDebugLog&&console.log("[LevelManager] Parts 已经初始化过，跳过重复初始化");else if(this.parts&&0!==this.parts.length){this.enableDebugLog&&console.log("[LevelManager] 开始初始化 Parts（记录原始缩放并隐藏 Part[1+]）"),this._originalScales={};for(var e=0;e<this.parts.length;e++){var a=this.parts[e];a?(this._recordPartOriginalScales(a,e),0===e?this.enableDebugLog&&console.log("[LevelManager] Part[0] ("+a.name+") 保持可见"):(this._setPartChildrenScale(a,0,0,0),this.enableDebugLog&&console.log("[LevelManager] Part["+e+"] ("+a.name+") 初始化时隐藏"))):this.enableDebugLog&&console.warn("[LevelManager] Part["+e+"] 为空，跳过")}this._currentPartIndex=0,this._partsInitialized=!0,this.enableDebugLog&&(console.log("[LevelManager] Parts 初始化完成，当前激活 Part:",this._currentPartIndex),console.log("[LevelManager] 原始缩放记录:",this._originalScales)),this._setInitialPlayerPosition()}else this.enableDebugLog&&console.warn("[LevelManager] Parts 列表为空，跳过初始化")},LevelManager.prototype._recordPartOriginalScales=function(e,a){if(e){this._originalScales[a]={};for(var t=e.children,n=0;n<t.length;n++){var o=t[n];if(o){var r=o.getLocalScale();r.x<.001&&r.y<.001&&r.z<.001?(this._originalScales[a][n]=new pc.Vec3(1,1,1),this.enableDebugLog&&console.log("[LevelManager] Part["+a+"] 子节点["+n+"] ("+o.name+") 缩放为 0，使用默认缩放 (1,1,1)")):(this._originalScales[a][n]=r.clone(),this.enableDebugLog&&console.log("[LevelManager] 记录 Part["+a+"] 子节点["+n+"] ("+o.name+") 原始缩放:",this._originalScales[a][n]))}}}},LevelManager.prototype._restorePartChildrenScale=function(e,a){if(e&&this._originalScales[a])for(var t=e.children,n=this._originalScales[a],o=0;o<t.length;o++){var r=t[o];r&&n[o]&&(r.setLocalScale(n[o]),r.enabled=!0,this.enableDebugLog&&console.log("[LevelManager] 恢复 Part["+a+"] 子节点["+o+"] ("+r.name+") 原始缩放:",n[o]))}},LevelManager.prototype._setPartChildrenScale=function(e,a,t,n){if(e){this._tempScale.set(a,t,n);for(var o=e.children,r=0;r<o.length;r++){var l=o[r];l&&l.setLocalScale(this._tempScale)}}},LevelManager.prototype.activatePart=function(e){if(e<0||e>=this.parts.length)console.warn("[LevelManager] 无效的 Part 索引:",e);else if(e!==this._currentPartIndex){this.enableDebugLog&&console.log("[LevelManager] 激活 Part["+e+"] 并恢复前面所有 Part");for(var a=this._currentPartIndex,t=0;t<=e;t++){var n=this.parts[t];if(n){var o=n.getLocalScale();(o.x<.001||o.y<.001||o.z<.001)&&(n.setLocalScale(1,1,1),this.enableDebugLog&&console.log("[LevelManager] Part["+t+"] 本身缩放为0，恢复为(1,1,1)")),this._restorePartChildrenScale(n,t),this.enableDebugLog&&console.log("[LevelManager] 已恢复 Part["+t+"] ("+n.name+") 的原始缩放")}}for(var r=e+1;r<this.parts.length;r++){var l=this.parts[r];l&&(this._setPartChildrenScale(l,0,0,0),this.enableDebugLog&&console.log("[LevelManager] 隐藏 Part["+r+"] ("+l.name+")"))}this._currentPartIndex=e,this._savePartStateToStorage(e),this.app.fire("level:part:changed",{previousIndex:a,currentIndex:e,currentPart:this.parts[e]})}else this.enableDebugLog&&console.log("[LevelManager] Part["+e+"] 已经激活，跳过")},LevelManager.prototype.getCurrentPartIndex=function(){return this._currentPartIndex},LevelManager.prototype.getCurrentPart=function(){return this.parts[this._currentPartIndex]||null},LevelManager.prototype.recordAllOriginalScales=function(){if(this.parts&&0!==this.parts.length){this.enableDebugLog&&console.log("[LevelManager] 重新记录所有 Parts 的原始缩放"),this._originalScales={};for(var e=0;e<this.parts.length;e++){var a=this.parts[e];a&&this._recordPartOriginalScales(a,e)}this.enableDebugLog&&console.log("[LevelManager] 原始缩放记录完成:",this._originalScales)}else this.enableDebugLog&&console.warn("[LevelManager] Parts 列表为空，无法记录原始缩放")},LevelManager.prototype.forceInitializeParts=function(){this.enableDebugLog&&console.log("[LevelManager] 手动强制初始化 Parts"),this._initializeParts()},LevelManager.prototype._restorePartStateFromStorage=function(){var e=this;try{var a=this._getCurrentSceneName();if(!a)return this.enableDebugLog&&console.warn("[LevelManager] 无法获取当前场景名，尝试延迟重试..."),void setTimeout((function(){e._restorePartStateFromStorageRetry()}),1e3);if("undefined"!=typeof GlobalGame&&GlobalGame.getScenePartState){var t=GlobalGame.getScenePartState(a);this.enableDebugLog&&console.log("[LevelManager] 从本地存储恢复Part状态，场景:",a,"激活Part索引:",t),t>0&&t<this.parts.length?(this.enableDebugLog&&console.log("[LevelManager] 恢复到Part["+t+"]"),this.activatePart(t)):this.enableDebugLog&&console.log("[LevelManager] 保持默认Part[0]激活状态"),this._restorePlayerRespawnPoint(a)}else this.enableDebugLog&&console.warn("[LevelManager] GlobalGame不可用，无法恢复Part状态")}catch(e){console.error("[LevelManager] 恢复Part状态失败:",e)}},LevelManager.prototype._restorePlayerRespawnPoint=function(e){try{if("undefined"==typeof GlobalGame)return void(this.enableDebugLog&&console.warn("[LevelManager] GlobalGame不可用，无法恢复重生点"));var a=null;e&&"function"==typeof GlobalGame.getSceneCheckpoint&&(a=GlobalGame.getSceneCheckpoint(e),this.enableDebugLog&&a&&console.log("[LevelManager] 从场景专属存档点获取位置，场景:",e)),a||"function"!=typeof GlobalGame.getCheckpoint||(a=GlobalGame.getCheckpoint(),this.enableDebugLog&&a&&console.log("[LevelManager] 从全局存档点获取位置"));var t=this.app.root.findByName("Player")||this.app.root.findByName("player")||this.app.root.findByTag("player")[0];if(!t)return void(this.enableDebugLog&&console.warn("[LevelManager] 未找到玩家实体，无法设置重生点"));a||(a=t.getPosition().clone(),this.enableDebugLog&&(console.log("[LevelManager] 当前场景没有保存的存档点，使用玩家当前位置作为初始存档点"),console.log("[LevelManager] 初始存档点位置:",a)),"undefined"!=typeof GlobalGame&&"function"==typeof GlobalGame.saveCurrentSceneCheckpoint&&(GlobalGame.saveCurrentSceneCheckpoint(a,"initial_spawn_"+e),this.enableDebugLog&&console.log("[LevelManager] 已保存初始存档点到localStorage")));var n=t.script&&t.script.deathController;if(!n)return void(this.enableDebugLog&&console.warn("[LevelManager] 玩家实体上未找到deathController脚本"));n.defaultRespawnPoint?(n.defaultRespawnPoint.copy(a),this.enableDebugLog&&console.log("[LevelManager] 已设置玩家重生点:",a)):(n.defaultRespawnPoint=a.clone(),this.enableDebugLog&&console.log("[LevelManager] 已创建并设置玩家重生点:",a)),"undefined"!=typeof GlobalGame&&"function"==typeof GlobalGame.setCheckpoint&&(GlobalGame.setCheckpoint(a,"level_restored_"+Date.now()),this.enableDebugLog&&console.log("[LevelManager] 已设置全局存档点:",a))}catch(e){console.error("[LevelManager] 恢复玩家重生点失败:",e)}},LevelManager.prototype._restorePartStateFromStorageRetry=function(){try{var e=this._getCurrentSceneName();if(!e)return void(this.enableDebugLog&&console.warn("[LevelManager] 重试后仍无法获取当前场景名，放弃Part状态恢复"));if(this.enableDebugLog&&console.log("[LevelManager] 重试成功，获取到场景名:",e),"undefined"!=typeof GlobalGame&&GlobalGame.getScenePartState){var a=GlobalGame.getScenePartState(e);this.enableDebugLog&&console.log("[LevelManager] 重试恢复Part状态，场景:",e,"激活Part索引:",a),a>0&&a<this.parts.length?(this.enableDebugLog&&console.log("[LevelManager] 重试恢复到Part["+a+"]"),this.activatePart(a)):this.enableDebugLog&&console.log("[LevelManager] 重试后保持默认Part[0]激活状态"),this._restorePlayerRespawnPoint(e)}else this.enableDebugLog&&console.warn("[LevelManager] 重试时GlobalGame仍不可用，无法恢复Part状态")}catch(e){console.error("[LevelManager] 重试恢复Part状态失败:",e)}},LevelManager.prototype._savePartStateToStorage=function(e){try{var a=this._getCurrentSceneName();if(!a)return void(this.enableDebugLog&&console.warn("[LevelManager] 无法获取当前场景名，跳过Part状态保存"));"undefined"!=typeof GlobalGame&&GlobalGame.setScenePartState?(GlobalGame.setScenePartState(a,e),this.enableDebugLog&&console.log("[LevelManager] 已保存Part状态到本地存储，场景:",a,"Part索引:",e)):this.enableDebugLog&&console.warn("[LevelManager] GlobalGame不可用，无法保存Part状态")}catch(e){console.error("[LevelManager] 保存Part状态失败:",e)}},LevelManager.prototype.activatePartWithAnimation=function(e,a){if(e<0||e>=this.parts.length)console.warn("[LevelManager] 无效的 Part 索引:",e);else if(e!==this._currentPartIndex){var t=a||{},n=t.duration||.8,o=t.delay||.3,r=t.itemDelay||.05,l=t.overshoot||1.2,i=!0===t.hidePrevious;this.enableDebugLog&&(console.log("[LevelManager] 激活 Part["+e+"] 并播放弹出动画"),console.log("[LevelManager] 动画参数:",{duration:n,delay:o,itemDelay:r,overshoot:l,hidePrevious:i}));var s=this._currentPartIndex;if(i){var g=this.parts[this._currentPartIndex];g&&(this._setPartChildrenScale(g,0,0,0),this.enableDebugLog&&console.log("[LevelManager] 隐藏 Part["+this._currentPartIndex+"] ("+g.name+")"))}else for(var c=0;c<e;c++){var h=this.parts[c];if(h){var L=h.getLocalScale();(L.x<.001||L.y<.001||L.z<.001)&&(h.setLocalScale(1,1,1),this.enableDebugLog&&console.log("[LevelManager] Part["+c+"] 本身缩放为0，恢复为(1,1,1)")),this._restorePartChildrenScale(h,c),this.enableDebugLog&&console.log("[LevelManager] 已恢复前置 Part["+c+"] ("+h.name+") 的原始缩放")}}for(var p=e+1;p<this.parts.length;p++){var v=this.parts[p];v&&(this._setPartChildrenScale(v,0,0,0),this.enableDebugLog&&console.log("[LevelManager] 隐藏后续 Part["+p+"] ("+v.name+")"))}var u=this.parts[e];if(u){this._currentPartIndex=e,this._savePartStateToStorage(e);var b=u.getLocalScale();(b.x<.001||b.y<.001||b.z<.001)&&(u.setLocalScale(1,1,1),this.enableDebugLog&&console.log("[LevelManager] Part["+e+"] 本身缩放为0，恢复为(1,1,1)")),this._setPartChildrenScale(u,0,0,0);var f=this;setTimeout((function(){f._animatePartChildrenPopIn(u,e,n,r,l)}),1e3*o),this.app.fire("level:part:changed",{previousIndex:s,currentIndex:e,currentPart:u,animated:!0}),this.enableDebugLog&&console.log("[LevelManager] Part["+e+"] 弹出动画已启动")}else console.warn("[LevelManager] Part["+e+"] 不存在")}else this.enableDebugLog&&console.log("[LevelManager] Part["+e+"] 已经激活，跳过动画")},LevelManager.prototype._animatePartChildrenPopIn=function(e,a,t,n,o){if(e&&this._originalScales[a]){var r=e.children,l=this._originalScales[a],i=this;this.enableDebugLog&&console.log("[LevelManager] 开始播放 Part["+a+"] 弹出动画，子节点数量:",r.length);for(var s=0;s<r.length;s++){var g=r[s],c=l[s];if(g&&c)!function(e,a,n,r){setTimeout((function(){i._animateScalePopIn(e,a,t,o,r)}),n)}(g,c,s*n*1e3,s)}}else this.enableDebugLog&&console.warn("[LevelManager] 无法播放弹出动画，Part 或原始缩放数据缺失")},LevelManager.prototype._animateScalePopIn=function(e,a,t,n,o){if(e&&a){e.enabled=!0;var r=Date.now(),l=1e3*t,i=this,s=new pc.Vec3;this.enableDebugLog&&console.log("[LevelManager] 子节点["+o+"] ("+e.name+") 开始弹出动画，目标缩放:",a),requestAnimationFrame((function animate(){var t=Date.now()-r,g=Math.min(t/l,1),c=i._easeOutBackScale(g,n);s.set(a.x*c,a.y*c,a.z*c),e.setLocalScale(s),g<1?requestAnimationFrame(animate):(e.setLocalScale(a),i.enableDebugLog&&console.log("[LevelManager] 子节点["+o+"] ("+e.name+") 弹出动画完成"))}))}},LevelManager.prototype._easeOutBackScale=function(e,a){var t=1.70158*(a-1);return 1+(t+1)*Math.pow(e-1,3)+t*Math.pow(e-1,2)},LevelManager.prototype._isLevelScene=function(e){return!!e&&0===e.toLowerCase().indexOf("level")},LevelManager.prototype._getCurrentSceneName=function(){if(this.sceneName&&""!==this.sceneName.trim())return this.enableDebugLog&&console.log("[LevelManager] 使用配置的场景名称:",this.sceneName),this.sceneName.trim();if("undefined"!=typeof GlobalGame&&GlobalGame.getCurrentScene){var e=GlobalGame.getCurrentScene();if(e)return this.enableDebugLog&&console.log("[LevelManager] 从GlobalGame获取场景名称:",e),e}if(this.app&&this.app.scene){if(this.app.scene.name)return this.app.scene.name;if(this.app.scene._name)return this.app.scene._name}if(this.app&&this.app.root&&this.app.root.name){var a=this.app.root.name;if(a&&"Root"!==a&&"root"!==a&&"Untitled"!==a)return a}return this.enableDebugLog&&(console.warn("[LevelManager] 无法获取场景名，建议在LevelManager属性中配置sceneName"),console.log("[LevelManager] Debug info:"),console.log("  - sceneName配置:",this.sceneName),console.log("  - GlobalGame available:","undefined"!=typeof GlobalGame),console.log("  - app.scene.name:",this.app&&this.app.scene&&this.app.scene.name),console.log("  - app.root.name:",this.app&&this.app.root&&this.app.root.name)),null},LevelManager.prototype._setInitialPlayerPosition=function(){try{var e=!1;if("undefined"!=typeof GlobalGame)GlobalGame.getCheckpoint()&&(e=!0,this.enableDebugLog&&console.log("[LevelManager] 已有存档点数据，跳过初始位置设置"));if(!e){var a=null,t=this.app.root.findByName("DeathController");if(t&&t.length>0&&(a=t[0].script&&t[0].script.deathController),!a)for(var n=this.app.root.findComponents("script"),o=0;o<n.length;o++){var r=n[o];if(r.script&&r.script.deathController){a=r.script.deathController;break}}if(a&&a.respawnPoint){var l=a.respawnPoint.getPosition().clone();if(a.defaultSpawnOffset){var i=a.defaultSpawnOffset;i instanceof pc.Vec3||(i=new pc.Vec3(i.x||i[0]||0,i.y||i[1]||0,i.z||i[2]||0)),l.add(i)}var s=null;if(a.player)s=a.player;else{var g=this.app.root.findByName("Player");g&&g.length>0&&(s=g[0])}if(s){var c=s.rigidbody;c?c.teleport(l,a.respawnPoint.getRotation()):(s.setPosition(l),s.setRotation(a.respawnPoint.getRotation())),this.enableDebugLog&&console.log("[LevelManager] 第一次进入场景，设置玩家初始位置为 DeathController 重生点:",l)}else this.enableDebugLog&&console.warn("[LevelManager] 未找到玩家实体，无法设置初始位置")}else this.enableDebugLog&&console.warn("[LevelManager] 未找到 DeathController 或其重生点，无法设置玩家初始位置")}}catch(e){this.enableDebugLog&&console.error("[LevelManager] 设置玩家初始位置时出错:",e)}};var SpawnPoint=pc.createScript("spawnPoint");SpawnPoint.attributes.add("sceneName",{type:"string",default:"",title:"场景名称",description:"指定此出生点对应的场景名，留空则使用当前场景名"}),SpawnPoint.attributes.add("isDefaultSpawn",{type:"boolean",default:!0,title:"默认出生点",description:"勾选后会自动注册为该场景的出生点"}),SpawnPoint.attributes.add("enableDebugLog",{type:"boolean",default:!1,title:"调试日志"}),SpawnPoint.attributes.add("showDebugVisual",{type:"boolean",default:!0,title:"显示调试可视化",description:"在编辑器中显示出生点标记"}),SpawnPoint.prototype.initialize=function(){var e=this.sceneName;if(!e){try{"undefined"!=typeof GlobalGame&&GlobalGame.getCurrentScene&&(e=GlobalGame.getCurrentScene())}catch(e){this.enableDebugLog&&console.warn("[SpawnPoint] Failed to get current scene name:",e)}e||(e="default")}this._sceneName=e,this.isDefaultSpawn&&this._registerSpawnPoint(),this.showDebugVisual&&this._createDebugVisual(),this.enableDebugLog&&console.log("[SpawnPoint] Initialized for scene:",this._sceneName,"at position:",this.entity.getPosition())},SpawnPoint.prototype._registerSpawnPoint=function(){try{if("undefined"!=typeof GlobalGame&&GlobalGame.setSceneSpawnPoint){var e=this.entity.getPosition();GlobalGame.setSceneSpawnPoint(this._sceneName,e),this.enableDebugLog&&console.log("[SpawnPoint] Registered spawn point for scene:",this._sceneName,"at:",e)}else this.enableDebugLog&&console.warn("[SpawnPoint] GlobalGame not available, cannot register spawn point")}catch(e){this.enableDebugLog&&console.error("[SpawnPoint] Failed to register spawn point:",e)}},SpawnPoint.prototype._createDebugVisual=function(){try{var e=new pc.Entity("SpawnPointVisual");if(e.addComponent("model",{type:"cylinder",castShadows:!1,receiveShadows:!1}),e.model&&e.model.meshInstances&&e.model.meshInstances[0]){var t=e.model.meshInstances[0].material;t&&(t.diffuse=new pc.Color(0,1,0),t.emissive=new pc.Color(0,.3,0),t.update())}e.setLocalScale(.5,.1,.5),e.setLocalPosition(0,.05,0),this.entity.addChild(e),this._debugVisual=e,this._createDebugLabel()}catch(e){this.enableDebugLog&&console.error("[SpawnPoint] Failed to create debug visual:",e)}},SpawnPoint.prototype._createDebugLabel=function(){try{var e=new pc.Entity("SpawnPointLabel");e.addComponent("element",{type:pc.ELEMENTTYPE_TEXT,text:"SPAWN: "+this._sceneName,fontSize:.5,color:new pc.Color(1,1,1),pivot:new pc.Vec2(.5,.5)}),e.setLocalPosition(0,2,0),e.lookAt=function(){if(this.app&&this.app.root){var e=this.app.root.findByName("Camera");e&&this.lookAt(e.getPosition())}},this.entity.addChild(e),this._debugLabel=e}catch(e){this.enableDebugLog&&console.error("[SpawnPoint] Failed to create debug label:",e)}},SpawnPoint.prototype.teleportPlayerHere=function(){try{if("undefined"!=typeof GlobalGame&&GlobalGame.teleportPlayer){var e=this.entity.getPosition();GlobalGame.teleportPlayer(e),this.enableDebugLog&&console.log("[SpawnPoint] Teleported player to spawn point:",e)}}catch(e){this.enableDebugLog&&console.error("[SpawnPoint] Failed to teleport player:",e)}},SpawnPoint.prototype.updateSpawnPoint=function(){this.isDefaultSpawn&&this._registerSpawnPoint()},SpawnPoint.prototype.destroy=function(){this._debugVisual&&(this._debugVisual.destroy(),this._debugVisual=null),this._debugLabel&&(this._debugLabel.destroy(),this._debugLabel=null)};var WorldTips=pc.createScript("worldTips");WorldTips.attributes.add("tipKey",{type:"string",default:"",title:"提示键名"}),WorldTips.attributes.add("triggerTag",{type:"string",default:"world-tip",title:"Smart Trigger标签"}),WorldTips.attributes.add("characterSpacing",{type:"number",default:30,title:"字符间距(px)"}),WorldTips.attributes.add("popDelay",{type:"number",default:.1,title:"弹出延迟(秒)"}),WorldTips.attributes.add("popDuration",{type:"number",default:.5,title:"弹出动画时长(秒)"}),WorldTips.attributes.add("hideDelay",{type:"number",default:.05,title:"隐藏延迟(秒)"}),WorldTips.attributes.add("hideDuration",{type:"number",default:.3,title:"隐藏动画时长(秒)"}),WorldTips.attributes.add("offsetY",{type:"number",default:50,title:"Y轴偏移"}),WorldTips.attributes.add("fontSize",{type:"number",default:24,title:"字体大小"}),WorldTips.attributes.add("fontColor",{type:"string",default:"#FFFFFF",title:"字体颜色"}),WorldTips.attributes.add("outlineColor",{type:"string",default:"#000000",title:"描边颜色"}),WorldTips.attributes.add("outlineThickness",{type:"number",default:.5,title:"描边厚度"}),WorldTips.attributes.add("font",{type:"asset",assetType:"font",title:"Font（必须）"}),WorldTips.attributes.add("layerName",{type:"string",default:"UI",title:"渲染层名称（默认UI）"}),WorldTips.attributes.add("enableDebugLog",{type:"boolean",default:!1,title:"启用调试日志"}),WorldTips.prototype.initialize=function(){this.isShowing=!1,this.isHiding=!1,this.characterEntities=[],this.animationTimeouts=[],this._tempVec3=new pc.Vec3,this.entity.screen||this.entity.addComponent("screen",{screenSpace:!1,resolution:new pc.Vec2(1920,1080),referenceResolution:new pc.Vec2(1920,1080),scaleMode:pc.SCALEMODE_BLEND}),this._targetLayerId=this._getLayerIdByName(this.layerName)??pc.LAYERID_UI,this._bindEvents(),this.enableDebugLog&&console.log("[WorldTips] init",{tipKey:this.tipKey,layerName:this.layerName,layerId:this._targetLayerId,hasFont:!!this.font,entity:this.entity.name}),this.font||console.warn("[WorldTips] 未设置 font 资产，文本将不可见！请在属性中拖入一个位图字体（Font Asset）。")},WorldTips.prototype.destroy=function(){this._unbindEvents(),this._clearAllTimeouts(),this._clearCharacterEntities()},WorldTips.prototype._bindEvents=function(){this._onTriggerEnter=(t,e)=>{this._isValidTrigger(t)&&this._showTips()},this._onTriggerLeave=(t,e)=>{this._isValidTrigger(t)&&this._hideTips()},this.app.on("trigger:enter",this._onTriggerEnter,this),this.app.on("trigger:leave",this._onTriggerLeave,this)},WorldTips.prototype._unbindEvents=function(){this._onTriggerEnter&&this.app.off("trigger:enter",this._onTriggerEnter,this),this._onTriggerLeave&&this.app.off("trigger:leave",this._onTriggerLeave,this)},WorldTips.prototype._isValidTrigger=function(t){return!!t&&(t===this.entity||(!!this._isChildOf(t,this.entity)||(!!(this.triggerTag&&t.tags&&t.tags.has(this.triggerTag))||!(!this.triggerTag||t.name!==this.triggerTag))))},WorldTips.prototype._isChildOf=function(t,e){for(var i=t&&t.parent;i;){if(i===e)return!0;i=i.parent}return!1},WorldTips.prototype._showTips=function(){if(this.isShowing)return;const t=this._getTipText(this.tipKey);t?this.font?(this.isShowing=!0,this.isHiding=!1,this._clearCharacterEntities(),this._clearAllTimeouts(),this._createCharacterEntities(t),this._animateCharactersIn()):console.warn("[WorldTips] 未设置 font 资产，无法显示文本：",t):this.enableDebugLog&&console.warn("[WorldTips] 没有文本可显示：",this.tipKey)},WorldTips.prototype._hideTips=function(){this.isHiding||0===this.characterEntities.length||(this.isHiding=!0,this.isShowing=!1,this._clearAllTimeouts(),this._animateCharactersOut())},WorldTips.prototype._getTipText=function(t){try{if("undefined"!=typeof I18n&&I18n.get){const e=I18n.get(t);if(e&&e!==t)return e}if("undefined"!=typeof GlobalGame){const e=GlobalGame.getCurrentLocale?GlobalGame.getCurrentLocale():"zh-CN";if(GlobalGame._worldTipsData&&GlobalGame._worldTipsData[e]){const i=this._getNestedValue(GlobalGame._worldTipsData[e],t);if(i)return i}}const e=(t||"").split(".");return(e[e.length-1]||t||"").replace(/_/g," ")}catch(e){return t||""}},WorldTips.prototype._getNestedValue=function(t,e){const i=(e||"").split(".");let r=t;for(let t=0;t<i.length;t++){if(!r||"object"!=typeof r)return null;r=r[i[t]]}return"string"==typeof r?r:null},WorldTips.prototype._createCharacterEntities=function(t){const e=t.split("").map((t=>"\n"===t?" ":t));let i=-((e.filter((t=>" "!==t)).length-1)*this.characterSpacing)/2,r=0;for(let t=0;t<e.length;t++){const s=e[t];if(" "===s){i+=this.characterSpacing;continue}const o=this._createCharacterEntity(s,t);if(!o)continue;const n=i+r*this.characterSpacing;o.setLocalPosition(n,this.offsetY,0),o.setLocalScale(0,0,0),this.characterEntities.push(o),r++}},WorldTips.prototype._createCharacterEntity=function(t,e){try{const i=new pc.Entity("WorldTip_Char_"+e);return i.addComponent("element",{type:pc.ELEMENTTYPE_TEXT,text:t,fontAsset:this.font?this.font.id:null,fontSize:this.fontSize,color:this._parseColor(this.fontColor),outlineColor:this._parseColor(this.outlineColor),outlineThickness:this.outlineThickness,alignment:[.5,.5],pivot:[.5,.5],autoWidth:!1,autoHeight:!1,width:2*this.fontSize,height:2*this.fontSize,useInput:!1}),i.element.layers=[this._targetLayerId],this.entity.addChild(i),this._billboardToCamera(i),i}catch(t){return this.enableDebugLog&&console.error("[WorldTips] 创建字符失败",t),null}},WorldTips.prototype._billboardToCamera=function(t){const e=this._getMainCamera();e&&(t.lookAt(e.getPosition()),t.rotateLocal(0,180,0))},WorldTips.prototype._getMainCamera=function(){return this.app.root.findByName("Camera")||this.app.root.findByTag("camera")[0]||null},WorldTips.prototype._parseColor=function(t){if(!t||"#"!==t[0]||7!==t.length&&4!==t.length)return new pc.Color(1,1,1);if(7===t.length){const e=parseInt(t.slice(1,3),16)/255,i=parseInt(t.slice(3,5),16)/255,r=parseInt(t.slice(5,7),16)/255;return new pc.Color(e,i,r)}{const e=parseInt(t[1]+t[1],16)/255,i=parseInt(t[2]+t[2],16)/255,r=parseInt(t[3]+t[3],16)/255;return new pc.Color(e,i,r)}},WorldTips.prototype._animateCharactersIn=function(){for(let t=0;t<this.characterEntities.length;t++){const e=this.characterEntities[t],i=t*this.popDelay*1e3,r=setTimeout((()=>{this.isShowing&&e&&e.element&&this._animateCharacterScale(e,0,1,this.popDuration)}),i);this.animationTimeouts.push(r)}},WorldTips.prototype._animateCharactersOut=function(){for(let t=0;t<this.characterEntities.length;t++){const e=this.characterEntities[t],i=t*this.hideDelay*1e3,r=t===this.characterEntities.length-1,s=setTimeout((()=>{e&&e.element&&this._animateCharacterScale(e,1,0,this.hideDuration,(()=>{r&&setTimeout((()=>{this._clearCharacterEntities(),this.isHiding=!1}),60)}))}),i);this.animationTimeouts.push(s)}},WorldTips.prototype._animateCharacterScale=function(t,e,i,r,s){const o=Date.now(),n=1e3*Math.max(.001,r),tick=()=>{if(!t||!t.element)return void(s&&s());const r=Math.min(1,(Date.now()-o)/n),a=this._easeOutBack(r),l=e+(i-e)*a;t.setLocalScale(l,l,l),r<1?requestAnimationFrame(tick):s&&s()};requestAnimationFrame(tick)},WorldTips.prototype._easeOutBack=function(t){const e=1.70158;return 1+2.70158*Math.pow(t-1,3)+e*Math.pow(t-1,2)},WorldTips.prototype._clearAllTimeouts=function(){for(let t=0;t<this.animationTimeouts.length;t++)clearTimeout(this.animationTimeouts[t]);this.animationTimeouts=[]},WorldTips.prototype._clearCharacterEntities=function(){for(let t=0;t<this.characterEntities.length;t++){const e=this.characterEntities[t];e&&e.destroy&&e.destroy()}this.characterEntities=[]},WorldTips.prototype._getLayerIdByName=function(t){if(!t)return null;const e=this.app.scene.layers;return e.getLayerByName(t)?e.getLayerByName(t).id:null},WorldTips.prototype.update=function(t){if(0===this.characterEntities.length)return;const e=this._getMainCamera();if(!e)return;const i=e.getPosition();for(let t=0;t<this.characterEntities.length;t++){const e=this.characterEntities[t];e&&e.enabled&&(e.lookAt(i),e.rotateLocal(0,180,0))}},WorldTips.prototype.debugShow=function(){this._showTips()},WorldTips.prototype.debugHide=function(){this._hideTips()};var SmartTrigger=pc.createScript("smartTrigger");SmartTrigger.attributes.add("targetEntity",{type:"entity",title:"目标实体",description:"指定触发对象（通常是玩家），留空则使用 targetTag"}),SmartTrigger.attributes.add("targetTag",{type:"string",default:"player",title:"目标Tag",description:"按标签筛选触发对象（targetEntity 为空时生效）"}),SmartTrigger.attributes.add("useCollision",{type:"boolean",default:!0,title:"使用碰撞触发",description:"需要实体有 collision 组件但无 rigidbody（trigger volume）"}),SmartTrigger.attributes.add("useDistance",{type:"boolean",default:!1,title:"使用距离触发",description:"基于球形范围的距离检测"}),SmartTrigger.attributes.add("distance",{type:"number",default:4,min:0,title:"距离阈值",description:"距离触发的半径（米），useDistance=true 时生效"}),SmartTrigger.attributes.add("ignoreY",{type:"boolean",default:!1,title:"忽略Y轴",description:"距离计算仅在水平面（XZ平面）"}),SmartTrigger.attributes.add("once",{type:"boolean",default:!1,title:"一次性触发",description:"触发一次后失效（如检查点、拾取物）"}),SmartTrigger.attributes.add("cooldown",{type:"number",default:0,min:0,title:"冷却时间",description:"触发后的冷却秒数，0 表示无冷却"}),SmartTrigger.attributes.add("enterEvent",{type:"string",default:"trigger:enter",title:"进入事件名",description:"触发进入时的事件名"}),SmartTrigger.attributes.add("leaveEvent",{type:"string",default:"trigger:leave",title:"离开事件名",description:"触发离开时的事件名"}),SmartTrigger.attributes.add("debugLog",{type:"boolean",default:!1,title:"调试日志",description:"在控制台输出触发信息"}),SmartTrigger.prototype.initialize=function(){this._active=!1,this._firedOnce=!1,this._cd=0,this._other=null,this.useCollision&&(this.entity.collision?(this.entity.collision.on("triggerenter",this._onTriggerEnter,this),this.entity.collision.on("triggerleave",this._onTriggerLeave,this),this.debugLog&&console.log("[SmartTrigger] 碰撞触发已启用:",this.entity.name)):console.warn("[SmartTrigger] useCollision=true 但实体缺少 collision 组件:",this.entity.name)),this.useDistance&&this.debugLog&&console.log("[SmartTrigger] 距离触发已启用:",this.entity.name,"阈值:",this.distance)},SmartTrigger.prototype.update=function(t){if(this._cd>0&&(this._cd=Math.max(0,this._cd-t)),(!this.once||!this._firedOnce)&&this.useDistance){var e=this._resolveTargetEntity();if(e){var i=this._checkDistance(e);i&&!this._active&&this._cd<=0?(this._active=!0,this._firedOnce=this.once,this._other=e,this._fireEnter(e)):!i&&this._active&&(this._active=!1,this._fireLeave(e),this.cooldown>0&&(this._cd=this.cooldown))}}},SmartTrigger.prototype.destroy=function(){this.entity.collision&&(this.entity.collision.off("triggerenter",this._onTriggerEnter,this),this.entity.collision.off("triggerleave",this._onTriggerLeave,this))},SmartTrigger.prototype._onTriggerEnter=function(t){this.useCollision&&this._isValidTarget(t)&&(this._cd>0||this.once&&this._firedOnce||(this._active=!0,this._firedOnce=this.once,this._other=t,this._fireEnter(t)))},SmartTrigger.prototype._onTriggerLeave=function(t){this.useCollision&&this._isValidTarget(t)&&(!this._active||null!==this._other&&this._other!==t||(this._active=!1,this._fireLeave(t),this.cooldown>0&&(this._cd=this.cooldown)))},SmartTrigger.prototype._isValidTarget=function(t){return this.targetEntity?t===this.targetEntity:this.targetTag&&this.targetTag.length>0?t.tags&&t.tags.has(this.targetTag):!!t.rigidbody},SmartTrigger.prototype._resolveTargetEntity=function(){if(this.targetEntity)return this.targetEntity;if(this.targetTag&&this.targetTag.length>0){var t=this.app.root.findByTag(this.targetTag);return t&&t.length>0?t[0]:null}return null},SmartTrigger.prototype._checkDistance=function(t){var e=this.entity.getPosition().clone(),i=t.getPosition().clone();return this.ignoreY&&(e.y=0,i.y=0),e.sub(i).length()<=Math.max(0,this.distance||0)},SmartTrigger.prototype._fireEnter=function(t){if(this.debugLog&&console.log("[SmartTrigger] ENTER ->",this.entity.name,"by",t.name),this.entity.fire(this.enterEvent,t),this.app.fire(this.enterEvent,this.entity,t),this.onEnter)try{this.onEnter(t)}catch(t){console.error("[SmartTrigger] onEnter 回调错误:",t)}},SmartTrigger.prototype._fireLeave=function(t){if(this.debugLog&&console.log("[SmartTrigger] LEAVE ->",this.entity.name,"by",t.name),this.entity.fire(this.leaveEvent,t),this.app.fire(this.leaveEvent,this.entity,t),this.onLeave)try{this.onLeave(t)}catch(t){console.error("[SmartTrigger] onLeave 回调错误:",t)}};!function(o){"use strict";var e={_initialized:!1,_app:null,_configMap:{},_currentScene:null,_currentAmbientKey:null,enableDebugLog:!1,initialize:function(o,e){this._initialized?console.warn("[GlobalAudioSceneConfig] 已经初始化过了"):(e=e||{},this._app=o,this.enableDebugLog=e.enableDebugLog||!1,console.log("[GlobalAudioSceneConfig] ========================================"),console.log("[GlobalAudioSceneConfig] 开始初始化全局音频系统..."),console.log("[GlobalAudioSceneConfig] ========================================"),this._initializeAudioSettings(e.storageKey||"game.audio.v1"),this._initializeBGM(),this._initializeSFX(e.poolSize2D||8,e.poolSize3D||16),this._loadSceneConfig(e.configAsset||e.configData),this._initialized=!0,console.log("[GlobalAudioSceneConfig] ========================================"),console.log("[GlobalAudioSceneConfig] 全局音频系统初始化完成！"),console.log("[GlobalAudioSceneConfig] 可用模块:"),console.log("[GlobalAudioSceneConfig]   - GlobalBgm (BGM管理)"),console.log("[GlobalAudioSceneConfig]   - GlobalSfx (音效管理)"),console.log("[GlobalAudioSceneConfig]   - GlobalAudioSettings (音频设置)"),console.log("[GlobalAudioSceneConfig]   - GlobalAudioSceneConfig (场景音频)"),console.log("[GlobalAudioSceneConfig] ========================================"))},_initializeAudioSettings:function(o){if("undefined"!=typeof GlobalAudioSettings)try{GlobalAudioSettings.initialize(this._app,o),console.log("[GlobalAudioSceneConfig] ✓ GlobalAudioSettings初始化完成")}catch(o){console.error("[GlobalAudioSceneConfig] GlobalAudioSettings初始化失败:",o)}else console.error("[GlobalAudioSceneConfig] GlobalAudioSettings未定义，请确保audio-settings-global.js已加载")},_initializeBGM:function(){if("undefined"!=typeof GlobalBgm)try{GlobalBgm.initialize(this._app),GlobalBgm.enableDebugLog=this.enableDebugLog,console.log("[GlobalAudioSceneConfig] ✓ GlobalBgm初始化完成，调试日志:",this.enableDebugLog)}catch(o){console.error("[GlobalAudioSceneConfig] GlobalBgm初始化失败:",o)}else console.error("[GlobalAudioSceneConfig] GlobalBgm未定义，请确保audio-bgm-global.js已加载")},_initializeSFX:function(o,e){if("undefined"!=typeof GlobalSfx)try{GlobalSfx.initialize(this._app,{poolSize2D:o,poolSize3D:e}),console.log("[GlobalAudioSceneConfig] ✓ GlobalSfx初始化完成")}catch(o){console.error("[GlobalAudioSceneConfig] GlobalSfx初始化失败:",o)}else console.error("[GlobalAudioSceneConfig] GlobalSfx未定义，请确保audio-sfx-global.js已加载")},_loadSceneConfig:function(o){if(!o)return console.warn("[GlobalAudioSceneConfig] 未提供配置，将使用空配置"),void(this._configMap={});o.resource?this._loadFromAsset(o):"object"==typeof o&&this._loadFromData(o),console.log("[GlobalAudioSceneConfig] ✓ 场景配置加载完成"),console.log("[GlobalAudioSceneConfig]   配置场景数:",Object.keys(this._configMap).length),console.log("[GlobalAudioSceneConfig]   配置的场景:",Object.keys(this._configMap))},_loadFromAsset:function(o){var e=o.resource;e&&e.scenes?(this._configMap=e.scenes,console.log("[GlobalAudioSceneConfig] ✓ 从Asset加载配置成功")):console.error("[GlobalAudioSceneConfig] Asset配置格式错误，缺少scenes字段")},_loadFromData:function(o){o.scenes?(this._configMap=o.scenes,console.log("[GlobalAudioSceneConfig] ✓ 从数据对象加载配置成功")):console.error("[GlobalAudioSceneConfig] 配置数据格式错误，缺少scenes字段")},playScene:function(o,e){if(this._initialized){e=e||{};var l=o.toLowerCase();if(this.enableDebugLog&&console.log("[GlobalAudioSceneConfig] 播放场景音频:",o),this._currentScene!==l||e.forceReplay){var i=this._configMap[l];if(!i)return console.warn("[GlobalAudioSceneConfig] 场景无配置:",o),void console.warn("[GlobalAudioSceneConfig] 可用场景:",Object.keys(this._configMap));i.bgm&&i.bgm.assetId&&this._playBGM(i.bgm),i.ambient&&i.ambient.assetId&&this._playAmbient(i.ambient),this._currentScene=l,this.enableDebugLog&&console.log("[GlobalAudioSceneConfig] ✓ 场景音频播放完成")}else this.enableDebugLog&&console.log("[GlobalAudioSceneConfig] 相同场景，跳过")}else console.warn("[GlobalAudioSceneConfig] 未初始化")},_playBGM:function(o){var e=o.assetId,l=null!=o.volume?o.volume:.7,i=null!=o.crossfade?o.crossfade:.8,n=this._app.assets.get(e);n?(this.enableDebugLog&&console.log("[GlobalAudioSceneConfig] 播放BGM:",n.name,"ID:",e,"音量:",l),"undefined"!=typeof GlobalBgm&&GlobalBgm._initialized?GlobalBgm.play({asset:n,id:e,crossfade:i,volume:l,loop:!0}):console.warn("[GlobalAudioSceneConfig] GlobalBgm未初始化")):console.error("[GlobalAudioSceneConfig] BGM资产未找到, ID:",e)},_playAmbient:function(o){var e=o.assetId,l=null!=o.volume?o.volume:.5;this._currentAmbientKey&&"undefined"!=typeof GlobalSfx&&GlobalSfx._initialized&&GlobalSfx.stop({key:this._currentAmbientKey});var i=this._app.assets.get(e);if(i){this.enableDebugLog&&console.log("[GlobalAudioSceneConfig] 播放环境音:",i.name,"ID:",e,"音量:",l);var n="ambient_"+e;"undefined"!=typeof GlobalSfx&&GlobalSfx._initialized?GlobalSfx.play({key:n,asset:i,vol:l,loop:!0}):console.warn("[GlobalAudioSceneConfig] GlobalSfx未初始化"),this._currentAmbientKey=n}else console.error("[GlobalAudioSceneConfig] 环境音资产未找到, ID:",e)},stopScene:function(){this._initialized&&(this.enableDebugLog&&console.log("[GlobalAudioSceneConfig] 停止场景音频"),"undefined"!=typeof GlobalSfx&&GlobalSfx._initialized&&GlobalSfx.stopAll(),this._currentAmbientKey=null,this._currentScene=null)},getSceneConfig:function(o){return o&&this._configMap[o.toLowerCase()]||null},destroy:function(){this._initialized&&(this._configMap={},this._currentScene=null,this._currentAmbientKey=null,this._initialized=!1,console.log("[GlobalAudioSceneConfig] 已销毁"))}};o.GlobalAudioSceneConfig=e}(window);var AudioGlobalInitializer=pc.createScript("audioGlobalInitializer");AudioGlobalInitializer.attributes.add("poolSize2D",{type:"number",default:8,title:"SFX 2D池大小"}),AudioGlobalInitializer.attributes.add("poolSize3D",{type:"number",default:16,title:"SFX 3D池大小"}),AudioGlobalInitializer.attributes.add("storageKey",{type:"string",default:"game.audio.v1",title:"音频设置存储键"}),AudioGlobalInitializer.attributes.add("audioConfigAsset",{type:"asset",assetType:"json",title:"音频配置JSON",description:"场景音频配置文件（audio-config.json）"}),AudioGlobalInitializer.attributes.add("enableDebugLog",{type:"boolean",default:!1,title:"启用调试日志"}),AudioGlobalInitializer.prototype.initialize=function(){if(this.enableDebugLog&&console.log("[AudioGlobalInitializer] 开始初始化全局音频模块..."),this._setupAudioUnlock(),"undefined"!=typeof GlobalBgm)if("undefined"!=typeof GlobalSfx)if("undefined"!=typeof GlobalAudioSettings)if("undefined"!=typeof GlobalAudioSceneConfig){try{GlobalAudioSettings.initialize(this.app,this.storageKey),this.enableDebugLog&&console.log("[AudioGlobalInitializer] ✓ GlobalAudioSettings 初始化完成")}catch(o){console.error("[AudioGlobalInitializer] GlobalAudioSettings 初始化失败:",o)}try{GlobalBgm.initialize(this.app),this.enableDebugLog&&console.log("[AudioGlobalInitializer] ✓ GlobalBgm 初始化完成")}catch(o){console.error("[AudioGlobalInitializer] GlobalBgm 初始化失败:",o)}try{GlobalSfx.initialize(this.app,{poolSize2D:this.poolSize2D,poolSize3D:this.poolSize3D}),this.enableDebugLog&&console.log("[AudioGlobalInitializer] ✓ GlobalSfx 初始化完成")}catch(o){console.error("[AudioGlobalInitializer] GlobalSfx 初始化失败:",o)}try{this.audioConfigAsset?(GlobalAudioSceneConfig.initialize(this.app,this.audioConfigAsset),GlobalAudioSceneConfig.enableDebugLog=this.enableDebugLog,this.enableDebugLog&&console.log("[AudioGlobalInitializer] ✓ GlobalAudioSceneConfig 初始化完成")):console.warn("[AudioGlobalInitializer] 未配置audioConfigAsset，GlobalAudioSceneConfig将使用空配置")}catch(o){console.error("[AudioGlobalInitializer] GlobalAudioSceneConfig 初始化失败:",o)}console.log("[AudioGlobalInitializer] ========================================"),console.log("[AudioGlobalInitializer] 全局音频模块初始化完成！"),console.log("[AudioGlobalInitializer] 可用模块:"),console.log("[AudioGlobalInitializer]   - GlobalBgm (BGM管理)"),console.log("[AudioGlobalInitializer]   - GlobalSfx (音效管理)"),console.log("[AudioGlobalInitializer]   - GlobalAudioSettings (音频设置)"),console.log("[AudioGlobalInitializer]   - GlobalAudioSceneConfig (场景音频配置)"),console.log("[AudioGlobalInitializer] ========================================")}else console.error("[AudioGlobalInitializer] GlobalAudioSceneConfig 未定义，请确保 audio-scene-config-global.js 已加载");else console.error("[AudioGlobalInitializer] GlobalAudioSettings 未定义，请确保 audio-settings-global.js 已加载");else console.error("[AudioGlobalInitializer] GlobalSfx 未定义，请确保 audio-sfx-global.js 已加载");else console.error("[AudioGlobalInitializer] GlobalBgm 未定义，请确保 audio-bgm-global.js 已加载")},AudioGlobalInitializer.prototype._setupAudioUnlock=function(){var o=this.app.soundManager&&this.app.soundManager.context;if(o){var i=this;this._unlocked=!1,this._unlock=function(){if(!i._unlocked)try{"suspended"===o.state&&o.resume&&o.resume().then((function(){console.log("[AudioGlobalInitializer] ✓ AudioContext已解锁"),i._unlocked=!0,i.app.fire("audio:unlocked"),i._removeDomListeners()})).catch((function(o){console.error("[AudioGlobalInitializer] AudioContext解锁失败:",o)}))}catch(o){console.error("[AudioGlobalInitializer] AudioContext解锁异常:",o)}},this._onPointerUp=function(){i._unlock()},this._onTouchEnd=function(){i._unlock()},this._onKeyDown=function(){i._unlock()},this._onClick=function(){i._unlock()},document.addEventListener("pointerup",this._onPointerUp,{passive:!0}),document.addEventListener("touchend",this._onTouchEnd,{passive:!0}),document.addEventListener("keydown",this._onKeyDown,{passive:!0}),document.addEventListener("click",this._onClick,{passive:!0}),this.enableDebugLog&&console.log("[AudioGlobalInitializer] 已设置音频解锁监听器（等待用户交互）")}else console.warn("[AudioGlobalInitializer] AudioContext不可用")},AudioGlobalInitializer.prototype._removeDomListeners=function(){this._onPointerUp&&document.removeEventListener("pointerup",this._onPointerUp),this._onTouchEnd&&document.removeEventListener("touchend",this._onTouchEnd),this._onKeyDown&&document.removeEventListener("keydown",this._onKeyDown),this._onClick&&document.removeEventListener("click",this._onClick)},AudioGlobalInitializer.prototype.destroy=function(){this.enableDebugLog&&console.log("[AudioGlobalInitializer] 开始销毁全局音频模块..."),this._removeDomListeners();try{"undefined"!=typeof GlobalBgm&&GlobalBgm.destroy()}catch(o){console.warn("[AudioGlobalInitializer] GlobalBgm 销毁失败:",o)}try{"undefined"!=typeof GlobalSfx&&GlobalSfx.destroy()}catch(o){console.warn("[AudioGlobalInitializer] GlobalSfx 销毁失败:",o)}try{"undefined"!=typeof GlobalAudioSettings&&GlobalAudioSettings.destroy()}catch(o){console.warn("[AudioGlobalInitializer] GlobalAudioSettings 销毁失败:",o)}try{"undefined"!=typeof GlobalAudioSceneConfig&&GlobalAudioSceneConfig.destroy()}catch(o){console.warn("[AudioGlobalInitializer] GlobalAudioSceneConfig 销毁失败:",o)}this.enableDebugLog&&console.log("[AudioGlobalInitializer] 全局音频模块已销毁")};var WorldTipsCycler=pc.createScript("worldTipsCycler");WorldTipsCycler.attributes.add("fadeInDuration",{type:"number",default:1,title:"淡入时长(秒)",description:"文字从透明到不透明的时长"}),WorldTipsCycler.attributes.add("displayDuration",{type:"number",default:5,title:"显示时长(秒)",description:"文字完全显示的停留时长"}),WorldTipsCycler.attributes.add("fadeOutDuration",{type:"number",default:1,title:"淡出时长(秒)",description:"文字从不透明到透明的时长"}),WorldTipsCycler.attributes.add("pauseDuration",{type:"number",default:.5,title:"停顿时长(秒)",description:"两条提示之间的停顿时长"}),WorldTipsCycler.attributes.add("i18nCategory",{type:"string",default:"world-tips",title:"i18n分类名",description:"从i18n中读取的分类名称"}),WorldTipsCycler.attributes.add("autoStart",{type:"boolean",default:!0,title:"自动开始",description:"脚本初始化时自动开始循环"}),WorldTipsCycler.attributes.add("enableDebugLog",{type:"boolean",default:!1,title:"调试日志"}),WorldTipsCycler.prototype.initialize=function(){if(this.entity.element&&this.entity.element.type===pc.ELEMENTTYPE_TEXT){this._state="idle",this._currentIndex=0,this._timer=0,this._isRunning=!1,this._tipKeys=[],this.entity.element.opacity=0;var t=this;"undefined"!=typeof I18n&&I18n.isReady&&I18n.isReady()?(this._loadTipKeys(),this.autoStart&&this.start()):this.app.once("i18n:ready",(function(){t._loadTipKeys(),t.autoStart&&t.start()})),this.enableDebugLog&&console.log("[WorldTipsCycler] Initialized on entity:",this.entity.name)}else console.error("[WorldTipsCycler] This script must be attached to a Text Element entity!")},WorldTipsCycler.prototype._loadTipKeys=function(){this._tipKeys=[];try{if("undefined"==typeof I18n||!I18n.get)return void console.warn("[WorldTipsCycler] I18n not available");var t=I18n.get(this.i18nCategory);if(!t)return void console.warn("[WorldTipsCycler] i18n category not found:",this.i18nCategory);for(var e in t)0===e.indexOf("tip_")&&this._tipKeys.push(e);this._tipKeys.sort(),this.enableDebugLog&&console.log("[WorldTipsCycler] Loaded tip keys:",this._tipKeys),0===this._tipKeys.length&&console.warn("[WorldTipsCycler] No tips found in category:",this.i18nCategory)}catch(t){console.error("[WorldTipsCycler] Failed to load tip keys:",t)}},WorldTipsCycler.prototype.start=function(){this._isRunning?this.enableDebugLog&&console.log("[WorldTipsCycler] Already running"):0!==this._tipKeys.length?(this._isRunning=!0,this._currentIndex=0,this._startFadeIn(),this.enableDebugLog&&console.log("[WorldTipsCycler] Started cycling tips")):console.warn("[WorldTipsCycler] No tips to display")},WorldTipsCycler.prototype.stop=function(){this._isRunning=!1,this._state="idle",this._timer=0,this.enableDebugLog&&console.log("[WorldTipsCycler] Stopped")},WorldTipsCycler.prototype.pause=function(){this._isRunning=!1},WorldTipsCycler.prototype.resume=function(){this._tipKeys.length>0&&(this._isRunning=!0)},WorldTipsCycler.prototype._startFadeIn=function(){if(this._isRunning&&0!==this._tipKeys.length){var t=this._tipKeys[this._currentIndex],e="";try{if("undefined"!=typeof I18n&&I18n.get){var i=I18n.get(this.i18nCategory);i&&i[t]&&(e=i[t])}}catch(t){console.error("[WorldTipsCycler] Failed to get tip text:",t)}e||(e="Tip "+(this._currentIndex+1)),this.entity.element.text=e,this.entity.element.opacity=0,this._state="fadeIn",this._timer=0,this.enableDebugLog&&console.log("[WorldTipsCycler] FadeIn started, index:",this._currentIndex,"text:",e)}},WorldTipsCycler.prototype._startDisplay=function(){this.entity.element.opacity=1,this._state="display",this._timer=0,this.enableDebugLog&&console.log("[WorldTipsCycler] Display started")},WorldTipsCycler.prototype._startFadeOut=function(){this._state="fadeOut",this._timer=0,this.enableDebugLog&&console.log("[WorldTipsCycler] FadeOut started")},WorldTipsCycler.prototype._startPause=function(){this.entity.element.opacity=0,this._state="pause",this._timer=0,this._currentIndex=(this._currentIndex+1)%this._tipKeys.length,this.enableDebugLog&&console.log("[WorldTipsCycler] Pause started, next index:",this._currentIndex)},WorldTipsCycler.prototype.update=function(t){if(this._isRunning&&this.entity.element)switch(this._timer+=t,this._state){case"fadeIn":this._updateFadeIn(t);break;case"display":this._updateDisplay(t);break;case"fadeOut":this._updateFadeOut(t);break;case"pause":this._updatePause(t)}},WorldTipsCycler.prototype._updateFadeIn=function(t){var e=Math.min(1,this._timer/Math.max(.001,this.fadeInDuration));this.entity.element.opacity=e,e>=1&&this._startDisplay()},WorldTipsCycler.prototype._updateDisplay=function(t){this._timer>=this.displayDuration&&this._startFadeOut()},WorldTipsCycler.prototype._updateFadeOut=function(t){var e=Math.min(1,this._timer/Math.max(.001,this.fadeOutDuration));this.entity.element.opacity=1-e,e>=1&&this._startPause()},WorldTipsCycler.prototype._updatePause=function(t){this._timer>=this.pauseDuration&&this._startFadeIn()},WorldTipsCycler.prototype.setTipKeys=function(t){Array.isArray(t)?(this._tipKeys=t.slice(),this._currentIndex=0,this.enableDebugLog&&console.log("[WorldTipsCycler] Tip keys manually set:",this._tipKeys)):console.error("[WorldTipsCycler] setTipKeys requires an array")},WorldTipsCycler.prototype.getCurrentIndex=function(){return this._currentIndex},WorldTipsCycler.prototype.goToIndex=function(t){t<0||t>=this._tipKeys.length?console.warn("[WorldTipsCycler] Invalid index:",t):(this._currentIndex=t,this._isRunning&&this._startFadeIn())},WorldTipsCycler.prototype.destroy=function(){this.stop()};var TextTranslator=pc.createScript("textTranslator");TextTranslator.attributes.add("i18nKey",{type:"string",default:"",title:"i18n 键名",description:"翻译键名，支持嵌套路径（如 menu.start_game）"}),TextTranslator.attributes.add("autoTranslate",{type:"boolean",default:!0,title:"自动翻译",description:"组件初始化时是否自动翻译"}),TextTranslator.attributes.add("namespace",{type:"string",default:"ui",title:"命名空间",description:"i18n 命名空间（ui, dialogue, title 等）"}),TextTranslator.attributes.add("enableDebugLog",{type:"boolean",default:!1,title:"调试日志"}),TextTranslator.attributes.add("delayedInit",{type:"boolean",default:!0,title:"延迟初始化",description:"启用延迟初始化以等待 I18n 系统加载"}),TextTranslator.attributes.add("maxRetries",{type:"number",default:10,title:"最大重试次数",description:"延迟初始化的最大重试次数"}),TextTranslator.attributes.add("retryInterval",{type:"number",default:500,title:"重试间隔",description:"延迟初始化的重试间隔（毫秒）"}),TextTranslator.attributes.add("mobileKey",{type:"string",default:"",title:"移动端键名",description:"移动端专用的 i18n 键名，为空时使用通用键名"}),TextTranslator.attributes.add("desktopKey",{type:"string",default:"",title:"桌面端键名",description:"桌面端专用的 i18n 键名，为空时使用通用键名"}),TextTranslator.attributes.add("enablePlatformDetection",{type:"boolean",default:!0,title:"启用平台检测",description:"是否根据平台自动选择不同的键名"}),TextTranslator.prototype.initialize=function(){this.entity.element&&this.entity.element.type===pc.ELEMENTTYPE_TEXT?(this._originalText=this.entity.element.text||"",this._isI18nReady=!1,this._retryCount=0,this._maxRetries=this.maxRetries||10,this._retryInterval=this.retryInterval||500,this._currentPlatform=this._detectPlatform(),this._effectiveKey=this._getEffectiveKey(),this.enableDebugLog&&(console.log("[TextTranslator] 初始化完成"),console.log("[TextTranslator] 实体:",this.entity.name),console.log("[TextTranslator] i18n键名:",this.i18nKey),console.log("[TextTranslator] 移动端键名:",this.mobileKey),console.log("[TextTranslator] 桌面端键名:",this.desktopKey),console.log("[TextTranslator] 当前平台:",this._currentPlatform),console.log("[TextTranslator] 有效键名:",this._effectiveKey),console.log("[TextTranslator] 命名空间:",this.namespace),console.log("[TextTranslator] 原始文本:",this._originalText)),this._onLanguageChanged=this._handleLanguageChanged.bind(this),this.app.on("i18n:language:changed",this._onLanguageChanged,this),this.app.on("i18n:changed",this._onLanguageChanged,this),this.app.on("locale:changed",this._onLanguageChanged,this),this._onI18nReady=this._handleI18nReady.bind(this),this.app.on("i18n:ready",this._onI18nReady,this),this._tryInitializeTranslation()):console.error("[TextTranslator] 组件必须绑定到 TextElement 上")},TextTranslator.prototype._detectPlatform=function(){if(this.app&&this.app.touch&&this.app.touch.supported)return"mobile";var t=navigator.userAgent||"",e=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(t),i=window.innerWidth<=768||window.innerHeight<=768,n="ontouchstart"in window||navigator.maxTouchPoints>0;return this.enableDebugLog&&(console.log("[TextTranslator] 平台检测信息:"),console.log("  User Agent Mobile:",e),console.log("  Small Screen:",i),console.log("  Touch Support:",n),console.log("  PlayCanvas Touch:",this.app&&this.app.touch&&this.app.touch.supported)),e||i&&n?"mobile":"desktop"},TextTranslator.prototype._getEffectiveKey=function(){if(!this.enablePlatformDetection)return this.i18nKey;var t="";"mobile"===this._currentPlatform&&this.mobileKey?t=this.mobileKey:"desktop"===this._currentPlatform&&this.desktopKey&&(t=this.desktopKey);var e=t||this.i18nKey;return this.enableDebugLog&&(console.log("[TextTranslator] 键名选择:"),console.log("  当前平台:",this._currentPlatform),console.log("  通用键名:",this.i18nKey),console.log("  移动端键名:",this.mobileKey),console.log("  桌面端键名:",this.desktopKey),console.log("  最终键名:",e)),e},TextTranslator.prototype._tryInitializeTranslation=function(){return this._checkI18nAvailable()?(this._isI18nReady=!0,this.enableDebugLog&&console.log("[TextTranslator] I18n 系统已就绪，执行翻译"),void(this.autoTranslate&&this._effectiveKey&&this.translate())):this.delayedInit?void(this._retryCount<this._maxRetries?(this._retryCount++,this.enableDebugLog&&console.log("[TextTranslator] I18n 系统不可用，延迟初始化 (尝试 "+this._retryCount+"/"+this._maxRetries+")"),setTimeout(this._tryInitializeTranslation.bind(this),this._retryInterval)):(this.enableDebugLog&&console.warn("[TextTranslator] I18n 系统初始化超时，使用原始文本"),this._setText(this._originalText))):(this.enableDebugLog&&console.warn("[TextTranslator] 延迟初始化已禁用，I18n 系统不可用，使用原始文本"),void this._setText(this._originalText))},TextTranslator.prototype._checkI18nAvailable=function(){if("undefined"==typeof I18n)return!1;if(!I18n.getText&&!I18n.t)return!1;try{if(I18n.getText){I18n.getText("ui","test");return!0}if(I18n.t){I18n.t("ui.test","test");return!0}}catch(t){return!1}return!1},TextTranslator.prototype._handleI18nReady=function(){this.enableDebugLog&&console.log("[TextTranslator] 收到 I18n 就绪事件"),this._isI18nReady||(this._isI18nReady=!0,this.autoTranslate&&this._effectiveKey&&this.translate())},TextTranslator.prototype.translate=function(t,e){var i=t||this._effectiveKey||this.i18nKey,n=e||this.namespace;if(!i)return this.enableDebugLog&&console.warn("[TextTranslator] 翻译键名为空，使用原始文本"),void this._setText(this._originalText);var o=this._getTranslation(i,n);this.enableDebugLog&&(console.log("[TextTranslator] 翻译结果"),console.log("  键名:",i),console.log("  命名空间:",n),console.log("  原始文本:",this._originalText),console.log("  翻译文本:",o)),this._setText(o),this.app.fire("text:translated",{entity:this.entity,key:i,namespace:n,text:o})},TextTranslator.prototype._getTranslation=function(t,e){if(!this._checkI18nAvailable())return this.enableDebugLog&&console.warn("[TextTranslator] I18n 系统不可用，使用原始文本"),this._originalText;try{var i=null;if(I18n.getText)i=I18n.getText(e,t);else if(I18n.t){var n=e+"."+t;i=I18n.t(n,t)}return i&&i!==t&&-1===i.indexOf(t)&&i!==e+"."+t?i:(this.enableDebugLog&&console.warn("[TextTranslator] 翻译失败或未找到，键名:",e+"."+t,"返回值:",i),this._originalText||t)}catch(e){return console.error("[TextTranslator] 翻译过程出错:",e),this._originalText||t}},TextTranslator.prototype._setText=function(t){this.entity.element&&(this.entity.element.text=t||"")},TextTranslator.prototype._handleLanguageChanged=function(t){this.enableDebugLog&&(console.log("[TextTranslator] 语言已变化，重新翻译"),t&&(console.log("[TextTranslator] 事件数据:",t),console.log("  新语言:",t.locale),console.log("  旧语言:",t.oldLocale))),this._currentPlatform=this._detectPlatform(),this._effectiveKey=this._getEffectiveKey(),this._effectiveKey?this.translate():this._setText(this._originalText)},TextTranslator.prototype.setKey=function(t,e){this.i18nKey=t||"",e&&(this.namespace=e),this._effectiveKey=this._getEffectiveKey(),this._effectiveKey?this.translate():this._setText(this._originalText)},TextTranslator.prototype.setNamespace=function(t){this.namespace=t||"ui",this._effectiveKey&&this.translate()},TextTranslator.prototype.setPlatformKeys=function(t,e){this.mobileKey=t||"",this.desktopKey=e||"",this._effectiveKey=this._getEffectiveKey(),this._effectiveKey?this.translate():this._setText(this._originalText)},TextTranslator.prototype.getPlatformInfo=function(){return{platform:this._currentPlatform,effectiveKey:this._effectiveKey,i18nKey:this.i18nKey,mobileKey:this.mobileKey,desktopKey:this.desktopKey,enablePlatformDetection:this.enablePlatformDetection}},TextTranslator.prototype.refresh=function(){this._currentPlatform=this._detectPlatform(),this._effectiveKey=this._getEffectiveKey(),this._effectiveKey&&this.translate()},TextTranslator.prototype.reset=function(){this._setText(this._originalText)},TextTranslator.prototype.destroy=function(){this._onLanguageChanged&&(this.app.off("i18n:language:changed",this._onLanguageChanged,this),this.app.off("i18n:changed",this._onLanguageChanged,this),this.app.off("locale:changed",this._onLanguageChanged,this)),this._onI18nReady&&this.app.off("i18n:ready",this._onI18nReady,this),this._isI18nReady=!1,this._retryCount=0,this.enableDebugLog&&console.log("[TextTranslator] 组件已销毁:",this.entity.name)};